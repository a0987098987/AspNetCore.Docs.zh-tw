---
uid: web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-vb
title: "排序自訂分頁資料 (VB) |Microsoft 文件"
author: rick-anderson
description: "在上一個教學課程中我們學到如何實作自訂分頁時 presentating 網頁上的資料。 在本教學課程中，我們看到如何擴充上述..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 08/15/2006
ms.topic: article
ms.assetid: 4823a186-caaf-4116-a318-c7ff4d955ddc
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-vb
msc.type: authoredcontent
ms.openlocfilehash: f7ba21116c2f5f976ffa95955247a49dc5f81e6c
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/10/2017
---
<a name="sorting-custom-paged-data-vb"></a><span data-ttu-id="c4e39-104">排序自訂分頁資料 (VB)</span><span class="sxs-lookup"><span data-stu-id="c4e39-104">Sorting Custom Paged Data (VB)</span></span>
====================
<span data-ttu-id="c4e39-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c4e39-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c4e39-106">[下載範例應用程式](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_VB.exe)或[下載 PDF](sorting-custom-paged-data-vb/_static/datatutorial26vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="c4e39-106">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_VB.exe) or [Download PDF](sorting-custom-paged-data-vb/_static/datatutorial26vb1.pdf)</span></span>

> <span data-ttu-id="c4e39-107">在上一個教學課程中我們學到如何實作自訂分頁時 presentating 網頁上的資料。</span><span class="sxs-lookup"><span data-stu-id="c4e39-107">In the previous tutorial we learned how to implement custom paging when presentating data on a web page.</span></span> <span data-ttu-id="c4e39-108">在本教學課程中，我們看到如何擴充上述的範例包括排序自訂分頁的支援。</span><span class="sxs-lookup"><span data-stu-id="c4e39-108">In this tutorial we see how to extend the preceding example to include support for sorting custom paging.</span></span>


## <a name="introduction"></a><span data-ttu-id="c4e39-109">簡介</span><span class="sxs-lookup"><span data-stu-id="c4e39-109">Introduction</span></span>

<span data-ttu-id="c4e39-110">相較於預設分頁時，自訂分頁的差距，進行自訂時進行大量的資料分頁的分頁既定的分頁實作選擇可以改善效能的資料進行分頁。</span><span class="sxs-lookup"><span data-stu-id="c4e39-110">Compared to default paging, custom paging can improve the performance of paging through data by several orders of magnitude, making custom paging the de facto paging implementation choice when paging through large amounts of data.</span></span> <span data-ttu-id="c4e39-111">實作自訂分頁會比實作預設的分頁，不過，尤其是加入至混合排序更複雜的。</span><span class="sxs-lookup"><span data-stu-id="c4e39-111">Implementing custom paging is more involved than implementing default paging, however, especially when adding sorting to the mix.</span></span> <span data-ttu-id="c4e39-112">在本教學課程中，我們將會延長從可支援排序的前一個範例*和*自訂分頁。</span><span class="sxs-lookup"><span data-stu-id="c4e39-112">In this tutorial we'll extend the example from the preceding one to include support for sorting *and* custom paging.</span></span>

> [!NOTE]
> <span data-ttu-id="c4e39-113">由於本教學課程是根據前一個，才能開始花點時間複製內的宣告式語法`<asp:Content>`先前的教學課程的網頁上的項目 (`EfficientPaging.aspx`) 並貼上它之間`<asp:Content>`中的項目`SortParameter.aspx`頁面。</span><span class="sxs-lookup"><span data-stu-id="c4e39-113">Since this tutorial builds upon the preceding one, before beginning take a moment to copy the declarative syntax within the `<asp:Content>` element from the preceding tutorial s web page (`EfficientPaging.aspx`) and paste it between the `<asp:Content>` element in the `SortParameter.aspx` page.</span></span> <span data-ttu-id="c4e39-114">指的步驟 1[新增驗證控制項的編輯和插入介面](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)教學課程的上一個 ASP.NET 網頁的功能複寫至另一個的更詳細討論。</span><span class="sxs-lookup"><span data-stu-id="c4e39-114">Refer back to Step 1 of the [Adding Validation Controls to the Editing and Inserting Interfaces](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md) tutorial for a more detailed discussion on replicating the functionality of one ASP.NET page to another.</span></span>


## <a name="step-1-reexamining-the-custom-paging-technique"></a><span data-ttu-id="c4e39-115">步驟 1： 再次檢驗自訂分頁技術</span><span class="sxs-lookup"><span data-stu-id="c4e39-115">Step 1: Reexamining the Custom Paging Technique</span></span>

<span data-ttu-id="c4e39-116">自訂分頁時才能正常運作，我們必須實作一種技術，可以有效率地擷取的記錄開始的資料列索引和最大資料列參數的特定子集。</span><span class="sxs-lookup"><span data-stu-id="c4e39-116">For custom paging to work properly, we must implement some technique that can efficiently grab a particular subset of records given the Start Row Index and Maximum Rows parameters.</span></span> <span data-ttu-id="c4e39-117">有很多的技術，可用來達到這個目的。</span><span class="sxs-lookup"><span data-stu-id="c4e39-117">There are a handful of techniques that can be used to achieve this aim.</span></span> <span data-ttu-id="c4e39-118">在前述我們探討了完成此教學課程中使用新的 Microsoft SQL Server 2005 的`ROW_NUMBER()`排名函數。</span><span class="sxs-lookup"><span data-stu-id="c4e39-118">In the preceding tutorial we looked at accomplishing this using Microsoft SQL Server 2005 s new `ROW_NUMBER()` ranking function.</span></span> <span data-ttu-id="c4e39-119">簡單地說，`ROW_NUMBER()`排名函數會將指派給傳回的查詢，並依照指定的排序順序的每個資料列的資料列數目。</span><span class="sxs-lookup"><span data-stu-id="c4e39-119">In short, the `ROW_NUMBER()` ranking function assigns a row number to each row returned by a query that is ranked by a specified sort order.</span></span> <span data-ttu-id="c4e39-120">然後藉由傳回特定的已編號的結果區段取得記錄的適當子集合。</span><span class="sxs-lookup"><span data-stu-id="c4e39-120">The appropriate subset of records is then obtained by returning a particular section of the numbered results.</span></span> <span data-ttu-id="c4e39-121">下列查詢說明如何使用這項技術，以傳回這些產品編號 11 到 20 的排名結果依字母順序排序時`ProductName`:</span><span class="sxs-lookup"><span data-stu-id="c4e39-121">The following query illustrates how to use this technique to return those products numbered 11 through 20 when ranking the results ordered alphabetically by the `ProductName`:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample1.sql)]

<span data-ttu-id="c4e39-122">這項技術非常適合使用特定的排序次序的分頁 (`ProductName`依字母順序排序，在此情況下)，但是查詢必須修改顯示依不同的排序運算式排序的結果。</span><span class="sxs-lookup"><span data-stu-id="c4e39-122">This technique works well for paging using a specific sort order (`ProductName` sorted alphabetically, in this case), but the query needs to be modified to show the results sorted by a different sort expression.</span></span> <span data-ttu-id="c4e39-123">在理想情況下，上述的查詢可以改寫為使用中的參數`OVER`子句，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="c4e39-123">Ideally, the above query could be rewritten to use a parameter in the `OVER` clause, like so:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample2.sql)]

<span data-ttu-id="c4e39-124">不幸的是，參數化`ORDER BY`不允許子句。</span><span class="sxs-lookup"><span data-stu-id="c4e39-124">Unfortunately, parameterized `ORDER BY` clauses are not allowed.</span></span> <span data-ttu-id="c4e39-125">相反地，我們必須建立可接受的預存程序`@sortExpression`輸入的參數，但會使用一種下列因應措施：</span><span class="sxs-lookup"><span data-stu-id="c4e39-125">Instead, we must create a stored procedure that accepts a `@sortExpression` input parameter, but uses one of the following workarounds:</span></span>

- <span data-ttu-id="c4e39-126">每個排序運算式可使用; 撰寫硬式編碼的查詢然後，使用`IF/ELSE`T-SQL 陳述式來判斷要執行的查詢。</span><span class="sxs-lookup"><span data-stu-id="c4e39-126">Write hard-coded queries for each of the sort expressions that may be used; then, use `IF/ELSE` T-SQL statements to determine which query to execute.</span></span>
- <span data-ttu-id="c4e39-127">使用`CASE`陳述式來提供動態`ORDER BY`運算式根據`@sortExpressio`n 輸入參數，請參閱 < 以動態方式排序查詢結果區段中用以[SQL 電源`CASE`陳述式](http://www.4guysfromrolla.com/webtech/102704-1.shtml)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="c4e39-127">Use a `CASE` statement to provide dynamic `ORDER BY` expressions based on the `@sortExpressio` n input parameter; see the Used to Dynamically Sort Query Results section in [The Power of SQL `CASE` Statements](http://www.4guysfromrolla.com/webtech/102704-1.shtml) for more information.</span></span>
- <span data-ttu-id="c4e39-128">預存程序以字串形式製作適當的查詢，然後使用[`sp_executesql`系統預存程序](https://msdn.microsoft.com/en-us/library/ms188001.aspx)執行動態查詢。</span><span class="sxs-lookup"><span data-stu-id="c4e39-128">Craft the appropriate query as a string in the stored procedure and then use [the `sp_executesql` system stored procedure](https://msdn.microsoft.com/en-us/library/ms188001.aspx) to execute the dynamic query.</span></span>

<span data-ttu-id="c4e39-129">每個這些因應措施有一些缺點。</span><span class="sxs-lookup"><span data-stu-id="c4e39-129">Each of these workarounds has some drawbacks.</span></span> <span data-ttu-id="c4e39-130">無法為可維護與其他兩個因為它需要您建立的每個可能的排序運算式查詢的第一個選項。</span><span class="sxs-lookup"><span data-stu-id="c4e39-130">The first option is not as maintainable as the other two as it requires that you create a query for each possible sort expression.</span></span> <span data-ttu-id="c4e39-131">因此，如果您稍後決定將新的、 可排序的欄位加入至 GridView 您也必須返回並更新預存程序。</span><span class="sxs-lookup"><span data-stu-id="c4e39-131">Therefore, if later you decide to add new, sortable fields to the GridView you will also need to go back and update the stored procedure.</span></span> <span data-ttu-id="c4e39-132">第二種方法都有一些微妙的非字串的資料庫資料行排序時造成效能問題，而且也會受到這些相同的可維護性問題，第一個。</span><span class="sxs-lookup"><span data-stu-id="c4e39-132">The second approach has some subtleties that introduce performance concerns when sorting by non-string database columns and also suffers from the same maintainability issues as the first.</span></span> <span data-ttu-id="c4e39-133">如果攻擊者能夠執行傳入輸入的參數值，他們所選擇的預存程序的第三個選擇，會使用動態 SQL，導入的 SQL 資料隱碼攻擊的風險。</span><span class="sxs-lookup"><span data-stu-id="c4e39-133">And the third choice, which uses dynamic SQL, introduces the risk for a SQL injection attack if an attacker is able to execute the stored procedure passing in the input parameter values of their choosing.</span></span>

<span data-ttu-id="c4e39-134">雖然沒有任何一種方法是完美，我認為第三個選項最適合的三個。</span><span class="sxs-lookup"><span data-stu-id="c4e39-134">While none of these approaches is perfect, I think the third option is the best of the three.</span></span> <span data-ttu-id="c4e39-135">它使用動態 SQL 中，它提供其他兩個不相符的彈性層的級。</span><span class="sxs-lookup"><span data-stu-id="c4e39-135">With its use of dynamic SQL, it offers a level of flexibility the other two do not.</span></span> <span data-ttu-id="c4e39-136">此外，如果攻擊者能夠執行他所選擇的輸入參數中傳遞的預存程序，可以只利用 SQL 資料隱碼攻擊。</span><span class="sxs-lookup"><span data-stu-id="c4e39-136">Furthermore, a SQL injection attack can only be exploited if an attacker is able to execute the stored procedure passing in the input parameters of his choice.</span></span> <span data-ttu-id="c4e39-137">DAL 會使用參數化的查詢，因為 ADO.NET 會保護通過此架構中，資料庫會傳送這些參數表示 SQL 資料隱碼攻擊的弱點可能會只存在如果攻擊者可以直接執行預存程序。</span><span class="sxs-lookup"><span data-stu-id="c4e39-137">Since the DAL uses parameterized queries, ADO.NET will protect those parameters that are sent to the database through the architecture, meaning that the SQL injection attack vulnerability only exists if the attacker can directly execute the stored procedure.</span></span>

<span data-ttu-id="c4e39-138">若要實作這項功能，建立新的預存程序中名為 Northwind 資料庫`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-138">To implement this functionality, create a new stored procedure in the Northwind database named `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="c4e39-139">這個預存程序應該接受三個輸入參數： `@sortExpression`，輸入的參數的型別`nvarchar(100`)，指定如何排序結果，並插入之後`ORDER BY`中的文字`OVER`子句; 和`@startRowIndex`和`@maximumRows`，從相同的兩個整數輸入的參數`GetProductsPaged`預存程序檢查前述教學課程。</span><span class="sxs-lookup"><span data-stu-id="c4e39-139">This stored procedure should accept three input parameters: `@sortExpression`, an input parameter of type `nvarchar(100`) that specifies how the results should be sorted and is injected directly after the `ORDER BY` text in the `OVER` clause; and `@startRowIndex` and `@maximumRows`, the same two integer input parameters from the `GetProductsPaged` stored procedure examined in the preceding tutorial.</span></span> <span data-ttu-id="c4e39-140">建立`GetProductsPagedAndSorted`預存程序使用下列指令碼：</span><span class="sxs-lookup"><span data-stu-id="c4e39-140">Create the `GetProductsPagedAndSorted` stored procedure using the following script:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample3.sql)]

<span data-ttu-id="c4e39-141">如此可確保的值會啟動預存程序`@sortExpression`已指定參數。</span><span class="sxs-lookup"><span data-stu-id="c4e39-141">The stored procedure starts by ensuring that a value for the `@sortExpression` parameter has been specified.</span></span> <span data-ttu-id="c4e39-142">如果遺失，結果會根據項目`ProductID`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-142">If it is missing, the results are ranked by `ProductID`.</span></span> <span data-ttu-id="c4e39-143">接下來，動態 SQL 查詢會建構。</span><span class="sxs-lookup"><span data-stu-id="c4e39-143">Next, the dynamic SQL query is constructed.</span></span> <span data-ttu-id="c4e39-144">請注意動態 SQL 查詢此處從我們先前用來從 Products 資料表中擷取所有資料列的查詢稍有不同。</span><span class="sxs-lookup"><span data-stu-id="c4e39-144">Note that the dynamic SQL query here differs slightly from our previous queries used to retrieve all rows from the Products table.</span></span> <span data-ttu-id="c4e39-145">在先前範例中，我們取得每個產品 s 相關聯的類別目錄和供應商的名稱使用子查詢。</span><span class="sxs-lookup"><span data-stu-id="c4e39-145">In prior examples, we obtained each product s associated category s and supplier s names using a subquery.</span></span> <span data-ttu-id="c4e39-146">此決策提出回[建立資料存取層](../introduction/creating-a-data-access-layer-vb.md)教學課程中，而不使用完成`JOIN`s 因為 TableAdapter 無法自動建立相關聯的插入、 更新和刪除這種方法執行查詢。</span><span class="sxs-lookup"><span data-stu-id="c4e39-146">This decision was made back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial and was done in lieu of using `JOIN` s because the TableAdapter cannot automatically create the associated insert, update, and delete methods for such queries.</span></span> <span data-ttu-id="c4e39-147">`GetProductsPagedAndSorted`預存程序，不過，必須使用`JOIN`s 來分類或供應商名稱排序結果。</span><span class="sxs-lookup"><span data-stu-id="c4e39-147">The `GetProductsPagedAndSorted` stored procedure, however, must use `JOIN` s for the results to be ordered by the category or supplier names.</span></span>

<span data-ttu-id="c4e39-148">此動態查詢建立藉由串連靜態查詢部分和`@sortExpression`， `@startRowIndex`，和`@maximumRows`參數。</span><span class="sxs-lookup"><span data-stu-id="c4e39-148">This dynamic query is built up by concatenating the static query portions and the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="c4e39-149">因為`@startRowIndex`和`@maximumRows`整數參數，它們必須先轉換成 nvarchars 才能正確的串連。</span><span class="sxs-lookup"><span data-stu-id="c4e39-149">Since `@startRowIndex` and `@maximumRows` are integer parameters, they must be converted into nvarchars in order to be correctly concatenated.</span></span> <span data-ttu-id="c4e39-150">一旦已建構此動態 SQL 查詢，執行透過`sp_executesql`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-150">Once this dynamic SQL query has been constructed, it is executed via `sp_executesql`.</span></span>

<span data-ttu-id="c4e39-151">請花一點時間來測試不同的值與這個預存程序`@sortExpression`， `@startRowIndex`，和`@maximumRows`參數。</span><span class="sxs-lookup"><span data-stu-id="c4e39-151">Take a moment to test this stored procedure with different values for the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="c4e39-152">從 伺服器總管 中，以滑鼠右鍵按一下預存程序名稱，然後選擇 執行。</span><span class="sxs-lookup"><span data-stu-id="c4e39-152">From the Server Explorer, right-click on the stored procedure name and choose Execute.</span></span> <span data-ttu-id="c4e39-153">這會顯示 [執行預存程序] 對話方塊，您可以輸入的輸入的參數 （請參閱圖 1）。</span><span class="sxs-lookup"><span data-stu-id="c4e39-153">This will bring up the Run Stored Procedure dialog box into which you can enter the input parameters (see Figure 1).</span></span> <span data-ttu-id="c4e39-154">若要依類別目錄名稱排序結果，使用 類別名稱的`@sortExpression`參數的值; 依供應商的公司名稱排序，請使用 供應商。</span><span class="sxs-lookup"><span data-stu-id="c4e39-154">To sort the results by the category name, use CategoryName for the `@sortExpression` parameter value; to sort by the supplier s company name, use CompanyName.</span></span> <span data-ttu-id="c4e39-155">提供的參數值之後, 按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="c4e39-155">After providing the parameters values, click OK.</span></span> <span data-ttu-id="c4e39-156">結果會顯示在 [輸出] 視窗中。</span><span class="sxs-lookup"><span data-stu-id="c4e39-156">The results are displayed in the Output window.</span></span> <span data-ttu-id="c4e39-157">圖 2 顯示時由排序時，傳回產品排名 11 到 20 的結果`UnitPrice`以遞減的順序。</span><span class="sxs-lookup"><span data-stu-id="c4e39-157">Figure 2 shows the results when returning products ranked 11 through 20 when ordering by the `UnitPrice` in descending order.</span></span>


![嘗試不同的值的預存程序 s 三個輸入參數](sorting-custom-paged-data-vb/_static/image1.png)

<span data-ttu-id="c4e39-159">**圖 1**： 預存程序 s 三個輸入參數，請嘗試不同的值</span><span class="sxs-lookup"><span data-stu-id="c4e39-159">**Figure 1**: Try Different Values for the Stored Procedure s Three Input Parameters</span></span>


<span data-ttu-id="c4e39-160">[![預存程序的結果會顯示在 [輸出] 視窗](sorting-custom-paged-data-vb/_static/image3.png)](sorting-custom-paged-data-vb/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="c4e39-160">[![The Stored Procedure s Results are Shown in the Output Window](sorting-custom-paged-data-vb/_static/image3.png)](sorting-custom-paged-data-vb/_static/image2.png)</span></span>

<span data-ttu-id="c4e39-161">**圖 2**: 預存程序的結果會顯示在 [輸出] 視窗 ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="c4e39-161">**Figure 2**: The Stored Procedure s Results are Shown in the Output Window ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image4.png))</span></span>


> [!NOTE]
> <span data-ttu-id="c4e39-162">當藉由指定排名結果`ORDER BY`中的資料行`OVER`子句，SQL Server 必須排序結果。</span><span class="sxs-lookup"><span data-stu-id="c4e39-162">When ranking the results by the specified `ORDER BY` column in the `OVER` clause, SQL Server must sort the results.</span></span> <span data-ttu-id="c4e39-163">這是快速的作業，如果沒有叢集的索引上的結果所排序的資料行，或者沒有涵蓋索引，但可否則成本更高。</span><span class="sxs-lookup"><span data-stu-id="c4e39-163">This is a quick operation if there is a clustered index over the column(s) the results are being ordered by or if there is a covering index, but can be more costly otherwise.</span></span> <span data-ttu-id="c4e39-164">若要改善夠大的查詢的效能，請考慮加入非叢集索引的結果依排序的資料行。</span><span class="sxs-lookup"><span data-stu-id="c4e39-164">To improve performance for sufficiently large queries, consider adding a non-clustered index for the column by which the results are ordered by.</span></span> <span data-ttu-id="c4e39-165">請參閱[排名函式和 SQL Server 2005 中的效能](http://www.sql-server-performance.com/ak_ranking_functions.asp)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="c4e39-165">Refer to [Ranking Functions and Performance in SQL Server 2005](http://www.sql-server-performance.com/ak_ranking_functions.asp) for more details.</span></span>


## <a name="step-2-augmenting-the-data-access-and-business-logic-layers"></a><span data-ttu-id="c4e39-166">步驟 2： 加強資料存取和商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="c4e39-166">Step 2: Augmenting the Data Access and Business Logic Layers</span></span>

<span data-ttu-id="c4e39-167">與`GetProductsPagedAndSorted`建立預存程序中，我們的下一個步驟是提供一種機制來執行該預存程序，透過我們的應用程式架構。</span><span class="sxs-lookup"><span data-stu-id="c4e39-167">With the `GetProductsPagedAndSorted` stored procedure created, our next step is to provide a means to execute that stored procedure through our application architecture.</span></span> <span data-ttu-id="c4e39-168">這需要 DAL 和 BLL 加入適當的方法。</span><span class="sxs-lookup"><span data-stu-id="c4e39-168">This entails adding an appropriate method to both the DAL and BLL.</span></span> <span data-ttu-id="c4e39-169">可讓 s dal 將一種方法來開始。</span><span class="sxs-lookup"><span data-stu-id="c4e39-169">Let s start by adding a method to the DAL.</span></span> <span data-ttu-id="c4e39-170">開啟`Northwind.xsd`具類型的資料集，以滑鼠右鍵按一下`ProductsTableAdapter`，，然後從內容功能表中選擇 加入查詢選項。</span><span class="sxs-lookup"><span data-stu-id="c4e39-170">Open the `Northwind.xsd` Typed DataSet, right-click on the `ProductsTableAdapter`, and choose the Add Query option from the context menu.</span></span> <span data-ttu-id="c4e39-171">我們在先前的教學課程中我們想要設定這個新的 DAL 方法，以使用現有的預存程序- `GetProductsPagedAndSorted`，在此情況下。</span><span class="sxs-lookup"><span data-stu-id="c4e39-171">As we did in the preceding tutorial, we want to configure this new DAL method to use an existing stored procedure - `GetProductsPagedAndSorted`, in this case.</span></span> <span data-ttu-id="c4e39-172">開始會指出您想要使用現有的預存程序的新 TableAdapter 方法。</span><span class="sxs-lookup"><span data-stu-id="c4e39-172">Start by indicating that you want the new TableAdapter method to use an existing stored procedure.</span></span>


![選擇使用現有的預存程序](sorting-custom-paged-data-vb/_static/image5.png)

<span data-ttu-id="c4e39-174">**圖 3**： 選擇使用現有的預存程序</span><span class="sxs-lookup"><span data-stu-id="c4e39-174">**Figure 3**: Choose to Use an Existing Stored Procedure</span></span>


<span data-ttu-id="c4e39-175">若要指定要使用的預存程序，請選取`GetProductsPagedAndSorted`儲存程序，從下拉式清單中下一個畫面。</span><span class="sxs-lookup"><span data-stu-id="c4e39-175">To specify the stored procedure to use, select the `GetProductsPagedAndSorted` stored procedure from the drop-down list in the next screen.</span></span>


![使用 GetProductsPagedAndSorted 預存程序](sorting-custom-paged-data-vb/_static/image6.png)

<span data-ttu-id="c4e39-177">**圖 4**： 使用 GetProductsPagedAndSorted 預存程序</span><span class="sxs-lookup"><span data-stu-id="c4e39-177">**Figure 4**: Use the GetProductsPagedAndSorted Stored Procedure</span></span>


<span data-ttu-id="c4e39-178">這個預存程序傳回一組記錄，因為其結果，在下一個畫面中，表示它會傳回表格式資料。</span><span class="sxs-lookup"><span data-stu-id="c4e39-178">This stored procedure returns a set of records as its results so, in the next screen, indicate that it returns tabular data.</span></span>


![指出預存程序傳回表格式資料](sorting-custom-paged-data-vb/_static/image7.png)

<span data-ttu-id="c4e39-180">**圖 5**： 指出預存程序傳回表格式資料</span><span class="sxs-lookup"><span data-stu-id="c4e39-180">**Figure 5**: Indicate that the Stored Procedure Returns Tabular Data</span></span>


<span data-ttu-id="c4e39-181">最後，建立 DAL 方法使用的填滿 DataTable，並傳回 DataTable 模式、 命名方法`FillPagedAndSorted`和`GetProductsPagedAndSorted`分別。</span><span class="sxs-lookup"><span data-stu-id="c4e39-181">Finally, create DAL methods that use both the Fill a DataTable and Return a DataTable patterns, naming the methods `FillPagedAndSorted` and `GetProductsPagedAndSorted`, respectively.</span></span>


![選擇 方法名稱](sorting-custom-paged-data-vb/_static/image8.png)

<span data-ttu-id="c4e39-183">**圖 6**： 選擇的方法名稱</span><span class="sxs-lookup"><span data-stu-id="c4e39-183">**Figure 6**: Choose the Methods Names</span></span>


<span data-ttu-id="c4e39-184">現在我們 ve 擴充 DAL，我們將 BLL 準備好。</span><span class="sxs-lookup"><span data-stu-id="c4e39-184">Now that we ve extended the DAL, we re ready to turn to the BLL.</span></span> <span data-ttu-id="c4e39-185">開啟`ProductsBLL`類別檔案，然後將新的方法， `GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-185">Open the `ProductsBLL` class file and add a new method, `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="c4e39-186">這個方法只需要接受三個輸入參數`sortExpression`， `startRowIndex`，和`maximumRows`，應該直接向下呼叫至 DAL 的`GetProductsPagedAndSorted`方法，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="c4e39-186">This method needs to accept three input parameters `sortExpression`, `startRowIndex`, and `maximumRows` and should simply call down into the DAL s `GetProductsPagedAndSorted` method, like so:</span></span>


[!code-vb[Main](sorting-custom-paged-data-vb/samples/sample4.vb)]

## <a name="step-3-configuring-the-objectdatasource-to-pass-in-the-sortexpression-parameter"></a><span data-ttu-id="c4e39-187">步驟 3： 設定 SortExpression 參數中傳遞至 ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="c4e39-187">Step 3: Configuring the ObjectDataSource to Pass in the SortExpression Parameter</span></span>

<span data-ttu-id="c4e39-188">DAL 和 BLL，包括使用的方法具有夾帶`GetProductsPagedAndSorted`預存程序，是設定在 ObjectDataSource`SortParameter.aspx`頁面，即可使用新的 BLL 方法並傳入`SortExpression`參數為基礎使用者已要求來排序結果所依據的資料行。</span><span class="sxs-lookup"><span data-stu-id="c4e39-188">Having augmented the DAL and BLL to include methods that utilize the `GetProductsPagedAndSorted` stored procedure, all that remains is to configure the ObjectDataSource in the `SortParameter.aspx` page to use the new BLL method and to pass in the `SortExpression` parameter based on the column that the user has requested to sort the results by.</span></span>

<span data-ttu-id="c4e39-189">藉由變更 ObjectDataSource s 啟動`SelectMethod`從`GetProductsPaged`至`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-189">Start by changing the ObjectDataSource s `SelectMethod` from `GetProductsPaged` to `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="c4e39-190">這可以透過設定資料來源精靈，從 [屬性] 視窗中，或直接透過宣告式語法完成。</span><span class="sxs-lookup"><span data-stu-id="c4e39-190">This can be done through the Configure Data Source wizard, from the Properties window, or directly through the declarative syntax.</span></span> <span data-ttu-id="c4e39-191">接下來，我們必須提供值給 ObjectDataSource s [ `SortParameterName`屬性](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx)。</span><span class="sxs-lookup"><span data-stu-id="c4e39-191">Next, we need to provide a value for the ObjectDataSource s [`SortParameterName` property](https://msdn.microsoft.com/en-us/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx).</span></span> <span data-ttu-id="c4e39-192">如果設定這個屬性，ObjectDataSource 嘗試傳入 GridView s`SortExpression`屬性`SelectMethod`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-192">If this property is set, the ObjectDataSource attempts to pass in the GridView s `SortExpression` property to the `SelectMethod`.</span></span> <span data-ttu-id="c4e39-193">ObjectDataSource 特別的是，其名稱的值等於輸入參數會尋找`SortParameterName`屬性。</span><span class="sxs-lookup"><span data-stu-id="c4e39-193">In particular, the ObjectDataSource looks for an input parameter whose name is equal to the value of the `SortParameterName` property.</span></span> <span data-ttu-id="c4e39-194">因為 BLL s`GetProductsPagedAndSorted`方法有名稱為排序的運算式輸入的參數`sortExpression`，設定 ObjectDataSource 的`SortExpression`sortExpression 的屬性。</span><span class="sxs-lookup"><span data-stu-id="c4e39-194">Since the BLL s `GetProductsPagedAndSorted` method has the sort expression input parameter named `sortExpression`, set the ObjectDataSource s `SortExpression` property to sortExpression .</span></span>

<span data-ttu-id="c4e39-195">這兩個變更之後，ObjectDataSource s 宣告式語法看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="c4e39-195">After making these two changes, the ObjectDataSource s declarative syntax should look similar to the following:</span></span>


[!code-aspx[Main](sorting-custom-paged-data-vb/samples/sample5.aspx)]

> [!NOTE]
> <span data-ttu-id="c4e39-196">如先前的教學課程中，確認 ObjectDataSource 就*不*sortExpression、 startRowIndex、 或 maximumRows 輸入的參數集合中包含其 SelectParameters。</span><span class="sxs-lookup"><span data-stu-id="c4e39-196">As with the preceding tutorial, ensure that the ObjectDataSource does *not* include the sortExpression, startRowIndex, or maximumRows input parameters in its SelectParameters collection.</span></span>


<span data-ttu-id="c4e39-197">若要啟用在 GridView 中排序，只會檢查啟用排序 核取方塊在 GridView s 智慧標籤中，這會設定 GridView s`AllowSorting`屬性`true`，進而導致每個資料行轉譯為 LinkButton 標頭文字。</span><span class="sxs-lookup"><span data-stu-id="c4e39-197">To enable sorting in the GridView, simply check the Enable Sorting checkbox in the GridView s smart tag, which sets the GridView s `AllowSorting` property to `true` and causing the header text for each column to be rendered as a LinkButton.</span></span> <span data-ttu-id="c4e39-198">當使用者按一下其中一個標頭 LinkButtons 時，回傳展示和經過下列步驟：</span><span class="sxs-lookup"><span data-stu-id="c4e39-198">When the end user clicks on one of the header LinkButtons, a postback ensues and the following steps transpire:</span></span>

1. <span data-ttu-id="c4e39-199">GridView 更新其[`SortExpression`屬性](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.gridview.sortexpression.aspx)值`SortExpression`已按下其標頭連結的欄位</span><span class="sxs-lookup"><span data-stu-id="c4e39-199">The GridView updates its [`SortExpression` property](https://msdn.microsoft.com/en-US/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) to the value of the `SortExpression` of the field whose header link was clicked</span></span>
2. <span data-ttu-id="c4e39-200">ObjectDataSource 叫用 BLL s`GetProductsPagedAndSorted`方法，傳入 GridView s`SortExpression`屬性做為方法的值`sortExpression`輸入的參數 (以及適當`startRowIndex`和`maximumRows`輸入參數值)</span><span class="sxs-lookup"><span data-stu-id="c4e39-200">The ObjectDataSource invokes the BLL s `GetProductsPagedAndSorted` method, passing in the GridView s `SortExpression` property as the value for the method s `sortExpression` input parameter (along with the appropriate `startRowIndex` and `maximumRows` input parameter values)</span></span>
3. <span data-ttu-id="c4e39-201">BLL 叫用 DAL 的`GetProductsPagedAndSorted`方法</span><span class="sxs-lookup"><span data-stu-id="c4e39-201">The BLL invokes the DAL s `GetProductsPagedAndSorted` method</span></span>
4. <span data-ttu-id="c4e39-202">DAL 執行`GetProductsPagedAndSorted`中傳遞預存程序，`@sortExpression`參數 (連同`@startRowIndex`和`@maximumRows`輸入參數值)</span><span class="sxs-lookup"><span data-stu-id="c4e39-202">The DAL executes the `GetProductsPagedAndSorted` stored procedure, passing in the `@sortExpression` parameter (along with the `@startRowIndex` and `@maximumRows` input parameter values)</span></span>
5. <span data-ttu-id="c4e39-203">預存程序會傳回適當的資料子集為 BLL，回到 ObjectDataSource;這項資料然後繫結至 GridView，轉譯為 HTML，並向下傳送給使用者</span><span class="sxs-lookup"><span data-stu-id="c4e39-203">The stored procedure returns the appropriate subset of data to the BLL, which returns it to the ObjectDataSource; this data is then bound to the GridView, rendered into HTML, and sent down to the end user</span></span>

<span data-ttu-id="c4e39-204">圖 7 顯示結果時，依排序的第一頁`UnitPrice`以遞增順序。</span><span class="sxs-lookup"><span data-stu-id="c4e39-204">Figure 7 shows the first page of results when sorted by the `UnitPrice` in ascending order.</span></span>


<span data-ttu-id="c4e39-205">[![結果會依照 UnitPrice](sorting-custom-paged-data-vb/_static/image10.png)](sorting-custom-paged-data-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="c4e39-205">[![The Results are Sorted by the UnitPrice](sorting-custom-paged-data-vb/_static/image10.png)](sorting-custom-paged-data-vb/_static/image9.png)</span></span>

<span data-ttu-id="c4e39-206">**圖 7**: 結果會依照 UnitPrice ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image11.png))</span><span class="sxs-lookup"><span data-stu-id="c4e39-206">**Figure 7**: The Results are Sorted by the UnitPrice ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image11.png))</span></span>


<span data-ttu-id="c4e39-207">目前的實作可以正確排序結果的產品名稱、 類別名稱、 每個單位和單價的數量，而嘗試排列結果的順序與供應商名稱結果在執行階段例外狀況 （請參閱圖 8）。</span><span class="sxs-lookup"><span data-stu-id="c4e39-207">While the current implementation can correctly sort the results by product name, category name, quantity per unit, and unit price, attempting to order the results by the supplier name results in a runtime exception (see Figure 8).</span></span>


![嘗試將排序結果，您可以在下列執行階段例外狀況的供應商結果](sorting-custom-paged-data-vb/_static/image12.png)

<span data-ttu-id="c4e39-209">**圖 8**： 嘗試將排序結果，您可以在下列執行階段例外狀況的供應商結果</span><span class="sxs-lookup"><span data-stu-id="c4e39-209">**Figure 8**: Attempting to Sort the Results by the Supplier Results in the Following Runtime Exception</span></span>


<span data-ttu-id="c4e39-210">發生這個例外狀況，因為`SortExpression`的 GridView s `SupplierName` BoundField 設`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-210">This exception occurs because the `SortExpression` of the GridView s `SupplierName` BoundField is set to `SupplierName`.</span></span> <span data-ttu-id="c4e39-211">供應商 s 中的名稱。 不過，`Suppliers`資料表實際上稱為`CompanyName`我們已經被別名做為此資料行名稱`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="c4e39-211">However, the supplier s name in the `Suppliers` table is actually called `CompanyName` we have been aliased this column name as `SupplierName`.</span></span> <span data-ttu-id="c4e39-212">不過，`OVER`子句使用`ROW_NUMBER()`函式不能使用別名，而且必須使用實際的資料行名稱。</span><span class="sxs-lookup"><span data-stu-id="c4e39-212">However, the `OVER` clause used by the `ROW_NUMBER()` function cannot use the alias and must use the actual column name.</span></span> <span data-ttu-id="c4e39-213">因此，變更`SupplierName`BoundField 的`SortExpression`從供應商名稱至供應商 （請參閱圖 9）。</span><span class="sxs-lookup"><span data-stu-id="c4e39-213">Therefore, change the `SupplierName` BoundField s `SortExpression` from SupplierName to CompanyName (see Figure 9).</span></span> <span data-ttu-id="c4e39-214">如圖 10 所示，這項變更後的結果可依供應商。</span><span class="sxs-lookup"><span data-stu-id="c4e39-214">As Figure 10 shows, after this change the results can be sorted by the supplier.</span></span>


![變更 CompanyName 供應商名稱 BoundField 的 SortExpression](sorting-custom-paged-data-vb/_static/image13.png)

<span data-ttu-id="c4e39-216">**圖 9**： 變更 CompanyName 供應商名稱 BoundField 的 SortExpression</span><span class="sxs-lookup"><span data-stu-id="c4e39-216">**Figure 9**: Change the SupplierName BoundField s SortExpression to CompanyName</span></span>


<span data-ttu-id="c4e39-217">[![現在可以依供應商排序結果](sorting-custom-paged-data-vb/_static/image15.png)](sorting-custom-paged-data-vb/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="c4e39-217">[![The Results Can Now Be Sorted by Supplier](sorting-custom-paged-data-vb/_static/image15.png)](sorting-custom-paged-data-vb/_static/image14.png)</span></span>

<span data-ttu-id="c4e39-218">**圖 10**: 結果可立即依供應商 ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="c4e39-218">**Figure 10**: The Results Can Now Be Sorted by Supplier ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="c4e39-219">總結</span><span class="sxs-lookup"><span data-stu-id="c4e39-219">Summary</span></span>

<span data-ttu-id="c4e39-220">我們探討前述教學課程的自訂分頁實作所需，您在設計階段指定之結果所要排序的順序。</span><span class="sxs-lookup"><span data-stu-id="c4e39-220">The custom paging implementation we examined in the preceding tutorial required that the order by which the results were to be sorted be specified at design time.</span></span> <span data-ttu-id="c4e39-221">簡單地說，這意味著，我們實作的自訂分頁實作無法，在相同的時間，提供排序功能。</span><span class="sxs-lookup"><span data-stu-id="c4e39-221">In short, this meant that the custom paging implementation we implemented could not, at the same time, provide sorting capabilities.</span></span> <span data-ttu-id="c4e39-222">在此教學課程中我們可以克服這項限制藉由擴充預存程序，從第一個包含`@sortExpression`結果無法排序的輸入的參數。</span><span class="sxs-lookup"><span data-stu-id="c4e39-222">In this tutorial we overcame this limitation by extending the stored procedure from the first to include a `@sortExpression` input parameter by which the results could be sorted.</span></span>

<span data-ttu-id="c4e39-223">建立此預存程序和 DAL 和 BLL 中建立新的方法之後，我們能夠實作的 GridView 會提供這兩個排序和自訂分頁藉由設定傳入 GridView s 目前 ObjectDataSource `SortExpression` BLL 屬性`SelectMethod`.</span><span class="sxs-lookup"><span data-stu-id="c4e39-223">After creating this stored procedure and creating new methods in the DAL and BLL, we were able to implement a GridView that offered both sorting and custom paging by configuring the ObjectDataSource to pass in the GridView s current `SortExpression` property to the BLL `SelectMethod`.</span></span>

<span data-ttu-id="c4e39-224">祝您程式設計 ！</span><span class="sxs-lookup"><span data-stu-id="c4e39-224">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="c4e39-225">關於作者</span><span class="sxs-lookup"><span data-stu-id="c4e39-225">About the Author</span></span>

<span data-ttu-id="c4e39-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七個 ASP/ASP.NET 書籍和的創辦[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已從 1998 年使用 Microsoft Web 技術。</span><span class="sxs-lookup"><span data-stu-id="c4e39-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="c4e39-227">Scott 可做為獨立顧問、 訓練和寫入器。</span><span class="sxs-lookup"><span data-stu-id="c4e39-227">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="c4e39-228">他最新的活頁簿[ *Sam 教導您自己 ASP.NET 2.0 24 小時內*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="c4e39-228">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="c4e39-229">他可以在達到[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)或透過他的部落格，這可以在找到[http://ScottOnWriting.NET](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="c4e39-229">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="c4e39-230">特別感謝</span><span class="sxs-lookup"><span data-stu-id="c4e39-230">Special Thanks To</span></span>

<span data-ttu-id="c4e39-231">許多有用的檢閱者已檢閱本教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="c4e39-231">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="c4e39-232">在此教學課程的前導檢閱者已 Carlos Santos。</span><span class="sxs-lookup"><span data-stu-id="c4e39-232">Lead reviewer for this tutorial was Carlos Santos.</span></span> <span data-ttu-id="c4e39-233">檢閱我即將推出的 MSDN 文件有興趣嗎？</span><span class="sxs-lookup"><span data-stu-id="c4e39-233">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="c4e39-234">如果是這樣，卸除我一行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="c4e39-234">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="c4e39-235">[上一頁](efficiently-paging-through-large-amounts-of-data-vb.md)
[下一頁](creating-a-customized-sorting-user-interface-vb.md)</span><span class="sxs-lookup"><span data-stu-id="c4e39-235">[Previous](efficiently-paging-through-large-amounts-of-data-vb.md)
[Next](creating-a-customized-sorting-user-interface-vb.md)</span></span>
