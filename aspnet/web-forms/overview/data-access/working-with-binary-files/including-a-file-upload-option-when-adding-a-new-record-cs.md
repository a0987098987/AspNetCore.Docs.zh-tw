---
uid: web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
title: 加入新的記錄 (C#) 時，其中包括的檔案上傳選項 |Microsoft 文件
author: rick-anderson
description: 本教學課程會示範如何建立可讓使用者輸入的文字資料，並上傳二進位檔案的 Web 介面。 為了說明選項可用 t...
ms.author: aspnetcontent
manager: wpickett
ms.date: 03/27/2007
ms.topic: article
ms.assetid: 362ade25-3965-4fb2-88d2-835c4786244f
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/data-access/working-with-binary-files/including-a-file-upload-option-when-adding-a-new-record-cs
msc.type: authoredcontent
ms.openlocfilehash: ab63f9b0c536be81fdaa894985bae6a6b9346fa5
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/06/2018
---
<a name="including-a-file-upload-option-when-adding-a-new-record-c"></a><span data-ttu-id="0d2a4-104">包括檔案上傳選項，當加入新的記錄 (C#)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-104">Including a File Upload Option When Adding a New Record (C#)</span></span>
====================
<span data-ttu-id="0d2a4-105">由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="0d2a4-106">[下載範例應用程式](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe)或[下載 PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-106">[Download Sample App](http://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_56_CS.exe) or [Download PDF](including-a-file-upload-option-when-adding-a-new-record-cs/_static/datatutorial56cs1.pdf)</span></span>

> <span data-ttu-id="0d2a4-107">本教學課程會示範如何建立可讓使用者輸入的文字資料，並上傳二進位檔案的 Web 介面。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-107">This tutorial shows how to create a Web interface that allows the user to both enter text data and upload binary files.</span></span> <span data-ttu-id="0d2a4-108">為了說明可用來儲存二進位資料的選項，一個檔案會儲存在資料庫中而其他則會儲存在檔案系統中。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-108">To illustrate the options available to store binary data, one file will be saved in the database while the other is stored in the file system.</span></span>


## <a name="introduction"></a><span data-ttu-id="0d2a4-109">簡介</span><span class="sxs-lookup"><span data-stu-id="0d2a4-109">Introduction</span></span>

<span data-ttu-id="0d2a4-110">我們在先前的兩個教學課程中瀏覽技巧來儲存應用程式的資料模型，查看如何使用檔案上傳控制項，將檔案從用戶端傳送到 web 伺服器，並可了解如何在資料 W 呈現這項二進位資料與相關聯的二進位資料eb 控制項。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-110">In the previous two tutorials we explored techniques for storing binary data that is associated with the application s data model, looked at how to use the FileUpload control to send files from the client to the web server, and saw how to present this binary data in a data Web control.</span></span> <span data-ttu-id="0d2a4-111">我們尚未以討論如何上傳的資料關聯的資料模型，不過我們。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-111">We ve yet to talk about how to associate uploaded data with the data model, though.</span></span>

<span data-ttu-id="0d2a4-112">在本教學課程中，我們將建立網頁新增新的類別。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-112">In this tutorial we will create a web page to add a new category.</span></span> <span data-ttu-id="0d2a4-113">除了類別 s 的名稱和描述的文字方塊，將需要此頁面包含兩個檔案上傳控制項的新類別的圖片，另一個用於冊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-113">In addition to TextBoxes for the category s name and description, this page will need to include two FileUpload controls one for the new category s picture and one for the brochure.</span></span> <span data-ttu-id="0d2a4-114">上傳的圖片會直接儲存在新的記錄 s`Picture`資料行，而冊儲存`~/Brochures`資料夾以儲存新的記錄 s 中的檔案路徑`BrochurePath`資料行。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-114">The uploaded picture will be stored directly in the new record s `Picture` column, whereas the brochure will be saved to the `~/Brochures` folder with the path to the file saved in the new record s `BrochurePath` column.</span></span>

<span data-ttu-id="0d2a4-115">之前建立這個新的網頁，我們需要更新架構。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-115">Before creating this new web page, we'll need to update the architecture.</span></span> <span data-ttu-id="0d2a4-116">`CategoriesTableAdapter` s 主查詢未擷取必要`Picture`資料行。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-116">The `CategoriesTableAdapter` s main query does not retrieve the `Picture` column.</span></span> <span data-ttu-id="0d2a4-117">因此，自動產生`Insert`方法只會有輸入`CategoryName`， `Description`，和`BrochurePath`欄位。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-117">Consequently, the auto-generated `Insert` method only has inputs for the `CategoryName`, `Description`, and `BrochurePath` fields.</span></span> <span data-ttu-id="0d2a4-118">因此，我們需要建立額外的方法會提示輸入所有的四個 TableAdapter 中`Categories`欄位。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-118">Therefore, we need to create an additional method in the TableAdapter that prompts for all four `Categories` fields.</span></span> <span data-ttu-id="0d2a4-119">`CategoriesBLL`商務邏輯層中的類別也需要更新。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-119">The `CategoriesBLL` class in the Business Logic Layer will also need to be updated.</span></span>

## <a name="step-1-adding-aninsertwithpicturemethod-to-thecategoriestableadapter"></a><span data-ttu-id="0d2a4-120">步驟 1： 加入`InsertWithPicture`方法`CategoriesTableAdapter`</span><span class="sxs-lookup"><span data-stu-id="0d2a4-120">Step 1: Adding an`InsertWithPicture`Method to the`CategoriesTableAdapter`</span></span>

<span data-ttu-id="0d2a4-121">當我們建立`CategoriesTableAdapter`回[建立資料存取層](../introduction/creating-a-data-access-layer-cs.md)教學課程中，我們設定為自動產生`INSERT`， `UPDATE`，和`DELETE`主要查詢為基礎的陳述式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-121">When we created the `CategoriesTableAdapter` back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) tutorial, we configured it to automatically generate `INSERT`, `UPDATE`, and `DELETE` statements based on the main query.</span></span> <span data-ttu-id="0d2a4-122">此外，我們指示採用 DB 直接的方法中，建立方法 TableAdapter `Insert`， `Update`，和`Delete`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-122">Moreover, we instructed the TableAdapter to employ the DB Direct approach, which created the methods `Insert`, `Update`, and `Delete`.</span></span> <span data-ttu-id="0d2a4-123">這些方法可讓您執行自動產生`INSERT`， `UPDATE`，和`DELETE`陳述式，因此，接受根據主查詢所傳回的資料行的輸入的參數。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-123">These methods execute the auto-generated `INSERT`, `UPDATE`, and `DELETE` statements and, consequently, accept input parameters based on the columns returned by the main query.</span></span> <span data-ttu-id="0d2a4-124">在[上傳檔案](uploading-files-cs.md)教學課程中我們夾帶`CategoriesTableAdapter`s 主查詢使用`BrochurePath`資料行。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-124">In the [Uploading Files](uploading-files-cs.md) tutorial we augmented the `CategoriesTableAdapter` s main query to use the `BrochurePath` column.</span></span>

<span data-ttu-id="0d2a4-125">因為`CategoriesTableAdapter`s 主查詢沒有參考`Picture`資料行中，我們可以加入新的記錄都有的值更新現有的記錄`Picture`資料行。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-125">Since the `CategoriesTableAdapter` s main query does not reference the `Picture` column, we can neither add a new record nor update an existing record with a value for the `Picture` column.</span></span> <span data-ttu-id="0d2a4-126">若要擷取這項資訊，我們可以建立新的方法會特別用來插入含二進位資料的資料錄的 TableAdapter 中，或者我們可以自訂自動產生`INSERT`陳述式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-126">In order to capture this information, we can either create a new method in the TableAdapter that is used specifically to insert a record with binary data or we can customize the auto-generated `INSERT` statement.</span></span> <span data-ttu-id="0d2a4-127">自訂自動產生的問題`INSERT`陳述式是我們風險讓我們的自訂覆寫精靈。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-127">The problem with customizing the auto-generated `INSERT` statement is that we risk having our customizations overwritten by the wizard.</span></span> <span data-ttu-id="0d2a4-128">例如，假設我們自訂`INSERT`陳述式，包括使用`Picture`資料行。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-128">For example, imagine that we customized the `INSERT` statement to include use of the `Picture` column.</span></span> <span data-ttu-id="0d2a4-129">這會更新 tableadapter`Insert`方法，將包含額外的輸入的參數為類別的圖片 s 二進位資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-129">This would update the TableAdapter s `Insert` method to include an additional input parameter for the category s picture s binary data.</span></span> <span data-ttu-id="0d2a4-130">我們無法再建立方法中使用這個 DAL 方法和展示層中，透過這個 BLL 方法叫用商務邏輯層及的所有項目會處理作出。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-130">We could then create a method in the Business Logic Layer to use this DAL method and invoke this BLL method through the Presentation Layer, and everything would work wonderfully.</span></span> <span data-ttu-id="0d2a4-131">亦即，直到下一次設定 TableAdapter 透過 TableAdapter 組態精靈。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-131">That is, until the next time we configured the TableAdapter through the TableAdapter Configuration wizard.</span></span> <span data-ttu-id="0d2a4-132">當精靈完成時，我們的自訂`INSERT`陳述式可能會被覆寫，`Insert`方法會還原成原來的形式，並將不會再編譯的程式碼 ！</span><span class="sxs-lookup"><span data-stu-id="0d2a4-132">As soon as the wizard completed, our customizations to the `INSERT` statement would be overwritten, the `Insert` method would revert to its old form, and our code would no longer compile!</span></span>

> [!NOTE]
> <span data-ttu-id="0d2a4-133">不便使用預存程序，而不特定 SQL 陳述式時非問題。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-133">This annoyance is a non-issue when using stored procedures instead of ad-hoc SQL statements.</span></span> <span data-ttu-id="0d2a4-134">未來的教學課程將探索資料存取層中使用這個特定 SQL 陳述式的預存程序。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-134">A future tutorial will explore using stored procedures in lieu of ad-hoc SQL statements in the Data Access Layer.</span></span>


<span data-ttu-id="0d2a4-135">若要避免此可能性麻煩，而不是自訂的自動產生 SQL 陳述式，可讓 s 改為建立 TableAdapter 的新方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-135">To avoid this potential headache, rather than customizing the auto-generated SQL statements let s instead create a new method for the TableAdapter.</span></span> <span data-ttu-id="0d2a4-136">這個方法，名為`InsertWithPicture`，將會接受的值`CategoryName`， `Description`， `BrochurePath`，和`Picture`資料行，並執行`INSERT`新記錄中儲存所有的四個值的陳述式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-136">This method, named `InsertWithPicture`, will accept values for the `CategoryName`, `Description`, `BrochurePath`, and `Picture` columns and execute an `INSERT` statement that stores all four values in a new record.</span></span>

<span data-ttu-id="0d2a4-137">開啟 輸入資料集，並從設計工具中，以滑鼠右鍵按一下`CategoriesTableAdapter`s 標頭和內容功能表選擇 加入查詢。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-137">Open the Typed DataSet and, from the Designer, right-click on the `CategoriesTableAdapter` s header and choose Add Query from the context menu.</span></span> <span data-ttu-id="0d2a4-138">這會啟動 TableAdapter 查詢組態精靈，一開始會詢問我們 TableAdapter 查詢應該如何存取資料庫。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-138">This launches the TableAdapter Query Configuration Wizard, which begins by asking us how the TableAdapter query should access the database.</span></span> <span data-ttu-id="0d2a4-139">選擇 使用 SQL 陳述式，然後按一下 下一步。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-139">Choose Use SQL statements and click Next.</span></span> <span data-ttu-id="0d2a4-140">下一個步驟會產生提示的查詢類型。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-140">The next step prompts for the type of query to be generated.</span></span> <span data-ttu-id="0d2a4-141">因為我們重新建立查詢以新增新記錄以`Categories`資料表，選擇 [插入]，按一下 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-141">Since we re creating a query to add a new record to the `Categories` table, choose INSERT and click Next.</span></span>


<span data-ttu-id="0d2a4-142">[![選取 [插入] 選項](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-142">[![Select the INSERT Option](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image1.png)</span></span>

<span data-ttu-id="0d2a4-143">**圖 1**： 選取 [插入] 選項 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-143">**Figure 1**: Select the INSERT Option ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.png))</span></span>


<span data-ttu-id="0d2a4-144">我們現在需要指定`INSERT`SQL 陳述式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-144">We now need to specify the `INSERT` SQL statement.</span></span> <span data-ttu-id="0d2a4-145">精靈會自動建議`INSERT`對應至 TableAdapter s 主查詢的陳述式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-145">The wizard automatically suggests an `INSERT` statement corresponding to the TableAdapter s main query.</span></span> <span data-ttu-id="0d2a4-146">在此情況下，它 s`INSERT`插入的陳述式`CategoryName`， `Description`，和`BrochurePath`值。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-146">In this case, it s an `INSERT` statement that inserts the `CategoryName`, `Description`, and `BrochurePath` values.</span></span> <span data-ttu-id="0d2a4-147">Update 陳述式，讓`Picture`資料行是否包含連同`@Picture`參數，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-147">Update the statement so that the `Picture` column is included along with a `@Picture` parameter, like so:</span></span>


[!code-sql[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample1.sql)]

<span data-ttu-id="0d2a4-148">在精靈的最後一個畫面會詢問您要將新的 TableAdapter 方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-148">The final screen of the wizard asks us to name the new TableAdapter method.</span></span> <span data-ttu-id="0d2a4-149">輸入`InsertWithPicture`按一下 [完成]。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-149">Enter `InsertWithPicture` and click Finish.</span></span>


<span data-ttu-id="0d2a4-150">[![新的 TableAdapter 方法 InsertWithPicture 名稱](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-150">[![Name the New TableAdapter Method InsertWithPicture](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image2.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.png)</span></span>

<span data-ttu-id="0d2a4-151">**圖 2**： 將新的 TableAdapter 方法`InsertWithPicture`([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-151">**Figure 2**: Name the New TableAdapter Method `InsertWithPicture` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.png))</span></span>


## <a name="step-2-updating-the-business-logic-layer"></a><span data-ttu-id="0d2a4-152">步驟 2： 更新商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="0d2a4-152">Step 2: Updating the Business Logic Layer</span></span>

<span data-ttu-id="0d2a4-153">展示層應該只有介面與商務邏輯層，而不是我們要建立 BLL 方法叫用剛才所建立的 DAL 方法略過它，直接移至資料存取層，因為 (`InsertWithPicture`)。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-153">Since the Presentation Layer should only interface with the Business Logic Layer rather than bypassing it to go directly to the Data Access Layer, we need to create a BLL method that invokes the DAL method we just created (`InsertWithPicture`).</span></span> <span data-ttu-id="0d2a4-154">本教學課程中建立方法`CategoriesBLL`名為類別`InsertWithPicture`接受作為輸入的三`string`s 和`byte`陣列。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-154">For this tutorial, create a method in the `CategoriesBLL` class named `InsertWithPicture` that accepts as input three `string` s and a `byte` array.</span></span> <span data-ttu-id="0d2a4-155">`string`輸入的參數都是為類別 s 的名稱、 描述和冊檔案路徑，雖然`byte`陣列為類別的圖片的二進位內容。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-155">The `string` input parameters are for the category s name, description, and brochure file path, while the `byte` array is for the binary contents of the category s picture.</span></span> <span data-ttu-id="0d2a4-156">如下列程式碼所示，這個 BLL 方法會叫用對應的 DAL 方法：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-156">As the following code shows, this BLL method invokes the corresponding DAL method:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample2.cs)]

> [!NOTE]
> <span data-ttu-id="0d2a4-157">請確定您已經加入之前儲存型別資料集`InsertWithPicture`BLL 的方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-157">Make sure that you have saved the Typed DataSet before adding the `InsertWithPicture` method to the BLL.</span></span> <span data-ttu-id="0d2a4-158">因為`CategoriesTableAdapter`類別程式碼是以自動產生基礎具類型資料集時，如果您不要先將您的變更儲存至型別資料集`Adapter`屬性贏了 t 知道`InsertWithPicture`方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-158">Since the `CategoriesTableAdapter` class code is auto-generated based on the Typed DataSet, if you don t first save your changes to the Typed DataSet the `Adapter` property won t know about the `InsertWithPicture` method.</span></span>


## <a name="step-3-listing-the-existing-categories-and-their-binary-data"></a><span data-ttu-id="0d2a4-159">步驟 3： 列出現有的類別和其二進位資料</span><span class="sxs-lookup"><span data-stu-id="0d2a4-159">Step 3: Listing the Existing Categories and their Binary Data</span></span>

<span data-ttu-id="0d2a4-160">在本教學課程中我們將建立頁面，好讓使用者將新類別新增至系統，提供新的類別目錄的圖片和冊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-160">In this tutorial we will create a page that allows an end user to add a new category to the system, providing a picture and brochure for the new category.</span></span> <span data-ttu-id="0d2a4-161">在[前述教學課程](displaying-binary-data-in-the-data-web-controls-cs.md)我們 GridView ImageField TemplateField 與用來顯示每個類別 s 的名稱，描述、 圖片和下載其冊的連結。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-161">In the [preceding tutorial](displaying-binary-data-in-the-data-web-controls-cs.md) we used a GridView with a TemplateField and ImageField to display each category s name, description, picture, and a link to download its brochure.</span></span> <span data-ttu-id="0d2a4-162">可讓此教學課程中，建立網頁，同時列出所有現有的類別，並允許建立新的複寫功能的 s。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-162">Let s replicate that functionality for this tutorial, creating a page that both lists all existing categories and allows for new ones to be created.</span></span>

<span data-ttu-id="0d2a4-163">先開啟`DisplayOrDownload.aspx`頁面`BinaryData`資料夾。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-163">Start by opening the `DisplayOrDownload.aspx` page from the `BinaryData` folder.</span></span> <span data-ttu-id="0d2a4-164">請移至來源檢視，並將複製的 GridView 和 ObjectDataSource s 宣告式語法，在貼上`<asp:Content>`中的項目`UploadInDetailsView.aspx`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-164">Go to the Source view and copy the GridView and ObjectDataSource s declarative syntax, pasting it within the `<asp:Content>` element in `UploadInDetailsView.aspx`.</span></span> <span data-ttu-id="0d2a4-165">此外，不要忘了透過複製`GenerateBrochureLink`方法從程式碼後置類別`DisplayOrDownload.aspx`至`UploadInDetailsView.aspx`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-165">Also, don t forget to copy over the `GenerateBrochureLink` method from the code-behind class of `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx`.</span></span>


<span data-ttu-id="0d2a4-166">[![複製並貼上 UploadInDetailsView.aspx 從 DisplayOrDownload.aspx 的宣告式語法](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-166">[![Copy and Paste the Declarative Syntax from DisplayOrDownload.aspx to UploadInDetailsView.aspx](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image3.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.png)</span></span>

<span data-ttu-id="0d2a4-167">**圖 3**： 複製和貼上從宣告式語法`DisplayOrDownload.aspx`至`UploadInDetailsView.aspx`([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-167">**Figure 3**: Copy and Paste the Declarative Syntax from `DisplayOrDownload.aspx` to `UploadInDetailsView.aspx` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.png))</span></span>


<span data-ttu-id="0d2a4-168">複製的宣告式語法之後和`GenerateBrochureLink`方法，透過以`UploadInDetailsView.aspx`頁面上，檢視網頁透過瀏覽器，確認所有項目已透過正確複製。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-168">After copying the declarative syntax and `GenerateBrochureLink` method over to the `UploadInDetailsView.aspx` page, view the page through a browser to ensure that everything was copied over correctly.</span></span> <span data-ttu-id="0d2a4-169">您應該會看到 GridView 列出八個類別目錄，其中包含下載冊為類別的圖片的連結。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-169">You should see a GridView listing the eight categories that includes a link to download the brochure as well as the category s picture.</span></span>


<span data-ttu-id="0d2a4-170">[![您現在應該會看到每個類別目錄以及其二進位資料](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-170">[![You Should Now See Each Category Along with Its Binary Data](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image4.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.png)</span></span>

<span data-ttu-id="0d2a4-171">**圖 4**： 您應該立即請參閱每個類別目錄沿著其二進位資料 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-171">**Figure 4**: You Should Now See Each Category Along with Its Binary Data ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.png))</span></span>


## <a name="step-4-configuring-thecategoriesdatasourceto-support-inserting"></a><span data-ttu-id="0d2a4-172">步驟 4： 設定`CategoriesDataSource`支援插入</span><span class="sxs-lookup"><span data-stu-id="0d2a4-172">Step 4: Configuring the`CategoriesDataSource`to Support Inserting</span></span>

<span data-ttu-id="0d2a4-173">`CategoriesDataSource` ObjectDataSource 所使用`Categories`GridView 目前不提供讓您插入資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-173">The `CategoriesDataSource` ObjectDataSource used by the `Categories` GridView currently does not provide the ability to insert data.</span></span> <span data-ttu-id="0d2a4-174">若要支援插入透過此資料來源控制項，我們要對應其`Insert`方法，其基礎物件中的方法以`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-174">In order to support inserting through this data source control, we need to map its `Insert` method to a method in its underlying object, `CategoriesBLL`.</span></span> <span data-ttu-id="0d2a4-175">特別是，我們要將它對應至`CategoriesBLL`方法回在步驟 2 中，我們已加入`InsertWithPicture`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-175">In particular, we want to map it to the `CategoriesBLL` method we added back in Step 2, `InsertWithPicture`.</span></span>

<span data-ttu-id="0d2a4-176">按一下 ObjectDataSource s 智慧標籤的設定資料來源連結來啟動。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-176">Start by clicking the Configure Data Source link from the ObjectDataSource s smart tag.</span></span> <span data-ttu-id="0d2a4-177">第一個畫面會顯示要使用的設定資料來源物件`CategoriesBLL`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-177">The first screen shows the object the data source is configured to work with, `CategoriesBLL`.</span></span> <span data-ttu-id="0d2a4-178">保留此設定設為-按一下前進至定義資料方法螢幕旁邊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-178">Leave this setting as-is and click Next to advance to the Define Data Methods screen.</span></span> <span data-ttu-id="0d2a4-179">移至 [插入] 索引標籤，並挑選`InsertWithPicture`方法，從下拉式清單。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-179">Move to the INSERT tab and pick the `InsertWithPicture` method from the drop-down list.</span></span> <span data-ttu-id="0d2a4-180">按一下 [完成] 5d; 以完成精靈。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-180">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="0d2a4-181">[![設定為使用 InsertWithPicture 方法 ObjectDataSource](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-181">[![Configure the ObjectDataSource to use the InsertWithPicture Method](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image5.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.png)</span></span>

<span data-ttu-id="0d2a4-182">**圖 5**： 設定用於 ObjectDataSource`InsertWithPicture`方法 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-182">**Figure 5**: Configure the ObjectDataSource to use the `InsertWithPicture` Method ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.png))</span></span>


> [!NOTE]
> <span data-ttu-id="0d2a4-183">正在完成精靈，在 Visual Studio 可能會要求是否您想要重新整理欄位和索引鍵，其會重新產生資料 Web 控制項欄位。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-183">Upon completing the wizard, Visual Studio may ask if you want to Refresh Fields and Keys, which will regenerate the data Web controls fields.</span></span> <span data-ttu-id="0d2a4-184">選擇 否，因為選擇 是 將會覆寫您所做的任何自訂欄位。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-184">Choose No, because choosing Yes will overwrite any field customizations you may have made.</span></span>


<span data-ttu-id="0d2a4-185">完成精靈之後，ObjectDataSource 現在包含的值及其`InsertMethod`屬性以及`InsertParameters`四個類別資料行中，為下列宣告式標記說明：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-185">After completing the wizard, the ObjectDataSource will now include a value for its `InsertMethod` property as well as `InsertParameters` for the four category columns, as the following declarative markup illustrates:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample3.aspx)]

## <a name="step-5-creating-the-inserting-interface"></a><span data-ttu-id="0d2a4-186">步驟 5： 建立插入介面</span><span class="sxs-lookup"><span data-stu-id="0d2a4-186">Step 5: Creating the Inserting Interface</span></span>

<span data-ttu-id="0d2a4-187">First 涵蓋[概觀的插入、 更新和刪除資料](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md)，DetailsView 控制項提供內建的插入介面，可以利用使用支援插入的資料來源控制項時。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-187">As first covered in the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md), the DetailsView control provides a built-in inserting interface that can be utilized when working with a data source control that supports inserting.</span></span> <span data-ttu-id="0d2a4-188">可讓 s DetailsView 控制項加入此頁面上方 GridView，永遠會轉譯其插入的介面，讓使用者快速新增新的類別。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-188">Let s add a DetailsView control to this page above the GridView that will permanently render its inserting interface, allowing a user to quickly add a new category.</span></span> <span data-ttu-id="0d2a4-189">在 DetailsView 加入新的類別，其下的 GridView 會自動重新整理，並顯示新的類別。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-189">Upon adding a new category in the DetailsView, the GridView beneath it will automatically refresh and display the new category.</span></span>

<span data-ttu-id="0d2a4-190">從 [工具箱] 拖曳至上方 GridView 中設定設計工具拖曳 DetailsView 開始其`ID`屬性`NewCategory`和清除`Height`和`Width`屬性值。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-190">Start by dragging a DetailsView from the Toolbox onto the Designer above the GridView, setting its `ID` property to `NewCategory` and clearing out the `Height` and `Width` property values.</span></span> <span data-ttu-id="0d2a4-191">在 DetailsView s 智慧標籤，從繫結到現有`CategoriesDataSource`然後核取 啟用插入核取方塊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-191">From the DetailsView s smart tag, bind it to the existing `CategoriesDataSource` and then check the Enable Inserting checkbox.</span></span>


<span data-ttu-id="0d2a4-192">[![結合 CategoriesDataSource DetailsView 和啟用插入](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-192">[![Bind the DetailsView to the CategoriesDataSource and Enable Inserting](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image6.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.png)</span></span>

<span data-ttu-id="0d2a4-193">**圖 6**： 繫結至 DetailsView`CategoriesDataSource`和啟用插入 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-193">**Figure 6**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image12.png))</span></span>


<span data-ttu-id="0d2a4-194">若要永久轉譯 DetailsView 插入介面中的，設定其`DefaultMode`屬性`Insert`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-194">To permanently render the DetailsView in its inserting interface, set its `DefaultMode` property to `Insert`.</span></span>

<span data-ttu-id="0d2a4-195">請注意，在 DetailsView 的五個 BoundFields `CategoryID`， `CategoryName`， `Description`， `NumberOfProducts`，和`BrochurePath`雖然`CategoryID`因為 BoundField 不會插入介面中呈現它`InsertVisible`屬性設定為`false`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-195">Note that the DetailsView has five BoundFields `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath` although the `CategoryID` BoundField is not rendered in the inserting interface because its `InsertVisible` property is set to `false`.</span></span> <span data-ttu-id="0d2a4-196">因為它們是所傳回的資料行，這些 BoundFields 存在`GetCategories()`方法，後者為 ObjectDataSource 叫用來擷取其資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-196">These BoundFields exists because they are the columns returned by the `GetCategories()` method, which is what the ObjectDataSource invokes to retrieve its data.</span></span> <span data-ttu-id="0d2a4-197">插入，不過，我們不想要讓使用者指定的值`NumberOfProducts`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-197">For inserting, however, we don t want to let the user specify a value for `NumberOfProducts`.</span></span> <span data-ttu-id="0d2a4-198">此外，我們需要允許它們上傳新的類別目錄的圖片，以及上傳的冊 PDF。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-198">Moreover, we need to allow them to upload a picture for the new category as well as upload a PDF for the brochure.</span></span>

<span data-ttu-id="0d2a4-199">移除`NumberOfProducts`DetailsView 完全與更新 BoundField`HeaderText`屬性`CategoryName`和`BrochurePath`BoundFields 類別目錄和冊，分別。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-199">Remove the `NumberOfProducts` BoundField from the DetailsView altogether and then update the `HeaderText` properties of the `CategoryName` and `BrochurePath` BoundFields to Category and Brochure, respectively.</span></span> <span data-ttu-id="0d2a4-200">接下來，將轉換`BrochurePath`到 TemplateField BoundField 並加入新的圖片，TemplateField 提供此新 TemplateField`HeaderText`圖片的值。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-200">Next, convert the `BrochurePath` BoundField into a TemplateField and add a new TemplateField for the picture, giving this new TemplateField a `HeaderText` value of Picture.</span></span> <span data-ttu-id="0d2a4-201">移動`Picture`TemplateField，讓它變成之間`BrochurePath`TemplateField 和 CommandField。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-201">Move the `Picture` TemplateField so that it is between the `BrochurePath` TemplateField and CommandField.</span></span>


![結合 CategoriesDataSource DetailsView 和啟用插入](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image7.gif)

<span data-ttu-id="0d2a4-203">**圖 7**： 繫結至 DetailsView`CategoriesDataSource`和啟用插入</span><span class="sxs-lookup"><span data-stu-id="0d2a4-203">**Figure 7**: Bind the DetailsView to the `CategoriesDataSource` and Enable Inserting</span></span>


<span data-ttu-id="0d2a4-204">如果您轉換`BrochurePath`到透過編輯欄位 對話方塊為 TemplateField BoundField TemplateField 包含`ItemTemplate`， `EditItemTemplate`，和`InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-204">If you converted the `BrochurePath` BoundField into a TemplateField through the Edit Fields dialog box, the TemplateField includes an `ItemTemplate`, `EditItemTemplate`, and `InsertItemTemplate`.</span></span> <span data-ttu-id="0d2a4-205">只有`InsertItemTemplate`是有需要不過，可以隨意移除兩個範本。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-205">Only the `InsertItemTemplate` is needed, however, so feel free to remove the other two templates.</span></span> <span data-ttu-id="0d2a4-206">此時 DetailsView s 的宣告式語法看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-206">At this point your DetailsView s declarative syntax should look like the following:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample4.aspx)]

## <a name="adding-fileupload-controls-for-the-brochure-and-picture-fields"></a><span data-ttu-id="0d2a4-207">將檔案上傳控制項加入冊和圖片欄位</span><span class="sxs-lookup"><span data-stu-id="0d2a4-207">Adding FileUpload Controls for the Brochure and Picture Fields</span></span>

<span data-ttu-id="0d2a4-208">目前， `BrochurePath` TemplateField s`InsertItemTemplate`包含文字方塊中，雖然`Picture`TemplateField 不包含任何範本。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-208">Presently, the `BrochurePath` TemplateField s `InsertItemTemplate` contains a TextBox, while the `Picture` TemplateField does not contain any templates.</span></span> <span data-ttu-id="0d2a4-209">我們需要更新這些兩個 TemplateField 的`InsertItemTemplate`以使用檔案上傳控制項。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-209">We need to update these two TemplateField s `InsertItemTemplate` s to use FileUpload controls.</span></span>

<span data-ttu-id="0d2a4-210">從 DetailsView s 智慧標籤，選擇 [編輯樣板] 選項，然後選取`BrochurePath`TemplateField 的`InsertItemTemplate`從下拉式清單。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-210">From the DetailsView s smart tag, choose the Edit Templates option and then select the `BrochurePath` TemplateField s `InsertItemTemplate` from the drop-down list.</span></span> <span data-ttu-id="0d2a4-211">移除文字方塊中，然後將檔案上傳控制項從 [工具箱] 拖曳至範本。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-211">Remove the TextBox and then drag a FileUpload control from the Toolbox into the template.</span></span> <span data-ttu-id="0d2a4-212">將檔案上傳控制項 s`ID`至`BrochureUpload`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-212">Set the FileUpload control s `ID` to `BrochureUpload`.</span></span> <span data-ttu-id="0d2a4-213">同樣地，將檔案上傳控制項加入`Picture`TemplateField 的`InsertItemTemplate`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-213">Similarly, add a FileUpload control to the `Picture` TemplateField s `InsertItemTemplate`.</span></span> <span data-ttu-id="0d2a4-214">設定此檔案上傳控制項 s`ID`至`PictureUpload`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-214">Set this FileUpload control s `ID` to `PictureUpload`.</span></span>


<span data-ttu-id="0d2a4-215">[![將檔案上傳控制項上加入](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-215">[![Add a FileUpload Control to the InsertItemTemplate](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image8.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image13.png)</span></span>

<span data-ttu-id="0d2a4-216">**圖 8**： 將檔案上傳控制項加入`InsertItemTemplate`([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-216">**Figure 8**: Add a FileUpload Control to the `InsertItemTemplate` ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image14.png))</span></span>


<span data-ttu-id="0d2a4-217">這些新增項目之後，請將兩個 TemplateField s 宣告式語法：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-217">After making these additions, the two TemplateField s declarative syntax will be:</span></span>


[!code-aspx[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample5.aspx)]

<span data-ttu-id="0d2a4-218">當使用者將新的類別時，我們想要確保冊及圖片檔案類型正確。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-218">When a user adds a new category, we want to ensure that the brochure and picture are of the correct file type.</span></span> <span data-ttu-id="0d2a4-219">冊，使用者必須提供 PDF。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-219">For the brochure, the user must supply a PDF.</span></span> <span data-ttu-id="0d2a4-220">圖片中，我們需要使用者上傳的映像檔，但我們允許*任何*映像檔案或僅映像檔案的特定型別，例如 Gif 或 JPGs 嗎？</span><span class="sxs-lookup"><span data-stu-id="0d2a4-220">For the picture, we need the user to upload an image file, but do we allow *any* image file or only image files of a particular type, such as GIFs or JPGs?</span></span> <span data-ttu-id="0d2a4-221">若要允許不同的檔案類型，d 我們要擴充`Categories`包含擷取的檔案類型，以便可以透過用戶端傳送此類型的資料行的結構描述`Response.ContentType`中`DisplayCategoryPicture.aspx`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-221">In order to allow for different file types, we d need to extend the `Categories` schema to include a column that captures the file type so that this type can be sent to the client through `Response.ContentType` in `DisplayCategoryPicture.aspx`.</span></span> <span data-ttu-id="0d2a4-222">因為我們不 t 有一個資料行，就必須在限制使用者僅提供特定的映像檔案類型。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-222">Since we don t have such a column, it would be prudent to restrict users to only providing a specific image file type.</span></span> <span data-ttu-id="0d2a4-223">`Categories`資料表 s 現有的映像是點陣圖，但 JPGs 更適當的檔案格式，透過 web 提供的映像。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-223">The `Categories` table s existing images are bitmaps, but JPGs are a more appropriate file format for images served over the web.</span></span>

<span data-ttu-id="0d2a4-224">如果使用者上傳不正確的檔案類型，我們需要取消插入，並顯示訊息，指出此問題。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-224">If a user uploads an incorrect file type, we need to cancel the insert and display a message indicating the problem.</span></span> <span data-ttu-id="0d2a4-225">加入標籤 Web 控制項 DetailsView 下方。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-225">Add a Label Web control beneath the DetailsView.</span></span> <span data-ttu-id="0d2a4-226">設定其`ID`屬性`UploadWarning`，清除出其`Text`屬性，將`CssClass`警告的屬性和`Visible`和`EnableViewState`屬性`false`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-226">Set its `ID` property to `UploadWarning`, clear out its `Text` property, set the `CssClass` property to Warning, and the `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="0d2a4-227">`Warning` CSS 類別定義於`Styles.css`並呈現大型、 紅色、 斜體、 粗體字型中的文字。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-227">The `Warning` CSS class is defined in `Styles.css` and renders the text in a large, red, italicized, bold font.</span></span>

> [!NOTE]
> <span data-ttu-id="0d2a4-228">在理想情況下，`CategoryName`和`Description`BoundFields 會轉換成 TemplateFields 和自訂其插入介面。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-228">Ideally, the `CategoryName` and `Description` BoundFields would be converted to TemplateFields and their inserting interfaces customized.</span></span> <span data-ttu-id="0d2a4-229">`Description`插入介面，比方說，就可能會更適合透過多行文字方塊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-229">The `Description` inserting interface, for example, would likely be better suited through a multi-line textbox.</span></span> <span data-ttu-id="0d2a4-230">由於`CategoryName`資料行不接受`NULL`值 RequiredFieldValidator 應該加入以確保使用者提供新的類別的名稱的值。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-230">And since the `CategoryName` column does not accept `NULL` values, a RequiredFieldValidator should be added to ensure the user provides a value for the new category s name.</span></span> <span data-ttu-id="0d2a4-231">這些步驟可供讀取器做為練習。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-231">These steps are left as an exercise to the reader.</span></span> <span data-ttu-id="0d2a4-232">回頭參考[自訂的資料修改介面](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md)的深入了解加強資料修改介面。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-232">Refer back to [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) for an in-depth look at augmenting the data modification interfaces.</span></span>


## <a name="step-6-saving-the-uploaded-brochure-to-the-web-server-s-file-system"></a><span data-ttu-id="0d2a4-233">步驟 6： 將上傳的冊儲存至 Web 伺服器的檔案系統</span><span class="sxs-lookup"><span data-stu-id="0d2a4-233">Step 6: Saving the Uploaded Brochure to the Web Server s File System</span></span>

<span data-ttu-id="0d2a4-234">當使用者輸入新的類別目錄的值，然後按一下 [插入] 按鈕時，就會發生回傳，而且插入工作流程可以掀起。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-234">When the user enters the values for a new category and clicks the Insert button, a postback occurs and the inserting workflow unfolds.</span></span> <span data-ttu-id="0d2a4-235">首先，DetailsView s [ `ItemInserting`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx)引發。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-235">First, the DetailsView s [`ItemInserting` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserting.aspx) fires.</span></span> <span data-ttu-id="0d2a4-236">下一步，ObjectDataSource s`Insert()`叫用方法時，結果會在新的記錄新增至`Categories`資料表。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-236">Next, the ObjectDataSource s `Insert()` method is invoked, which results in a new record being added to the `Categories` table.</span></span> <span data-ttu-id="0d2a4-237">之後，DetailsView s [ `ItemInserted`事件](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx)引發。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-237">After that, the DetailsView s [`ItemInserted` event](https://msdn.microsoft.com/library/system.web.ui.webcontrols.detailsview.iteminserted.aspx) fires.</span></span>

<span data-ttu-id="0d2a4-238">在 ObjectDataSource s 前面`Insert()`叫用方法，我們必須先確認使用者已上傳適當的檔案類型，然後將冊 PDF 儲存到 web 伺服器檔案系統。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-238">Before the ObjectDataSource s `Insert()` method is invoked, we must first ensure that the appropriate file types were uploaded by the user and then save the brochure PDF to the web server s file system.</span></span> <span data-ttu-id="0d2a4-239">建立事件處理常式 DetailsView s`ItemInserting`事件並加入下列程式碼：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-239">Create an event handler for the DetailsView s `ItemInserting` event and add the following code:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample6.cs)]

<span data-ttu-id="0d2a4-240">此事件處理常式啟動藉由參考`BrochureUpload`DetailsView 的範本的檔案上傳控制項。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-240">The event handler starts by referencing the `BrochureUpload` FileUpload control from the DetailsView s templates.</span></span> <span data-ttu-id="0d2a4-241">然後，如果已上傳冊，會檢查已上傳的 s 副檔名。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-241">Then, if a brochure has been uploaded, the uploaded file s extension is examined.</span></span> <span data-ttu-id="0d2a4-242">如果沒有延伸。PDF、 然後警告會顯示、 插入已取消，並執行的事件處理常式結束。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-242">If the extension is not .PDF, then a warning is displayed, the insert is cancelled, and the execution of the event handler ends.</span></span>

> [!NOTE]
> <span data-ttu-id="0d2a4-243">信賴憑證者上傳的 s 副檔名不是萬全技巧，確保上傳的檔案的 PDF 文件。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-243">Relying on the uploaded file s extension is not a sure-fire technique for ensuring that the uploaded file is a PDF document.</span></span> <span data-ttu-id="0d2a4-244">使用者可能會有有效的 PDF 文件副檔名`.Brochure`，或無法擁有採用非 PDF 文件，並提供`.pdf`延伸模組。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-244">The user could have a valid PDF document with the extension `.Brochure`, or could have taken a non-PDF document and given it a `.pdf` extension.</span></span> <span data-ttu-id="0d2a4-245">若要更明確地驗證檔案類型必須以程式設計方式檢查需要檔案 s 二進位內容。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-245">The file s binary content would need to be programmatically examined in order to more conclusively verify the file type.</span></span> <span data-ttu-id="0d2a4-246">這類徹底的方法，不過，通常是大材小用;檢查擴充功能就足以應付大部分的狀況。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-246">Such thorough approaches, though, are often overkill; checking the extension is sufficient for most scenarios.</span></span>


<span data-ttu-id="0d2a4-247">中所述[上傳檔案](uploading-files-cs.md)教學課程，必須小心儲存檔案至檔案系統，讓一位使用者的傳不會覆寫另一個 s 時。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-247">As discussed in the [Uploading Files](uploading-files-cs.md) tutorial, care must be taken when saving files to the file system so that one user s upload does not overwrite another s.</span></span> <span data-ttu-id="0d2a4-248">此教學課程中，我們會嘗試上傳的檔案使用相同的名稱。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-248">For this tutorial we will attempt to use the same name as the uploaded file.</span></span> <span data-ttu-id="0d2a4-249">如果已經存在的檔案中`~/Brochures`目錄與該相同檔名，不過，我們將附加的數字結尾，直到找到唯一的名稱。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-249">If there already exists a file in the `~/Brochures` directory with that same file name, however, we'll append a number at the end until a unique name is found.</span></span> <span data-ttu-id="0d2a4-250">例如，如果使用者將名為冊檔案上傳`Meats.pdf`，但已經有名稱為的檔案`Meats.pdf`中`~/Brochures`資料夾中，我們將會變更已儲存的檔案名稱以`Meats-1.pdf`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-250">For example, if the user uploads a brochure file named `Meats.pdf`, but there is already a file named `Meats.pdf` in the `~/Brochures` folder, we'll change the saved file name to `Meats-1.pdf`.</span></span> <span data-ttu-id="0d2a4-251">如果已存在，我們將嘗試`Meats-2.pdf`，依此類推，直到找到唯一的檔案名稱。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-251">If that exists, we'll try `Meats-2.pdf`, and so on, until a unique file name is found.</span></span>

<span data-ttu-id="0d2a4-252">下列程式碼會使用[`File.Exists(path)`方法](https://msdn.microsoft.com/library/system.io.file.exists.aspx)來判斷檔案是否已存在具有指定的檔案名稱。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-252">The following code uses the [`File.Exists(path)` method](https://msdn.microsoft.com/library/system.io.file.exists.aspx) to determine if a file already exists with the specified file name.</span></span> <span data-ttu-id="0d2a4-253">如果是的話，它會繼續嘗試冊新檔案名稱，直到找到沒有衝突。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-253">If so, it continues to try new file names for the brochure until no conflict is found.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample7.cs)]

<span data-ttu-id="0d2a4-254">一旦找到有效的檔名，檔案必須儲存到檔案系統和 ObjectDataSource 的`brochurePath``InsertParameter`值需要更新，讓此檔案名稱寫入資料庫。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-254">Once a valid file name has been found, the file needs to be saved to the file system and the ObjectDataSource s `brochurePath``InsertParameter` value needs to be updated so that this file name is written to the database.</span></span> <span data-ttu-id="0d2a4-255">如我們所見回*上傳檔案*教學課程中，可以儲存檔案使用的檔案上傳控制項的`SaveAs(path)`方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-255">As we saw back in the *Uploading Files* tutorial, the file can be saved using the FileUpload control s `SaveAs(path)` method.</span></span> <span data-ttu-id="0d2a4-256">若要更新 ObjectDataSource s`brochurePath`參數，使用`e.Values`集合。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-256">To update the ObjectDataSource s `brochurePath` parameter, use the `e.Values` collection.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample8.cs)]

## <a name="step-7-saving-the-uploaded-picture-to-the-database"></a><span data-ttu-id="0d2a4-257">步驟 7： 將上傳的圖片儲存到資料庫</span><span class="sxs-lookup"><span data-stu-id="0d2a4-257">Step 7: Saving the Uploaded Picture to the Database</span></span>

<span data-ttu-id="0d2a4-258">若要上傳的圖片儲存在新`Categories`記錄，我們需要上傳的二進位內容指派至 ObjectDataSource s `picture` DetailsView s 中的參數`ItemInserting`事件。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-258">To store the uploaded picture in the new `Categories` record, we need to assign the uploaded binary content to the ObjectDataSource s `picture` parameter in the DetailsView s `ItemInserting` event.</span></span> <span data-ttu-id="0d2a4-259">不過，我們進行此作業之前，我們需要先確定已上傳的圖片是 JPG 和不一些其他的影像類型。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-259">Before we make this assignment, however, we need to first make sure that the uploaded picture is a JPG and not some other image type.</span></span> <span data-ttu-id="0d2a4-260">如同步驟 6 中，可讓 s 使用上載的圖片的副檔名來確定其型別。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-260">As in Step 6, let s use the uploaded picture s file extension to ascertain its type.</span></span>

<span data-ttu-id="0d2a4-261">雖然`Categories`資料表允許`NULL`值`Picture`資料行，所有分類目前有一張圖片。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-261">While the `Categories` table allows `NULL` values for the `Picture` column, all categories currently have a picture.</span></span> <span data-ttu-id="0d2a4-262">可讓 s 會強制要求使用者提供圖片，加入新的類別，透過此頁面時。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-262">Let s force the user to provide a picture when adding a new category through this page.</span></span> <span data-ttu-id="0d2a4-263">下列程式碼會檢查以確保已上傳的圖片，而且它有適當的副檔名。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-263">The following code checks to ensure that a picture has been uploaded and that it has an appropriate extension.</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample9.cs)]

<span data-ttu-id="0d2a4-264">這個程式碼應該放置*之前*步驟 6 中的程式碼，以便冊檔案儲存至檔案系統之前，如果沒有在圖片上傳的問題，將會終止事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-264">This code should be placed *before* the code from Step 6 so that if there is a problem with the picture upload, the event handler will terminate before the brochure file is saved to the file system.</span></span>

<span data-ttu-id="0d2a4-265">假設已上傳適當的檔案，請將上傳的二進位內容指派給圖片參數 s 的值與下列程式碼行：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-265">Assuming that an appropriate file has been uploaded, assign the uploaded binary content to the picture parameter s value with the following line of code:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample10.cs)]

## <a name="the-completeiteminsertingevent-handler"></a><span data-ttu-id="0d2a4-266">完整`ItemInserting`事件處理常式</span><span class="sxs-lookup"><span data-stu-id="0d2a4-266">The Complete`ItemInserting`Event Handler</span></span>

<span data-ttu-id="0d2a4-267">為求完整起見，以下是`ItemInserting`完整的事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-267">For completeness, here is the `ItemInserting` event handler in its entirety:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample11.cs)]

## <a name="step-8-fixing-thedisplaycategorypictureaspxpage"></a><span data-ttu-id="0d2a4-268">步驟 8： 修正`DisplayCategoryPicture.aspx`頁面</span><span class="sxs-lookup"><span data-stu-id="0d2a4-268">Step 8: Fixing the`DisplayCategoryPicture.aspx`Page</span></span>

<span data-ttu-id="0d2a4-269">可讓 s 花點時間測試插入介面和`ItemInserting`幾個步驟在最後所建立的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-269">Let s take a moment to test out the inserting interface and `ItemInserting` event handler that was created over the last few steps.</span></span> <span data-ttu-id="0d2a4-270">請瀏覽`UploadInDetailsView.aspx`頁面上透過瀏覽器，並嘗試新增的類別，但省略圖片，或指定非 JPG 圖片或非 PDF 冊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-270">Visit the `UploadInDetailsView.aspx` page through a browser and attempt to add a category, but omit the picture, or specify a non-JPG picture or a non-PDF brochure.</span></span> <span data-ttu-id="0d2a4-271">任何這些情況下，將會顯示錯誤訊息，並取消插入工作流程。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-271">In any of these cases, an error message will be displayed and the insert workflow cancelled.</span></span>


<span data-ttu-id="0d2a4-272">[![警告訊息時，顯示無效的檔案類型已上傳](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-272">[![A Warning Message is Displayed If an Invalid File Type is Uploaded](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image9.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image15.png)</span></span>

<span data-ttu-id="0d2a4-273">**圖 9**: 警告訊息時，顯示無效的檔案類型已上傳 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-273">**Figure 9**: A Warning Message is Displayed If an Invalid File Type is Uploaded ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image16.png))</span></span>


<span data-ttu-id="0d2a4-274">一旦您已確認頁面需要上載圖片和獲利的 t 接受非 PDF 或非 JPG 檔案，加入新的類別，以有效的 JPG 圖片，將冊欄位保留空白。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-274">Once you have verified that the page requires a picture to be uploaded and won t accept non-PDF or non-JPG files, add a new category with a valid JPG picture, leaving the Brochure field empty.</span></span> <span data-ttu-id="0d2a4-275">頁面會回傳之後按一下 [插入] 按鈕，並將新的記錄將會加入至`Categories`直接儲存在資料庫上傳映像 s 二進位內容的資料表。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-275">After clicking the Insert button, the page will postback and a new record will be added to the `Categories` table with the uploaded image s binary contents stored directly in the database.</span></span> <span data-ttu-id="0d2a4-276">GridView 會更新，而且會顯示一個資料列的新加入的分類中，不過，如圖 10 所示，新的類別目錄的圖片就無法正確呈現。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-276">The GridView is updated and shows a row for the newly added category, but, as Figure 10 shows, the new category s picture is not rendered correctly.</span></span>


<span data-ttu-id="0d2a4-277">[![新的類別不會顯示圖片的 s](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-277">[![The New Category s Picture is not Displayed](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image10.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image17.png)</span></span>

<span data-ttu-id="0d2a4-278">**圖 10**： 圖片不會顯示新的分類 s ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-278">**Figure 10**: The New Category s Picture is not Displayed ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image18.png))</span></span>


<span data-ttu-id="0d2a4-279">新的圖片不會顯示的原因是因為`DisplayCategoryPicture.aspx`傳回指定之分類的圖片的網頁設定成可以處理 OLE 標頭的點陣圖。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-279">The reason the new picture is not displayed is because the `DisplayCategoryPicture.aspx` page that returns a specified category s picture is configured to process bitmaps that have an OLE header.</span></span> <span data-ttu-id="0d2a4-280">此 78 位元組的標頭移除`Picture`再進行傳送，則資料行 s 二進位內容傳回至用戶端。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-280">This 78 byte header is stripped from the `Picture` column s binary contents before they are sent back to the client.</span></span> <span data-ttu-id="0d2a4-281">但沒有此 OLE 標頭; JPG 檔案我們剛剛上傳新的類別目錄。因此，有效，需位元組正在移除從影像 s 二進位資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-281">But the JPG file we just uploaded for the new category does not have this OLE header; therefore, valid, necessary bytes are being removed from the image s binary data.</span></span>

<span data-ttu-id="0d2a4-282">因為現在有兩個點陣圖中的 JPGs OLE 標頭與`Categories`資料表中，我們需要更新`DisplayCategoryPicture.aspx`使它不會刪除原始的八個類別目錄的 OLE 標頭和略過較新的類別記錄此條狀配置。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-282">Since there are now both bitmaps with OLE headers and JPGs in the `Categories` table, we need to update `DisplayCategoryPicture.aspx` so that it does the OLE header stripping for the original eight categories and bypasses this stripping for the newer category records.</span></span> <span data-ttu-id="0d2a4-283">在我們的下一個教學課程中，我們將檢驗如何更新現有的記錄 s 映像，並使它們 JPGs 我們會將更新的所有舊的分類圖片。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-283">In our next tutorial we'll examine how to update an existing record s image, and we'll update all of the old category pictures so that they are JPGs.</span></span> <span data-ttu-id="0d2a4-284">現在，不過，使用中的下列程式碼`DisplayCategoryPicture.aspx`去除 OLE 標頭，僅針對那些原始的八個類別：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-284">For now, though, use the following code in `DisplayCategoryPicture.aspx` to strip the OLE headers only for those original eight categories:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample12.cs)]

<span data-ttu-id="0d2a4-285">這項變更，使用 JPG 影像是現在正確呈現在 GridView。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-285">With this change, the JPG image is now rendered correctly in the GridView.</span></span>


<span data-ttu-id="0d2a4-286">[![新的類別目錄的 JPG 影像會正確轉譯](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-286">[![The JPG Images for New Categories are Correctly Rendered](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image11.gif)](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image19.png)</span></span>

<span data-ttu-id="0d2a4-287">**圖 11**： 新的類別目錄的 JPG 影像會正確轉譯 ([按一下以檢視完整大小的影像](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="0d2a4-287">**Figure 11**: The JPG Images for New Categories are Correctly Rendered ([Click to view full-size image](including-a-file-upload-option-when-adding-a-new-record-cs/_static/image20.png))</span></span>


## <a name="step-9-deleting-the-brochure-in-the-face-of-an-exception"></a><span data-ttu-id="0d2a4-288">步驟 9： 刪除冊遇到例外狀況時</span><span class="sxs-lookup"><span data-stu-id="0d2a4-288">Step 9: Deleting the Brochure in the Face of an Exception</span></span>

<span data-ttu-id="0d2a4-289">二進位資料儲存在 web 伺服器的檔案系統上的挑戰之一就是會導致中斷連接資料模型和二進位資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-289">One of the challenges of storing binary data on the web server s file system is that it introduces a disconnect between the data model and its binary data.</span></span> <span data-ttu-id="0d2a4-290">因此，每當刪除記錄時，對應的二進位資料，在檔案系統上也必須移除。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-290">Therefore, whenever a record is deleted, the corresponding binary data on the file system must also be removed.</span></span> <span data-ttu-id="0d2a4-291">插入時，也可以來自加入遊戲。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-291">This can come into play when inserting, as well.</span></span> <span data-ttu-id="0d2a4-292">請考慮下列狀況： 使用者加入新的類別，指定有效的圖片和冊。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-292">Consider the following scenario: a user adds a new category, specifying a valid picture and brochure.</span></span> <span data-ttu-id="0d2a4-293">按一下 [插入] 按鈕，就會發生回傳和 DetailsView 的`ItemInserting`事件引發，冊儲存至 web 伺服器檔案系統。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-293">Upon clicking the Insert button, a postback occurs and the DetailsView s `ItemInserting` event fires, saving the brochure to the web server s file system.</span></span> <span data-ttu-id="0d2a4-294">下一步，ObjectDataSource s`Insert()`叫用方法時，呼叫`CategoriesBLL`類別 s`InsertWithPicture`方法，這個方法會呼叫`CategoriesTableAdapter`s`InsertWithPicture`方法。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-294">Next, the ObjectDataSource s `Insert()` method is invoked, which calls the `CategoriesBLL` class s `InsertWithPicture` method, which calls the `CategoriesTableAdapter` s `InsertWithPicture` method.</span></span>

<span data-ttu-id="0d2a4-295">現在，如果資料庫離線，會發生什麼事或是否有錯誤`INSERT`SQL 陳述式？</span><span class="sxs-lookup"><span data-stu-id="0d2a4-295">Now, what happens if the database is offline, or if there is an error in the `INSERT` SQL statement?</span></span> <span data-ttu-id="0d2a4-296">清楚地插入將會失敗，因此沒有新的類別目錄資料列會加入至資料庫。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-296">Clearly the INSERT will fail, so no new category row will be added to the database.</span></span> <span data-ttu-id="0d2a4-297">但我們仍具有上傳的冊檔案位在 web 伺服器的檔案系統 ！</span><span class="sxs-lookup"><span data-stu-id="0d2a4-297">But we still have the uploaded brochure file sitting on the web server s file system!</span></span> <span data-ttu-id="0d2a4-298">這個檔案必須先刪除遇到期間插入工作流程的例外狀況時。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-298">This file needs to be deleted in the face of an exception during the inserting workflow.</span></span>

<span data-ttu-id="0d2a4-299">如先前所討論在[處理 BLL-以及 DAL 層級例外狀況，在 ASP.NET 網頁](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md)教學課程中，於擲回例外狀況從內各層透過昇的架構的深度。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-299">As discussed previously in the [Handling BLL- and DAL-Level Exceptions in an ASP.NET Page](../editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs.md) tutorial, when an exception is thrown from within the depths of the architecture it is bubbled up through the various layers.</span></span> <span data-ttu-id="0d2a4-300">在展示層中，我們可以判斷是否發生了例外狀況從 DetailsView 的`ItemInserted`事件。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-300">At the Presentation Layer, we can determine if an exception has occurred from the DetailsView s `ItemInserted` event.</span></span> <span data-ttu-id="0d2a4-301">這個事件處理常式也會提供值的 ObjectDataSource 的`InsertParameters`。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-301">This event handler also provides the values of the ObjectDataSource s `InsertParameters`.</span></span> <span data-ttu-id="0d2a4-302">因此，我們可以建立事件處理常式`ItemInserted`如果時發生例外狀況，如果是的話，會檢查的事件刪除 ObjectDataSource s 所指定的檔案`brochurePath`參數：</span><span class="sxs-lookup"><span data-stu-id="0d2a4-302">Therefore, we can create an event handler for the `ItemInserted` event that checks if there was an exception and, if so, deletes the file specified by the ObjectDataSource s `brochurePath` parameter:</span></span>


[!code-csharp[Main](including-a-file-upload-option-when-adding-a-new-record-cs/samples/sample13.cs)]

## <a name="summary"></a><span data-ttu-id="0d2a4-303">總結</span><span class="sxs-lookup"><span data-stu-id="0d2a4-303">Summary</span></span>

<span data-ttu-id="0d2a4-304">有幾個步驟，您必須執行才能提供的 web 型介面，來加入包含二進位資料的記錄。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-304">There are a number of steps that must be performed in order to provide a web-based interface for adding records that include binary data.</span></span> <span data-ttu-id="0d2a4-305">如果直接將資料庫儲存二進位資料時，有可能是您要更新之架構、 加入特定的方法，以處理二進位資料會被插入的情況。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-305">If the binary data is being stored directly into the database, chances are you'll need to update the architecture, adding specific methods to handle the case where binary data is being inserted.</span></span> <span data-ttu-id="0d2a4-306">一旦架構已更新下, 一個步驟建立插入介面，可以使用已自訂為包含二進位資料的每個欄位的檔案上傳控制項的 DetailsView 來完成。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-306">Once the architecture has been updated, the next step is creating the inserting interface, which can be accomplished using a DetailsView that has been customized to include a FileUpload control for each binary data field.</span></span> <span data-ttu-id="0d2a4-307">上傳的資料可以再儲存到 web 伺服器檔案系統或指派給 DetailsView s 中的資料來源參數`ItemInserting`事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-307">The uploaded data can then be saved to the web server s file system or assigned to a data source parameter in the DetailsView s `ItemInserting` event handler.</span></span>

<span data-ttu-id="0d2a4-308">將二進位資料儲存至檔案系統需要詳細規劃比直接在資料庫中儲存資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-308">Saving binary data to the file system requires more planning than saving data directly into the database.</span></span> <span data-ttu-id="0d2a4-309">為了避免覆寫另一個 s 的一個使用者的上載，您必須選擇的命名配置。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-309">A naming scheme must be chosen in order to avoid one user s upload overwriting another s.</span></span> <span data-ttu-id="0d2a4-310">此外，必須採取額外的步驟來刪除上傳的檔案，如果資料庫插入會失敗。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-310">Also, extra steps must be taken to delete the uploaded file if the database insert fails.</span></span>

<span data-ttu-id="0d2a4-311">我們現在有了可將新的分類加入至具有冊和圖片，但我們系統 ve 尚未以查看如何更新現有的類別目錄 s 二進位資料或如何正確地移除已刪除類別目錄的二進位資料。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-311">We now have the ability to add new categories to the system with a brochure and picture, but we ve yet to look at how to update an existing category s binary data or how to correctly remove the binary data for a deleted category.</span></span> <span data-ttu-id="0d2a4-312">在下一個教學課程中，我們將探討以下兩個主題。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-312">We'll explore these two topics in the next tutorial.</span></span>

<span data-ttu-id="0d2a4-313">祝您程式設計 ！</span><span class="sxs-lookup"><span data-stu-id="0d2a4-313">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="0d2a4-314">關於作者</span><span class="sxs-lookup"><span data-stu-id="0d2a4-314">About the Author</span></span>

<span data-ttu-id="0d2a4-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七個 ASP/ASP.NET 書籍和的創辦[4GuysFromRolla.com](http://www.4guysfromrolla.com)，已從 1998 年使用 Microsoft Web 技術。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-315">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="0d2a4-316">Scott 可做為獨立顧問、 訓練和寫入器。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-316">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="0d2a4-317">他最新的活頁簿[ *Sam 教導您自己 ASP.NET 2.0 24 小時內*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-317">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="0d2a4-318">他可以在達到[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)或透過他的部落格，這可以在找到[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-318">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com) or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="0d2a4-319">特別感謝</span><span class="sxs-lookup"><span data-stu-id="0d2a4-319">Special Thanks To</span></span>

<span data-ttu-id="0d2a4-320">許多有用的檢閱者已檢閱本教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-320">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="0d2a4-321">此教學課程中的前導檢閱者已 Dave Gardner、 本文菲和 Bernadette Leigh。</span><span class="sxs-lookup"><span data-stu-id="0d2a4-321">Lead reviewers for this tutorial were Dave Gardner, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="0d2a4-322">檢閱我即將推出的 MSDN 文件有興趣嗎？</span><span class="sxs-lookup"><span data-stu-id="0d2a4-322">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="0d2a4-323">如果是這樣，卸除我一行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-323">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="0d2a4-324">[上一頁](displaying-binary-data-in-the-data-web-controls-cs.md)
> [下一頁](updating-and-deleting-existing-binary-data-cs.md)</span><span class="sxs-lookup"><span data-stu-id="0d2a4-324">[Previous](displaying-binary-data-in-the-data-web-controls-cs.md)
[Next](updating-and-deleting-existing-binary-data-cs.md)</span></span>
