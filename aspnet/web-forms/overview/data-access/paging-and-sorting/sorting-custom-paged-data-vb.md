---
uid: web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-vb
title: 排序自訂的分頁資料 (VB) |Microsoft Docs
author: rick-anderson
description: 在上一個教學課程中我們已了解如何實作自訂分頁時 presentating 網頁上的資料。 在本教學課程中，我們了解如何擴充先前的內容...
ms.author: aspnetcontent
ms.date: 08/15/2006
ms.assetid: 4823a186-caaf-4116-a318-c7ff4d955ddc
msc.legacyurl: /web-forms/overview/data-access/paging-and-sorting/sorting-custom-paged-data-vb
msc.type: authoredcontent
ms.openlocfilehash: 7a660f697676e20d8987af150b10fc6694ce7c57
ms.sourcegitcommit: b28cd0313af316c051c2ff8549865bff67f2fbb4
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/05/2018
ms.locfileid: "37805310"
---
<a name="sorting-custom-paged-data-vb"></a><span data-ttu-id="bf6e8-104">排序自訂的分頁資料 (VB)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-104">Sorting Custom Paged Data (VB)</span></span>
====================
<span data-ttu-id="bf6e8-105">藉由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="bf6e8-106">[下載範例應用程式](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_VB.exe)或[下載 PDF](sorting-custom-paged-data-vb/_static/datatutorial26vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-106">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_26_VB.exe) or [Download PDF](sorting-custom-paged-data-vb/_static/datatutorial26vb1.pdf)</span></span>

> <span data-ttu-id="bf6e8-107">在上一個教學課程中我們已了解如何實作自訂分頁時 presentating 網頁上的資料。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-107">In the previous tutorial we learned how to implement custom paging when presentating data on a web page.</span></span> <span data-ttu-id="bf6e8-108">在本教學課程中，我們看到如何擴充以包含針對排序自訂的分頁支援上述的範例。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-108">In this tutorial we see how to extend the preceding example to include support for sorting custom paging.</span></span>


## <a name="introduction"></a><span data-ttu-id="bf6e8-109">簡介</span><span class="sxs-lookup"><span data-stu-id="bf6e8-109">Introduction</span></span>

<span data-ttu-id="bf6e8-110">相較於預設分頁時，自訂分頁的差距，讓自訂分頁時進行大量的資料分頁的既定的分頁實作選擇可以改善效能的資料進行分頁。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-110">Compared to default paging, custom paging can improve the performance of paging through data by several orders of magnitude, making custom paging the de facto paging implementation choice when paging through large amounts of data.</span></span> <span data-ttu-id="bf6e8-111">實作自訂的分頁是比實作預設的分頁，不過，尤其是當加入至混合排序更複雜。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-111">Implementing custom paging is more involved than implementing default paging, however, especially when adding sorting to the mix.</span></span> <span data-ttu-id="bf6e8-112">在本教學課程中，我們會擴大納入支援排序的前一個範例*和*自訂分頁。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-112">In this tutorial we'll extend the example from the preceding one to include support for sorting *and* custom paging.</span></span>

> [!NOTE]
> <span data-ttu-id="bf6e8-113">因為本教學課程是在前一個，才能開始花一點時間複製內的宣告式語法`<asp:Content>`從先前的教學課程的網頁上的項目 (`EfficientPaging.aspx`) 並貼上它之間`<asp:Content>`中的項目`SortParameter.aspx`  頁面。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-113">Since this tutorial builds upon the preceding one, before beginning take a moment to copy the declarative syntax within the `<asp:Content>` element from the preceding tutorial s web page (`EfficientPaging.aspx`) and paste it between the `<asp:Content>` element in the `SortParameter.aspx` page.</span></span> <span data-ttu-id="bf6e8-114">回頭參考步驟 1[將驗證控制項加入編輯和插入介面](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md)教學課程的上一個 ASP.NET 網頁的功能複寫至另一個的更詳細討論。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-114">Refer back to Step 1 of the [Adding Validation Controls to the Editing and Inserting Interfaces](../editing-inserting-and-deleting-data/adding-validation-controls-to-the-editing-and-inserting-interfaces-vb.md) tutorial for a more detailed discussion on replicating the functionality of one ASP.NET page to another.</span></span>


## <a name="step-1-reexamining-the-custom-paging-technique"></a><span data-ttu-id="bf6e8-115">步驟 1： 再次檢驗自訂分頁技術</span><span class="sxs-lookup"><span data-stu-id="bf6e8-115">Step 1: Reexamining the Custom Paging Technique</span></span>

<span data-ttu-id="bf6e8-116">自訂分頁時才能正常運作，我們必須實作一種技術，可以有效率地擷取記錄參數的開始資料列索引和最大資料列的特定子集。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-116">For custom paging to work properly, we must implement some technique that can efficiently grab a particular subset of records given the Start Row Index and Maximum Rows parameters.</span></span> <span data-ttu-id="bf6e8-117">有少數幾個可用來達到這個目的的技術。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-117">There are a handful of techniques that can be used to achieve this aim.</span></span> <span data-ttu-id="bf6e8-118">在先前教學課程中我們探討了完成這項作業使用新的 Microsoft SQL Server 2005 的`ROW_NUMBER()`排名函式。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-118">In the preceding tutorial we looked at accomplishing this using Microsoft SQL Server 2005 s new `ROW_NUMBER()` ranking function.</span></span> <span data-ttu-id="bf6e8-119">簡單地說，`ROW_NUMBER()`排名函式會將指派給所指定的排序順序第一個查詢所傳回的每個資料列的資料列數目。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-119">In short, the `ROW_NUMBER()` ranking function assigns a row number to each row returned by a query that is ranked by a specified sort order.</span></span> <span data-ttu-id="bf6e8-120">記錄的適當子集則會取得藉由傳回編號結果中的特定區段中。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-120">The appropriate subset of records is then obtained by returning a particular section of the numbered results.</span></span> <span data-ttu-id="bf6e8-121">下列查詢說明如何使用此技巧來傳回編號 11 到 20 時排名結果依字母順序排序的產品`ProductName`:</span><span class="sxs-lookup"><span data-stu-id="bf6e8-121">The following query illustrates how to use this technique to return those products numbered 11 through 20 when ranking the results ordered alphabetically by the `ProductName`:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample1.sql)]

<span data-ttu-id="bf6e8-122">此技術適用於使用特定的排序次序的分頁 (`ProductName`依字母順序排序，在此情況下)，但是查詢必須修改，以顯示依不同的排序運算式排序的結果。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-122">This technique works well for paging using a specific sort order (`ProductName` sorted alphabetically, in this case), but the query needs to be modified to show the results sorted by a different sort expression.</span></span> <span data-ttu-id="bf6e8-123">在理想情況下，上述的查詢無法加以改寫才能使用中的參數`OVER`子句，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-123">Ideally, the above query could be rewritten to use a parameter in the `OVER` clause, like so:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample2.sql)]

<span data-ttu-id="bf6e8-124">不幸的是，參數化`ORDER BY`子句不允許。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-124">Unfortunately, parameterized `ORDER BY` clauses are not allowed.</span></span> <span data-ttu-id="bf6e8-125">相反地，我們必須建立可接受的預存程序`@sortExpression`輸入的參數，但使用一項因應措施：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-125">Instead, we must create a stored procedure that accepts a `@sortExpression` input parameter, but uses one of the following workarounds:</span></span>

- <span data-ttu-id="bf6e8-126">撰寫每個可能使用; 的排序運算式的硬式編碼查詢然後，使用`IF/ELSE`T-SQL 陳述式來判斷要執行的查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-126">Write hard-coded queries for each of the sort expressions that may be used; then, use `IF/ELSE` T-SQL statements to determine which query to execute.</span></span>
- <span data-ttu-id="bf6e8-127">使用`CASE`陳述式來提供動態`ORDER BY`運算式根據`@sortExpressio`n 輸入參數，請參閱用來動態排序查詢結果中的一節[的 SQL Power`CASE`陳述式](http://www.4guysfromrolla.com/webtech/102704-1.shtml)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-127">Use a `CASE` statement to provide dynamic `ORDER BY` expressions based on the `@sortExpressio` n input parameter; see the Used to Dynamically Sort Query Results section in [The Power of SQL `CASE` Statements](http://www.4guysfromrolla.com/webtech/102704-1.shtml) for more information.</span></span>
- <span data-ttu-id="bf6e8-128">製作適當的查詢，為預存程序中的字串，然後使用[`sp_executesql`系統預存程序](https://msdn.microsoft.com/library/ms188001.aspx)執行動態查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-128">Craft the appropriate query as a string in the stored procedure and then use [the `sp_executesql` system stored procedure](https://msdn.microsoft.com/library/ms188001.aspx) to execute the dynamic query.</span></span>

<span data-ttu-id="bf6e8-129">每個這些因應措施有一些缺點。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-129">Each of these workarounds has some drawbacks.</span></span> <span data-ttu-id="bf6e8-130">第一個選項不是預期的容易維護與其他兩個因為它需要您建立每個可能的排序運算式的查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-130">The first option is not as maintainable as the other two as it requires that you create a query for each possible sort expression.</span></span> <span data-ttu-id="bf6e8-131">因此，如果您稍後決定將新的、 可排序的欄位加入至 GridView 也會需要返回並更新預存程序。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-131">Therefore, if later you decide to add new, sortable fields to the GridView you will also need to go back and update the stored procedure.</span></span> <span data-ttu-id="bf6e8-132">第二種方法有一些微妙之處引進效能考量，對非字串的資料庫資料行排序時，也有相同的可維護性問題，與第一個。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-132">The second approach has some subtleties that introduce performance concerns when sorting by non-string database columns and also suffers from the same maintainability issues as the first.</span></span> <span data-ttu-id="bf6e8-133">如果攻擊者能夠執行傳入輸入的參數值，他們所選擇的預存程序的第三個選擇，會使用動態 SQL，引進了 SQL 資料隱碼攻擊的風險。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-133">And the third choice, which uses dynamic SQL, introduces the risk for a SQL injection attack if an attacker is able to execute the stored procedure passing in the input parameter values of their choosing.</span></span>

<span data-ttu-id="bf6e8-134">雖然沒有任何一種方式很完美，我認為第三個選項最適合的三個。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-134">While none of these approaches is perfect, I think the third option is the best of the three.</span></span> <span data-ttu-id="bf6e8-135">其使用動態 SQL 中，它會提供某種程度的彈性，其他兩個不這麼做。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-135">With its use of dynamic SQL, it offers a level of flexibility the other two do not.</span></span> <span data-ttu-id="bf6e8-136">此外，如果攻擊者能夠執行預存程序在自己選擇的輸入參數中傳遞，可以只利用 SQL 資料隱碼攻擊。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-136">Furthermore, a SQL injection attack can only be exploited if an attacker is able to execute the stored procedure passing in the input parameters of his choice.</span></span> <span data-ttu-id="bf6e8-137">由於 DAL 會使用參數化的查詢，ADO.NET 會保護到架構中，資料庫會傳送這些參數表示，SQL 資料隱碼攻擊的弱點可能會只存在於如果攻擊者可以直接執行預存程序。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-137">Since the DAL uses parameterized queries, ADO.NET will protect those parameters that are sent to the database through the architecture, meaning that the SQL injection attack vulnerability only exists if the attacker can directly execute the stored procedure.</span></span>

<span data-ttu-id="bf6e8-138">若要實作這項功能，，請在名為 Northwind 資料庫中建立新的預存程序`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-138">To implement this functionality, create a new stored procedure in the Northwind database named `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="bf6e8-139">這個預存程序應該接受三個輸入參數： `@sortExpression`，輸入的參數的型別`nvarchar(100`)，指定如何應該排序結果，並直接在之後插入`ORDER BY`中的文字`OVER`子句; 以及`@startRowIndex`並`@maximumRows`，從相同的兩個整數輸入的參數`GetProductsPaged`預存程序檢查在先前的教學課程。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-139">This stored procedure should accept three input parameters: `@sortExpression`, an input parameter of type `nvarchar(100`) that specifies how the results should be sorted and is injected directly after the `ORDER BY` text in the `OVER` clause; and `@startRowIndex` and `@maximumRows`, the same two integer input parameters from the `GetProductsPaged` stored procedure examined in the preceding tutorial.</span></span> <span data-ttu-id="bf6e8-140">建立`GetProductsPagedAndSorted`預存程序使用下列指令碼：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-140">Create the `GetProductsPagedAndSorted` stored procedure using the following script:</span></span>


[!code-sql[Main](sorting-custom-paged-data-vb/samples/sample3.sql)]

<span data-ttu-id="bf6e8-141">預存程序一開始透過確保值`@sortExpression`已指定參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-141">The stored procedure starts by ensuring that a value for the `@sortExpression` parameter has been specified.</span></span> <span data-ttu-id="bf6e8-142">如果遺失，結果會依排名`ProductID`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-142">If it is missing, the results are ranked by `ProductID`.</span></span> <span data-ttu-id="bf6e8-143">接下來，會建構動態 SQL 查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-143">Next, the dynamic SQL query is constructed.</span></span> <span data-ttu-id="bf6e8-144">請注意與動態 SQL 查詢稍有不同我們先前的查詢，用來從 Products 資料表中擷取所有資料列。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-144">Note that the dynamic SQL query here differs slightly from our previous queries used to retrieve all rows from the Products table.</span></span> <span data-ttu-id="bf6e8-145">在先前的範例，我們取得每個產品 s 相關聯的分類和供應商的名稱使用子查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-145">In prior examples, we obtained each product s associated category s and supplier s names using a subquery.</span></span> <span data-ttu-id="bf6e8-146">回到才做出此決定[建立資料存取層](../introduction/creating-a-data-access-layer-vb.md)教學課程中，而不使用已完成`JOIN`s 因為 TableAdapter 無法自動建立關聯的插入、 更新和刪除這類方法執行查詢。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-146">This decision was made back in the [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) tutorial and was done in lieu of using `JOIN` s because the TableAdapter cannot automatically create the associated insert, update, and delete methods for such queries.</span></span> <span data-ttu-id="bf6e8-147">`GetProductsPagedAndSorted`預存程序，不過，必須使用`JOIN`s 依照分類或供應商的名稱來排序結果。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-147">The `GetProductsPagedAndSorted` stored procedure, however, must use `JOIN` s for the results to be ordered by the category or supplier names.</span></span>

<span data-ttu-id="bf6e8-148">此動態查詢打造藉由串連的靜態查詢部分並`@sortExpression`， `@startRowIndex`，和`@maximumRows`參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-148">This dynamic query is built up by concatenating the static query portions and the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="bf6e8-149">由於`@startRowIndex`和`@maximumRows`整數參數，它們必須先轉換成 nvarchars 才能正確地串連。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-149">Since `@startRowIndex` and `@maximumRows` are integer parameters, they must be converted into nvarchars in order to be correctly concatenated.</span></span> <span data-ttu-id="bf6e8-150">一旦已建構此動態 SQL 查詢，它在透過執行`sp_executesql`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-150">Once this dynamic SQL query has been constructed, it is executed via `sp_executesql`.</span></span>

<span data-ttu-id="bf6e8-151">請花一點時間來測試使用不同的值，如這個預存程序`@sortExpression`， `@startRowIndex`，和`@maximumRows`參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-151">Take a moment to test this stored procedure with different values for the `@sortExpression`, `@startRowIndex`, and `@maximumRows` parameters.</span></span> <span data-ttu-id="bf6e8-152">從 伺服器總管 中，以滑鼠右鍵按一下預存程序名稱，然後選擇 執行。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-152">From the Server Explorer, right-click on the stored procedure name and choose Execute.</span></span> <span data-ttu-id="bf6e8-153">這會顯示 執行預存程序 對話方塊中，您可以在其中輸入 （請參閱 圖 1） 的輸入的參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-153">This will bring up the Run Stored Procedure dialog box into which you can enter the input parameters (see Figure 1).</span></span> <span data-ttu-id="bf6e8-154">若要依類別目錄排序結果，使用 類別名稱的`@sortExpression`參數的值; 依供應商的公司名稱排序，請使用公司名稱。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-154">To sort the results by the category name, use CategoryName for the `@sortExpression` parameter value; to sort by the supplier s company name, use CompanyName.</span></span> <span data-ttu-id="bf6e8-155">提供的參數值之後, 按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-155">After providing the parameters values, click OK.</span></span> <span data-ttu-id="bf6e8-156">結果會顯示在 [輸出] 視窗中。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-156">The results are displayed in the Output window.</span></span> <span data-ttu-id="bf6e8-157">圖 2 顯示的結果，藉由排序時，傳回產品排名 11 到 20 時`UnitPrice`以遞減順序。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-157">Figure 2 shows the results when returning products ranked 11 through 20 when ordering by the `UnitPrice` in descending order.</span></span>


![預存程序 s 三個輸入參數嘗試不同的值](sorting-custom-paged-data-vb/_static/image1.png)

<span data-ttu-id="bf6e8-159">**圖 1**： 嘗試不同的值，如預存程序 s，三個輸入參數</span><span class="sxs-lookup"><span data-stu-id="bf6e8-159">**Figure 1**: Try Different Values for the Stored Procedure s Three Input Parameters</span></span>


<span data-ttu-id="bf6e8-160">[![結果會顯示在 [輸出] 視窗中的預存程序 s](sorting-custom-paged-data-vb/_static/image3.png)](sorting-custom-paged-data-vb/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-160">[![The Stored Procedure s Results are Shown in the Output Window](sorting-custom-paged-data-vb/_static/image3.png)](sorting-custom-paged-data-vb/_static/image2.png)</span></span>

<span data-ttu-id="bf6e8-161">**圖 2**： 結果會顯示在 [輸出] 視窗中的預存程序 s ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="bf6e8-161">**Figure 2**: The Stored Procedure s Results are Shown in the Output Window ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image4.png))</span></span>


> [!NOTE]
> <span data-ttu-id="bf6e8-162">當指定排名結果`ORDER BY`中的資料行`OVER`子句，SQL Server 必須排序結果。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-162">When ranking the results by the specified `ORDER BY` column in the `OVER` clause, SQL Server must sort the results.</span></span> <span data-ttu-id="bf6e8-163">這是快速的作業，如果結果正在當做排序依據的資料行上沒有叢集的索引，或是否涵蓋編製索引，但可以否則成本更高。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-163">This is a quick operation if there is a clustered index over the column(s) the results are being ordered by or if there is a covering index, but can be more costly otherwise.</span></span> <span data-ttu-id="bf6e8-164">若要改善夠大的查詢的效能，請考慮將結果依排序的資料行的非叢集索引。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-164">To improve performance for sufficiently large queries, consider adding a non-clustered index for the column by which the results are ordered by.</span></span> <span data-ttu-id="bf6e8-165">請參閱[排名函式和 SQL Server 2005 中的效能](http://www.sql-server-performance.com/ak_ranking_functions.asp)如需詳細資訊。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-165">Refer to [Ranking Functions and Performance in SQL Server 2005](http://www.sql-server-performance.com/ak_ranking_functions.asp) for more details.</span></span>


## <a name="step-2-augmenting-the-data-access-and-business-logic-layers"></a><span data-ttu-id="bf6e8-166">步驟 2： 增強的資料存取和商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="bf6e8-166">Step 2: Augmenting the Data Access and Business Logic Layers</span></span>

<span data-ttu-id="bf6e8-167">使用`GetProductsPagedAndSorted`建立預存程序中，我們的下一個步驟是能用來執行該預存程序，透過我們的應用程式架構。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-167">With the `GetProductsPagedAndSorted` stored procedure created, our next step is to provide a means to execute that stored procedure through our application architecture.</span></span> <span data-ttu-id="bf6e8-168">這需要 DAL 和 BLL 新增適當的方法。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-168">This entails adding an appropriate method to both the DAL and BLL.</span></span> <span data-ttu-id="bf6e8-169">可讓著手將方法加入 DAL 的 s。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-169">Let s start by adding a method to the DAL.</span></span> <span data-ttu-id="bf6e8-170">開啟`Northwind.xsd`具類型的資料集，以滑鼠右鍵按一下`ProductsTableAdapter`，，然後從操作功能表中選擇 加入查詢選項。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-170">Open the `Northwind.xsd` Typed DataSet, right-click on the `ProductsTableAdapter`, and choose the Add Query option from the context menu.</span></span> <span data-ttu-id="bf6e8-171">如同我們在先前的教學課程中，我們想要設定這個新的 DAL 方法，以使用現有的預存程序- `GetProductsPagedAndSorted`，在此案例。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-171">As we did in the preceding tutorial, we want to configure this new DAL method to use an existing stored procedure - `GetProductsPagedAndSorted`, in this case.</span></span> <span data-ttu-id="bf6e8-172">藉由指示您想要使用現有新的 TableAdapter 方法啟動預存程序。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-172">Start by indicating that you want the new TableAdapter method to use an existing stored procedure.</span></span>


![選擇使用現有的預存程序](sorting-custom-paged-data-vb/_static/image5.png)

<span data-ttu-id="bf6e8-174">**圖 3**： 選擇使用現有的預存程序</span><span class="sxs-lookup"><span data-stu-id="bf6e8-174">**Figure 3**: Choose to Use an Existing Stored Procedure</span></span>


<span data-ttu-id="bf6e8-175">若要指定要使用的預存程序，請選取`GetProductsPagedAndSorted`儲存程序，從下拉式清單中下一個畫面。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-175">To specify the stored procedure to use, select the `GetProductsPagedAndSorted` stored procedure from the drop-down list in the next screen.</span></span>


![使用 GetProductsPagedAndSorted 預存程序](sorting-custom-paged-data-vb/_static/image6.png)

<span data-ttu-id="bf6e8-177">**圖 4**： 使用 GetProductsPagedAndSorted 預存程序</span><span class="sxs-lookup"><span data-stu-id="bf6e8-177">**Figure 4**: Use the GetProductsPagedAndSorted Stored Procedure</span></span>


<span data-ttu-id="bf6e8-178">這個預存程序會傳回一組記錄，因為其結果因此，在下一個畫面中，表示它會傳回表格式資料。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-178">This stored procedure returns a set of records as its results so, in the next screen, indicate that it returns tabular data.</span></span>


![指出預存程序會傳回表格式資料](sorting-custom-paged-data-vb/_static/image7.png)

<span data-ttu-id="bf6e8-180">**圖 5**： 指出預存程序會傳回表格式資料</span><span class="sxs-lookup"><span data-stu-id="bf6e8-180">**Figure 5**: Indicate that the Stored Procedure Returns Tabular Data</span></span>


<span data-ttu-id="bf6e8-181">最後，建立 DAL 方法中使用這兩種填滿 DataTable，並傳回 DataTable 模式、 命名方法`FillPagedAndSorted`和`GetProductsPagedAndSorted`分別。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-181">Finally, create DAL methods that use both the Fill a DataTable and Return a DataTable patterns, naming the methods `FillPagedAndSorted` and `GetProductsPagedAndSorted`, respectively.</span></span>


![選擇 方法名稱](sorting-custom-paged-data-vb/_static/image8.png)

<span data-ttu-id="bf6e8-183">**圖 6**： 選擇 方法名稱</span><span class="sxs-lookup"><span data-stu-id="bf6e8-183">**Figure 6**: Choose the Methods Names</span></span>


<span data-ttu-id="bf6e8-184">現在我們已擴充 DAL 中，我們準備好辦法 BLL。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-184">Now that we ve extended the DAL, we re ready to turn to the BLL.</span></span> <span data-ttu-id="bf6e8-185">開啟`ProductsBLL`類別檔案，並新增一個新的方法， `GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-185">Open the `ProductsBLL` class file and add a new method, `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="bf6e8-186">這個方法必須接受三個輸入參數`sortExpression`， `startRowIndex`，並`maximumRows`，應該直接向下呼叫到 DAL 的`GetProductsPagedAndSorted`方法，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-186">This method needs to accept three input parameters `sortExpression`, `startRowIndex`, and `maximumRows` and should simply call down into the DAL s `GetProductsPagedAndSorted` method, like so:</span></span>


[!code-vb[Main](sorting-custom-paged-data-vb/samples/sample4.vb)]

## <a name="step-3-configuring-the-objectdatasource-to-pass-in-the-sortexpression-parameter"></a><span data-ttu-id="bf6e8-187">步驟 3： 設定 SortExpression 參數中的行程 ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="bf6e8-187">Step 3: Configuring the ObjectDataSource to Pass in the SortExpression Parameter</span></span>

<span data-ttu-id="bf6e8-188">DAL 和 BLL，包括使用的方法需要擴增`GetProductsPagedAndSorted`預存程序，所有會保持為設定內的 ObjectDataSource`SortParameter.aspx`頁面，即可使用新的 BLL 方法，並傳入`SortExpression`參數為基礎使用者已要求來排序結果所依據的資料行。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-188">Having augmented the DAL and BLL to include methods that utilize the `GetProductsPagedAndSorted` stored procedure, all that remains is to configure the ObjectDataSource in the `SortParameter.aspx` page to use the new BLL method and to pass in the `SortExpression` parameter based on the column that the user has requested to sort the results by.</span></span>

<span data-ttu-id="bf6e8-189">開始先變更 ObjectDataSource s`SelectMethod`從`GetProductsPaged`至`GetProductsPagedAndSorted`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-189">Start by changing the ObjectDataSource s `SelectMethod` from `GetProductsPaged` to `GetProductsPagedAndSorted`.</span></span> <span data-ttu-id="bf6e8-190">這可以透過設定資料來源精靈 」，從 [屬性] 視窗中，或直接透過宣告式語法完成。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-190">This can be done through the Configure Data Source wizard, from the Properties window, or directly through the declarative syntax.</span></span> <span data-ttu-id="bf6e8-191">接下來，我們必須為 ObjectDataSource s 提供一個值[`SortParameterName`屬性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx)。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-191">Next, we need to provide a value for the ObjectDataSource s [`SortParameterName` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.objectdatasource.sortparametername.aspx).</span></span> <span data-ttu-id="bf6e8-192">如果設定這個屬性，ObjectDataSource 會嘗試將傳入的 GridView s`SortExpression`屬性設`SelectMethod`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-192">If this property is set, the ObjectDataSource attempts to pass in the GridView s `SortExpression` property to the `SelectMethod`.</span></span> <span data-ttu-id="bf6e8-193">ObjectDataSource 特別的是，尋找其名稱是相等的值為輸入參數`SortParameterName`屬性。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-193">In particular, the ObjectDataSource looks for an input parameter whose name is equal to the value of the `SortParameterName` property.</span></span> <span data-ttu-id="bf6e8-194">因為 BLL s`GetProductsPagedAndSorted`方法具有名為排序的運算式輸入的參數`sortExpression`，設定 ObjectDataSource 的`SortExpression`sortExpression 的屬性。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-194">Since the BLL s `GetProductsPagedAndSorted` method has the sort expression input parameter named `sortExpression`, set the ObjectDataSource s `SortExpression` property to sortExpression .</span></span>

<span data-ttu-id="bf6e8-195">進行這兩項變更之後, 的 ObjectDataSource s 宣告式語法看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-195">After making these two changes, the ObjectDataSource s declarative syntax should look similar to the following:</span></span>


[!code-aspx[Main](sorting-custom-paged-data-vb/samples/sample5.aspx)]

> [!NOTE]
> <span data-ttu-id="bf6e8-196">如先前的教學課程中，確認 ObjectDataSource 就*不*其 SelectParameters 集合中包含的 sortExpression、 startRowIndex 或 maximumRows 的輸入的參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-196">As with the preceding tutorial, ensure that the ObjectDataSource does *not* include the sortExpression, startRowIndex, or maximumRows input parameters in its SelectParameters collection.</span></span>


<span data-ttu-id="bf6e8-197">若要啟用排序 GridView 裡，只要核取方塊啟用排序 GridView s 智慧標籤中，它會設定 GridView s`AllowSorting`屬性設`true`並導致每個資料行轉譯為 LinkButton 的標頭文字。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-197">To enable sorting in the GridView, simply check the Enable Sorting checkbox in the GridView s smart tag, which sets the GridView s `AllowSorting` property to `true` and causing the header text for each column to be rendered as a LinkButton.</span></span> <span data-ttu-id="bf6e8-198">當使用者按一下其中一個標頭 Linkbutton 時，回傳是兩邊彼此乾瞪眼並發生下列步驟：</span><span class="sxs-lookup"><span data-stu-id="bf6e8-198">When the end user clicks on one of the header LinkButtons, a postback ensues and the following steps transpire:</span></span>

1. <span data-ttu-id="bf6e8-199">GridView 更新其[`SortExpression`屬性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sortexpression.aspx)的值`SortExpression`其標頭已按下連結的欄位</span><span class="sxs-lookup"><span data-stu-id="bf6e8-199">The GridView updates its [`SortExpression` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridview.sortexpression.aspx) to the value of the `SortExpression` of the field whose header link was clicked</span></span>
2. <span data-ttu-id="bf6e8-200">ObjectDataSource 會叫用的 BLL s`GetProductsPagedAndSorted`方法並傳入 GridView s`SortExpression`屬性做為方法 s 的值`sortExpression`輸入的參數 (以及適當`startRowIndex`和`maximumRows`輸入參數值)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-200">The ObjectDataSource invokes the BLL s `GetProductsPagedAndSorted` method, passing in the GridView s `SortExpression` property as the value for the method s `sortExpression` input parameter (along with the appropriate `startRowIndex` and `maximumRows` input parameter values)</span></span>
3. <span data-ttu-id="bf6e8-201">BLL 叫用的 DAL s`GetProductsPagedAndSorted`方法</span><span class="sxs-lookup"><span data-stu-id="bf6e8-201">The BLL invokes the DAL s `GetProductsPagedAndSorted` method</span></span>
4. <span data-ttu-id="bf6e8-202">執行 DAL`GetProductsPagedAndSorted`預存程序，並傳遞`@sortExpression`參數 (連同`@startRowIndex`和`@maximumRows`輸入參數值)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-202">The DAL executes the `GetProductsPagedAndSorted` stored procedure, passing in the `@sortExpression` parameter (along with the `@startRowIndex` and `@maximumRows` input parameter values)</span></span>
5. <span data-ttu-id="bf6e8-203">預存程序傳回 BLL，bll ObjectDataSource; 將它傳回適當的資料子集這項資料是繫結至 GridView，轉譯為 HTML，然後傳送給使用者</span><span class="sxs-lookup"><span data-stu-id="bf6e8-203">The stored procedure returns the appropriate subset of data to the BLL, which returns it to the ObjectDataSource; this data is then bound to the GridView, rendered into HTML, and sent down to the end user</span></span>

<span data-ttu-id="bf6e8-204">[圖 7] 顯示時依排序的結果的第一頁`UnitPrice`以遞增順序。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-204">Figure 7 shows the first page of results when sorted by the `UnitPrice` in ascending order.</span></span>


<span data-ttu-id="bf6e8-205">[![結果會依照 UnitPrice](sorting-custom-paged-data-vb/_static/image10.png)](sorting-custom-paged-data-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-205">[![The Results are Sorted by the UnitPrice](sorting-custom-paged-data-vb/_static/image10.png)](sorting-custom-paged-data-vb/_static/image9.png)</span></span>

<span data-ttu-id="bf6e8-206">**圖 7**： 結果會依照 UnitPrice ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image11.png))</span><span class="sxs-lookup"><span data-stu-id="bf6e8-206">**Figure 7**: The Results are Sorted by the UnitPrice ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image11.png))</span></span>


<span data-ttu-id="bf6e8-207">目前的實作可以正確排序的結果依產品名稱、 類別名稱、 每個單位和單價的數量，而嘗試排列結果的順序與供應商名稱結果在執行階段例外狀況 （請參閱 圖 8）。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-207">While the current implementation can correctly sort the results by product name, category name, quantity per unit, and unit price, attempting to order the results by the supplier name results in a runtime exception (see Figure 8).</span></span>


![嘗試將排序結果，您可以在下列執行階段例外狀況的供應商結果](sorting-custom-paged-data-vb/_static/image12.png)

<span data-ttu-id="bf6e8-209">**圖 8**： 嘗試將排序結果，您可以在下列執行階段例外狀況的供應商結果</span><span class="sxs-lookup"><span data-stu-id="bf6e8-209">**Figure 8**: Attempting to Sort the Results by the Supplier Results in the Following Runtime Exception</span></span>


<span data-ttu-id="bf6e8-210">因為發生這個例外狀況`SortExpression`的 GridView s `SupplierName` BoundField 設`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-210">This exception occurs because the `SortExpression` of the GridView s `SupplierName` BoundField is set to `SupplierName`.</span></span> <span data-ttu-id="bf6e8-211">供應商 s 中的名稱但`Suppliers`資料表稱為實際上`CompanyName`我們已經被別名做為此資料行名稱`SupplierName`。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-211">However, the supplier s name in the `Suppliers` table is actually called `CompanyName` we have been aliased this column name as `SupplierName`.</span></span> <span data-ttu-id="bf6e8-212">不過，`OVER`所使用的子句`ROW_NUMBER()`函式無法使用此別名，而且必須使用實際的資料行名稱。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-212">However, the `OVER` clause used by the `ROW_NUMBER()` function cannot use the alias and must use the actual column name.</span></span> <span data-ttu-id="bf6e8-213">因此，變更`SupplierName`BoundField 的`SortExpression`從供應商名稱至 CompanyName （請參閱 圖 9）。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-213">Therefore, change the `SupplierName` BoundField s `SortExpression` from SupplierName to CompanyName (see Figure 9).</span></span> <span data-ttu-id="bf6e8-214">如 [圖 10] 所示，這項變更之後的結果可依供應商。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-214">As Figure 10 shows, after this change the results can be sorted by the supplier.</span></span>


![將 供應商的供應商名稱 BoundField 的 SortExpression](sorting-custom-paged-data-vb/_static/image13.png)

<span data-ttu-id="bf6e8-216">**圖 9**： 將供應商名稱 BoundField 的 SortExpression 變更為 公司名稱</span><span class="sxs-lookup"><span data-stu-id="bf6e8-216">**Figure 9**: Change the SupplierName BoundField s SortExpression to CompanyName</span></span>


<span data-ttu-id="bf6e8-217">[![現在可以供應商提供的排序結果](sorting-custom-paged-data-vb/_static/image15.png)](sorting-custom-paged-data-vb/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-217">[![The Results Can Now Be Sorted by Supplier](sorting-custom-paged-data-vb/_static/image15.png)](sorting-custom-paged-data-vb/_static/image14.png)</span></span>

<span data-ttu-id="bf6e8-218">**圖 10**: 結果可立即依供應商 ([按一下以檢視完整大小的影像](sorting-custom-paged-data-vb/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="bf6e8-218">**Figure 10**: The Results Can Now Be Sorted by Supplier ([Click to view full-size image](sorting-custom-paged-data-vb/_static/image16.png))</span></span>


## <a name="summary"></a><span data-ttu-id="bf6e8-219">總結</span><span class="sxs-lookup"><span data-stu-id="bf6e8-219">Summary</span></span>

<span data-ttu-id="bf6e8-220">在先前的教學課程中，我們檢查的自訂分頁實作所需的結果已排序的順序會在設計階段指定。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-220">The custom paging implementation we examined in the preceding tutorial required that the order by which the results were to be sorted be specified at design time.</span></span> <span data-ttu-id="bf6e8-221">簡單地說，這表示，我們實作的自訂分頁實作可能不是，在此同時，提供排序功能。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-221">In short, this meant that the custom paging implementation we implemented could not, at the same time, provide sorting capabilities.</span></span> <span data-ttu-id="bf6e8-222">在本教學課程克服這項限制藉由從要包含第一個擴充預存程序`@sortExpression`結果無法排序的輸入的參數。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-222">In this tutorial we overcame this limitation by extending the stored procedure from the first to include a `@sortExpression` input parameter by which the results could be sorted.</span></span>

<span data-ttu-id="bf6e8-223">建立此預存程序和 BLL 和 DAL 中建立新的方法之後，我們能夠實作的 GridView 會提供這兩個排序和自訂設定來傳入 GridView s 目前 ObjectDataSource 分頁`SortExpression`BLL 屬性`SelectMethod`.</span><span class="sxs-lookup"><span data-stu-id="bf6e8-223">After creating this stored procedure and creating new methods in the DAL and BLL, we were able to implement a GridView that offered both sorting and custom paging by configuring the ObjectDataSource to pass in the GridView s current `SortExpression` property to the BLL `SelectMethod`.</span></span>

<span data-ttu-id="bf6e8-224">快樂地寫程式 ！</span><span class="sxs-lookup"><span data-stu-id="bf6e8-224">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="bf6e8-225">關於作者</span><span class="sxs-lookup"><span data-stu-id="bf6e8-225">About the Author</span></span>

<span data-ttu-id="bf6e8-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七個 ASP 書籍和的創辦人[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年從事 Microsoft Web 技術工作。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-226">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="bf6e8-227">Scott 會擔任獨立的顧問、 培訓講師和作家。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-227">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="bf6e8-228">他最新的著作是[ *Sams 教導您自己 ASP.NET 2.0 在 24 小時內*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-228">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="bf6e8-229">他可以在觸達[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-229">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="bf6e8-230">或透過他的部落格，這位於[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-230">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="bf6e8-231">特別感謝</span><span class="sxs-lookup"><span data-stu-id="bf6e8-231">Special Thanks To</span></span>

<span data-ttu-id="bf6e8-232">本教學課程系列是由許多實用的檢閱者檢閱。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-232">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="bf6e8-233">本教學課程中的潛在客戶檢閱者已 Carlos 環境。</span><span class="sxs-lookup"><span data-stu-id="bf6e8-233">Lead reviewer for this tutorial was Carlos Santos.</span></span> <span data-ttu-id="bf6e8-234">有興趣檢閱我即將推出的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="bf6e8-234">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="bf6e8-235">如果是這樣，psychic 在[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-235">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="bf6e8-236">[上一頁](efficiently-paging-through-large-amounts-of-data-vb.md)
> [下一頁](creating-a-customized-sorting-user-interface-vb.md)</span><span class="sxs-lookup"><span data-stu-id="bf6e8-236">[Previous](efficiently-paging-through-large-amounts-of-data-vb.md)
[Next](creating-a-customized-sorting-user-interface-vb.md)</span></span>
