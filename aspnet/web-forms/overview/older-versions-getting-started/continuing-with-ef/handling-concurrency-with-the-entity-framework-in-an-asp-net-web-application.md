---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: "處理與 Entity Framework 4.0 ASP.NET 4 Web 應用程式中的並行 |Microsoft 文件"
author: tdykstra
description: "此教學課程系列為基礎所建立的開始使用 Entity Framework 4.0 教學課程系列的 Contoso 大學 web 應用程式。 我..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 7bdcf610458631749531ed1279d27e90572f0371
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/10/2017
---
<a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="4b9ad-104">處理並行與 Entity Framework 4.0 ASP.NET 4 Web 應用程式</span><span class="sxs-lookup"><span data-stu-id="4b9ad-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>
====================
<span data-ttu-id="4b9ad-105">由[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="4b9ad-106">此教學課程系列為基礎所建立的 Contoso 大學 web 應用程式[開始使用 Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started)教學課程系列。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="4b9ad-107">如果您未完成先前的教學課程，您可以身分本教學課程的起始點來[下載應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a)您會建立。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="4b9ad-108">您也可以[下載應用程式](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa)完整的教學課程所建立。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="4b9ad-109">如果您有疑問的教學課程，您可以張貼他們[ASP.NET Entity Framework 論壇](https://forums.asp.net/1227.aspx)。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="4b9ad-110">您在上一個教學課程中學會如何排序和篩選資料使用`ObjectDataSource`控制項和 Entity Framework。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="4b9ad-111">本教學課程示範處理中使用 Entity Framework 的 ASP.NET web 應用程式的並行存取的選項。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="4b9ad-112">您將建立新的網頁，專門用來更新講師 office 指派。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="4b9ad-113">您將會處理在該頁面，然後在您稍早建立的 [部門] 頁面的並行問題。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="4b9ad-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="4b9ad-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="4b9ad-116">並行衝突</span><span class="sxs-lookup"><span data-stu-id="4b9ad-116">Concurrency Conflicts</span></span>

<span data-ttu-id="4b9ad-117">當一位使用者編輯資料錄和另一位使用者編輯同一筆記錄，第一個使用者的變更寫入資料庫之前，就會發生並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="4b9ad-118">如果您不要設定 Entity Framework 來偵測這類衝突，只要更新資料庫最後會覆寫其他使用者的變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="4b9ad-119">在許多應用程式，這項風險是可接受的而您不需要設定應用程式處理可能的並行存取衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="4b9ad-120">(如果有少數的使用者或一些更新，或如果不是最關鍵的某些變更會覆寫時，如果並行程式設計的成本可能會超過的好處。)如果您不需要擔心並行衝突，您可以略過本教學課程。數列中其餘的兩個教學課程不取決於您在此一中建立的任何項目。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="4b9ad-121">封閉式並行存取 （鎖定）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="4b9ad-122">如果您的應用程式需要以防止資料意外遺失並行案例中的，方法之一是使用資料庫鎖定。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="4b9ad-123">這稱為*封閉式並行存取*。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="4b9ad-124">例如，從資料庫讀取資料列之前，您要求的鎖定唯讀或 update 存取權。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="4b9ad-125">如果您鎖定的資料列進行 update 存取權，允許任何其他使用者鎖定資料列的唯讀或更新存取權，因為他們會取得正在變更的資料副本。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="4b9ad-126">如果鎖定為唯讀存取的資料列時，其他人可以唯讀存取權，但不適用於更新也鎖定。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="4b9ad-127">管理鎖定也有一些缺點。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="4b9ad-128">是相當複雜的程式。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-128">It can be complex to program.</span></span> <span data-ttu-id="4b9ad-129">這需要大量的資料庫管理資源，而且它會造成效能問題的應用程式的使用者數目增加時 （亦即，將無法妥善調整）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="4b9ad-130">基於這些理由，並非所有的資料庫管理系統支援封閉式並行存取。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="4b9ad-131">Entity Framework 提供的內建支援，而本教學課程不會顯示您如何實作它。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="4b9ad-132">開放式並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-132">Optimistic Concurrency</span></span>

<span data-ttu-id="4b9ad-133">封閉式並行存取另一種是*開放式並行存取*。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="4b9ad-134">開放式並行存取表示允許發生並行衝突，然後適當地回應如果沒有的話。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="4b9ad-135">John 會執行，例如*Department.aspx*頁面上，按一下**編輯**連結的歷程記錄 」 部門，並減少**預算**1,000,000.00 $ $ 的數量125,000.00。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="4b9ad-136">（John 管理競爭部門的而且想要釋出其部門的）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="4b9ad-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="4b9ad-138">John 按之前**更新**，Jane 執行相同的頁面上，按一下**編輯**記錄部門，然後變更連結**開始日期**從 2011 年 1 月 10 日欄位設為 1/1 /1999。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="4b9ad-139">（Jane 管理記錄部門的而且想要為它提供更多的 seniority）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="4b9ad-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="4b9ad-141">John 按**更新**第一次，然後 Jane 按一下**更新**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="4b9ad-142">Jane 的瀏覽器現在清單**預算**做 $1,000,000.00，但是這樣的數量不正確，因為量已由 John 變更 $125,000.00。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="4b9ad-143">在此案例中，您可以採取的動作包括下列：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="4b9ad-144">您可以追蹤的哪些使用者已修改的屬性，並更新只對應的資料行在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="4b9ad-145">在範例案例中，任何資料將不會遺失，因為兩位使用者已更新不同的屬性。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="4b9ad-146">在下一次有人瀏覽歷程記錄部門，他們會看到 1/1/1999年和 $125,000.00。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="4b9ad-147">這是 Entity Framework 中的預設行為，而且它可以大幅減少可能會導致資料遺失的衝突數目。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="4b9ad-148">不過，此行為不會避免資料遺失，如果相同的實體屬性進行競爭的變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="4b9ad-149">此外，這種行為並不一定都可能;當您為實體型別對應預存程序，所有實體的屬性會更新任何實體變更時在資料庫中。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="4b9ad-150">您可以讓 Jane 的變更覆寫 John 的變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="4b9ad-151">Jane 按一下之後**更新**、**預算**量會回到 $1,000,000.00。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="4b9ad-152">這稱為*用戶端獲勝*或*Wins 中的最後一個*案例。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="4b9ad-153">（用戶端的值優先於什麼是資料存放區中。）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="4b9ad-154">您可以防止資料庫中的更新 Jane 的變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="4b9ad-155">一般而言，您會顯示錯誤訊息、 顯示她目前狀態的資料，並允許她如果她仍然想要讓它們重新輸入其變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="4b9ad-156">您無法進一步自動化程序，透過儲存其輸入，並讓她有機會重新套用而不必重新輸入。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="4b9ad-157">這稱為*存放區 Wins*案例。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="4b9ad-158">（資料存放區的值優先於用戶端所送出的值。）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="4b9ad-159">偵測並行衝突</span><span class="sxs-lookup"><span data-stu-id="4b9ad-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="4b9ad-160">在 Entity Framework 中，您可以藉由處理解決衝突`OptimisticConcurrencyException`Entity Framework 就會擲回的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="4b9ad-161">若要知道何時擲回這些例外狀況，Entity Framework 必須能夠偵測衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="4b9ad-162">因此，您必須設定資料庫和資料模型適當。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="4b9ad-163">啟用衝突偵測的一些選項如下：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="4b9ad-164">在資料庫中，包含可用來判斷已變更的資料列的資料表資料行。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="4b9ad-165">接著，您可以設定要包含在該資料行的 Entity Framework`Where`子句的 SQL`Update`或`Delete`命令。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="4b9ad-166">目的，是`Timestamp`中的資料行`OfficeAssignment`資料表。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="4b9ad-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="4b9ad-168">資料型別`Timestamp`資料行也稱為`Timestamp`。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="4b9ad-169">不過，資料行實際上並不包含日期或時間值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="4b9ad-170">相反地，值會是已遞增每次更新資料列時的序號。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="4b9ad-171">在`Update`或`Delete`命令，`Where`子句會包含原始`Timestamp`值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="4b9ad-172">如果正在更新的資料列已由另一位使用者中的值變更`Timestamp`不同於原始值，所以`Where`子句會傳回沒有要更新的資料列。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="4b9ad-173">Entity Framework 找到任何資料列，已由目前已更新`Update`或`Delete`命令 （亦即，受影響的資料列數目為零） 時，它將會解譯為並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="4b9ad-174">設定要包含的資料表中的每個資料行的原始值的 Entity Framework`Where`子句`Update`和`Delete`命令。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="4b9ad-175">如同第一個選項之後第一次讀取的資料列，, 資料列中的任何項目已變更`Where`子句不會 Entity Framework 會解譯為並行衝突的傳回資料列來更新。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="4b9ad-176">這個方法是使用效率`Timestamp`欄位，但可能會沒有效率。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="4b9ad-177">對於具有許多資料行的資料庫資料表，可能會產生非常大`Where`子句，並在 web 應用程式可以要求您維護大量的狀態。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="4b9ad-178">維護大量的狀態會影響應用程式效能，因為它需要的伺服器資源 （例如，工作階段狀態），或必須包含在網頁本身 （例如，檢視狀態）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="4b9ad-179">在本教學課程中，您會加入錯誤處理開放式並行存取衝突的實體沒有追蹤屬性 (`Department`實體) 和實體沒有追蹤屬性 (`OfficeAssignment`實體)。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="4b9ad-180">處理開放式並行存取沒有追蹤內容</span><span class="sxs-lookup"><span data-stu-id="4b9ad-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="4b9ad-181">若要實作的開放式並行存取`Department`沒有追蹤的實體 (`Timestamp`) 屬性，您將完成下列工作：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="4b9ad-182">變更資料模型，以啟用追蹤的並行`Department`實體。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="4b9ad-183">在`SchoolRepository`類別，控制代碼中的並行存取例外狀況`SaveChanges`方法。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="4b9ad-184">在*Departments.aspx*頁面上，顯示訊息警告不成功的嘗試的變更使用者的控制代碼並行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="4b9ad-185">使用者可以查看目前的值，然後重試所做的變更，如果仍然需要它們時。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="4b9ad-186">啟用追蹤資料模型中的並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="4b9ad-187">在 Visual Studio 中，開啟您已在此系列的上一個教學課程中使用的 Contoso 大學 web 應用程式。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="4b9ad-188">開啟*SchoolModel.edmx*，在資料模型設計師中，以滑鼠右鍵按一下`Name`屬性`Department`實體，然後按一下**屬性**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="4b9ad-189">在**屬性**視窗中，變更`ConcurrencyMode`屬性`Fixed`。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="4b9ad-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="4b9ad-191">執行其他非主要金鑰純量屬性相同的動作 (`Budget`， `StartDate`，和`Administrator`。)（您無法這樣做為導覽屬性。）這會指定，每當 Entity Framework 產生`Update`或`Delete`SQL 命令，以更新`Department`資料庫中的實體，這些值的資料行 （原始） 必須包含在`Where`子句。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="4b9ad-192">如果不找到任何資料列時`Update`或`Delete`命令執行時，Entity Framework 將會擲回開放式並行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="4b9ad-193">儲存並關閉 資料模型。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="4b9ad-194">在 DAL 的並行存取例外狀況處理</span><span class="sxs-lookup"><span data-stu-id="4b9ad-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="4b9ad-195">開啟*SchoolRepository.cs*並加入下列`using`陳述式`System.Data`命名空間：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="4b9ad-196">新增下列新`SaveChanges`方法，這個方法會處理開放式並行存取例外狀況：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="4b9ad-197">如果並行存取錯誤發生時呼叫這個方法，在記憶體中實體的屬性值會取代目前資料庫中的值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="4b9ad-198">並行存取例外狀況重新擲回，好讓網頁可以處理它。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="4b9ad-199">在`DeleteDepartment`和`UpdateDepartment`方法，會取代現有呼叫`context.SaveChanges()`呼叫`SaveChanges()`才能叫用新的方法。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="4b9ad-200">展示層中的並行存取例外狀況處理</span><span class="sxs-lookup"><span data-stu-id="4b9ad-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="4b9ad-201">開啟*Departments.aspx*並加入`OnDeleted="DepartmentsObjectDataSource_Deleted"`屬性`DepartmentsObjectDataSource`控制項。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="4b9ad-202">控制項的開頭標記現在會類似下列的範例。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="4b9ad-203">在`DepartmentsGridView`控制項，指定所有的資料表資料行`DataKeyNames`屬性，如下列範例所示。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="4b9ad-204">請注意，這會建立非常大的檢視狀態欄位，這是其中一個原因為何使用追蹤欄位通常是慣用的方法來追蹤並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="4b9ad-205">開啟*Departments.aspx.cs*並加入下列`using`陳述式`System.Data`命名空間：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="4b9ad-206">將下列新方法，您會從資料來源控制項的呼叫`Updated`和`Deleted`處理並行例外狀況的事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="4b9ad-207">此程式碼會檢查例外狀況型別和並行存取例外狀況，所以如果程式碼以動態方式建立`CustomValidator`接著會顯示在訊息的控制項`ValidationSummary`控制項。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="4b9ad-208">呼叫的新方法，從`Updated`您先前加入的事件處理常式。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="4b9ad-209">此外，建立新`Deleted`呼叫相同方法 （但不執行任何其他動作） 的事件處理常式：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="4b9ad-210">在 [部門] 頁面中測試開放式並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="4b9ad-211">執行*Departments.aspx*頁面。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="4b9ad-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="4b9ad-213">按一下**編輯**中一個資料列中的值變更和**預算**資料行。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="4b9ad-214">(請記住，您可以只進行編輯記錄，您已建立本教學課程中，因為現有`School`資料庫的記錄包含某些無效的資料。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="4b9ad-215">經濟部門的記錄是安全的一個試驗。）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="4b9ad-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="4b9ad-217">開啟新的瀏覽器視窗並執行資料頁 （複製的 URL 從第一個瀏覽器視窗的 [網址] 方塊的第二個瀏覽器視窗）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="4b9ad-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="4b9ad-219">按一下**編輯**在同一個資料列您稍早編輯並變更**預算**為其他值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="4b9ad-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="4b9ad-221">在第二個瀏覽器視窗中，按一下 **更新**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="4b9ad-222">**預算**數量已成功變更為這個新值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="4b9ad-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="4b9ad-224">在第一個瀏覽器視窗中，按一下 **更新**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="4b9ad-225">更新失敗。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-225">The update fails.</span></span> <span data-ttu-id="4b9ad-226">**預算**量會重新顯示，使用您在第二個瀏覽器視窗中，設定的值，您看到錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="4b9ad-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="4b9ad-228">使用 追蹤屬性處理開放式並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="4b9ad-229">若要處理的追蹤屬性的實體的開放式並行存取，您將完成下列工作：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="4b9ad-230">將預存程序加入至資料模型，以管理`OfficeAssignment`實體。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="4b9ad-231">（追蹤屬性和預存程序，不需要同時使用; 它們會只分組在一起這裡舉例來說）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="4b9ad-232">CRUD 方法加入 DAL 和如 BLL`OfficeAssignment`實體，包括處理中 DAL 的開放式並行存取例外狀況的程式碼。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="4b9ad-233">建立 office 指派網頁。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="4b9ad-234">測試新的網頁中開放式並行存取。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="4b9ad-235">加入 OfficeAssignment 預存程序的資料模型</span><span class="sxs-lookup"><span data-stu-id="4b9ad-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="4b9ad-236">開啟*SchoolModel.edmx*檔案在模型設計師中，以滑鼠右鍵按一下設計介面，然後按一下**從資料庫更新模型**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="4b9ad-237">在**新增** 索引標籤**選擇您的資料庫物件**對話方塊方塊中，展開 **預存程序**並選取三個`OfficeAssignment`預存程序 (請參閱下列螢幕擷取畫面），然後按一下 **完成**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="4b9ad-238">（這些預存程序均已在資料庫中下載，或使用指令碼在建立時。）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="4b9ad-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="4b9ad-240">以滑鼠右鍵按一下`OfficeAssignment`實體，然後選取**預存程序對應**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="4b9ad-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="4b9ad-242">設定**插入**，**更新**，和**刪除**使用其對應之函數的預存程序。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="4b9ad-243">如`OrigTimestamp`參數`Update`函式中，設定**屬性**至`Timestamp`選取**使用原始值**選項。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="4b9ad-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="4b9ad-245">當 Entity Framework 呼叫`UpdateOfficeAssignment`預存程序，它將傳遞的原始值`Timestamp`中的資料行`OrigTimestamp`參數。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="4b9ad-246">預存程序會使用此參數以其`Where`子句：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="4b9ad-247">預存程序也會選取的新值`Timestamp`更新後的資料行，以便可以讓 Entity Framework`OfficeAssignment`為記憶體中與對應的資料庫資料列的同步處理的實體。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="4b9ad-248">(請注意，刪除 office 作業的預存程序沒有`OrigTimestamp`參數。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="4b9ad-249">因此，Entity Framework 無法驗證實體不變，然後再刪除它。）</span><span class="sxs-lookup"><span data-stu-id="4b9ad-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="4b9ad-250">儲存並關閉 資料模型。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="4b9ad-251">Dal 加入 OfficeAssignment 方法</span><span class="sxs-lookup"><span data-stu-id="4b9ad-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="4b9ad-252">開啟*ISchoolRepository.cs*並加入下列的 CRUD 方法`OfficeAssignment`實體集：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="4b9ad-253">將下列新方法加入*SchoolRepository.cs*。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="4b9ad-254">在`UpdateOfficeAssignment`方法，呼叫本機`SaveChanges`方法，而非`context.SaveChanges`。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="4b9ad-255">在測試專案中，開啟*MockSchoolRepository.cs*並加入下列`OfficeAssignment`集合和 CRUD 方法。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="4b9ad-256">（模擬儲存機制必須實作儲存機制的介面，或將不會編譯方案）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="4b9ad-257">加入 BLL OfficeAssignment 方法</span><span class="sxs-lookup"><span data-stu-id="4b9ad-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="4b9ad-258">在主專案中，開啟*SchoolBL.cs*並加入下列的 CRUD 方法`OfficeAssignment`實體設：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="4b9ad-259">建立 OfficeAssignments Web 網頁</span><span class="sxs-lookup"><span data-stu-id="4b9ad-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="4b9ad-260">建立新的 web 網頁會使用*Site.Master*主版頁面並將其命名*OfficeAssignments.aspx*。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="4b9ad-261">加入下列標記以`Content`控制項，名為`Content2`:</span><span class="sxs-lookup"><span data-stu-id="4b9ad-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="4b9ad-262">請注意，在`DataKeyNames`屬性，指定標記`Timestamp`屬性，以及記錄索引鍵 (`InstructorID`)。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="4b9ad-263">指定屬性中的`DataKeyNames`屬性使控制項將它們儲存在控制項的狀態 （這是類似於檢視狀態），讓回傳的處理期間有可用的原始值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="4b9ad-264">如果沒有儲存`Timestamp`值，Entity Framework 不會有它的`Where`子句的 SQL`Update`命令。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="4b9ad-265">因此不會找到更新。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="4b9ad-266">如此一來，Entity Framework 會擲回例外狀況的開放式並行存取每次`OfficeAssignment`在更新的實體。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="4b9ad-267">開啟*OfficeAssignments.aspx.cs*並加入下列`using`資料存取層的陳述式：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="4b9ad-268">加入下列`Page_Init`方法，可啟用動態資料功能。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="4b9ad-269">也加入下列的處理常式，如`ObjectDataSource`控制項的`Updated`事件，若要檢查並行存取錯誤：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="4b9ad-270">在 OfficeAssignments 頁面中測試開放式並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="4b9ad-271">執行*OfficeAssignments.aspx*頁面。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="4b9ad-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="4b9ad-273">按一下**編輯**中一個資料列中的值變更和**位置**資料行。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="4b9ad-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="4b9ad-275">開啟新的瀏覽器視窗並執行資料頁 （複製的 URL 從第一個瀏覽器視窗的第二個瀏覽器視窗）。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="4b9ad-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="4b9ad-277">按一下**編輯**在同一個資料列您稍早編輯並變更**位置**為其他值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="4b9ad-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="4b9ad-279">在第二個瀏覽器視窗中，按一下 **更新**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="4b9ad-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="4b9ad-281">切換至第一個瀏覽器視窗，然後按一下**更新**。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="4b9ad-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="4b9ad-283">您看到錯誤訊息和**位置**值已更新為顯示的值，第二個瀏覽器視窗中的變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="4b9ad-284">EntityDataSource 控制項處理並行存取</span><span class="sxs-lookup"><span data-stu-id="4b9ad-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="4b9ad-285">`EntityDataSource`控制項包含可辨識資料模型中的並行設定的內建邏輯，並控點會更新，並據以刪除作業。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="4b9ad-286">不過，如同所有的例外狀況，您必須處理`OptimisticConcurrencyException`例外狀況自行以提供使用者易記的錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="4b9ad-287">接下來，您將設定*Courses.aspx*頁面 (它會使用`EntityDataSource`控制項) 允許更新和刪除作業，並顯示錯誤訊息，如果發生並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="4b9ad-288">`Course`實體沒有追蹤的資料行，所以您將使用相同的方法與您所執行的並行`Department`實體： 追蹤所有的非索引鍵屬性的值。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="4b9ad-289">開啟*SchoolModel.edmx*檔案。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="4b9ad-290">非索引鍵內容的`Course`實體 (`Title`， `Credits`，和`DepartmentID`)，將**並行模式**屬性`Fixed`。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="4b9ad-291">然後儲存並關閉 資料模型。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-291">Then save and close the data model.</span></span>

<span data-ttu-id="4b9ad-292">開啟*Courses.aspx*頁面並進行下列變更：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="4b9ad-293">在`CoursesEntityDataSource`控制項，加入`EnableUpdate="true"`和`EnableDelete="true"`屬性。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="4b9ad-294">該控制項的開頭標記就會類似下列範例如下：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="4b9ad-295">在`CoursesGridView`控制項，變更`DataKeyNames`屬性值，以`"CourseID,Title,Credits,DepartmentID"`。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="4b9ad-296">然後加入`CommandField`元素`Columns`顯示的項目**編輯**和**刪除**按鈕 (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`)。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="4b9ad-297">`GridView`控制項現在會類似下列的範例：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="4b9ad-298">執行網頁，並建立衝突情況，如同您先前在 [部門] 頁面。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="4b9ad-299">在兩個瀏覽器視窗中執行網頁中，按一下**編輯**在同一行中每個視窗中，並在每個不同變更。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="4b9ad-300">按一下**更新**在一個視窗，然後按一下**更新**另一個視窗中。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="4b9ad-301">當您按一下**更新**第二個階段中，您會看到錯誤頁面所產生的未處理的並行存取例外狀況。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="4b9ad-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="4b9ad-303">處理此錯誤的方式非常類似於如何處理它的`ObjectDataSource`控制項。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="4b9ad-304">開啟*Courses.aspx*  頁面上，然後在`CoursesEntityDataSource`控制項，指定的處理常式`Deleted`和`Updated`事件。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="4b9ad-305">控制項的開頭標記現在會類似下列的範例：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="4b9ad-306">之前`CoursesGridView`控制項，加入下列`ValidationSummary`控制項：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="4b9ad-307">在*Courses.aspx.cs*，新增`using`陳述式`System.Data`命名空間中，加入的方法，檢查對於並行存取例外狀況，並加入處理常式`EntityDataSource`控制項的`Updated`和`Deleted`處理常式。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="4b9ad-308">程式碼看起來如下所示：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="4b9ad-309">這個程式碼，您對唯一的差別`ObjectDataSource`控制項是在此情況下的並行存取例外狀況是在`Exception`屬性的事件引數物件，而不是在該例外狀況`InnerException`屬性。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="4b9ad-310">執行網頁，然後重新建立並行衝突。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="4b9ad-311">此時您會看到一則錯誤訊息：</span><span class="sxs-lookup"><span data-stu-id="4b9ad-311">This time you see an error message:</span></span>

<span data-ttu-id="4b9ad-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="4b9ad-313">如此即完成處理並行衝突的簡介。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="4b9ad-314">下一個教學課程將提供如何改善使用 Entity Framework 的 web 應用程式效能的指引。</span><span class="sxs-lookup"><span data-stu-id="4b9ad-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="4b9ad-315">[上一頁](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[下一頁](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="4b9ad-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
