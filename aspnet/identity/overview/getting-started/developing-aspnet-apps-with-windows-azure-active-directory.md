---
uid: identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
title: 開發與 Azure Active Directory 的 ASP.NET 應用程式 |Microsoft 文件
author: Rick-Anderson
description: Azure Active Directory 的 Microsoft ASP.NET tools 可讓您更簡單，好讓在 Azure 上裝載的 web 應用程式的驗證。 您可以使用 Azure 驗證...
ms.author: aspnetcontent
manager: wpickett
ms.date: 08/14/2014
ms.topic: article
ms.assetid: 457d7eaf-ee76-4ceb-9082-c7c1721435ad
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /identity/overview/getting-started/developing-aspnet-apps-with-windows-azure-active-directory
msc.type: authoredcontent
ms.openlocfilehash: 44bf29e099583bf9d49f2715d3ff4f748728ad8b
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 04/06/2018
---
<a name="developing-aspnet-apps-with-azure-active-directory"></a><span data-ttu-id="fe3e5-104">使用 Azure Active Directory 開發的 ASP.NET 應用程式</span><span class="sxs-lookup"><span data-stu-id="fe3e5-104">Developing ASP.NET Apps with Azure Active Directory</span></span>
====================
<span data-ttu-id="fe3e5-105">由[Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="fe3e5-105">by [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="fe3e5-106">Microsoft ASP.NET 工具的 Azure Active Directory 可簡化針對上主控的 web 應用程式啟用驗證[Azure](https://www.windowsazure.com/home/features/web-sites/)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-106">Microsoft ASP.NET tools for Azure Active Directory makes it simple to enable authentication for web applications hosted on [Azure](https://www.windowsazure.com/home/features/web-sites/).</span></span> <span data-ttu-id="fe3e5-107">您可以使用 Azure 驗證來驗證 Office 365 使用者，從您的組織，從您在內部部署 Active Directory 同步處理的公司帳戶或建立您自己自訂的 Azure Active Directory 網域中的使用者。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-107">You can use Azure Authentication to authenticate Office 365 users from your organization, corporate accounts synced from your on-premise Active Directory or users created in your own custom Azure Active Directory domain.</span></span> <span data-ttu-id="fe3e5-108">啟用 Windows Azure 驗證設定您的應用程式驗證使用者使用單一[Azure Active Directory](https://docs.microsoft.com/azure/active-directory/)租用戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-108">Enabling Windows Azure Authentication configures your application to authenticate users using a single [Azure Active Directory](https://docs.microsoft.com/azure/active-directory/) tenant.</span></span>
> 
>  <span data-ttu-id="fe3e5-109">本教學課程中所編寫的 Rick Anderson [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="fe3e5-109">This tutorial was written by Rick Anderson [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)</span></span>


<span data-ttu-id="fe3e5-110">本教學課程會示範如何建立 ASP.NET 應用程式設定為使用登入[Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-110">This tutorial will show you how to create an ASP.NET application that is configured for sign-on with [Azure Active Directory](https://msdn.microsoft.com/library/azure/mt168838.aspx) (Azure AD).</span></span> <span data-ttu-id="fe3e5-111">您也將學習如何呼叫 Graph API 來取得目前登入使用者的相關資訊及如何部署 Azure 應用程式。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-111">You will also learn how to call the Graph API to get information about the currently signed-in user and how to deploy the application to Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="fe3e5-112">必要條件</span><span class="sxs-lookup"><span data-stu-id="fe3e5-112">Prerequisites</span></span>

1. <span data-ttu-id="fe3e5-113">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express)或[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-113">[Visual Studio Express 2013 for Web](https://www.microsoft.com/visualstudio/eng/2013-downloads#d-2013-express) or [Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/2013-downloads).</span></span>
2. <span data-ttu-id="fe3e5-114">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) -3 或更高的更新為必要項。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-114">[Visual Studio 2013 Update 4](https://www.microsoft.com/download/details.aspx?id=44921) - Update 3 or higher is required.</span></span>
3. <span data-ttu-id="fe3e5-115">Azure 帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-115">An Azure account.</span></span> <span data-ttu-id="fe3e5-116">[按一下這裡](https://azure.microsoft.com/pricing/free-trial/)免費試用，如果您沒有帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-116">[Click here](https://azure.microsoft.com/pricing/free-trial/) for a free trial if you do not already have an account.</span></span>

## <a name="add-a-global-administrator-to-your-active-directory"></a><span data-ttu-id="fe3e5-117">加入您的 Active Directory 的全域管理員</span><span class="sxs-lookup"><span data-stu-id="fe3e5-117">Add a Global Administrator to your Active Directory</span></span>

1. <span data-ttu-id="fe3e5-118">登入[Azure 管理入口網站](https://manage.windowsazure.com/)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-118">Sign in to the [Azure Management Portal](https://manage.windowsazure.com/).</span></span>
2. <span data-ttu-id="fe3e5-119">包含所有的 Azure 帳戶**預設目錄**-按一下它，然後按一下 [**使用者**頂端的頁面] 索引標籤 （請參閱下面的影像）。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-119">All Azure accounts contain a **Default Directory** -- click on it, then click the **Users** tab at the top of the page (see image below).</span></span>
3. <span data-ttu-id="fe3e5-120">按一下 新增使用者。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-120">Click Add User.</span></span>  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image1.png)
4. <span data-ttu-id="fe3e5-121">建立新的使用者與**全域管理員**角色。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-121">Create a new user with the **Global Administrator** role.</span></span> <span data-ttu-id="fe3e5-122">按一下**使用者**從頂端功能表中，然後按一下**新增使用者**命令列上的按鈕。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-122">Click **Users** from the top menu, and then click the **Add User** button on the command bar.</span></span>
5. <span data-ttu-id="fe3e5-123">在**新增使用者** 對話方塊中，輸入新使用者的名稱，然後按一下向右箭號。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-123">In the **Add User** dialog, enter a name for the new user and then click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image2.png)
6. <span data-ttu-id="fe3e5-124">輸入使用者名稱和角色設定為**全域管理員**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-124">Enter the user name and set the role to **Global Administrator**.</span></span> <span data-ttu-id="fe3e5-125">全域管理員需要替代電子郵件地址進行復原密碼。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-125">Global administrators require an alternate email address for password recovery purposes.</span></span> <span data-ttu-id="fe3e5-126">在完成之後，按一下向右箭號。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-126">After you're finished, click the right arrow.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image3.png)
7. <span data-ttu-id="fe3e5-127">在對話方塊的 下一步 頁面上，按一下 **建立**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-127">On the next page of the dialog, click **Create**.</span></span> <span data-ttu-id="fe3e5-128">將建立新的使用者暫時密碼，並將其顯示在對話方塊中。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-128">A temporary password will be created for the new user and displayed in the dialog.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image4.png)  
  
   <span data-ttu-id="fe3e5-129">儲存密碼，您必須變更密碼之後的第一個記錄檔中。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-129">Save the password, you will be required to change the password after the first log in.</span></span> <span data-ttu-id="fe3e5-130">下圖顯示新的系統管理員帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-130">The following image shows the new admin account.</span></span> <span data-ttu-id="fe3e5-131">您必須使用 Azure Active Directory 登入您的應用程式，而不是 Microsoft 帳戶也會顯示此頁面上。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-131">You must use the Azure Active Directory to log into your app, not the Microsoft account also shown on this page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image5.png)

## <a name="create-an-aspnet-application"></a><span data-ttu-id="fe3e5-132">建立 ASP.NET 應用程式</span><span class="sxs-lookup"><span data-stu-id="fe3e5-132">Create an ASP.NET Application</span></span>

<span data-ttu-id="fe3e5-133">下列步驟會使用[Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747)，而且需要[Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-133">The following steps use [Visual Studio Express 2013 for Web](https://www.microsoft.com/download/details.aspx?id=40747), and requires [Visual Studio 2013 Update 3](https://www.microsoft.com/download/details.aspx?id=43721).</span></span>

1. <span data-ttu-id="fe3e5-134">在 Visual Studio 中，按一下 **檔案**然後**新專案**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-134">In Visual Studio, click **File** and then **New Project**.</span></span> <span data-ttu-id="fe3e5-135">在**新專案**對話方塊中，選取 Visual C# Web 專案從左窗格中，按一下**確定**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-135">On the **New Project** dialog, select the Visual C# Web project from the left menu and click **OK**.</span></span> <span data-ttu-id="fe3e5-136">您也可以取消核取**加入 Application Insights 加入專案**如果您不想為您的應用程式的功能。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-136">You may also want to uncheck the **Add Application Insights to Project** if you don't want the functionality for your application.</span></span>
2. <span data-ttu-id="fe3e5-137">在**新增 ASP.NET 專案**對話方塊中，選取**MVC**，然後按一下 **變更驗證**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-137">In the **New ASP.NET Project** dialog, select **MVC**, and then click **Change Authentication**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image6.png)
3. <span data-ttu-id="fe3e5-138">在**變更驗證**對話方塊中，選取**組織帳戶**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-138">On the **Change Authentication** dialog, select **Organizational Accounts**.</span></span> <span data-ttu-id="fe3e5-139">這些選項可用來自動向 Azure AD 中註冊您的應用程式，以及自動設定您的應用程式與 Azure AD 整合。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-139">These options can be used to automatically register your application with Azure AD as well as automatically configure your application to integrate with Azure AD.</span></span> <span data-ttu-id="fe3e5-140">您不必使用**變更驗證**對話方塊來註冊及設定您的應用程式，但它可以更容易。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-140">You don't have to use the **Change Authentication** dialog to register and configure your application, but it makes it much easier.</span></span> <span data-ttu-id="fe3e5-141">如果您使用 Visual Studio 2012 比方說，您就可以仍然可以手動在 Azure 管理入口網站中註冊應用程式，並更新其設定以使用 Azure AD 整合。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-141">If you are using Visual Studio 2012 for example, you can still manually register the application in the Azure Management Portal and update its configuration to integrate with Azure AD.</span></span>  
   <span data-ttu-id="fe3e5-142">在下拉式功能表中，選取**雲端-單一組織**和**單一登入，讀取目錄資料**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-142">In the drop-down menus, select **Cloud - Single Organization** and **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="fe3e5-143">為您的 Azure AD 目錄，例如 （在下列映像） 輸入的網域*aricka0yahoo.onmicrosoft.com*，然後按一下 **確定**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-143">Enter the domain for your Azure AD directory, for example (in the images below) *aricka0yahoo.onmicrosoft.com*, and then click **OK**.</span></span> <span data-ttu-id="fe3e5-144">您可以從 [網域] 索引標籤預設目錄，在 azure 入口網站來取得網域名稱 （請參閱下圖中，向下）。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-144">You can get the domain name from the Domains tab for the Default Directory on the azure portal (see the next image down).</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image7.png)  
  
   <span data-ttu-id="fe3e5-145">下圖顯示從 Azure 入口網站的網域名稱。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-145">The following image shows the domain name from the Azure portal.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image8.png)  

    > [!NOTE]
    > <span data-ttu-id="fe3e5-146">您可以選擇性地設定會依序按一下 Azure AD 中註冊應用程式識別碼 URI**更多選項**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-146">You can optionally configure the Application ID URI that will be registered in Azure AD by clicking **More Options**.</span></span> <span data-ttu-id="fe3e5-147">應用程式識別碼 URI 是應用程式，其 Azure AD 中註冊，並由應用程式用來與 Azure AD 進行通訊時識別本身的唯一識別碼。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-147">The App ID URI is the unique identifier for an application, which is registered in Azure AD and used by the application to identify itself when communicating with Azure AD.</span></span> <span data-ttu-id="fe3e5-148">如需應用程式識別碼 URI 和已註冊的應用程式的其他屬性的詳細資訊，請參閱[本主題](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-148">For more information about the App ID URI and other properties of registered applications, see [this topic](https://msdn.microsoft.com/library/azure/dn499820.aspx#BKMK_Registering).</span></span> <span data-ttu-id="fe3e5-149">按一下 [應用程式識別碼 URI] 欄位下方的核取方塊，您也可以選擇使用相同的應用程式識別碼 URI 的 Azure AD 中覆寫現有的註冊。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-149">By clicking the checkbox below the App ID URI field, you can also choose to overwrite an existing registration in Azure AD that uses the same App ID URI.</span></span>
4. <span data-ttu-id="fe3e5-150">按一下後**確定**、 登入 對話方塊隨即出現，以及您要使用的全域管理員帳戶 （不與您訂用帳戶相關聯的 Microsoft 帳戶） 登入。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-150">After clicking **OK**, a sign-in dialog will appear, and you'll need to sign in using a Global Administrator account (not the Microsoft account associated with your subscription).</span></span> <span data-ttu-id="fe3e5-151">如果您先前建立新的系統管理員帳戶，您將必須變更密碼，然後登入一次使用新的密碼。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-151">If you created a new Administrator account earlier, you'll be required to change the password and then sign in again using the new password.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image9.png)
5. <span data-ttu-id="fe3e5-152">您已成功通過驗證之後，**新增 ASP.NET 專案**對話方塊會顯示您的驗證選項 (**組織**) 並將新的應用程式的目錄註冊 (*aricka0yahoo.onmicrosoft.com*在下圖)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-152">After you've successfully authenticated, the **New ASP.NET Project** dialog will show your authentication choice (**Organizational** ) and the directory where the new application will be registered (*aricka0yahoo.onmicrosoft.com* in the image below).</span></span> <span data-ttu-id="fe3e5-153">以下這項資訊，請選取標示的核取方塊**雲端中的主機**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-153">Below this information, select the checkbox labeled **Host in the cloud**.</span></span> <span data-ttu-id="fe3e5-154">如果選取此核取方塊，則專案會佈建為 Azure web 應用程式，並將簡單發行更新版本的啟用。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-154">If this checkbox is selected, the project will be provisioned as an Azure web app and will be enabled for easy publishing later.</span></span> <span data-ttu-id="fe3e5-155">按一下 [確定 **Deploying Office Solutions**]。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-155">Click **OK**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image10.png)
6. <span data-ttu-id="fe3e5-156">**設定 Azure 網站**對話方塊隨即出現，使用系統自動產生站台名稱和區域。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-156">The **Configure Azure Website** dialog will appear, using an auto-generated site name and region.</span></span> <span data-ttu-id="fe3e5-157">也請注意您目前登入對話方塊中的帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-157">Also note the account you're currently signed into in the dialog.</span></span> <span data-ttu-id="fe3e5-158">您想要確定此帳戶是一個 Azure 訂用帳戶附加到，通常是 Microsoft 帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-158">You want to make sure that this account is the one that your Azure subscription is attached to, typically a Microsoft account.</span></span>

    > [!NOTE]
    > <span data-ttu-id="fe3e5-159">這個專案需要資料庫。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-159">This project requires a database.</span></span> <span data-ttu-id="fe3e5-160">您必須選取其中一個現有的資料庫，或是另外新建一個。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-160">You need to select one of your existing databases, or create a new one.</span></span> <span data-ttu-id="fe3e5-161">需要資料庫，因為專案已經使用本機資料庫檔案來儲存少量驗證組態資料。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-161">A database is required because the project already uses a local database file to store a small amount of authentication configuration data.</span></span> <span data-ttu-id="fe3e5-162">當您部署至 Azure 網站應用程式時，此資料庫未隨附部署，因此您必須選擇一個可存取位於雲端。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-162">When you deploy the application to an Azure Website, this database isn't packaged with the deployment, so you need to choose one that's accessible in the cloud.</span></span> <span data-ttu-id="fe3e5-163">按一下 [確定 **Deploying Office Solutions**]。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-163">Click **OK**.</span></span>

    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image11.png)
7. <span data-ttu-id="fe3e5-164">將建立專案，和您的驗證選項和 web 應用程式選項將會自動設定與專案。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-164">The project will be created, and your authentication options and web app options will be automatically configured with the project.</span></span> <span data-ttu-id="fe3e5-165">此程序完成後，請執行專案在本機按**^ F5**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-165">Once this process has completed, run the project locally by pressing **^F5**.</span></span> <span data-ttu-id="fe3e5-166">您必須使用您的組織帳戶登入。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-166">You will be required to sign in using your organizational account.</span></span> <span data-ttu-id="fe3e5-167">提供您稍早建立的帳戶使用者名稱和密碼，然後按一下**登入**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-167">Provide the username and password for the account you created earlier and click **Sign in**.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image12.png)
8. <span data-ttu-id="fe3e5-168">之後成功登入，ASP.NET 網站會顯示您藉由顯示在頁面的右上角的使用者名稱驗證。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-168">After successful sign in, the ASP.NET site will show that you've authenticated by displaying the username in the top right corner of the page.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image13.png)  
  
   <span data-ttu-id="fe3e5-169">如果您收到錯誤：</span><span class="sxs-lookup"><span data-stu-id="fe3e5-169">If you get the error:</span></span>  
   <span data-ttu-id="fe3e5-170">值不可為 null 或空白。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-170">Value cannot be null or empty.</span></span> <span data-ttu-id="fe3e5-171">參數名稱： Externallink></span><span class="sxs-lookup"><span data-stu-id="fe3e5-171">Parameter name: linkText</span></span>   
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image14.png)  
  
   <span data-ttu-id="fe3e5-172">請參閱[偵錯](#dbg)教學課程的最後一節。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-172">see the [debug](#dbg) section at the end of the tutorial.</span></span>

## <a name="basics-of-the-graph-api"></a><span data-ttu-id="fe3e5-173">Graph API 的基本概念</span><span class="sxs-lookup"><span data-stu-id="fe3e5-173">Basics of the Graph API</span></span>

<span data-ttu-id="fe3e5-174">[Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx)是用來執行 CRUD 和其他物件上的作業，您的 Azure AD 目錄中的程式設計介面。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-174">[The Graph API](https://msdn.microsoft.com/library/azure/hh974476.aspx) is the programmatic interface used to perform CRUD and other operations on objects in your Azure AD directory.</span></span> <span data-ttu-id="fe3e5-175">如果您選取驗證的組織帳戶選項，在 Visual Studio 2013 中建立新的專案時，您的應用程式將已設定為呼叫 Graph API。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-175">If you select an Organizational Account option for authentication when creating a new project in Visual Studio 2013, your application will already be configured to call the Graph API.</span></span> <span data-ttu-id="fe3e5-176">本節簡短說明 Graph API 的運作方式。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-176">This section briefly shows you how the Graph API works.</span></span>

1. <span data-ttu-id="fe3e5-177">在執行的應用程式中按一下頂端的登入的使用者名稱頁面的權限。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-177">In your running application, click on the name of the signed-in user at the top right of the page.</span></span> <span data-ttu-id="fe3e5-178">這會帶您前往 使用者設定檔頁面上，這可能會在首頁控制器的動作。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-178">This will take you to the User Profile page, which is an action on the Home Controller.</span></span> <span data-ttu-id="fe3e5-179">您會發現資料表包含您稍早建立的系統管理員帳戶相關的使用者資訊。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-179">You'll notice that the table contains user information about the administrator account you created earlier.</span></span> <span data-ttu-id="fe3e5-180">這項資訊會儲存在您的目錄，並會呼叫 Graph API 來載入頁面時，擷取這項資訊。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-180">This information is stored in your directory, and the Graph API is called to retrieve this information when the page loads.</span></span>   
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image15.png)
2. <span data-ttu-id="fe3e5-181">返回 Visual Studio，並展開**控制器**資料夾，然後開啟**HomeController.cs**檔案。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-181">Go back to Visual Studio and expand the **Controllers** folder and then open the **HomeController.cs** file.</span></span> <span data-ttu-id="fe3e5-182">您會看到**UserProfile()**包含擷取權杖，然後再呼叫 Graph API 的程式碼的動作。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-182">You'll see a **UserProfile()** action that contains code to retrieve a token and then call the Graph API.</span></span> <span data-ttu-id="fe3e5-183">此程式碼會複製如下：</span><span class="sxs-lookup"><span data-stu-id="fe3e5-183">This code is duplicated below:</span></span> 

    [!code-csharp[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample1.cs?highlight=22)]

    <span data-ttu-id="fe3e5-184">若要呼叫 Graph API，您需要擷取語彙基元。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-184">To call the Graph API, you first need to retrieve a token.</span></span> <span data-ttu-id="fe3e5-185">擷取語彙基元時，它的字串值必須附加的 Graph API 的所有後續要求的 Authorization 標頭。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-185">When the token is retrieved, its string value must be appended in the Authorization header for all subsequent requests to the Graph API.</span></span> <span data-ttu-id="fe3e5-186">上方的程式碼的大部分處理向 Azure AD 取得權杖，使用權杖來呼叫 Graph API，以與然後轉換回應，讓它可以顯示在 檢視詳細的資料。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-186">Most of the code above handles the details of authenticating to Azure AD to get a token, using the token to make a call to the Graph API, and then transforming the response so that it can be presented in the View.</span></span>

    <span data-ttu-id="fe3e5-187">討論的最相關的部分會反白顯示的下行： `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-187">The most relevant portion for discussion is the following highlighted line: `UserProfile profile = JsonConvert.DeserializeObject<UserProfile>(responseString);`.</span></span> <span data-ttu-id="fe3e5-188">這一行表示已經還原序列化來自 JSON 回應，並顯示在檢視中的使用者名稱。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-188">This line represents the name of the user, which has been deserialized from the JSON response and is presented in the View.</span></span>

    <span data-ttu-id="fe3e5-189">您可以呼叫 Graph API 使用 HttpClient 和處理未經處理資料，但更簡單的方法是使用[圖形用戶端程式庫可透過 NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-189">You can call the Graph API using HttpClient and handle the raw data yourself, but an easier way is to use the [Graph Client Library which is available via NuGet](http://www.nuget.org/packages/Microsoft.Azure.ActiveDirectory.GraphClient/).</span></span> <span data-ttu-id="fe3e5-190">用戶端程式庫會處理未經處理的 HTTP 要求和所傳回資料的轉換，並讓您更容易使用 Graph API 在.NET 環境中運作。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-190">The Client Library handles the raw HTTP requests and the transformation of the returned data for you, and makes it much easier to work with the Graph API in a .NET environment.</span></span> <span data-ttu-id="fe3e5-191">請參閱上相關的 Graph API 的程式碼範例[GitHub。](https://github.com/AzureADSamples)</span><span class="sxs-lookup"><span data-stu-id="fe3e5-191">See the related Graph API code samples on [GitHub.](https://github.com/AzureADSamples)</span></span>

## <a name="deploy-the-application-to-azure"></a><span data-ttu-id="fe3e5-192">部署至 Azure 應用程式</span><span class="sxs-lookup"><span data-stu-id="fe3e5-192">Deploy the Application to Azure</span></span>

<span data-ttu-id="fe3e5-193">下列步驟將說明如何部署 Azure 應用程式。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-193">The following steps will show you how to deploy the application to Azure.</span></span> <span data-ttu-id="fe3e5-194">在先前步驟中，您新的專案以連接 web 應用程式在 Azure 上，讓它準備好可以發佈幾個步驟中。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-194">In the earlier steps, you connected your new project with a web app on Azure, so it's ready to be published in just a few steps.</span></span>

1. <span data-ttu-id="fe3e5-195">在 Visual Studio 中，以滑鼠右鍵按一下專案，然後選取**發行**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-195">In Visual Studio, right-click on the project and select **Publish**.</span></span> <span data-ttu-id="fe3e5-196">**發行 Web**對話方塊會顯示每個設定。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-196">The **Publish Web** dialog will appear with each setting already configured.</span></span> <span data-ttu-id="fe3e5-197">按一下**下一步**按鈕移至**設定**頁面。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-197">Click on the **Next** button to go to the **Settings** page.</span></span> <span data-ttu-id="fe3e5-198">您可能會提示您進行驗證。請確定您使用您的 Azure 訂用帳戶 （通常是 Microsoft 帳戶） 和不您稍早建立的組織帳戶進行驗證。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-198">You may be prompted to authenticate; make sure you authenticate using your Azure subscription account (typically a Microsoft account) and not the organizational account you created earlier.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image16.png)
2. <span data-ttu-id="fe3e5-199">請檢查**啟用組織驗證**選項。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-199">Check the **Enable Organizational Authentication** option.</span></span> <span data-ttu-id="fe3e5-200">在**網域**欄位中，輸入您的目錄的網域。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-200">In the **Domain** field, enter the domain for your directory.</span></span> <span data-ttu-id="fe3e5-201">從**存取層級**下拉式清單中，選取**單一登入，讀取目錄資料**。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-201">From the **Access Level** drop-down, select **Single Sign On, Read directory data**.</span></span> <span data-ttu-id="fe3e5-202">您會注意到您所使用的先前資料庫中便已自行填入**資料庫**> 一節。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-202">You'll notice that the previous database you used is already populated in the **Databases** section.</span></span> <span data-ttu-id="fe3e5-203">按一下 [發行] 。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-203">Click **Publish**.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image17.png)
3. <span data-ttu-id="fe3e5-204">Visual Studio 會開始部署您的網站，則會出現新的瀏覽器視窗。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-204">Visual Studio will begin deploying your website, and then a new browser window will appear.</span></span> <span data-ttu-id="fe3e5-205">您可能會提示您再次向您的目錄。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-205">You may be prompted to authenticate to your directory once again.</span></span> <span data-ttu-id="fe3e5-206">您已驗證之後，您將會重新導向至新發行的網站在 Azure 上。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-206">Once you've authenticated, you'll be redirected to your newly published website on Azure.</span></span>  
  
    ![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image18.png)

<a id="dbg"></a>
## <a name="debugging-the-app"></a><span data-ttu-id="fe3e5-207">偵錯應用程式</span><span class="sxs-lookup"><span data-stu-id="fe3e5-207">Debugging the app</span></span>

<span data-ttu-id="fe3e5-208">如果您收到下列錯誤：</span><span class="sxs-lookup"><span data-stu-id="fe3e5-208">If you get the following error:</span></span>   
 <span data-ttu-id="fe3e5-209">值不可為 null 或空白。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-209">Value cannot be null or empty.</span></span> <span data-ttu-id="fe3e5-210">參數名稱： Externallink></span><span class="sxs-lookup"><span data-stu-id="fe3e5-210">Parameter name: linkText</span></span>   
   
![](developing-aspnet-apps-with-windows-azure-active-directory/_static/image19.png)  
  

<span data-ttu-id="fe3e5-211">中的程式碼取代*_layout.cshtml\\_LoginPartial.cshtml*以下列檔案：</span><span class="sxs-lookup"><span data-stu-id="fe3e5-211">Replace the code in the *Views\Shared\\_LoginPartial.cshtml* file with the following:</span></span>

[!code-cshtml[Main](developing-aspnet-apps-with-windows-azure-active-directory/samples/sample2.cshtml?highlight=1-8,15-16)]

<span data-ttu-id="fe3e5-212">之後執行應用程式時，如果登入的使用者顯示 「 Null 使用者 」，請先登出，並以登入您稍早建立的 Active Directory 帳戶。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-212">After running the app, if the logged in user shows "Null User", sign out, and sign back in with the Active Directory account you created earlier.</span></span>

<span data-ttu-id="fe3e5-213">絕佳教學課程，請遵循是 Rick Rainey[深入探討： Azure 網站和組織使用 Azure AD 的驗證](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)。</span><span class="sxs-lookup"><span data-stu-id="fe3e5-213">An excellent tutorial to follow is Rick Rainey's [Deep Dive: Azure Websites and Organizational Authentication using Azure AD](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/).</span></span>

## <a name="more-information"></a><span data-ttu-id="fe3e5-214">更多資訊</span><span class="sxs-lookup"><span data-stu-id="fe3e5-214">More Information</span></span>

- [<span data-ttu-id="fe3e5-215">深入探討： Azure 網站和組織使用 Azure AD 的驗證</span><span class="sxs-lookup"><span data-stu-id="fe3e5-215">Deep Dive: Azure Websites and Organizational Authentication using Azure AD</span></span>](http://rickrainey.com/2014/08/19/deep-dive-azure-websites-and-organizational-authentication-using-azure-ad/)
- [<span data-ttu-id="fe3e5-216">Azure AD Graph API 概觀</span><span class="sxs-lookup"><span data-stu-id="fe3e5-216">Azure AD Graph API Overview</span></span>](https://msdn.microsoft.com/library/azure/hh974476.aspx)
- [<span data-ttu-id="fe3e5-217">在 Azure AD 中的驗證案例</span><span class="sxs-lookup"><span data-stu-id="fe3e5-217">Authentication Scenarios in Azure AD</span></span>](https://msdn.microsoft.com/library/azure/dn499820.aspx)
- [<span data-ttu-id="fe3e5-218">GitHub 上的 azure AD 程式碼範例</span><span class="sxs-lookup"><span data-stu-id="fe3e5-218">Azure AD Code Samples on GitHub</span></span>](https://github.com/AzureADSamples)
