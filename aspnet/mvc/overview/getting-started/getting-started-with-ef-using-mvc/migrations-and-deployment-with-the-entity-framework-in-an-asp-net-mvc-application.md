---
uid: mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
title: "Code First 移轉，以及使用的 Entity Framework 中的 ASP.NET MVC 應用程式部署 |Microsoft 文件"
author: tdykstra
description: "Contoso 大學範例 web 應用程式示範如何建立 ASP.NET MVC 5 應用程式使用 Entity Framework 6 Code First 和 Visual Studio..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2014
ms.topic: article
ms.assetid: d4dfc435-bda6-4621-9762-9ba270f8de4e
ms.technology: dotnet-mvc
ms.prod: .net-framework
msc.legacyurl: /mvc/overview/getting-started/getting-started-with-ef-using-mvc/migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application
msc.type: authoredcontent
ms.openlocfilehash: 2294f2aba3f765d7849d1f407e85f424dc8b2518
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/10/2017
---
<a name="code-first-migrations-and-deployment-with-the-entity-framework-in-an-aspnet-mvc-application"></a><span data-ttu-id="02b62-103">Code First 移轉，以及使用的 Entity Framework 中的 ASP.NET MVC 應用程式部署</span><span class="sxs-lookup"><span data-stu-id="02b62-103">Code First Migrations and Deployment with the Entity Framework in an ASP.NET MVC Application</span></span>
====================
<span data-ttu-id="02b62-104">由[Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="02b62-104">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

<span data-ttu-id="02b62-105">[下載完成的專案](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8)或[下載 PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span><span class="sxs-lookup"><span data-stu-id="02b62-105">[Download Completed Project](http://code.msdn.microsoft.com/ASPNET-MVC-Application-b01a9fe8) or [Download PDF](http://download.microsoft.com/download/0/F/B/0FBFAA46-2BFD-478F-8E56-7BF3C672DF9D/Getting%20Started%20with%20Entity%20Framework%206%20Code%20First%20using%20MVC%205.pdf)</span></span>

> <span data-ttu-id="02b62-106">Contoso 大學範例 web 應用程式示範如何建立使用 Entity Framework 6 Code First 和 Visual Studio 2013 的 ASP.NET MVC 5 應用程式。</span><span class="sxs-lookup"><span data-stu-id="02b62-106">The Contoso University sample web application demonstrates how to create ASP.NET MVC 5 applications using the Entity Framework 6 Code First and Visual Studio 2013.</span></span> <span data-ttu-id="02b62-107">教學課程系列的相關資訊，請參閱[系列的第一個教學課程](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md)。</span><span class="sxs-lookup"><span data-stu-id="02b62-107">For information about the tutorial series, see [the first tutorial in the series](creating-an-entity-framework-data-model-for-an-asp-net-mvc-application.md).</span></span>

<span data-ttu-id="02b62-108">到目前為止已被本機執行應用程式在 IIS Express 在開發電腦上。</span><span class="sxs-lookup"><span data-stu-id="02b62-108">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="02b62-109">若要讓實際的應用程式供其他人透過網際網路使用，您必須將它部署至 web 主控提供者。</span><span class="sxs-lookup"><span data-stu-id="02b62-109">To make a real application available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="02b62-110">在本教學課程中，您將部署在 Azure 中雲端 Contoso 大學應用程式。</span><span class="sxs-lookup"><span data-stu-id="02b62-110">In this tutorial, you'll deploy the Contoso University application to the cloud in Azure.</span></span>

<span data-ttu-id="02b62-111">本教學課程包含下列各節：</span><span class="sxs-lookup"><span data-stu-id="02b62-111">The tutorial contains the following sections:</span></span>

- <span data-ttu-id="02b62-112">啟用 Code First 移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-112">Enable Code First Migrations.</span></span> <span data-ttu-id="02b62-113">移轉功能可讓您變更資料模型，並將變更部署到實際執行，藉由更新資料庫結構描述，而不需要卸除並重新建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-113">The Migrations feature enables you to change the data model and deploy your changes to production by updating the database schema without having to drop and re-create the database.</span></span>
- <span data-ttu-id="02b62-114">部署至 Azure。</span><span class="sxs-lookup"><span data-stu-id="02b62-114">Deploy to Azure.</span></span> <span data-ttu-id="02b62-115">這個步驟是選擇性的;您可以繼續，其餘教學課程，而不需要部署專案。</span><span class="sxs-lookup"><span data-stu-id="02b62-115">This step is optional; you can continue with the remaining tutorials without having deployed the project.</span></span>

<span data-ttu-id="02b62-116">我們建議您部署中，使用持續整合程序與原始檔控制，但本教學課程並未涵蓋這些主題。</span><span class="sxs-lookup"><span data-stu-id="02b62-116">We recommend that you use a continuous integration process with source control for deployment, but this tutorial does not cover those topics.</span></span> <span data-ttu-id="02b62-117">如需詳細資訊，請參閱[原始檔控制](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control)和[連續整合](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery)章節[建置真實世界雲端應用程式與 Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction)電子書。</span><span class="sxs-lookup"><span data-stu-id="02b62-117">For more information, see the [source control](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control) and [continuous integration](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) chapters of the [Building Real-World Cloud Apps with Azure](xref:aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/introduction) e-book.</span></span>

## <a name="enable-code-first-migrations"></a><span data-ttu-id="02b62-118">啟用 Code First 移轉</span><span class="sxs-lookup"><span data-stu-id="02b62-118">Enable Code First Migrations</span></span>

<span data-ttu-id="02b62-119">當您開發新的應用程式時，您的資料模型變更常見問題，以及每次將模型變更時，它會取得與資料庫同步處理。</span><span class="sxs-lookup"><span data-stu-id="02b62-119">When you develop a new application, your data model changes frequently, and each time the model changes, it gets out of sync with the database.</span></span> <span data-ttu-id="02b62-120">您已設定 Entity Framework 自動卸除並重新建立每次變更資料模型資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-120">You have configured the Entity Framework to automatically drop and re-create the database each time you change the data model.</span></span> <span data-ttu-id="02b62-121">當您新增、 移除或變更實體類別或變更您`DbContext`類別，在下次執行應用程式它自動刪除現有的資料庫，然後建立一個新符合模型，並設測試資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-121">When you add, remove, or change entity classes or change your `DbContext` class, the next time you run the application it automatically deletes your existing database, creates a new one that matches the model, and seeds it with test data.</span></span>

<span data-ttu-id="02b62-122">讓資料庫保持同步資料模型的這個方法適用於也直到您將部署到生產環境應用程式。</span><span class="sxs-lookup"><span data-stu-id="02b62-122">This method of keeping the database in sync with the data model works well until you deploy the application to production.</span></span> <span data-ttu-id="02b62-123">當應用程式在生產環境中執行時，通常正在儲存您想要保留，且您不想遺失的所有項目每次您進行變更，例如加入新的資料行的資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-123">When the application is running in production, it is usually storing data that you want to keep, and you don't want to lose everything each time you make a change such as adding a new column.</span></span> <span data-ttu-id="02b62-124">[Code First 移轉](https://msdn.microsoft.com/data/jj591621)功能藉由啟用程式碼第一次更新資料庫結構描述，而不是卸除並重新建立資料庫來解決這個問題。</span><span class="sxs-lookup"><span data-stu-id="02b62-124">The [Code First Migrations](https://msdn.microsoft.com/data/jj591621) feature solves this problem by enabling Code First to update the database schema instead of dropping and re-creating the database.</span></span> <span data-ttu-id="02b62-125">在本教學課程中，您要部署應用程式，並準備，您將會啟用移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-125">In this tutorial, you'll deploy the application, and to prepare for that you'll enable Migrations.</span></span>

1. <span data-ttu-id="02b62-126">停用您稍早標記為註解或刪除設定的初始設定式`contexts`您新增至應用程式 Web.config 檔案的項目。</span><span class="sxs-lookup"><span data-stu-id="02b62-126">Disable the initializer that you set up earlier by commenting out or deleting the `contexts` element that you added to the application Web.config file.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample1.xml?highlight=2,6)]
2. <span data-ttu-id="02b62-127">應用程式中而且*Web.config*檔案中，將連接字串中的資料庫名稱變更為 ContosoUniversity2。</span><span class="sxs-lookup"><span data-stu-id="02b62-127">Also in the application *Web.config* file, change the name of the database in the connection string to ContosoUniversity2.</span></span>

    [!code-xml[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample2.xml?highlight=2)]

    <span data-ttu-id="02b62-128">這項變更設定，讓第一次移轉將會建立新的資料庫專案。</span><span class="sxs-lookup"><span data-stu-id="02b62-128">This change sets up the project so that the first migration will create a new database.</span></span> <span data-ttu-id="02b62-129">這不是必要，但您稍後就會看到的原因是個不錯的主意。</span><span class="sxs-lookup"><span data-stu-id="02b62-129">This isn't required but you'll see later why it's a good idea.</span></span>
3. <span data-ttu-id="02b62-130">從**工具**功能表上，按一下 **程式庫套件管理員**然後**Package Manager Console**。</span><span class="sxs-lookup"><span data-stu-id="02b62-130">From the **Tools** menu, click **Library Package Manager** and then **Package Manager Console**.</span></span>

    ![Selecting_Package_Manager_Console](https://asp.net/media/4336350/1pm.png)
4. <span data-ttu-id="02b62-132">在`PM>`提示字元輸入下列命令：</span><span class="sxs-lookup"><span data-stu-id="02b62-132">At the `PM>` prompt enter the following commands:</span></span>

    `enable-migrations`  
    `add-migration InitialCreate`

    ![enable-migrations 命令](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image1.png)

    <span data-ttu-id="02b62-134">`enable-migrations`命令會建立*移轉*資料夾 ContosoUniversity 專案中，它會將該資料夾中放*configuration.cs 中*設定移轉，您可以編輯的檔案。</span><span class="sxs-lookup"><span data-stu-id="02b62-134">The `enable-migrations` command creates a *Migrations* folder in the ContosoUniversity project, and it puts in that folder a *Configuration.cs* file that you can edit to configure Migrations.</span></span>

    <span data-ttu-id="02b62-135">(如果您錯過上述步驟，以引導您變更資料庫名稱時，移轉會尋找現有的資料庫，並自動執行`add-migration`命令。</span><span class="sxs-lookup"><span data-stu-id="02b62-135">(If you missed the step above that directs you to change the database name, Migrations will find the existing database and automatically do the `add-migration` command.</span></span> <span data-ttu-id="02b62-136">[確定]，它只是表示部署資料庫之前，您將不會執行測試移轉程式碼。</span><span class="sxs-lookup"><span data-stu-id="02b62-136">That's OK, it just means you won't run a test of the migrations code before you deploy the database.</span></span> <span data-ttu-id="02b62-137">稍後當您執行`update-database`命令，因為資料庫已經存在，所以會發生任何事。)</span><span class="sxs-lookup"><span data-stu-id="02b62-137">Later when you run the `update-database` command nothing will happen because the database will already exist.)</span></span>

    ![Migrations 資料夾](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image2.png)

    <span data-ttu-id="02b62-139">初始設定式類別更早版本，您所看到的一樣`Configuration`類別包含`Seed`方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-139">Like the initializer class that you saw earlier, the `Configuration` class includes a `Seed` method.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample3.cs)]

    <span data-ttu-id="02b62-140">目的[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法是，您可以插入或更新之後的程式碼第一次建立或更新資料庫的測試資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-140">The purpose of the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is to enable you to insert or update test data after Code First creates or updates the database.</span></span> <span data-ttu-id="02b62-141">建立資料庫時，每當資料庫結構描述資料模型變更之後更新時，會呼叫方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-141">The method is called when the database is created and every time the database schema is updated after a data model change.</span></span>

### <a name="set-up-the-seed-method"></a><span data-ttu-id="02b62-142">設定種子方法</span><span class="sxs-lookup"><span data-stu-id="02b62-142">Set up the Seed Method</span></span>

<span data-ttu-id="02b62-143">當您卸除並重新建立資料庫的每一個資料模型變更，您使用初始設定式類別的`Seed`插入測試資料，因為每個模型變更之後卸除資料庫的方法和測試的所有資料都會遺失。</span><span class="sxs-lookup"><span data-stu-id="02b62-143">When you are dropping and re-creating the database for every data model change, you use the initializer class's `Seed` method to insert test data, because after every model change the database is dropped and all the test data is lost.</span></span> <span data-ttu-id="02b62-144">Code First 移轉，資料會保留在資料庫變更後的測試，包括中的測試資料[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法通常不是必要。</span><span class="sxs-lookup"><span data-stu-id="02b62-144">With Code First Migrations, test data is retained after database changes, so including test data in the [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method is typically not necessary.</span></span> <span data-ttu-id="02b62-145">事實上，您不想`Seed`方法插入的測試資料，如果您將使用移轉將資料庫部署到生產環境，因為`Seed`方法會在生產環境中執行。</span><span class="sxs-lookup"><span data-stu-id="02b62-145">In fact, you don't want the `Seed` method to insert test data if you'll be using Migrations to deploy the database to production, because the `Seed` method will run in production.</span></span> <span data-ttu-id="02b62-146">在此情況下您想`Seed`插入資料庫，您需要的資料在生產環境中的方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-146">In that case you want the `Seed` method to insert into the database only the data that you need in production.</span></span> <span data-ttu-id="02b62-147">例如，您可能想要包括在實際的部門名稱的資料庫`Department`資料表在生產環境中可以使用應用程式時。</span><span class="sxs-lookup"><span data-stu-id="02b62-147">For example, you might want the database to include actual department names in the `Department` table when the application becomes available in production.</span></span>

<span data-ttu-id="02b62-148">此教學課程中，您將會使用移轉部署，但您`Seed`方法將還是插入測試資料，以便更輕鬆地查看應用程式的功能而不需要以手動方式插入大量資料的運作方式。</span><span class="sxs-lookup"><span data-stu-id="02b62-148">For this tutorial, you'll be using Migrations for deployment, but your `Seed` method will insert test data anyway in order to make it easier to see how application functionality works without having to manually insert a lot of data.</span></span>

1. <span data-ttu-id="02b62-149">取代內容*configuration.cs 中*以下列程式碼，將測試資料載入至新的資料庫檔案。</span><span class="sxs-lookup"><span data-stu-id="02b62-149">Replace the contents of the *Configuration.cs* file with the following code, which will load test data into the new database.</span></span> 

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample4.cs)]

    <span data-ttu-id="02b62-150">[種子](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx)方法會採用做為輸入參數，為資料庫物件和方法中的程式碼會使用該物件加入資料庫中的新實體。</span><span class="sxs-lookup"><span data-stu-id="02b62-150">The [Seed](https://msdn.microsoft.com/library/hh829453(v=vs.103).aspx) method takes the database context object as an input parameter, and the code in the method uses that object to add new entities to the database.</span></span> <span data-ttu-id="02b62-151">每個實體類型，程式碼會建立新實體的集合，將它們加入至適當[DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx)屬性，然後按一下 儲存至資料庫的變更。</span><span class="sxs-lookup"><span data-stu-id="02b62-151">For each entity type, the code creates a collection of new entities, adds them to the appropriate [DbSet](https://msdn.microsoft.com/library/system.data.entity.dbset(v=vs.103).aspx) property, and then saves the changes to the database.</span></span> <span data-ttu-id="02b62-152">不需要呼叫[SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx)方法之後每個實體群組，做為執行這項，但這麼做可協助您找出問題的來源，如果程式碼寫入資料庫時發生例外狀況。</span><span class="sxs-lookup"><span data-stu-id="02b62-152">It isn't necessary to call the [SaveChanges](https://msdn.microsoft.com/library/system.data.entity.dbcontext.savechanges(v=VS.103).aspx) method after each group of entities, as is done here, but doing that helps you locate the source of a problem if an exception occurs while the code is writing to the database.</span></span>

    <span data-ttu-id="02b62-153">某些插入資料的陳述式使用[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)方法，以執行 「 更新插入 」 作業。</span><span class="sxs-lookup"><span data-stu-id="02b62-153">Some of the statements that insert data use the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method to perform an "upsert" operation.</span></span> <span data-ttu-id="02b62-154">因為`Seed`方法會執行，每次您執行`update-database`命令時，通常每個移轉之後，因為您嘗試新增的資料列，就會有第一個移轉建立資料庫之後插入資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-154">Because the `Seed` method runs every time you execute the `update-database` command, typically after each migration, you can't just insert data, because the rows you are trying to add will already be there after the first migration that creates the database.</span></span> <span data-ttu-id="02b62-155">「 更新插入 」 作業會防止您嘗試要插入的資料列已經存在，但它會發生的錯誤***會覆寫***資料您測試應用程式時所做的任何變更。</span><span class="sxs-lookup"><span data-stu-id="02b62-155">The "upsert" operation prevents errors that would happen if you try to insert a row that already exists, but it ***overrides*** any changes to data that you may have made while testing the application.</span></span> <span data-ttu-id="02b62-156">測試資料表中的資料部分可能不會想才會發生： 在某些情況下測試時變更資料時要您的資料庫更新後要保持的變更。</span><span class="sxs-lookup"><span data-stu-id="02b62-156">With test data in some tables you might not want that to happen: in some cases when you change data while testing you want your changes to remain after database updates.</span></span> <span data-ttu-id="02b62-157">在此情況下您要執行條件式的 insert 作業： 插入資料列，只有當其不存在。</span><span class="sxs-lookup"><span data-stu-id="02b62-157">In that case you want to do a conditional insert operation: insert a row only if it doesn't already exist.</span></span> <span data-ttu-id="02b62-158">Seed 方法會使用這兩種方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-158">The Seed method uses both approaches.</span></span>

    <span data-ttu-id="02b62-159">第一個參數傳遞至[AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx)方法會指定用來檢查資料列是否已經存在的屬性。</span><span class="sxs-lookup"><span data-stu-id="02b62-159">The first parameter passed to the [AddOrUpdate](https://msdn.microsoft.com/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx) method specifies the property to use to check if a row already exists.</span></span> <span data-ttu-id="02b62-160">您提供的測試學生資料`LastName`因為每個清單中的最後一個名稱是唯一的可以針對此用途使用屬性：</span><span class="sxs-lookup"><span data-stu-id="02b62-160">For the test student data that you are providing, the `LastName` property can be used for this purpose since each last name in the list is unique:</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample5.cs)]

    <span data-ttu-id="02b62-161">此程式碼會假設這些姓氏是唯一。</span><span class="sxs-lookup"><span data-stu-id="02b62-161">This code assumes that last names are unique.</span></span> <span data-ttu-id="02b62-162">如果您手動新增一位學生重複最後一個名稱，您會得到下列例外狀況下一次執行移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-162">If you manually add a student with a duplicate last name, you'll get the following exception the next time you perform a migration.</span></span>

    <span data-ttu-id="02b62-163">序列包含一個以上的項目</span><span class="sxs-lookup"><span data-stu-id="02b62-163">Sequence contains more than one element</span></span>

    <span data-ttu-id="02b62-164">如需如何處理重複的資料，例如兩個名為"Alexander Carson"的學生的資訊，請參閱[植入和偵錯 Entity Framework (EF) Db](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) Rick Anderson 部落格上。</span><span class="sxs-lookup"><span data-stu-id="02b62-164">For information about how to handle redundant data such as two students named "Alexander Carson", see [Seeding and Debugging Entity Framework (EF) DBs](https://blogs.msdn.com/b/rickandy/archive/2013/02/12/seeding-and-debugging-entity-framework-ef-dbs.aspx) on Rick Anderson's blog.</span></span> <span data-ttu-id="02b62-165">如需有關`AddOrUpdate`方法，請參閱[小心以 EF 4.3 AddOrUpdate 方法](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/)Julie Lerman 部落格上。</span><span class="sxs-lookup"><span data-stu-id="02b62-165">For more information about the `AddOrUpdate` method, see [Take care with EF 4.3 AddOrUpdate Method](http://thedatafarm.com/blog/data-access/take-care-with-ef-4-3-addorupdate-method/) on Julie Lerman's blog.</span></span>

    <span data-ttu-id="02b62-166">建立的程式碼`Enrollment`實體會假設您擁有`ID`中的實體中的值`students`集合中，雖然您不會建立集合的程式碼中設定該屬性。</span><span class="sxs-lookup"><span data-stu-id="02b62-166">The code that creates `Enrollment` entities assumes you have the `ID` value in the entities in the `students` collection, although you didn't set that property in the code that creates the collection.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample6.cs?highlight=2)]

    <span data-ttu-id="02b62-167">您可以使用`ID`這裡屬性因為`ID`設定值，當您呼叫`SaveChanges`如`students`集合。</span><span class="sxs-lookup"><span data-stu-id="02b62-167">You can use the `ID` property here because the `ID` value is set when you call `SaveChanges` for the `students` collection.</span></span> <span data-ttu-id="02b62-168">EF 自動時，取得索引鍵值插入資料庫中，實體，便會更新`ID`在記憶體中的實體屬性。</span><span class="sxs-lookup"><span data-stu-id="02b62-168">EF automatically gets the primary key value when it inserts an entity into the database, and it updates the `ID` property of the entity in memory.</span></span>

    <span data-ttu-id="02b62-169">每個加入的程式碼`Enrollment`實體`Enrollments`不會使用實體集`AddOrUpdate`方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-169">The code that adds each `Enrollment` entity to the `Enrollments` entity set doesn't use the `AddOrUpdate` method.</span></span> <span data-ttu-id="02b62-170">它會檢查是否實體已經存在，並將實體，如果不存在。</span><span class="sxs-lookup"><span data-stu-id="02b62-170">It checks if an entity already exists and inserts the entity if it doesn't exist.</span></span> <span data-ttu-id="02b62-171">這種方法將會保留您對使用應用程式 UI 來註冊等級變更。</span><span class="sxs-lookup"><span data-stu-id="02b62-171">This approach will preserve changes you make to an enrollment grade by using the application UI.</span></span> <span data-ttu-id="02b62-172">此程式碼迴圈的每個成員`Enrollment`[清單](https://msdn.microsoft.com/library/6sh2ey19.aspx)，如果資料庫中找不到註冊，它會將註冊加入資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-172">The code loops through each member of the `Enrollment`[List](https://msdn.microsoft.com/library/6sh2ey19.aspx) and if the enrollment is not found in the database, it adds the enrollment to the database.</span></span> <span data-ttu-id="02b62-173">第一次更新資料庫，資料庫將是空的因此它會將加入每個註冊。</span><span class="sxs-lookup"><span data-stu-id="02b62-173">The first time you update the database, the database will be empty, so it will add each enrollment.</span></span>

    [!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample7.cs)]
2. <span data-ttu-id="02b62-174">建置專案。</span><span class="sxs-lookup"><span data-stu-id="02b62-174">Build the project.</span></span>

### <a name="execute-the-first-migration"></a><span data-ttu-id="02b62-175">執行第一次移轉</span><span class="sxs-lookup"><span data-stu-id="02b62-175">Execute the First Migration</span></span>

<span data-ttu-id="02b62-176">當您執行`add-migration`命令，移轉作業產生的程式碼會從頭開始建立資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-176">When you executed the `add-migration` command, Migrations generated the code that would create the database from scratch.</span></span> <span data-ttu-id="02b62-177">此程式碼也是*移轉*資料夾中名為的檔案*&lt;時間戳記&gt;\_InitialCreate.cs*。</span><span class="sxs-lookup"><span data-stu-id="02b62-177">This code is also in the *Migrations* folder, in the file named *&lt;timestamp&gt;\_InitialCreate.cs*.</span></span> <span data-ttu-id="02b62-178">`Up`方法`InitialCreate`類別會建立對應至資料模型實體集的資料庫資料表和`Down`方法會刪除它們。</span><span class="sxs-lookup"><span data-stu-id="02b62-178">The `Up` method of the `InitialCreate` class creates the database tables that correspond to the data model entity sets, and the `Down` method deletes them.</span></span>

[!code-csharp[Main](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/samples/sample8.cs)]

<span data-ttu-id="02b62-179">移轉呼叫`Up`方法，以實作資料模型變更，以進行移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-179">Migrations calls the `Up` method to implement the data model changes for a migration.</span></span> <span data-ttu-id="02b62-180">當您輸入命令，以回復更新、 移轉呼叫`Down`方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-180">When you enter a command to roll back the update, Migrations calls the `Down` method.</span></span>

<span data-ttu-id="02b62-181">這是您輸入時所建立的初始移轉`add-migration InitialCreate`命令。</span><span class="sxs-lookup"><span data-stu-id="02b62-181">This is the initial migration that was created when you entered the `add-migration InitialCreate` command.</span></span> <span data-ttu-id="02b62-182">參數 (`InitialCreate`在範例中) 用於檔案名稱，而且可以是您所要的任何; 您通常會選擇的單字或片語來摘要列出所要完成移轉中的作業。</span><span class="sxs-lookup"><span data-stu-id="02b62-182">The parameter (`InitialCreate` in the example) is used for the file name and can be whatever you want; you typically choose a word or phrase that summarizes what is being done in the migration.</span></span> <span data-ttu-id="02b62-183">例如，您可能會命名稍後移轉&quot;AddDepartmentTable&quot;。</span><span class="sxs-lookup"><span data-stu-id="02b62-183">For example, you might name a later migration &quot;AddDepartmentTable&quot;.</span></span>

<span data-ttu-id="02b62-184">如果資料庫已經存在時，您會建立初始的移轉，資料庫建立程式碼會產生，但它不一定要執行，因為資料庫已經符合資料模型。</span><span class="sxs-lookup"><span data-stu-id="02b62-184">If you created the initial migration when the database already exists, the database creation code is generated but it doesn't have to run because the database already matches the data model.</span></span> <span data-ttu-id="02b62-185">當您部署應用程式到另一個環境，其中資料庫不存在，但這段程式碼會執行以建立您的資料庫時，因此，建議您先測試它。</span><span class="sxs-lookup"><span data-stu-id="02b62-185">When you deploy the app to another environment where the database doesn't exist yet, this code will run to create your database, so it's a good idea to test it first.</span></span> <span data-ttu-id="02b62-186">這就是為什麼您使移轉可以建立一個新從頭變更先前-在連接字串中的資料庫名稱。</span><span class="sxs-lookup"><span data-stu-id="02b62-186">That's why you changed the name of the database in the connection string earlier -- so that migrations can create a new one from scratch.</span></span>

1. <span data-ttu-id="02b62-187">在**Package Manager Console**視窗中，輸入下列命令：</span><span class="sxs-lookup"><span data-stu-id="02b62-187">In the **Package Manager Console** window, enter the following command:</span></span>

    `update-database`

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image3.png)

    <span data-ttu-id="02b62-188">`update-database`命令執行`Up`方法來建立資料庫然後執行`Seed`方法來擴展資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-188">The `update-database` command runs the `Up` method to create the database and then it runs the `Seed` method to populate the database.</span></span> <span data-ttu-id="02b62-189">相同的程序會自動執行在生產環境中部署應用程式之後, 您會發現下一節。</span><span class="sxs-lookup"><span data-stu-id="02b62-189">The same process will run automatically in production after you deploy the application, as you'll see in the following section.</span></span>
- <span data-ttu-id="02b62-190">使用**伺服器總管**檢查資料庫，您可以如同在第一個教學課程中，並執行應用程式確認運作一切仍然正常相同和以前一樣。</span><span class="sxs-lookup"><span data-stu-id="02b62-190">Use **Server Explorer** to inspect the database as you did in the first tutorial, and run the application to verify that everything still works the same as before.</span></span>

## <a name="deploy-to-azure"></a><span data-ttu-id="02b62-191">部署至 Azure</span><span class="sxs-lookup"><span data-stu-id="02b62-191">Deploy to Azure</span></span>

<span data-ttu-id="02b62-192">到目前為止已被本機執行應用程式在 IIS Express 在開發電腦上。</span><span class="sxs-lookup"><span data-stu-id="02b62-192">So far the application has been running locally in IIS Express on your development computer.</span></span> <span data-ttu-id="02b62-193">若要使其可供其他人透過網際網路使用，您必須將它部署至 web 主控提供者。</span><span class="sxs-lookup"><span data-stu-id="02b62-193">To make it available for other people to use over the Internet, you have to deploy it to a web hosting provider.</span></span> <span data-ttu-id="02b62-194">本章節的教學課程中您會將它部署至 Azure。</span><span class="sxs-lookup"><span data-stu-id="02b62-194">In this section of the tutorial you'll deploy it to Azure.</span></span> <span data-ttu-id="02b62-195">這個區段是選擇性的。您可以略過此步驟並繼續進行下列教學課程中，或您可以調整這一節的指示不同的主控提供者您選擇。</span><span class="sxs-lookup"><span data-stu-id="02b62-195">This section is optional; you can skip this and continue with the following tutorial, or you can adapt the instructions in this section for a different hosting provider of your choice.</span></span>

### <a name="using-code-first-migrations-to-deploy-the-database"></a><span data-ttu-id="02b62-196">使用 Code First 移轉，將資料庫部署</span><span class="sxs-lookup"><span data-stu-id="02b62-196">Using Code First Migrations to Deploy the Database</span></span>

<span data-ttu-id="02b62-197">若要將資料庫部署中，您將使用 Code First 移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-197">To deploy the database you'll use Code First Migrations.</span></span> <span data-ttu-id="02b62-198">當您建立發行設定檔讓您從 Visual Studio 部署的設定時，您會選取核取方塊標示為**更新資料庫**。</span><span class="sxs-lookup"><span data-stu-id="02b62-198">When you create the publish profile that you use to configure settings for deploying from Visual Studio, you'll select a check box labeled **Update Database**.</span></span> <span data-ttu-id="02b62-199">此設定會自動設定應用程式部署程序*Web.config*檔案在目的地伺服器上，所以第一個程式碼會使用`MigrateDatabaseToLatestVersion`初始設定式類別。</span><span class="sxs-lookup"><span data-stu-id="02b62-199">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>

<span data-ttu-id="02b62-200">Visual Studio 不執行任何動作與資料庫在部署程序時，它會將您的專案複製到目的地伺服器。</span><span class="sxs-lookup"><span data-stu-id="02b62-200">Visual Studio doesn't do anything with the database during the deployment process while it is copying your project to the destination server.</span></span> <span data-ttu-id="02b62-201">當您執行部署的應用程式，且它存取資料庫第一次部署之後時，Code First 會檢查資料庫是否符合資料模型。</span><span class="sxs-lookup"><span data-stu-id="02b62-201">When you run the deployed application and it accesses the database for the first time after deployment, Code First checks if the database matches the data model.</span></span> <span data-ttu-id="02b62-202">如果不相符，第一個程式碼會自動建立資料庫 （如果尚未存在） 或更新至最新版本的資料庫結構描述 （如果資料庫存在，但不符合模型）。</span><span class="sxs-lookup"><span data-stu-id="02b62-202">If there's a mismatch, Code First automatically creates the database (if it doesn't exist yet) or updates the database schema to the latest version (if a database exists but doesn't match the model).</span></span> <span data-ttu-id="02b62-203">如果應用程式實作移轉`Seed`方法，在方法執行之後建立資料庫，或在更新結構描述。</span><span class="sxs-lookup"><span data-stu-id="02b62-203">If the application implements a Migrations `Seed` method, the method runs after the database is created or the schema is updated.</span></span>

<span data-ttu-id="02b62-204">您的移轉`Seed`方法會將測試資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-204">Your Migrations `Seed` method inserts test data.</span></span> <span data-ttu-id="02b62-205">如果您已部署至生產環境，您必須變更`Seed`方法，使它只會插入您想要插入至您的生產資料庫的資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-205">If you were deploying to a production environment, you would have to change the `Seed` method so that it only inserts data that you want to be inserted into your production database.</span></span> <span data-ttu-id="02b62-206">例如，您目前的資料模型中您可以開發資料庫中有實際的課程，但虛構學生。</span><span class="sxs-lookup"><span data-stu-id="02b62-206">For example, in your current data model you might want to have real courses but fictional students in the development database.</span></span> <span data-ttu-id="02b62-207">您可以撰寫`Seed`方法來載入兩者在開發中，並再標記為註解虛構的學生在部署到生產環境之前。</span><span class="sxs-lookup"><span data-stu-id="02b62-207">You can write a `Seed` method to load both in development, and then comment out the fictional students before you deploy to production.</span></span> <span data-ttu-id="02b62-208">您可以撰寫或`Seed`載入只課程中，並使用應用程式的 UI 手動輸入虛構的學生在測試資料庫中的方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-208">Or you can write a `Seed` method to load only courses, and enter the fictional students in the test database manually by using the application's UI.</span></span>

### <a name="get-an-azure-account"></a><span data-ttu-id="02b62-209">取得 Azure 帳戶</span><span class="sxs-lookup"><span data-stu-id="02b62-209">Get an Azure account</span></span>

<span data-ttu-id="02b62-210">您將需要 Azure 帳戶。</span><span class="sxs-lookup"><span data-stu-id="02b62-210">You'll need an Azure account.</span></span> <span data-ttu-id="02b62-211">如果您還沒有其中一個，但您沒有 Visual Studio 訂用帳戶，您可以[啟用訂用帳戶權益](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/)。</span><span class="sxs-lookup"><span data-stu-id="02b62-211">If you don't already have one, but you do have a Visual Studio subscription, you can [activate your subscription benefits](https://azure.microsoft.com/pricing/member-offers/msdn-benefits-details/).</span></span> <span data-ttu-id="02b62-212">否則，您可以建立免費的試用帳戶只需要幾分鐘的時間。</span><span class="sxs-lookup"><span data-stu-id="02b62-212">Otherwise, you can create a free trial account in just a couple of minutes.</span></span> <span data-ttu-id="02b62-213">如需詳細資訊，請參閱[Azure 免費試用](https://azure.microsoft.com/free/)。</span><span class="sxs-lookup"><span data-stu-id="02b62-213">For details, see [Azure Free Trial](https://azure.microsoft.com/free/).</span></span>

### <a name="create-a-web-site-and-a-sql-database-in-azure"></a><span data-ttu-id="02b62-214">在 Azure 中建立的網站和 SQL 資料庫</span><span class="sxs-lookup"><span data-stu-id="02b62-214">Create a web site and a SQL database in Azure</span></span>

<span data-ttu-id="02b62-215">在 Azure web 應用程式將會執行共用裝載環境中，這表示它與其他 Azure 用戶端共用的虛擬機器 (Vm) 上執行。</span><span class="sxs-lookup"><span data-stu-id="02b62-215">Your web app in Azure will run in a shared hosting environment, which means it runs on virtual machines (VMs) that are shared with other Azure clients.</span></span> <span data-ttu-id="02b62-216">共用裝載環境是開始在雲端中的低成本方法。</span><span class="sxs-lookup"><span data-stu-id="02b62-216">A shared hosting environment is a low-cost way to get started in the cloud.</span></span> <span data-ttu-id="02b62-217">更新版本中，如果您的 web 流量的增加，應用程式可以調整以符合需要專用的 Vm 上執行。</span><span class="sxs-lookup"><span data-stu-id="02b62-217">Later, if your web traffic increases, the application can scale to meet the need by running on dedicated VMs.</span></span> <span data-ttu-id="02b62-218">若要深入了解定價選項 Azure 應用程式服務，請參閱文件上[Azure 文件](https://azure.microsoft.com/pricing/details/app-service/)</span><span class="sxs-lookup"><span data-stu-id="02b62-218">To learn more about Pricing Options for Azure App Service, read the documentation on [Azure Docs](https://azure.microsoft.com/pricing/details/app-service/)</span></span>

<span data-ttu-id="02b62-219">您要將資料庫部署到 Azure SQL Database。</span><span class="sxs-lookup"><span data-stu-id="02b62-219">You'll deploy the database to Azure SQL Database.</span></span> <span data-ttu-id="02b62-220">SQL Database 是建立在 SQL Server 技術以雲端為基礎的關聯式資料庫服務。</span><span class="sxs-lookup"><span data-stu-id="02b62-220">SQL Database is a cloud-based relational database service that is built on SQL Server technologies.</span></span> <span data-ttu-id="02b62-221">工具和 SQL Server 所使用的應用程式也使用 SQL 資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-221">Tools and applications that work with SQL Server also work with SQL Database.</span></span>

1. <span data-ttu-id="02b62-222">在[Azure 管理入口網站](https://portal.azure.com)，按一下 **新增**在左側的索引標籤上，按一下**查看所有**中新刀鋒視窗中，然後按一下**Web 應用程式與 SQL**中**Web**區段，最後**建立**。</span><span class="sxs-lookup"><span data-stu-id="02b62-222">In the [Azure Management Portal](https://portal.azure.com), click **New** in the left tab, click **See all** in new blade, and then click **Web App & SQL** in the **Web** Section and finally **Create**.</span></span>

    ![在管理入口網站中的新按鈕](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/CreateWeb-Sql.png)

 <span data-ttu-id="02b62-224">**新 Web 應用程式與 SQL-建立**精靈 隨即開啟。</span><span class="sxs-lookup"><span data-stu-id="02b62-224">The **New Web App & SQL - Create** wizard opens.</span></span>

2. <span data-ttu-id="02b62-225">在刀鋒視窗中，輸入字串中的**應用程式名稱**方塊，以使用唯一的 URL 做為您的應用程式。</span><span class="sxs-lookup"><span data-stu-id="02b62-225">In the blade, enter a string in the **App name** box to use as the unique URL for your application.</span></span> <span data-ttu-id="02b62-226">將會包含哪些您在此處輸入再加上 Azure 應用程式服務的預設網域的完整 URL (。 名稱是.azurewebsites.net)。</span><span class="sxs-lookup"><span data-stu-id="02b62-226">The complete URL will consist of what you enter here plus the default domain of Azure App Services (.azurewebsites.net).</span></span> <span data-ttu-id="02b62-227">如果**應用程式名稱**已經存在，精靈會將通知您有紅色*應用程式名稱不是使用*訊息。</span><span class="sxs-lookup"><span data-stu-id="02b62-227">If the **App name** is already taken, the Wizard will notify you of this with a red *The app name is not available* message.</span></span> <span data-ttu-id="02b62-228">如果**應用程式名稱**為可用，就會出現綠色的核取記號。</span><span class="sxs-lookup"><span data-stu-id="02b62-228">If the **App name** is available, you will get a green checkmark.</span></span>

    ![建立具有管理入口網站中的資料庫連結](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-WebApp.png)

3. <span data-ttu-id="02b62-230">在**訂用帳戶**下拉式清單中，請選擇 Azure 訂用帳戶在您想在其中**App Service**位於。</span><span class="sxs-lookup"><span data-stu-id="02b62-230">In the **Subscription** Dropdown, please choose the Azure Subscription in which you want the **App Service** to reside.</span></span>

4. <span data-ttu-id="02b62-231">在**資源群組**文字方塊中，選擇資源群組，或另外新建一個。</span><span class="sxs-lookup"><span data-stu-id="02b62-231">In the **Resource Group** text box, choose a Resource Group or create a new one.</span></span> <span data-ttu-id="02b62-232">此設定指定您的網站會在執行哪一個資料中心。</span><span class="sxs-lookup"><span data-stu-id="02b62-232">This setting specifies which data center your web site will run in.</span></span> <span data-ttu-id="02b62-233">如需資源群組的詳細資訊，請閱讀文件上[Azure 文件](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups)。</span><span class="sxs-lookup"><span data-stu-id="02b62-233">For more information about Resource Groups, read the documentation on [Azure Docs](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-overview#resource-groups).</span></span>
5. <span data-ttu-id="02b62-234">建立新**應用程式服務方案**按一下*應用程式服務 區段*，**建立新**，並填入**App Service 方案**（可以是相同的名稱應用程式服務）**位置**，和**定價層**（沒有可用的選項）。</span><span class="sxs-lookup"><span data-stu-id="02b62-234">Create a new **App Service Plan** by clicking the *App Service section*, **Create New**, and fill in **App Service plan** (can be same name as App Service), **Location**, and **Pricing tier** (there is a free option).</span></span>

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-AppService.png)
6. <span data-ttu-id="02b62-235">按一下**SQL Database**，然後選擇 *新建*或選取現有的資料庫</span><span class="sxs-lookup"><span data-stu-id="02b62-235">Click the **SQL Database**, and choose *Create New* or select an existing database</span></span>

    ![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Create-Database.png)

7. <span data-ttu-id="02b62-236">在**名稱**方塊中，輸入您的資料庫的名稱。</span><span class="sxs-lookup"><span data-stu-id="02b62-236">In the **Name** box, enter a name for your database.</span></span>
8. <span data-ttu-id="02b62-237">按一下**目標伺服器**方塊中，選取**建立新的伺服器**。</span><span class="sxs-lookup"><span data-stu-id="02b62-237">Click the **Target Server** box, select **Create a new server**.</span></span> <span data-ttu-id="02b62-238">或者，如果您先前建立的伺服器，您可以從可用的伺服器清單中選取該伺服器。</span><span class="sxs-lookup"><span data-stu-id="02b62-238">Alternatively, if you previously created a server, you can select that server from list of available servers.</span></span>
9. <span data-ttu-id="02b62-239">選擇**定價層**區段中，選擇*免費*。</span><span class="sxs-lookup"><span data-stu-id="02b62-239">Choose **Pricing tier** section, choose *Free*.</span></span> <span data-ttu-id="02b62-240">如需其他資源，可以隨時向上資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-240">If additional resources are needed, the database can be scaled up at any time.</span></span> <span data-ttu-id="02b62-241">若要了解需 Azure SQL 定價的詳細資訊，請閱讀文件上[Azure 文件](https://azure.microsoft.com/pricing/details/sql-database/)。</span><span class="sxs-lookup"><span data-stu-id="02b62-241">To learn more on Azure SQL Pricing, read the documentation on [Azure Docs](https://azure.microsoft.com/pricing/details/sql-database/).</span></span>
10. <span data-ttu-id="02b62-242">修改[定序](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support)視。</span><span class="sxs-lookup"><span data-stu-id="02b62-242">Modify [collation](https://docs.microsoft.com/sql/relational-databases/collations/collation-and-unicode-support) as needed.</span></span>
11. <span data-ttu-id="02b62-243">輸入系統管理員**SQL 系統管理員使用者名稱**和**SQL 系統管理員密碼**。</span><span class="sxs-lookup"><span data-stu-id="02b62-243">Enter an administrator **SQL Admin Username** and **SQL Admin Password**.</span></span> <span data-ttu-id="02b62-244">如果您選取**新 SQL Database 伺服器**，您不輸入現有的名稱和密碼，您輸入新名稱和密碼，您現在定義存取資料庫時使用。</span><span class="sxs-lookup"><span data-stu-id="02b62-244">If you selected **New SQL Database server**, you aren't entering an existing name and password here, you're entering a new name and password that you're defining now to use later when you access the database.</span></span> <span data-ttu-id="02b62-245">如果您選取您先前建立的伺服器，您會輸入該伺服器的認證。</span><span class="sxs-lookup"><span data-stu-id="02b62-245">If you selected a server that you created previously, you'll enter credentials for that server.</span></span>
12. <span data-ttu-id="02b62-246">使用 Application Insights 的應用程式服務，可以啟用遙測收集。</span><span class="sxs-lookup"><span data-stu-id="02b62-246">Telemetry collection can be enabled for App Service using Application Insights.</span></span> <span data-ttu-id="02b62-247">組態設定少與 application Insights 收集重要事件、 例外狀況、 相依性、 要求，以及追蹤資訊。</span><span class="sxs-lookup"><span data-stu-id="02b62-247">Application Insights with little configuration collects valuable event, exception, dependency, request, and trace information.</span></span> <span data-ttu-id="02b62-248">若要深入了解 Application Insights，開始[Azure 文件](https://azure.microsoft.com/services/application-insights/)。</span><span class="sxs-lookup"><span data-stu-id="02b62-248">To learn more about Application Insights, get started in [Azure Docs](https://azure.microsoft.com/services/application-insights/).</span></span>
12. <span data-ttu-id="02b62-249">按一下**建立**底部的刀鋒視窗，指出您已完成。</span><span class="sxs-lookup"><span data-stu-id="02b62-249">Click **Create** at the bottom of the blade to indicate that you're finished.</span></span>
  
 <span data-ttu-id="02b62-250">在管理入口網站會回到儀表板 頁面上，而**通知**刀鋒視窗頂端的頁面顯示建立網站。</span><span class="sxs-lookup"><span data-stu-id="02b62-250">The Management Portal returns to the Dashboards page, and the **Notifications** blade at the top of the page shows that the site is being created.</span></span> <span data-ttu-id="02b62-251">（通常小於一分鐘），一段時間之後會有部署成功的通知。</span><span class="sxs-lookup"><span data-stu-id="02b62-251">After a while (typically less than a minute), there will be a notification that the Deployment succeeded.</span></span> <span data-ttu-id="02b62-252">在左側導覽列中的新**App Service**會出現在*應用程式服務*區段和新**SQL Database**會出現在*SQL 資料庫* > 一節。</span><span class="sxs-lookup"><span data-stu-id="02b62-252">In the navigation bar at the left, the new **App Service** appears in the *App Services* section and the new **SQL Database** appears in the *SQL Databases* section.</span></span>

### <a name="deploy-the-application-to-azure"></a><span data-ttu-id="02b62-253">部署至 Azure 應用程式</span><span class="sxs-lookup"><span data-stu-id="02b62-253">Deploy the application to Azure</span></span>

1. <span data-ttu-id="02b62-254">在 Visual Studio 中的專案上按一下滑鼠右鍵**方案總管 中**選取**發行**從內容功能表。</span><span class="sxs-lookup"><span data-stu-id="02b62-254">In Visual Studio, right-click the project in **Solution Explorer** and select **Publish** from the context menu.</span></span>
  
    ![在專案內容功能表中發行](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image10.png)
2. <span data-ttu-id="02b62-256">在**設定檔** 索引標籤**發行 Web**精靈 中，按一下  **Microsoft Azure App Service**。</span><span class="sxs-lookup"><span data-stu-id="02b62-256">In the **Profile** tab of the **Publish Web** wizard, click **Microsoft Azure App Service**.</span></span>
  
    ![匯入發行設定](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-ChooseTarget.png)
3. <span data-ttu-id="02b62-258">如果您未在 Visual Studio 中先前加入您 Azure 訂用帳戶，請在螢幕上執行步驟。</span><span class="sxs-lookup"><span data-stu-id="02b62-258">If you have not previously added your Azure subscription in Visual Studio, perform the steps on the screen.</span></span> <span data-ttu-id="02b62-259">這些步驟會啟用 Visual Studio 以連接到您的 Azure 訂閱所以清單**應用程式服務**將包含您的網站。</span><span class="sxs-lookup"><span data-stu-id="02b62-259">These steps enable Visual Studio to connect to your Azure subscription so that the list of **App Services** will include your web site.</span></span>
 
4. <span data-ttu-id="02b62-260">選取**訂用帳戶**您加入應用程式服務，然後**App Service 方案**資料夾應用程式服務的一部分，最後再**App Service**本身後面**確定**。</span><span class="sxs-lookup"><span data-stu-id="02b62-260">Select the **Subscription** you added the App Service to, then the **App Service Plan** folder your App Service is a part of, and finally the **App Service** itself followed by **Ok**.</span></span>

    ![選取應用程式服務](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-AppService.png)
5. <span data-ttu-id="02b62-262">在設定設定檔之後，**連接** 索引標籤會顯示。</span><span class="sxs-lookup"><span data-stu-id="02b62-262">After the Profile has been configured, the **Connection** tab will be shown.</span></span> <span data-ttu-id="02b62-263">按一下**驗證連線**確定設定正確無誤</span><span class="sxs-lookup"><span data-stu-id="02b62-263">Click **Validate Connection** to make sure that the settings are correct</span></span>

    ![驗證連接](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Connection.png)
7. <span data-ttu-id="02b62-265">當已驗證的連接時，旁邊顯示綠色的核取記號**驗證連線** 按鈕。</span><span class="sxs-lookup"><span data-stu-id="02b62-265">When the connection has been validated, a green check mark is shown next to the **Validate Connection** button.</span></span> <span data-ttu-id="02b62-266">按 [ **下一步**]。</span><span class="sxs-lookup"><span data-stu-id="02b62-266">Click **Next**.</span></span>
  
    ![已成功驗證的連接](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-SettingsValidated.png)
8. <span data-ttu-id="02b62-268">開啟**遠端的連接字串**底下的下拉式清單**SchoolContext**並選取您所建立之資料庫的連接字串。</span><span class="sxs-lookup"><span data-stu-id="02b62-268">Open the **Remote connection string** drop-down list under **SchoolContext** and select the connection string for the database you created.</span></span>
9. <span data-ttu-id="02b62-269">選取**更新資料庫**。</span><span class="sxs-lookup"><span data-stu-id="02b62-269">Select **Update database**.</span></span>

    ![設定 索引標籤](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Settings.png)

    <span data-ttu-id="02b62-271">此設定會自動設定應用程式部署程序*Web.config*檔案在目的地伺服器上，所以第一個程式碼會使用`MigrateDatabaseToLatestVersion`初始設定式類別。</span><span class="sxs-lookup"><span data-stu-id="02b62-271">This setting causes the deployment process to automatically configure the application *Web.config* file on the destination server so that Code First uses the `MigrateDatabaseToLatestVersion` initializer class.</span></span>
10. <span data-ttu-id="02b62-272">按 [ **下一步**]。</span><span class="sxs-lookup"><span data-stu-id="02b62-272">Click **Next**.</span></span>
11. <span data-ttu-id="02b62-273">在**預覽**索引標籤上，按一下 **啟動預覽**。</span><span class="sxs-lookup"><span data-stu-id="02b62-273">In the **Preview** tab, click **Start Preview**.</span></span>
  
    ![在 [預覽] 索引標籤中的 StartPreview 按鈕](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Preview.png)
  
 <span data-ttu-id="02b62-275">索引標籤會顯示將會複製到伺服器的檔案清單。</span><span class="sxs-lookup"><span data-stu-id="02b62-275">The tab displays a list of the files that will be copied to the server.</span></span> <span data-ttu-id="02b62-276">顯示預覽並不需要發行應用程式但要注意的有用的函式。</span><span class="sxs-lookup"><span data-stu-id="02b62-276">Displaying the preview isn't required to publish the application but is a useful function to be aware of.</span></span> <span data-ttu-id="02b62-277">在此情況下，您不需要進行任何動作顯示的檔案清單。</span><span class="sxs-lookup"><span data-stu-id="02b62-277">In this case, you don't need to do anything with the list of files that is displayed.</span></span> <span data-ttu-id="02b62-278">下次當您部署此應用程式，這份清單中會變更的檔案。</span><span class="sxs-lookup"><span data-stu-id="02b62-278">The next time you deploy this application, only the files that have changed will be in this list.</span></span>
    <span data-ttu-id="02b62-279">![StartPreview 檔案輸出](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)</span><span class="sxs-lookup"><span data-stu-id="02b62-279">![StartPreview file output](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-PreviewLoaded.png)</span></span>

12. <span data-ttu-id="02b62-280">按一下 [發行] 。</span><span class="sxs-lookup"><span data-stu-id="02b62-280">Click **Publish**.</span></span>
 <span data-ttu-id="02b62-281">Visual Studio 會開始將檔案複製到 Azure 伺服器的程序。</span><span class="sxs-lookup"><span data-stu-id="02b62-281">Visual Studio begins the process of copying the files to the Azure server.</span></span>
13. <span data-ttu-id="02b62-282">**輸出**視窗會顯示所執行的部署動作，並回報成功完成部署。</span><span class="sxs-lookup"><span data-stu-id="02b62-282">The **Output** window shows what deployment actions were taken and reports successful completion of the deployment.</span></span>
  
    ![報告成功部署的 [輸出] 視窗](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-BuildOutput.png)
14. <span data-ttu-id="02b62-284">部署成功之後，預設瀏覽器會自動開啟至已部署的網站的 URL。</span><span class="sxs-lookup"><span data-stu-id="02b62-284">Upon successful deployment, the default browser automatically opens to the URL of the deployed web site.</span></span>
 <span data-ttu-id="02b62-285">您所建立的應用程式現在在雲端中執行。</span><span class="sxs-lookup"><span data-stu-id="02b62-285">The application you created is now running in the cloud.</span></span> 
  
    ![Students_index_page_with_paging](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Publish-Site.png)

<span data-ttu-id="02b62-287">此時您*SchoolContext*資料庫已建立 Azure SQL Database 中因為您選取**執行 Code First 移轉 （在應用程式啟動時執行）**。</span><span class="sxs-lookup"><span data-stu-id="02b62-287">At this point your *SchoolContext* database has been created in the Azure SQL Database because you selected **Execute Code First Migrations (runs on app start)**.</span></span> <span data-ttu-id="02b62-288">*Web.config*已部署的網站中檔案已經變更，讓[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)初始設定式會執行第一次讀取或寫入資料 （這發生在資料庫中的程式碼當您選取**學生** 索引標籤):</span><span class="sxs-lookup"><span data-stu-id="02b62-288">The *Web.config* file in the deployed web site has been changed so that the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer runs the first time your code reads or writes data in the database (which happened when you selected the **Students** tab):</span></span>

![](https://asp.net/media/4367421/mig.png)

<span data-ttu-id="02b62-289">部署程序也會建立新的連接字串*(SchoolContext\_DatabasePublish*) 的 Code First 移轉，以用於更新資料庫結構描述和植入資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-289">The deployment process also created a new connection string *(SchoolContext\_DatabasePublish*) for Code First Migrations to use for updating the database schema and seeding the database.</span></span>

![Database_Publish 連接字串](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/image26.png)

<span data-ttu-id="02b62-291">您可以找到您自己的電腦上的 Web.config 檔案的部署的版本*ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*。您可以存取已部署*Web.config*檔案本身可以使用 FTP。</span><span class="sxs-lookup"><span data-stu-id="02b62-291">You can find the deployed version of the Web.config file on your own computer in *ContosoUniversity\obj\Release\Package\PackageTmp\Web.config*. You can access the deployed *Web.config* file itself by using FTP.</span></span> <span data-ttu-id="02b62-292">如需指示，請參閱[使用 Visual Studio 的 ASP.NET Web 部署： 部署程式碼更新](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update)。</span><span class="sxs-lookup"><span data-stu-id="02b62-292">For instructions, see [ASP.NET Web Deployment using Visual Studio: Deploying a Code Update](xref:web-forms/overview/deployment/visual-studio-web-deployment/deploying-a-code-update).</span></span> <span data-ttu-id="02b62-293">遵循開頭 「 若要使用 FTP 工具，您需要三件事： FTP URL、 使用者名稱和密碼。 」</span><span class="sxs-lookup"><span data-stu-id="02b62-293">Follow the instructions that start with "To use an FTP tool, you need three things: the FTP URL, the user name, and the password."</span></span>

> [!NOTE]
> <span data-ttu-id="02b62-294">Web 應用程式不會實作安全性，以便尋找此 URL 的任何人都可以變更資料。</span><span class="sxs-lookup"><span data-stu-id="02b62-294">The web app doesn't implement security, so anyone who finds the URL can change the data.</span></span> <span data-ttu-id="02b62-295">如需有關如何保護網站的指示，請參閱[成員資格、 OAuth、 與 SQL Database 的安全的 ASP.NET MVC 應用程式部署至 Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data)。</span><span class="sxs-lookup"><span data-stu-id="02b62-295">For instructions on how to secure the web site, see [Deploy a Secure ASP.NET MVC app with Membership, OAuth, and SQL Database to Azure](https://docs.microsoft.com/aspnet/core/security/authorization/secure-data).</span></span> <span data-ttu-id="02b62-296">您可以防止其他人使用 Azure 管理入口網站使用站台或**伺服器總管**停止站台的 Visual Studio 中。</span><span class="sxs-lookup"><span data-stu-id="02b62-296">You can prevent other people from using the site by using the Azure Management Portal or **Server Explorer** in Visual Studio to stop the site.</span></span>


![](migrations-and-deployment-with-the-entity-framework-in-an-asp-net-mvc-application/_static/Stop-Service.png)

## <a name="advanced-migrations-scenarios"></a><span data-ttu-id="02b62-297">進階的移轉案例</span><span class="sxs-lookup"><span data-stu-id="02b62-297">Advanced Migrations Scenarios</span></span>

<span data-ttu-id="02b62-298">如果您本教學課程中所示的自動執行移轉以部署資料庫，而且您要部署到多部伺服器執行的 web 站台，您可以取得多部伺服器嘗試在相同時間執行移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-298">If you deploy a database by running migrations automatically as shown in this tutorial, and you are deploying to a web site that runs on multiple servers, you could get multiple servers trying to run migrations at the same time.</span></span> <span data-ttu-id="02b62-299">移轉是不可部分完成的因此如果兩部伺服器會嘗試執行相同的移轉，其中將會成功，其他將會失敗 （假設作業無法完成兩次）。</span><span class="sxs-lookup"><span data-stu-id="02b62-299">Migrations are atomic, so if two servers try to run the same migration, one will succeed and the other will fail (assuming the operations can't be done twice).</span></span> <span data-ttu-id="02b62-300">在案例中，如果您想要避免這些問題，您可以手動呼叫移轉並設定自己的程式碼，讓它只會發生一次。</span><span class="sxs-lookup"><span data-stu-id="02b62-300">In that scenario if you want to avoid those issues, you can call migrations manually and set up your own code so that it only happens once.</span></span> <span data-ttu-id="02b62-301">如需詳細資訊，請參閱[執行，並從程式碼的指令碼移轉](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/)Rowan Miller 部落格上並[Migrate.exe](https://msdn.microsoft.com/data/jj618307) （適用於從命令列執行移轉） MSDN 上。</span><span class="sxs-lookup"><span data-stu-id="02b62-301">For more information, see [Running and Scripting Migrations from Code](http://romiller.com/2012/02/09/running-scripting-migrations-from-code/) on Rowan Miller's blog and [Migrate.exe](https://msdn.microsoft.com/data/jj618307) (for executing migrations from the command line) on MSDN.</span></span>

<span data-ttu-id="02b62-302">其他的移轉案例的相關資訊，請參閱[移轉錄影畫面數列](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx)。</span><span class="sxs-lookup"><span data-stu-id="02b62-302">For information about other migrations scenarios, see [Migrations Screencast Series](https://blogs.msdn.com/b/adonet/archive/2014/03/12/migrations-screencast-series.aspx).</span></span>

## <a name="code-first-initializers"></a><span data-ttu-id="02b62-303">程式碼的第一個初始設定式</span><span class="sxs-lookup"><span data-stu-id="02b62-303">Code First Initializers</span></span>

<span data-ttu-id="02b62-304">在 [部署] 區段中看到[MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx)所使用的初始設定式。</span><span class="sxs-lookup"><span data-stu-id="02b62-304">In the deployment section you saw the [MigrateDatabaseToLatestVersion](https://msdn.microsoft.com/library/hh829476(v=vs.103).aspx) initializer being used.</span></span> <span data-ttu-id="02b62-305">程式碼第一次也提供其他初始設定式，包括[CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) （預設）、 [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) （用您稍早） 和[DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx)。</span><span class="sxs-lookup"><span data-stu-id="02b62-305">Code First also provides other initializers, including [CreateDatabaseIfNotExists](https://msdn.microsoft.com/library/gg679221(v=vs.103).aspx) (the default), [DropCreateDatabaseIfModelChanges](https://msdn.microsoft.com/library/gg679604(v=VS.103).aspx) (which you used earlier) and [DropCreateDatabaseAlways](https://msdn.microsoft.com/library/gg679506(v=VS.103).aspx).</span></span> <span data-ttu-id="02b62-306">`DropCreateAlways`初始設定式可用於設定單元測試的條件。</span><span class="sxs-lookup"><span data-stu-id="02b62-306">The `DropCreateAlways` initializer can be useful for setting up conditions for unit tests.</span></span> <span data-ttu-id="02b62-307">您也可以撰寫您自己的初始設定式，而且您可以呼叫初始設定式明確若不想等到應用程式讀取或寫入資料庫。</span><span class="sxs-lookup"><span data-stu-id="02b62-307">You can also write your own initializers, and you can call an initializer explicitly if you don't want to wait until the application reads from or writes to the database.</span></span> <span data-ttu-id="02b62-308">本教學課程以 2013 年 11 月日次您只可以使用 Create and DropCreate 初始設定式之前啟用移轉。</span><span class="sxs-lookup"><span data-stu-id="02b62-308">At the time this tutorial is being written in November, 2013, you can only use the Create and DropCreate initializers before you enable migrations.</span></span> <span data-ttu-id="02b62-309">Entity Framework 團隊正在進行移轉，以及在這些初始設定式。</span><span class="sxs-lookup"><span data-stu-id="02b62-309">The Entity Framework team is working on making these initializers usable with migrations as well.</span></span>

<span data-ttu-id="02b62-310">如需初始設定式的詳細資訊，請參閱[Entity Framework Code First 中了解資料庫初始設定式](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm)和活頁簿第 6 章[程式設計 Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) Julie Lerman 由和 Rowan Miller。</span><span class="sxs-lookup"><span data-stu-id="02b62-310">For more information about initializers, see [Understanding Database Initializers in Entity Framework Code First](http://www.codeguru.com/csharp/article.php/c19999/Understanding-Database-Initializers-in-Entity-Framework-Code-First.htm) and chapter 6 of the book [Programming Entity Framework: Code First](http://shop.oreilly.com/product/0636920022220.do) by Julie Lerman and Rowan Miller.</span></span>

## <a name="summary"></a><span data-ttu-id="02b62-311">總結</span><span class="sxs-lookup"><span data-stu-id="02b62-311">Summary</span></span>

<span data-ttu-id="02b62-312">在本教學課程中，您已經看到如何啟用移轉和部署應用程式。</span><span class="sxs-lookup"><span data-stu-id="02b62-312">In this tutorial you've seen how to enable migrations and deploy the application.</span></span> <span data-ttu-id="02b62-313">在下一個教學課程中開始，您將查看更進階的主題，方法是展開的資料模型。</span><span class="sxs-lookup"><span data-stu-id="02b62-313">In the next tutorial you'll begin looking at more advanced topics by expanding the data model.</span></span>

<span data-ttu-id="02b62-314">請在您所喜歡本教學課程的方式，我們可以改進留下意見反應。</span><span class="sxs-lookup"><span data-stu-id="02b62-314">Please leave feedback on how you liked this tutorial and what we could improve.</span></span> <span data-ttu-id="02b62-315">您也可以要求在新的主題[顯示我如何使用程式碼](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code)。</span><span class="sxs-lookup"><span data-stu-id="02b62-315">You can also request new topics at [Show Me How With Code](http://aspnet.uservoice.com/forums/228522-show-me-how-with-code).</span></span>

<span data-ttu-id="02b62-316">Entity Framework 中的其他資源連結位於[ASP.NET 資料存取-建議資源](xref:whitepapers/aspnet-data-access-content-map)。</span><span class="sxs-lookup"><span data-stu-id="02b62-316">Links to other Entity Framework resources can be found in [ASP.NET Data Access - Recommended Resources](xref:whitepapers/aspnet-data-access-content-map).</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="02b62-317">[上一頁](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
[下一頁](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span><span class="sxs-lookup"><span data-stu-id="02b62-317">[Previous](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/connection-resiliency-and-command-interception-with-the-entity-framework-in-an-asp-net-mvc-application)
[Next](xref:mvc/overview/getting-started/getting-started-with-ef-using-mvc/creating-a-more-complex-data-model-for-an-asp-net-mvc-application)</span></span>
