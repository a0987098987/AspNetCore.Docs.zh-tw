---
uid: web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
title: 記錄錯誤的詳細資料，使用 ASP.NET 狀況監控 (C#) |Microsoft Docs
author: rick-anderson
description: Microsoft 的健全狀況監視系統會提供簡單且可自訂的方式來記錄各種 web 事件，包括未處理的例外狀況。 本教學課程將逐步引導儲存...
ms.author: riande
ms.date: 06/09/2009
ms.assetid: b1abb452-642a-4ff3-8504-37b85590ff79
msc.legacyurl: /web-forms/overview/older-versions-getting-started/deploying-web-site-projects/logging-error-details-with-asp-net-health-monitoring-cs
msc.type: authoredcontent
ms.openlocfilehash: 32f78927ae3e3f90392fea5968a035ab30c423ac
ms.sourcegitcommit: 45ac74e400f9f2b7dbded66297730f6f14a4eb25
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/16/2018
ms.locfileid: "41823655"
---
<a name="logging-error-details-with-aspnet-health-monitoring-c"></a><span data-ttu-id="b7c6e-104">記錄錯誤的詳細資料，使用 ASP.NET 狀況監控 (C#)</span><span class="sxs-lookup"><span data-stu-id="b7c6e-104">Logging Error Details with ASP.NET Health Monitoring (C#)</span></span>
====================
<span data-ttu-id="b7c6e-105">藉由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="b7c6e-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="b7c6e-106">[下載程式碼](http://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip)或[下載 PDF](http://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span><span class="sxs-lookup"><span data-stu-id="b7c6e-106">[Download Code](http://download.microsoft.com/download/1/0/C/10CC829F-A808-4302-97D3-59989B8F9C01/ASPNET_Hosting_Tutorial_13_CS.zip) or [Download PDF](http://download.microsoft.com/download/5/C/5/5C57DB8C-5DEA-4B3A-92CA-4405544D313B/aspnet_tutorial13_HealthMonitoring_cs.pdf)</span></span>

> <span data-ttu-id="b7c6e-107">Microsoft 的健全狀況監視系統會提供簡單且可自訂的方式來記錄各種 web 事件，包括未處理的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-107">Microsoft's health monitoring system provides an easy and customizable way to log various web events, including unhandled exceptions.</span></span> <span data-ttu-id="b7c6e-108">本教學課程會逐步設定狀況監控系統，以記錄至資料庫的未處理例外狀況，並通知開發人員透過電子郵件訊息。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-108">This tutorial walks through setting up the health monitoring system to log unhandled exceptions to a database and to notify developers via an email message.</span></span>


## <a name="introduction"></a><span data-ttu-id="b7c6e-109">簡介</span><span class="sxs-lookup"><span data-stu-id="b7c6e-109">Introduction</span></span>

<span data-ttu-id="b7c6e-110">記錄是很有用的工具來監視部署的應用程式的健全狀況及診斷任何可能發生的問題。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-110">Logging is a useful tool for monitoring the health of a deployed application and for diagnosing any problems that may arise.</span></span> <span data-ttu-id="b7c6e-111">它是特別重要的記錄，以便可以進行補救，已部署的應用程式中發生的錯誤。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-111">It is especially important to log errors that occur in a deployed application so that they can be remedied.</span></span> <span data-ttu-id="b7c6e-112">`Error`處理的例外狀況發生在 ASP.NET 應用程式; 時，就會引發事件[前述教學課程](processing-unhandled-exceptions-cs.md)示範了如何通知錯誤的開發人員，並藉由建立事件處理常式，如記錄其詳細資料`Error`事件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-112">The `Error` event is raised whenever an unhandled exception occurs in an ASP.NET application; the [preceding tutorial](processing-unhandled-exceptions-cs.md) showed how to notify a developer of an error and log its details by creating an event handler for the `Error` event.</span></span> <span data-ttu-id="b7c6e-113">不過，建立`Error`記錄錯誤的詳細資料，並告知開發人員的事件處理常式是不必要的與 ASP 的可執行這項工作。NET 的*狀況監控系統*。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-113">However, creating an `Error` event handler to log the error's details and notify a developer is unnecessary, as this task can be performed by ASP.NET's *health monitoring system*.</span></span>

<span data-ttu-id="b7c6e-114">狀況監控系統 ASP.NET 2.0 中引進，設計來監視部署的 ASP.NET 應用程式的健全狀況，在應用程式或要求的存留期期間發生的事件記錄。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-114">The health monitoring system was introduced in ASP.NET 2.0 and is designed to monitor the health of a deployed ASP.NET application by logging events that occur during the application or request's lifetime.</span></span> <span data-ttu-id="b7c6e-115">狀況監控系統所記錄的事件指*健康監視事件*或是*Web 事件*，並包含：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-115">The events logged by the health monitoring system are referred to as *health monitoring events* or *Web events*, and include:</span></span>

- <span data-ttu-id="b7c6e-116">應用程式存留期事件，例如當應用程式啟動或停止</span><span class="sxs-lookup"><span data-stu-id="b7c6e-116">Application lifetime events, such as when an application starts or stops</span></span>
- <span data-ttu-id="b7c6e-117">安全性事件，包括登入嘗試失敗，以及失敗的 URL 授權要求</span><span class="sxs-lookup"><span data-stu-id="b7c6e-117">Security events, including failed login attempts and failed URL authorization requests</span></span>
- <span data-ttu-id="b7c6e-118">應用程式錯誤，包括未處理例外狀況，剖析例外狀況、 要求驗證例外狀況和其他類型的錯誤之間的編譯錯誤的檢視狀態。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-118">Application errors, including unhandled exceptions, view state parsing exceptions, request validation exceptions, and compilation errors, among other types of errors.</span></span>

<span data-ttu-id="b7c6e-119">當健全狀況監視的事件引發時可以記錄至任何數目的指定*記錄來源*。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-119">When a health monitoring event is raised it can be logged to any number of specified *log sources*.</span></span> <span data-ttu-id="b7c6e-120">狀況監控系統隨附於 Web 事件記錄到至 Windows 事件記錄檔中，或透過電子郵件訊息，以及其他的 Microsoft SQL Server 資料庫的記錄檔來源。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-120">The health monitoring system ships with log sources that log Web events to a Microsoft SQL Server database, to the Windows Event Log, or via an email message, among others.</span></span> <span data-ttu-id="b7c6e-121">您也可以建立您自己的記錄檔來源。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-121">You can also create your own log sources.</span></span>

<span data-ttu-id="b7c6e-122">中所定義的事件監視系統健全狀況記錄檔，以及使用，記錄檔來源`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-122">The events the health monitoring system logs, along with the log sources used, are defined in `Web.config`.</span></span> <span data-ttu-id="b7c6e-123">只要幾行的組態標記中，您可以使用健全狀況監視記錄加入資料庫的所有未處理的例外狀況，並通知您透過電子郵件的例外狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-123">With a few lines of configuration markup you can use health monitoring to log all unhandled exceptions to a database and to notify you of the exception via email.</span></span>

## <a name="exploring-the-health-monitoring-systems-configuration"></a><span data-ttu-id="b7c6e-124">探索健全狀況監視系統的組態</span><span class="sxs-lookup"><span data-stu-id="b7c6e-124">Exploring the Health Monitoring System's Configuration</span></span>

<span data-ttu-id="b7c6e-125">狀況監控系統的行為由其組態資訊定義，位於[`<healthMonitoring>`項目](https://msdn.microsoft.com/library/2fwh2ss9.aspx)在`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-125">The health monitoring system's behavior is defined by its configuration information, which is located in the [`<healthMonitoring>` element](https://msdn.microsoft.com/library/2fwh2ss9.aspx) in `Web.config`.</span></span> <span data-ttu-id="b7c6e-126">這個組態區段會定義，以及其他項目中，下列三個重要部分的資訊：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-126">This configuration section defines, among other things, the following three important pieces of information:</span></span>

1. <span data-ttu-id="b7c6e-127">健康監視事件，當引發時，應該記錄</span><span class="sxs-lookup"><span data-stu-id="b7c6e-127">The health monitoring events that, when raised, should be logged,</span></span>
2. <span data-ttu-id="b7c6e-128">記錄檔來源，以及</span><span class="sxs-lookup"><span data-stu-id="b7c6e-128">The log sources, and</span></span>
3. <span data-ttu-id="b7c6e-129">每個健全狀況監視 (1) 中定義的事件對應至記錄檔來源的方式 (2) 中所定義。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-129">How each health monitoring event defined in (1) is mapped to the log sources defined in (2).</span></span>

<span data-ttu-id="b7c6e-130">這項資訊透過三個子系的組態項目指定： [ `<eventMappings>` ](https://msdn.microsoft.com/library/yc5yk01w.aspx)， [ `<providers>` ](https://msdn.microsoft.com/library/zaa41kz1.aspx)，以及[ `<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx)分別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-130">This information is specified through three children configuration elements: [`<eventMappings>`](https://msdn.microsoft.com/library/yc5yk01w.aspx), [`<providers>`](https://msdn.microsoft.com/library/zaa41kz1.aspx), and [`<rules>`](https://msdn.microsoft.com/library/fe5wyxa0.aspx), respectively.</span></span>

<span data-ttu-id="b7c6e-131">預設健全狀況監視的系統設定資訊位於`Web.config`檔案中`%WINDIR%\Microsoft.NET\Framework\version\CONFIG`資料夾。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-131">The default health monitoring system configuration information can be found in the `Web.config` file in `%WINDIR%\Microsoft.NET\Framework\version\CONFIG` folder.</span></span> <span data-ttu-id="b7c6e-132">此預設設定資訊中，為求簡潔，移除某個標記與如下所示：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-132">This default configuration information, with some markup removed for brevity, is shown below:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample1.xml)]

<span data-ttu-id="b7c6e-133">監視感興趣的事件中所定義的健全狀況`<eventMappings>`元素，其健康監視事件的類別會提供人類看得好記的名稱。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-133">The health monitoring events of interest are defined in the `<eventMappings>` element, which gives a human-friendly name to a class of health monitoring events.</span></span> <span data-ttu-id="b7c6e-134">在上述的標記`<eventMappings>`項目會人類的易記名稱 」 的所有錯誤 「 指定的健全狀況監視類型的事件`WebBaseErrorEvent`名稱 [失敗稽核] 健全狀況監視類型的事件和`WebFailureAuditEvent`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-134">In the markup above, the `<eventMappings>` element assigns the human-friendly name "All Errors" to the health monitoring events of type `WebBaseErrorEvent` and the name "Failure Audits" to health monitoring events of type `WebFailureAuditEvent`.</span></span>

<span data-ttu-id="b7c6e-135">`<providers>`項目會定義記錄檔的來源，讓他們人類的易記名稱，並指定任何記錄檔來源的特定組態資訊。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-135">The `<providers>` element defines the log sources, giving them a human-friendly name and specifying any log source-specific configuration information.</span></span> <span data-ttu-id="b7c6e-136">第一個`<add>`項目會定義 「 EventLogProvider"提供者，它會記錄指定的健全狀況監視使用的事件`EventLogWebEventProvider`類別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-136">The first `<add>` element defines the "EventLogProvider" provider, which logs the specified health monitoring events using the `EventLogWebEventProvider` class.</span></span> <span data-ttu-id="b7c6e-137">`EventLogWebEventProvider`類別的事件記錄至 Windows 事件記錄檔。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-137">The `EventLogWebEventProvider` class logs the event to the Windows Event Log.</span></span> <span data-ttu-id="b7c6e-138">第二個`<add>`項目會定義 「 SqlWebEventProvider"提供者，將事件記錄到 Microsoft SQL Server 資料庫透過`SqlWebEventProvider`類別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-138">The second `<add>` element defines the "SqlWebEventProvider" provider, which logs events to a Microsoft SQL Server database via the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="b7c6e-139">「 SqlWebEventProvider 」 組態中指定資料庫的連接字串 (`connectionStringName`) 等其他組態選項。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-139">The "SqlWebEventProvider" configuration specifies the database's connection string (`connectionStringName`) among other configuration options.</span></span>

<span data-ttu-id="b7c6e-140">`<rules>`項目對應中指定的事件`<eventMappings>`登入來源的項目`<providers>`項目。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-140">The `<rules>` element maps the events specified in the `<eventMappings>` element to log sources in the `<providers>` element.</span></span> <span data-ttu-id="b7c6e-141">根據預設，ASP.NET web 應用程式會記錄所有未處理的例外狀況，而稽核失敗 Windows 事件記錄檔。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-141">By default, ASP.NET web applications log all unhandled exceptions and audit failures to the Windows Event Log.</span></span>

## <a name="logging-events-to-a-database"></a><span data-ttu-id="b7c6e-142">事件記錄到資料庫</span><span class="sxs-lookup"><span data-stu-id="b7c6e-142">Logging Events to a Database</span></span>

<span data-ttu-id="b7c6e-143">狀況監控系統的預設組態可以新增的自訂 web 應用程式的 web 應用程式為基礎`<healthMonitoring>`一節，以應用程式的`Web.config`檔案。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-143">The health monitoring system's default configuration can be customized on a web application-by-web application basis by adding a `<healthMonitoring>` section to the application's `Web.config` file.</span></span> <span data-ttu-id="b7c6e-144">您可以包含在其他項目`<eventMappings>`， `<providers>`，並`<rules>`區段，方法是使用`<add>`項目。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-144">You can include additional elements in the `<eventMappings>`, `<providers>`, and `<rules>` sections by using the `<add>` element.</span></span> <span data-ttu-id="b7c6e-145">若要儦蘤飶從預設組態，請使用`<remove>`項目或使用`<clear />`移除其中一個區段的所有預設值。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-145">To remove a setting from the default configuration use the `<remove>` element, or use `<clear />` to remove all default values from one of these sections.</span></span> <span data-ttu-id="b7c6e-146">讓我們設定的書籍評論 web 應用程式使用 Microsoft SQL Server 資料庫記錄所有未處理的例外狀況`SqlWebEventProvider`類別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-146">Let's configure the Book Reviews web application to log all unhandled exceptions to a Microsoft SQL Server database using the `SqlWebEventProvider` class.</span></span>

<span data-ttu-id="b7c6e-147">`SqlWebEventProvider`類別是狀況監控系統的一部分，而記錄健康監視事件，以指定的 SQL Server 資料庫。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-147">The `SqlWebEventProvider` class is part of the health monitoring system and logs a health monitoring event to a specified SQL Server database.</span></span> <span data-ttu-id="b7c6e-148">`SqlWebEventProvider`類別必須是指定的資料庫包含名為預存程序`aspnet_WebEvent_LogEvent`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-148">The `SqlWebEventProvider` class expects that the specified database includes a stored procedure named `aspnet_WebEvent_LogEvent`.</span></span> <span data-ttu-id="b7c6e-149">這個預存程序會傳遞事件的詳細資料，並負責儲存事件的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-149">This stored procedure is passed the details of the event and is tasked with storing the event details.</span></span> <span data-ttu-id="b7c6e-150">好消息是您不需要建立此預存程序和資料表來儲存事件的詳細資料。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-150">The good news is that you do not need to create this stored procedure nor the table to store the event details.</span></span> <span data-ttu-id="b7c6e-151">您可以將這些物件新增至您的資料庫使用`aspnet_regsql.exe`工具。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-151">You can add these objects to your database using the `aspnet_regsql.exe` tool.</span></span>

> [!NOTE]
> <span data-ttu-id="b7c6e-152">`aspnet_regsql.exe`討論工具回到[*設定網站，會使用應用程式服務*教學課程](configuring-a-website-that-uses-application-services-cs.md)當我們新增了 asp 的支援。NET 的應用程式服務。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-152">The `aspnet_regsql.exe` tool was discussed back in the [*Configuring a Website That Uses Application Services* tutorial](configuring-a-website-that-uses-application-services-cs.md) when we added support for ASP.NET's application services.</span></span> <span data-ttu-id="b7c6e-153">因此，書籍評論網站的資料庫已經包含`aspnet_WebEvent_LogEvent`預存程序，將名為事件資訊儲存在`aspnet_WebEvent_Events`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-153">Consequently, the Book Reviews website's database already contains the `aspnet_WebEvent_LogEvent` stored procedure, which stores the event information into a table named `aspnet_WebEvent_Events`.</span></span>


<span data-ttu-id="b7c6e-154">一旦您擁有所需的預存程序和資料表加入至您的資料庫，全都是指示記錄到資料庫的所有未處理的例外狀況監視的健全狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-154">Once you have the necessary stored procedure and table added to your database, all that remains is to instruct health monitoring to log all unhandled exceptions to the database.</span></span> <span data-ttu-id="b7c6e-155">將下列標記新增至您的網站完成這項作業`Web.config`檔案：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-155">Accomplish this by adding the following markup to your website's `Web.config` file:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample2.xml)]

<span data-ttu-id="b7c6e-156">健全狀況監視會使用上述的組態標記`<clear />`抹除預先定義的健康情況監視來自組態資訊的項目`<eventMappings>`， `<providers>`，和`<rules>`區段。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-156">The health monitoring configuration markup above uses `<clear />` elements to wipe the pre-defined health monitoring configuration information from the `<eventMappings>`, `<providers>`, and `<rules>` sections.</span></span> <span data-ttu-id="b7c6e-157">接著，它會加入一個項目至每個區段。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-157">It then adds a single entry to each of these sections.</span></span>

- <span data-ttu-id="b7c6e-158">`<eventMappings>`項目會定義單一的健康狀態監視名為 「 所有錯誤 」，會引發未處理的例外狀況發生時的感興趣的事件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-158">The `<eventMappings>` element defines a single health monitoring event of interest named "All Errors", which is raised whenever an unhandled exception occurs.</span></span>
- <span data-ttu-id="b7c6e-159">`<providers>`項目會定義名為"SqlWebEventProvider 」 使用的單一記錄檔來源`SqlWebEventProvider`類別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-159">The `<providers>` element defines a single log source named "SqlWebEventProvider" that uses the `SqlWebEventProvider` class.</span></span> <span data-ttu-id="b7c6e-160">`connectionStringName`屬性已設定為"ReviewsConnectionString 」，也就是我們連接的名稱中所定義的字串`<connectionStrings>`一節。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-160">The `connectionStringName` attribute has been set to "ReviewsConnectionString", which is the name of our connection string defined in the `<connectionStrings>` section.</span></span>
- <span data-ttu-id="b7c6e-161">最後，&lt;規則&gt;項目表示，當 「 所有錯誤 」 事件瓿，它應該會記錄使用"SqlWebEventProvider 「 提供者。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-161">Finally, the &lt;rules&gt; element indicates that when an "All Errors" event transpires that it should be logged using the "SqlWebEventProvider" provider.</span></span>

<span data-ttu-id="b7c6e-162">此組態資訊會指示監視系統，以記錄所有未處理的例外狀況的書籍評論資料庫的健全狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-162">This configuration information instructs the health monitoring system to log all unhandled exceptions to the Book Reviews database.</span></span>

> [!NOTE]
> <span data-ttu-id="b7c6e-163">`WebBaseErrorEvent`才會引發事件的伺服器錯誤，它就不會引發 HTTP 錯誤，例如找不到 ASP.NET 資源的要求。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-163">The `WebBaseErrorEvent` event is only raised for server errors; it is not raised for HTTP errors, such as a request for an ASP.NET resource that is not found.</span></span> <span data-ttu-id="b7c6e-164">這與不同的行為`HttpApplication`類別的`Error`伺服器和 HTTP 錯誤，就會引發的事件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-164">This differs from the behavior of the `HttpApplication` class's `Error` event, which is raised for both server and HTTP errors.</span></span>


<span data-ttu-id="b7c6e-165">若要查看狀況監控系統作用中的，瀏覽網站和產生執行階段錯誤，請造訪`Genre.aspx?ID=foo`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-165">To see the health monitoring system in action, visit the website and generate a runtime error by visiting `Genre.aspx?ID=foo`.</span></span> <span data-ttu-id="b7c6e-166">您應該會看到適當的錯誤頁面-例外狀況詳細資料黃色死亡畫面 （當在本機瀏覽） 或自訂錯誤頁面 （瀏覽網站時在生產環境中）。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-166">You should see the appropriate error page - either the Exception Details Yellow Screen of Death (when visiting locally) or the custom error page (when visiting the site in production).</span></span> <span data-ttu-id="b7c6e-167">在幕後，狀況監控系統會記錄到資料庫資訊時發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-167">Behind the scenes, the health monitoring system logged the error information to the database.</span></span> <span data-ttu-id="b7c6e-168">應該有一筆記錄`aspnet_WebEvent_Events`資料表 (請參閱 < **圖 1**); 這個記錄包含剛剛才發生執行階段錯誤的相關資訊。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-168">There should be one record in the `aspnet_WebEvent_Events` table (see **Figure 1**); this record contains information about the runtime error that just occurred.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image2.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image1.png)

<span data-ttu-id="b7c6e-169">**圖 1**： 錯誤詳細資料登入到`aspnet_WebEvent_Events`資料表</span><span class="sxs-lookup"><span data-stu-id="b7c6e-169">**Figure 1**: The Error Details Were Logged to the `aspnet_WebEvent_Events` Table</span></span>  
<span data-ttu-id="b7c6e-170">([按一下以檢視完整大小的影像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="b7c6e-170">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image3.png))</span></span>

### <a name="displaying-the-error-log-in-a-web-page"></a><span data-ttu-id="b7c6e-171">在網頁上顯示的錯誤記錄檔</span><span class="sxs-lookup"><span data-stu-id="b7c6e-171">Displaying the Error Log In a Web Page</span></span>

<span data-ttu-id="b7c6e-172">使用網站的目前設定時，監視系統健全狀況會記錄所有未處理的例外狀況至資料庫。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-172">With the website's current configuration, the health monitoring system logs all unhandled exceptions to the database.</span></span> <span data-ttu-id="b7c6e-173">不過，健全狀況監視不提供任何機制可檢視錯誤記錄檔，透過網頁。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-173">However, health monitoring does not provide any mechanism to view the error log through a web page.</span></span> <span data-ttu-id="b7c6e-174">不過，您可以建置的 ASP.NET 網頁，會顯示資料庫的這項資訊。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-174">However, you could build an ASP.NET page that displays this information from the database.</span></span> <span data-ttu-id="b7c6e-175">（我們暫時會發現，您可以選擇以電子郵件傳送給您的錯誤詳細資料。）</span><span class="sxs-lookup"><span data-stu-id="b7c6e-175">(As we'll see momentarily, you can opt to have the error details sent to you in an email message.)</span></span>

<span data-ttu-id="b7c6e-176">如果您建立這類網頁時，請確定您採取行動，只允許已獲授權的使用者若要檢視錯誤詳細資料。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-176">If you create such a page, make sure you take steps to allow only authorized users to view the error details.</span></span> <span data-ttu-id="b7c6e-177">如果您的網站已採用使用者帳戶，則您可以使用 URL 授權規則來限制存取權給特定使用者或角色 頁面。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-177">If your site already employs user accounts then you can use URL authorization rules to restrict access to the page to certain users or roles.</span></span> <span data-ttu-id="b7c6e-178">如需有關如何授與或限制存取登入的使用者為基礎的 web 網頁的詳細資訊，請參閱我[網站安全性教學課程](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md)。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-178">For more information on how to grant or restrict access to web pages based on the logged in user, refer to my [Website Security Tutorials](../../older-versions-security/introduction/security-basics-and-asp-net-support-cs.md).</span></span>

> [!NOTE]
> <span data-ttu-id="b7c6e-179">後續的教學課程會探索名為 ELMAH 替代錯誤記錄和通知系統。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-179">The subsequent tutorial explores an alternative error logging and notification system named ELMAH.</span></span> <span data-ttu-id="b7c6e-180">ELMAH 包含內建的機制，以檢視錯誤記錄檔從這兩個網頁，並透過 rss 摘要。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-180">ELMAH includes a built-in mechanism to view the error log from both a web page and as an RSS feed.</span></span>


## <a name="logging-events-to-email"></a><span data-ttu-id="b7c6e-181">事件記錄到電子郵件</span><span class="sxs-lookup"><span data-stu-id="b7c6e-181">Logging Events to Email</span></span>

<span data-ttu-id="b7c6e-182">狀況監控系統包含電子郵件訊息 [記錄] 事件記錄檔來源提供者。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-182">The health monitoring system includes a log source provider that "logs" an event to an email message.</span></span> <span data-ttu-id="b7c6e-183">記錄檔來源包含相同的資訊記錄至電子郵件訊息內文中的資料庫。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-183">The log source includes the same information that is logged to the database in the email message body.</span></span> <span data-ttu-id="b7c6e-184">若要在特定的健全狀況監視事件發生時，通知開發人員，您可以使用此記錄檔來源。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-184">You can use this log source to notify a developer when a certain health monitoring event occurs.</span></span>

<span data-ttu-id="b7c6e-185">讓我們更新網站的設定，讓我們收到一封電子郵件時例外狀況發生的書籍評論。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-185">Let's update the Book Reviews website's configuration so that we receive an email whenever an exception occurs.</span></span> <span data-ttu-id="b7c6e-186">若要這麼做，我們需要執行三項工作：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-186">To accomplish this we need to perform three tasks:</span></span>

1. <span data-ttu-id="b7c6e-187">設定 ASP.NET web 應用程式傳送電子郵件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-187">Configure the ASP.NET web application to send email.</span></span> <span data-ttu-id="b7c6e-188">這可以藉由指定透過電子郵件訊息的傳送方式`<system.net>`組態項目。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-188">This is accomplished by specifying how email messages are sent via the `<system.net>` configuration element.</span></span> <span data-ttu-id="b7c6e-189">如需有關傳送電子郵件訊息中的 ASP.NET 應用程式來參考[在 ASP.NET 中的 傳送電子郵件](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx)並[System.Net.Mail 常見問題集](http://systemnetmail.com/)。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-189">For more information on sending email messages in an ASP.NET application refer to [Sending Email in ASP.NET](http://aspnet.4guysfromrolla.com/articles/072606-1.aspx) and the [System.Net.Mail FAQ](http://systemnetmail.com/).</span></span>
2. <span data-ttu-id="b7c6e-190">註冊電子郵件記錄來源提供者中的`<providers>`項目，以及</span><span class="sxs-lookup"><span data-stu-id="b7c6e-190">Register the email log source provider in the `<providers>` element, and</span></span>
3. <span data-ttu-id="b7c6e-191">新增項目以`<rules>`項目會對應至在步驟 (2) 中新增的記錄檔來源提供者的 「 所有錯誤 」 事件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-191">Add an entry to the `<rules>` element that maps the "All Errors" event to the log source provider added in step (2).</span></span>

<span data-ttu-id="b7c6e-192">狀況監控系統包含兩個電子郵件記錄來源提供者類別：`SimpleMailWebEventProvider`和`TemplatedMailWebEventProvider`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-192">The health monitoring system includes two email log source provider classes: `SimpleMailWebEventProvider` and `TemplatedMailWebEventProvider`.</span></span> <span data-ttu-id="b7c6e-193">[ `SimpleMailWebEventProvider`類別](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx)傳送純文字電子郵件訊息，其中包含事件詳細資料，並提供一些自訂的電子郵件內文。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-193">The [`SimpleMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.simplemailwebeventprovider.aspx) sends a plain-text email message that includes the event details and provides little customization of the email body.</span></span> <span data-ttu-id="b7c6e-194">具有[`TemplatedMailWebEventProvider`類別](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)指定 ASP.NET 網頁的呈現的標記會作為主體電子郵件訊息。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-194">With the [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) you specify an ASP.NET page whose rendered markup is used as the body for the email message.</span></span> <span data-ttu-id="b7c6e-195">[ `TemplatedMailWebEventProvider`類別](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx)可讓您的內容和格式的電子郵件訊息中，更進一步控制，但需要更多的前置工作，您必須建立 ASP.NET 網頁所產生的電子郵件訊息本文。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-195">The [`TemplatedMailWebEventProvider` class](https://msdn.microsoft.com/library/system.web.management.templatedmailwebeventprovider.aspx) gives you much greater control over the contents and format of the email message, but requires a bit more upfront work as you have to create the ASP.NET page that generates the email message's body.</span></span> <span data-ttu-id="b7c6e-196">本教學課程著重於使用`SimpleMailWebEventProvider`類別。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-196">This tutorial focuses on using the `SimpleMailWebEventProvider` class.</span></span>

<span data-ttu-id="b7c6e-197">更新監視系統的健康情況`<providers>`中的項目`Web.config`檔案，以包含的記錄檔來源`SimpleMailWebEventProvider`類別：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-197">Update the health monitoring system's `<providers>` element in the `Web.config` file to include a log source for the `SimpleMailWebEventProvider` class:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample3.xml)]

<span data-ttu-id="b7c6e-198">上述標記會使用`SimpleMailWebEventProvider`類別作為記錄檔來源提供者，並將其指派的易記名稱 「 EmailWebEventProvider"。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-198">The above markup uses the `SimpleMailWebEventProvider` class as the log source provider, and assigns it the friendly name "EmailWebEventProvider".</span></span> <span data-ttu-id="b7c6e-199">此外，`<add>`屬性包含其他組態選項，例如 收件者，以及來自電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-199">Moreover, the `<add>` attribute includes additional configuration options, such as the To and From addresses of the email message.</span></span>

<span data-ttu-id="b7c6e-200">與電子郵件記錄來源定義，全都是指示健全狀況監視系統，才能使用此來源以 「 記錄 」 未處理例外狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-200">With the email log source defined, all that remains is to instruct the health monitoring system to use this source to "log" unhandled exceptions.</span></span> <span data-ttu-id="b7c6e-201">這藉由加入新的規則，在`<rules>`區段：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-201">This is accomplished by adding a new rule in the `<rules>` section:</span></span>

[!code-xml[Main](logging-error-details-with-asp-net-health-monitoring-cs/samples/sample4.xml)]

<span data-ttu-id="b7c6e-202">`<rules>`區段現在包含兩個規則。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-202">The `<rules>` section now includes two rules.</span></span> <span data-ttu-id="b7c6e-203">第一個名為 「 所有錯誤以電子郵件 」，會將所有未處理的例外狀況傳送至 「 EmailWebEventProvider 」 記錄檔來源。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-203">The first one, named "All Errors To Email", sends all unhandled exceptions to the "EmailWebEventProvider" log source.</span></span> <span data-ttu-id="b7c6e-204">此規則的效果網站上的錯誤相關的詳細資料傳送至指定的位址。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-204">This rule has the effect of sending details about errors on the website to the specified To address.</span></span> <span data-ttu-id="b7c6e-205">「 所有錯誤到資料庫 」 規則會記錄至站台資料庫的錯誤詳細資料。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-205">The "All Errors To Database" rule logs the error details to the site's database.</span></span> <span data-ttu-id="b7c6e-206">因此，每次發生站台上其詳細資料的未處理的例外狀況時一併記錄到資料庫及傳送至指定的電子郵件地址。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-206">Consequently, whenever an unhandled exception occurs on the site its details are both logged to the database and sent to specified email address.</span></span>

<span data-ttu-id="b7c6e-207">**圖 2**顯示所產生的電子郵件`SimpleMailWebEventProvider`類別，在瀏覽`Genre.aspx?ID=foo`。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-207">**Figure 2** shows the email generated by the `SimpleMailWebEventProvider` class when visiting `Genre.aspx?ID=foo`.</span></span>

[![](logging-error-details-with-asp-net-health-monitoring-cs/_static/image5.png)](logging-error-details-with-asp-net-health-monitoring-cs/_static/image4.png)

<span data-ttu-id="b7c6e-208">**圖 2**: 錯誤詳細資料會傳送電子郵件訊息</span><span class="sxs-lookup"><span data-stu-id="b7c6e-208">**Figure 2**: The Error Details are Sent in an Email Message</span></span>  
<span data-ttu-id="b7c6e-209">([按一下以檢視完整大小的影像](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="b7c6e-209">([Click to view full-size image](logging-error-details-with-asp-net-health-monitoring-cs/_static/image6.png))</span></span>

## <a name="summary"></a><span data-ttu-id="b7c6e-210">總結</span><span class="sxs-lookup"><span data-stu-id="b7c6e-210">Summary</span></span>

<span data-ttu-id="b7c6e-211">ASP.NET 健康監視系統可讓系統管理員可以監視已部署的 web 應用程式的健全狀況。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-211">The ASP.NET health monitoring system is designed to allow administrators to monitor the health of a deployed web application.</span></span> <span data-ttu-id="b7c6e-212">展開特定的動作，例如當應用程式停止時，當使用者成功登入網站，或未處理的例外狀況發生時，會引發健康情況監視的事件。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-212">Health monitoring events are raised when certain actions unfold, such as when the application stops, when a user successfully logs onto the site, or when an unhandled exception occurs.</span></span> <span data-ttu-id="b7c6e-213">這些事件可以記錄至任何數目的記錄檔來源。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-213">These events can be logged to any number of log sources.</span></span> <span data-ttu-id="b7c6e-214">本教學課程會示範如何將記錄的未處理例外狀況詳細資料的資料庫，以及透過電子郵件訊息。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-214">This tutorial showed how to log the details of unhandled exceptions to a database and through an email message.</span></span>

<span data-ttu-id="b7c6e-215">本教學課程著重於使用狀況監控記錄未處理的例外狀況，但請記住，健康狀態監控設計來測量所部署的 ASP.NET 應用程式的整體健全狀況，以及包括豐富的健全狀況監視的事件並不記錄來源此探索。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-215">This tutorial focused on using health monitoring to log unhandled exceptions, but keep in mind that health monitoring is designed to measure the overall health of a deployed ASP.NET application and includes a wealth of health monitoring events and log sources not explored here.</span></span> <span data-ttu-id="b7c6e-216">什麼是多個項目，您可以建立您自己的健全狀況監視的事件和記錄檔來源，需要發生。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-216">What's more, you can create your own health monitoring events and log sources, should the need arise.</span></span> <span data-ttu-id="b7c6e-217">如果您有興趣深入了解健康狀態監視，良好的第一個步驟是閱讀[Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)的[健全狀況監視常見問題集](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-217">If you are interested in learning more about health monitoring, a good first step is to read through [Erik Reitan](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)'s [health monitoring FAQ](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx).</span></span> <span data-ttu-id="b7c6e-218">接下來，請參閱[How To： 使用 ASP.NET 2.0 中的健全狀況監視](https://msdn.microsoft.com/library/ms998306.aspx)。</span><span class="sxs-lookup"><span data-stu-id="b7c6e-218">Following that, consult [How To: Use Health Monitoring in ASP.NET 2.0](https://msdn.microsoft.com/library/ms998306.aspx).</span></span>

<span data-ttu-id="b7c6e-219">快樂地寫程式 ！</span><span class="sxs-lookup"><span data-stu-id="b7c6e-219">Happy Programming!</span></span>

### <a name="further-reading"></a><span data-ttu-id="b7c6e-220">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="b7c6e-220">Further Reading</span></span>

<span data-ttu-id="b7c6e-221">如需有關在本教學課程所討論的主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="b7c6e-221">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="b7c6e-222">ASP.NET 健康監視概觀</span><span class="sxs-lookup"><span data-stu-id="b7c6e-222">ASP.NET Health Monitoring Overview</span></span>](https://msdn.microsoft.com/library/bb398933.aspx)
- [<span data-ttu-id="b7c6e-223">設定和自訂健全狀況監視的 ASP.NET 的系統</span><span class="sxs-lookup"><span data-stu-id="b7c6e-223">Configuring and Customizing the Health Monitoring System of ASP.NET</span></span>](http://dotnetslackers.com/articles/aspnet/ConfiguringAndCustomizingTheHealthMonitoringSystemOfASPNET.aspx)
- [<span data-ttu-id="b7c6e-224">常見問題集-在 ASP.NET 2.0 中監視的健全狀況</span><span class="sxs-lookup"><span data-stu-id="b7c6e-224">FAQ - Health Monitoring in ASP.NET 2.0</span></span>](https://blogs.msdn.com/erikreitan/archive/2006/05/22/603586.aspx)
- [<span data-ttu-id="b7c6e-225">如何： 傳送電子郵件健康情況監視通知</span><span class="sxs-lookup"><span data-stu-id="b7c6e-225">How To: Send E-Mail for Health Monitoring Notifications</span></span>](https://msdn.microsoft.com/library/ms227553.aspx)
- [<span data-ttu-id="b7c6e-226">如何： 使用 ASP.NET 的健康狀態監視</span><span class="sxs-lookup"><span data-stu-id="b7c6e-226">How To: Use Health Monitoring in ASP.NET</span></span>](https://msdn.microsoft.com/library/ms998306.aspx)
- [<span data-ttu-id="b7c6e-227">在 ASP.NET 中監視的健全狀況</span><span class="sxs-lookup"><span data-stu-id="b7c6e-227">Health Monitoring in ASP.NET</span></span>](http://aspnet.4guysfromrolla.com/articles/031407-1.aspx)

> [!div class="step-by-step"]
> <span data-ttu-id="b7c6e-228">[上一頁](processing-unhandled-exceptions-cs.md)
> [下一頁](logging-error-details-with-elmah-cs.md)</span><span class="sxs-lookup"><span data-stu-id="b7c6e-228">[Previous](processing-unhandled-exceptions-cs.md)
[Next](logging-error-details-with-elmah-cs.md)</span></span>
