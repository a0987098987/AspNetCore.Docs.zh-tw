---
uid: web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
title: 建立預存程序和使用者定義函數的 Managed 程式碼 (C#) |Microsoft Docs
author: rick-anderson
description: Microsoft SQL Server 2005 整合了.NET Common Language Runtime 可讓開發人員建立透過 managed 程式碼的資料庫物件。 本教學課程...
ms.author: aspnetcontent
ms.date: 08/03/2007
ms.assetid: 213eea41-1ab4-4371-8b24-1a1a66c515de
msc.legacyurl: /web-forms/overview/data-access/advanced-data-access-scenarios/creating-stored-procedures-and-user-defined-functions-with-managed-code-cs
msc.type: authoredcontent
ms.openlocfilehash: 33ec7cfbb029c1a0e5200eb61aa4e39b02d991f3
ms.sourcegitcommit: b28cd0313af316c051c2ff8549865bff67f2fbb4
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 07/05/2018
ms.locfileid: "37824412"
---
<a name="creating-stored-procedures-and-user-defined-functions-with-managed-code-c"></a><span data-ttu-id="56bd3-104">建立預存程序和使用者定義函式，以 Managed 程式碼 (C#)</span><span class="sxs-lookup"><span data-stu-id="56bd3-104">Creating Stored Procedures and User-Defined Functions with Managed Code (C#)</span></span>
====================
<span data-ttu-id="56bd3-105">藉由[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="56bd3-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="56bd3-106">[下載程式碼](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip)或[下載 PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="56bd3-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_75_CS.zip) or [Download PDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/datatutorial75cs1.pdf)</span></span>

> <span data-ttu-id="56bd3-107">Microsoft SQL Server 2005 整合了.NET Common Language Runtime 可讓開發人員建立透過 managed 程式碼的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-107">Microsoft SQL Server 2005 integrates with the .NET Common Language Runtime to allow developers to create database objects through managed code.</span></span> <span data-ttu-id="56bd3-108">本教學課程會示範如何建立 managed 預存程序，並管理您的 Visual Basic 或 C# 程式碼的使用者定義函數。</span><span class="sxs-lookup"><span data-stu-id="56bd3-108">This tutorial shows how to create managed stored procedures and managed user-defined functions with your Visual Basic or C# code.</span></span> <span data-ttu-id="56bd3-109">我們也會看到這些版本的 Visual Studio 如何讓您偵錯這類的 managed 的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-109">We also see how these editions of Visual Studio allow you to debug such managed database objects.</span></span>


## <a name="introduction"></a><span data-ttu-id="56bd3-110">簡介</span><span class="sxs-lookup"><span data-stu-id="56bd3-110">Introduction</span></span>

<span data-ttu-id="56bd3-111">使用如 Microsoft 的 SQL Server 2005 的資料庫[Transact-Structured 查詢語言 (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL)插入、 修改和擷取資料。</span><span class="sxs-lookup"><span data-stu-id="56bd3-111">Databases like Microsoft s SQL Server 2005 use the [Transact-Structured Query Language (T-SQL)](http://en.wikipedia.org/wiki/Transact-SQL) for inserting, modifying, and retrieving data.</span></span> <span data-ttu-id="56bd3-112">大部分的資料庫系統包含群組的 SQL 陳述式，則可以執行為單一、 可重複使用單位的一系列的建構。</span><span class="sxs-lookup"><span data-stu-id="56bd3-112">Most database systems include constructs for grouping a series of SQL statements that can then be executed as a single, reusable unit.</span></span> <span data-ttu-id="56bd3-113">預存程序是一個範例。</span><span class="sxs-lookup"><span data-stu-id="56bd3-113">Stored procedures are one example.</span></span> <span data-ttu-id="56bd3-114">另一個是*使用者定義函式*(Udf)，我們將在步驟 9 中的更詳細地檢查的建構。</span><span class="sxs-lookup"><span data-stu-id="56bd3-114">Another is *User-Defined Functions*(UDFs), a construct that we will examine in greater detail in Step 9.</span></span>

<span data-ttu-id="56bd3-115">基本上，SQL 被設計用於處理的資料集。</span><span class="sxs-lookup"><span data-stu-id="56bd3-115">At its core, SQL is designed for working with sets of data.</span></span> <span data-ttu-id="56bd3-116">`SELECT`， `UPDATE`，並`DELETE`陳述式本質上套用至對應資料表中的所有記錄，並只受限於其`WHERE`子句。</span><span class="sxs-lookup"><span data-stu-id="56bd3-116">The `SELECT`, `UPDATE`, and `DELETE` statements inherently apply to all records in the corresponding table and are only limited by their `WHERE` clauses.</span></span> <span data-ttu-id="56bd3-117">尚未有許多設計使用一次一筆記錄，並處理純量資料的語言功能。</span><span class="sxs-lookup"><span data-stu-id="56bd3-117">Yet there are many language features designed for working with one record at a time and for manipulating scalar data.</span></span> <span data-ttu-id="56bd3-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553)提供一組記錄，透過一次執行迴圈。</span><span class="sxs-lookup"><span data-stu-id="56bd3-118">[`CURSOR` s](http://www.sqlteam.com/item.asp?ItemID=553) allow for a set of records to be looped through one at a time.</span></span> <span data-ttu-id="56bd3-119">字串操作函式，例如`LEFT`， `CHARINDEX`，和`PATINDEX`搭配純量資料。</span><span class="sxs-lookup"><span data-stu-id="56bd3-119">String manipulation functions like `LEFT`, `CHARINDEX`, and `PATINDEX` work with scalar data.</span></span> <span data-ttu-id="56bd3-120">SQL 也會包含控制流程陳述式，例如`IF`和`WHILE`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-120">SQL also includes control flow statements like `IF` and `WHILE`.</span></span>

<span data-ttu-id="56bd3-121">Microsoft SQL Server 2005 之前, 預存程序和 Udf 可以只定義為 T-SQL 陳述式的集合。</span><span class="sxs-lookup"><span data-stu-id="56bd3-121">Prior to Microsoft SQL Server 2005, stored procedures and UDFs could only be defined as a collection of T-SQL statements.</span></span> <span data-ttu-id="56bd3-122">SQL Server 2005，不過，用意是要提供與整合[Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx)，這是所有的.NET 組件所使用的執行階段。</span><span class="sxs-lookup"><span data-stu-id="56bd3-122">SQL Server 2005, however, was designed to provide integration with the [Common Language Runtime (CLR)](https://msdn.microsoft.com/netframework/aa497266.aspx), which is the runtime used by all .NET assemblies.</span></span> <span data-ttu-id="56bd3-123">因此，預存程序和 Udf，SQL Server 2005 資料庫中的可以建立使用 managed 程式碼。</span><span class="sxs-lookup"><span data-stu-id="56bd3-123">Consequently, the stored procedures and UDFs in a SQL Server 2005 database can be created using managed code.</span></span> <span data-ttu-id="56bd3-124">也就是說，您可以建立預存程序或 UDF 為 C# 類別的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-124">That is, you can create a stored procedure or UDF as a method in a C# class.</span></span> <span data-ttu-id="56bd3-125">這可讓這些預存程序和 Udf，以利用.NET Framework 中，並從您自己的自訂類別的功能。</span><span class="sxs-lookup"><span data-stu-id="56bd3-125">This enables these stored procedures and UDFs to utilize functionality in the .NET Framework and from your own custom classes.</span></span>

<span data-ttu-id="56bd3-126">在此教學課程中，我們會檢驗如何建立 managed 預存程序和使用者定義函式，以及如何將它們整合到我們的 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-126">In this tutorial we will examine how to create managed stored procedures and User-Defined Functions and how to integrate them into our Northwind database.</span></span> <span data-ttu-id="56bd3-127">讓 s 開始 ！</span><span class="sxs-lookup"><span data-stu-id="56bd3-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-128">Managed 的資料庫物件會提供一些優於其 SQL 對應項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-128">Managed database objects offer some advantages over their SQL counterparts.</span></span> <span data-ttu-id="56bd3-129">語言豐富功能和熟悉度及重複使用現有的程式碼和邏輯的能力是主要的優點。</span><span class="sxs-lookup"><span data-stu-id="56bd3-129">Language richness and familiarity and the ability to reuse existing code and logic are the main advantages.</span></span> <span data-ttu-id="56bd3-130">但 managed 的資料庫物件有可能使用不涉及多程序邏輯的資料集時為比較沒有效率。</span><span class="sxs-lookup"><span data-stu-id="56bd3-130">But managed database objects are likely to be less efficient when working with sets of data that do not involve much procedural logic.</span></span> <span data-ttu-id="56bd3-131">如需優點使用 T-SQL 與 managed 程式碼的更完整討論，請參閱[優點的使用 Managed 程式碼建立資料庫物件](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-131">For a more thorough discussion on the advantages of using managed code versus T-SQL, check out the [Advantages of Using Managed Code to Create Database Objects](https://msdn.microsoft.com/library/k2e1fb36(VS.80).aspx).</span></span>


## <a name="step-1-moving-the-northwind-database-out-ofappdata"></a><span data-ttu-id="56bd3-132">步驟 1︰ 移出的 Northwind 資料庫`App_Data`</span><span class="sxs-lookup"><span data-stu-id="56bd3-132">Step 1: Moving the Northwind Database Out of`App_Data`</span></span>

<span data-ttu-id="56bd3-133">我們的教學課程的所有目前為止已使用 Microsoft SQL Server 2005 Express 的 Edition 資料庫檔案中之 web 應用程式`App_Data`資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-133">All of our tutorials thus far have used a Microsoft SQL Server 2005 Express Edition database file in the web application s `App_Data` folder.</span></span> <span data-ttu-id="56bd3-134">將資料庫中的放置`App_Data`簡化發佈和執行這些教學課程，以及所有的檔案是位於一個目錄所不需的任何其他組態步驟，以測試本教學課程。</span><span class="sxs-lookup"><span data-stu-id="56bd3-134">Placing the database in `App_Data` simplified distributing and running these tutorials as all of the files were located within one directory and required no additional configuration steps to test the tutorial.</span></span>

<span data-ttu-id="56bd3-135">本教學課程中，不過，讓的 Northwind 將資料庫移出`App_Data`並明確地向 SQL Server 2005 Express Edition 資料庫執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-135">For this tutorial, however, let s move the Northwind database out of `App_Data` and explicitly register it with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="56bd3-136">雖然我們可以執行本教學課程中使用的資料庫中的步驟`App_Data`資料夾中，數個步驟會更簡單藉由明確地向 SQL Server 2005 Express Edition 資料庫執行個體中的資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-136">While we can perform the steps for this tutorial with the database in the `App_Data` folder, a number of the steps are made much simpler by explicitly registering the database with the SQL Server 2005 Express Edition database instance.</span></span>

<span data-ttu-id="56bd3-137">本教學課程中下載有兩個資料庫檔案-`NORTHWND.MDF`並`NORTHWND_log.LDF`放在名為的資料夾中- `DataFiles`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-137">The download for this tutorial has the two database files - `NORTHWND.MDF` and `NORTHWND_log.LDF` - placed in a folder named `DataFiles`.</span></span> <span data-ttu-id="56bd3-138">如果您密切注意您自己的實作，教學課程，請關閉 Visual Studio，並移`NORTHWND.MDF`並`NORTHWND_log.LDF`檔案，從網站的`App_Data`至外部網站資料夾的資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-138">If you are following along with your own implementation of the tutorials, close Visual Studio and move the `NORTHWND.MDF` and `NORTHWND_log.LDF` files from the website s `App_Data` folder to a folder outside of the website.</span></span> <span data-ttu-id="56bd3-139">一旦將資料庫檔案已移到另一個資料夾我們必須向 Northwind 資料庫的 SQL Server 2005 Express Edition 資料庫執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-139">Once the database files have been moved to another folder we need to register the Northwind database with the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="56bd3-140">這可從 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="56bd3-140">This can be done from SQL Server Management Studio.</span></span> <span data-ttu-id="56bd3-141">如果您有非-Express Edition 的 SQL Server 2005 安裝在您的電腦上則您可能已經有安裝 Management Studio。</span><span class="sxs-lookup"><span data-stu-id="56bd3-141">If you have a non-Express Edition of SQL Server 2005 installed on your computer then you likely already have Management Studio installed.</span></span> <span data-ttu-id="56bd3-142">如果您只在您的電腦上有 SQL Server 2005 Express Edition，請花一點時間下載並安裝[Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-142">If you only have SQL Server 2005 Express Edition on your computer then take a moment to download and install [Microsoft SQL Server Management Studio Express](https://www.microsoft.com/downloads/details.aspx?displaylang=en&amp;FamilyID=C243A5AE-4BD1-4E3D-94B8-5A0F62BF7796).</span></span>

<span data-ttu-id="56bd3-143">啟動 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="56bd3-143">Launch SQL Server Management Studio.</span></span> <span data-ttu-id="56bd3-144">如 [圖 1] 所示，Management Studio 一開始會詢問您要連接到哪一部伺服器。</span><span class="sxs-lookup"><span data-stu-id="56bd3-144">As Figure 1 shows, Management Studio starts by asking what server to connect to.</span></span> <span data-ttu-id="56bd3-145">Localhost\SQLExpress 輸入伺服器名稱，在驗證 下拉式清單中，選擇 Windows 驗證，按一下 連接。</span><span class="sxs-lookup"><span data-stu-id="56bd3-145">Enter localhost\SQLExpress for the server name, choose Windows Authentication in the Authentication drop-down list, and click Connect.</span></span>


![連接到適當的資料庫執行個體](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image1.png)

<span data-ttu-id="56bd3-147">**圖 1**： 連接到適當的資料庫執行個體</span><span class="sxs-lookup"><span data-stu-id="56bd3-147">**Figure 1**: Connect to the Appropriate Database Instance</span></span>


<span data-ttu-id="56bd3-148">一旦您已連線，[物件總管] 視窗會列出 SQL Server 2005 Express Edition 資料庫執行個體，包括資料庫、 安全性資訊、 管理選項等相關資訊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-148">Once you ve connected, the Object Explorer window will list information about the SQL Server 2005 Express Edition database instance, including its databases, security information, management options, and so forth.</span></span>

<span data-ttu-id="56bd3-149">我們要附加 Northwind 資料庫中的`DataFiles`資料夾 （或只要您可能會將其移動） 到 SQL Server 2005 Express Edition 資料庫執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-149">We need to attach the Northwind database in the `DataFiles` folder (or wherever you may have moved it) to the SQL Server 2005 Express Edition database instance.</span></span> <span data-ttu-id="56bd3-150">以滑鼠右鍵按一下 [資料庫] 資料夾，並從內容功能表中選擇 [附加] 選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-150">Right-click on the Databases folder and choose the Attach option from the context menu.</span></span> <span data-ttu-id="56bd3-151">這會顯示 [附加資料庫] 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-151">This will bring up the Attach Databases dialog box.</span></span> <span data-ttu-id="56bd3-152">按一下 [新增] 按鈕，向下鑽研至適當`NORTHWND.MDF`檔案，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-152">Click the Add button, drill down to the appropriate `NORTHWND.MDF` file, and click OK.</span></span> <span data-ttu-id="56bd3-153">此時您的畫面應該看起來類似 圖 2。</span><span class="sxs-lookup"><span data-stu-id="56bd3-153">At this point your screen should look similar to Figure 2.</span></span>


<span data-ttu-id="56bd3-154">[![連接到適當的資料庫執行個體](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-154">[![Connect to the Appropriate Database Instance](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image3.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image2.png)</span></span>

<span data-ttu-id="56bd3-155">**圖 2**： 連接到適當的資料庫執行個體 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-155">**Figure 2**: Connect to the Appropriate Database Instance ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image4.png))</span></span>


> [!NOTE]
> <span data-ttu-id="56bd3-156">當連接到 SQL Server 2005 Express Edition 執行個體，透過 Management Studio 附加資料庫 對話方塊中不允許您向下切入至 使用者設定檔的目錄，例如 我的文件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-156">When connecting to the SQL Server 2005 Express Edition instance through Management Studio the Attach Databases dialog box does not allow you to drill down into user profile directories, such as My Documents.</span></span> <span data-ttu-id="56bd3-157">因此，請確定放`NORTHWND.MDF`和`NORTHWND_log.LDF`非使用者設定檔目錄中的檔案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-157">Therefore, make sure to place the `NORTHWND.MDF` and `NORTHWND_log.LDF` files in a non-user profile directory.</span></span>


<span data-ttu-id="56bd3-158">按一下 [確定] 按鈕，以附加資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-158">Click the OK button to attach the database.</span></span> <span data-ttu-id="56bd3-159">[附加資料庫] 對話方塊會關閉，[物件總管] 現在應該會列出剛才附加的資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-159">The Attach Databases dialog box will close and the Object Explorer should now list the just-attached database.</span></span> <span data-ttu-id="56bd3-160">您想要的資料庫有名稱，例如 Northwind `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-160">Chances are the Northwind database has a name like `9FE54661B32FDD967F51D71D0D5145CC_LINE ARTICLES\DATATUTORIALS\VOLUME 3\CSHARP\73\ASPNET_DATA_TUTORIAL_75_CS\APP_DATA\NORTHWND.MDF`.</span></span> <span data-ttu-id="56bd3-161">重新命名資料庫以 Northwind 資料庫上按一下滑鼠右鍵，然後選擇 重新命名。</span><span class="sxs-lookup"><span data-stu-id="56bd3-161">Rename the database to Northwind by right-clicking on the database and choosing Rename.</span></span>


![重新命名資料庫以 Northwind](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image5.png)

<span data-ttu-id="56bd3-163">**圖 3**： 重新命名資料庫以 Northwind</span><span class="sxs-lookup"><span data-stu-id="56bd3-163">**Figure 3**: Rename the Database to Northwind</span></span>


## <a name="step-2-creating-a-new-solution-and-sql-server-project-in-visual-studio"></a><span data-ttu-id="56bd3-164">步驟 2： 在 Visual Studio 中建立新的方案和 SQL Server 專案</span><span class="sxs-lookup"><span data-stu-id="56bd3-164">Step 2: Creating a New Solution and SQL Server Project in Visual Studio</span></span>

<span data-ttu-id="56bd3-165">若要建立 SQL Server 2005 中的 受管理的預存程序或 Udf 我們會為類別中的 C# 程式碼撰寫的預存程序和 UDF 邏輯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-165">To create managed stored procedures or UDFs in SQL Server 2005 we will write the stored procedure and UDF logic as C# code in a class.</span></span> <span data-ttu-id="56bd3-166">一旦已撰寫的程式碼，我們需要此類別編譯為組件 (`.dll`檔案) 使用 SQL Server 資料庫時，註冊組件，然後建立指向的相對應的方法，在資料庫中的 預存程序或 UDF 物件組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-166">Once the code has been written, we will need to compile this class into an assembly (a `.dll` file), register the assembly with the SQL Server database, and then create a stored procedure or UDF object in the database that points to the corresponding method in the assembly.</span></span> <span data-ttu-id="56bd3-167">這些步驟可以所有手動執行。</span><span class="sxs-lookup"><span data-stu-id="56bd3-167">These steps can all be performed manually.</span></span> <span data-ttu-id="56bd3-168">我們可以在任何文字編輯器建立的程式碼，從命令列使用 C# 編譯器編譯它 ([`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx))，向使用[ `CREATE ASSEMBLY` ](https://msdn.microsoft.com/library/ms189524.aspx)命令，或從管理Studio 中，並加入預存程序或 UDF 物件，可透過類似的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-168">We can create the code in any text editor, compile it from the command line using the C# compiler ([`csc.exe`](https://msdn.microsoft.com/library/ms379563(vs.80).aspx)), register it with the database using the [`CREATE ASSEMBLY`](https://msdn.microsoft.com/library/ms189524.aspx) command or from Management Studio, and add the stored procedure or UDF object through similar means.</span></span> <span data-ttu-id="56bd3-169">幸運的是，Visual Studio Professional 和 Team 系統版本包含 SQL Server 專案類型，用來自動化這些工作。</span><span class="sxs-lookup"><span data-stu-id="56bd3-169">Fortunately, the Professional and Team Systems versions of Visual Studio include a SQL Server Project type that automates these tasks.</span></span> <span data-ttu-id="56bd3-170">在本教學課程中我們將逐步引導使用 SQL Server 專案類型來建立 managed 預存程序和 UDF。</span><span class="sxs-lookup"><span data-stu-id="56bd3-170">In this tutorial we will walk through using the SQL Server Project type to create a managed stored procedure and UDF.</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-171">如果您使用 Visual Web Developer 或 Standard edition 的 Visual Studio，則您必須改為使用手動方式。</span><span class="sxs-lookup"><span data-stu-id="56bd3-171">If you are using Visual Web Developer or the Standard edition of Visual Studio, then you will have to use the manual approach instead.</span></span> <span data-ttu-id="56bd3-172">步驟 13 中提供了以手動方式執行這些步驟的詳細的指示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-172">Step 13 provides detailed instructions for performing these steps manually.</span></span> <span data-ttu-id="56bd3-173">建議您閱讀 12 中的步驟 2，再閱讀步驟 13，因為這些步驟包括重要必須套用不論您使用哪個版本的 Visual Studio 的 SQL Server 組態指示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-173">I encourage you to read Steps 2 through 12 before reading Step 13 since these steps include important SQL Server configuration instructions that must be applied regardless of what version of Visual Studio you are using.</span></span>


<span data-ttu-id="56bd3-174">首先開啟 Visual Studio。</span><span class="sxs-lookup"><span data-stu-id="56bd3-174">Start by opening Visual Studio.</span></span> <span data-ttu-id="56bd3-175">從 檔案 功能表中，選擇 新增專案 以顯示 新增專案 對話方塊 （請參閱 圖 4）。</span><span class="sxs-lookup"><span data-stu-id="56bd3-175">From the File menu, choose New Project to display the New Project dialog box (see Figure 4).</span></span> <span data-ttu-id="56bd3-176">向下鑽研至資料庫專案類型，並從列於右側的範本，然後選擇 建立新的 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-176">Drill down to the Database project type and then, from the Templates listed on the right, choose to create a new SQL Server Project.</span></span> <span data-ttu-id="56bd3-177">我選擇此專案的名稱，`ManagedDatabaseConstructs`並放置在名為方案內`Tutorial75`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-177">I have chosen to name this project `ManagedDatabaseConstructs` and placed it within a Solution named `Tutorial75`.</span></span>


<span data-ttu-id="56bd3-178">[![建立新的 SQL Server 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-178">[![Create a New SQL Server Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image7.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image6.png)</span></span>

<span data-ttu-id="56bd3-179">**圖 4**： 建立新的 SQL Server 專案 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-179">**Figure 4**: Create a New SQL Server Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image8.png))</span></span>


<span data-ttu-id="56bd3-180">按一下 [新增專案] 對話方塊中，建立方案和 SQL Server 專案中的 [確定] 按鈕。</span><span class="sxs-lookup"><span data-stu-id="56bd3-180">Click the OK button in the New Project dialog box to create the Solution and SQL Server Project.</span></span>

<span data-ttu-id="56bd3-181">SQL Server 專案繫結至特定的資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-181">A SQL Server Project is tied to a particular database.</span></span> <span data-ttu-id="56bd3-182">因此，建立新的 SQL Server 專案之後我們會立即要求您指定這項資訊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-182">Consequently, after creating the new SQL Server Project we are immediately asked to specify this information.</span></span> <span data-ttu-id="56bd3-183">圖 5 顯示具有指向我們註冊 SQL Server 2005 Express Edition 資料庫執行個體，在 步驟 1 中的 Northwind 資料庫填妥 新增資料庫參考 對話方塊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-183">Figure 5 shows the New Database Reference dialog box that has been filled out to point to the Northwind database we registered in the SQL Server 2005 Express Edition database instance back in Step 1.</span></span>


![與 Northwind 資料庫產生關聯的 SQL Server 專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image9.png)

<span data-ttu-id="56bd3-185">**圖 5**： 關聯 Northwind 資料庫的 SQL Server 專案</span><span class="sxs-lookup"><span data-stu-id="56bd3-185">**Figure 5**: Associate the SQL Server Project with the Northwind Database</span></span>


<span data-ttu-id="56bd3-186">若要偵錯 managed 預存程序和 Udf，我們將建立在此專案中，我們要啟用 SQL/CLR 偵錯連接的支援。</span><span class="sxs-lookup"><span data-stu-id="56bd3-186">In order to debug the managed stored procedures and UDFs we will create within this project, we need to enable SQL/CLR debugging support for the connection.</span></span> <span data-ttu-id="56bd3-187">每當 SQL Server 專案與新的資料庫產生關聯，（如同我們在 圖 5），Visual Studio 會詢問您是否我們想要啟用在連接上的 SQL/CLR 偵錯 （請參閱 圖 6）。</span><span class="sxs-lookup"><span data-stu-id="56bd3-187">Whenever associating a SQL Server Project with a new database (as we did in Figure 5), Visual Studio asks us if we want to enable SQL/CLR debugging on the connection (see Figure 6).</span></span> <span data-ttu-id="56bd3-188">按一下 [是]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-188">Click Yes.</span></span>


![啟用 SQL/CLR 偵錯](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image10.png)

<span data-ttu-id="56bd3-190">**圖 6**： 啟用 SQL/CLR 偵錯</span><span class="sxs-lookup"><span data-stu-id="56bd3-190">**Figure 6**: Enable SQL/CLR Debugging</span></span>


<span data-ttu-id="56bd3-191">此時新的 SQL Server 專案有已加入至方案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-191">At this point the new SQL Server Project has been added to the Solution.</span></span> <span data-ttu-id="56bd3-192">它包含名為的資料夾`Test Scripts`檔案，名為`Test.sql`，後者用來偵錯 managed 的資料庫物件，在專案中建立。</span><span class="sxs-lookup"><span data-stu-id="56bd3-192">It contains a folder named `Test Scripts` with a file named `Test.sql`, which is used for debugging the managed database objects created in the project.</span></span> <span data-ttu-id="56bd3-193">我們將探討在步驟 12 中偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-193">We will look at debugging in Step 12.</span></span>

<span data-ttu-id="56bd3-194">我們現在可以將新的 managed 預存程序和 Udf，加入此專案中，但我們還是會讓之前先包含我們現有的 web 應用程式方案中。</span><span class="sxs-lookup"><span data-stu-id="56bd3-194">We can now add new managed stored procedures and UDFs to this project, but before we do let s first include our existing web application in the Solution.</span></span> <span data-ttu-id="56bd3-195">從 [檔案] 功能表選取 [新增] 選項，並選擇現有的網站。</span><span class="sxs-lookup"><span data-stu-id="56bd3-195">From the File menu select the Add option and choose Existing Web Site.</span></span> <span data-ttu-id="56bd3-196">瀏覽至適當的網站資料夾，然後按一下 [確定]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-196">Browse to the appropriate website folder and click OK.</span></span> <span data-ttu-id="56bd3-197">如 [圖 7] 所示，這將會更新以包含兩個專案的解決方案： 網站和`ManagedDatabaseConstructs`SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-197">As Figure 7 shows, this will update the Solution to include two projects: the website and the `ManagedDatabaseConstructs` SQL Server Project.</span></span>


![[方案總管] 現在包含兩個專案](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image11.png)

<span data-ttu-id="56bd3-199">**圖 7**: 方案總管 現在包含兩個專案</span><span class="sxs-lookup"><span data-stu-id="56bd3-199">**Figure 7**: The Solution Explorer Now Includes Two Projects</span></span>


<span data-ttu-id="56bd3-200">`NORTHWNDConnectionString`中的值`Web.config`目前參考`NORTHWND.MDF`檔案中`App_Data`資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-200">The `NORTHWNDConnectionString` value in `Web.config` currently references the `NORTHWND.MDF` file in the `App_Data` folder.</span></span> <span data-ttu-id="56bd3-201">由於我們移除了此資料庫，從`App_Data`明確註冊它，並在 SQL Server 2005 Express Edition 資料庫執行個體中，我們必須跟著更新`NORTHWNDConnectionString`值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-201">Since we removed this database from `App_Data` and explicitly registered it in the SQL Server 2005 Express Edition database instance, we need to correspondingly update the `NORTHWNDConnectionString` value.</span></span> <span data-ttu-id="56bd3-202">開啟`Web.config`檔案中的網站和變更`NORTHWNDConnectionString`值，以便讀取連接字串： `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-202">Open the `Web.config` file in the website and change the `NORTHWNDConnectionString` value so that the connection string reads: `Data Source=localhost\SQLExpress;Initial Catalog=Northwind;Integrated Security=True`.</span></span> <span data-ttu-id="56bd3-203">這項變更之後, 您`<connectionStrings>`一節中`Web.config`看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="56bd3-203">After this change, your `<connectionStrings>` section in `Web.config` should look similar to the following:</span></span>


[!code-xml[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample1.xml)]

> [!NOTE]
> <span data-ttu-id="56bd3-204">中所述[前述教學課程](debugging-stored-procedures-cs.md)時偵錯用戶端應用程式中，從 SQL Server 物件，例如 ASP.NET 網站，我們必須停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="56bd3-204">As discussed in the [preceding tutorial](debugging-stored-procedures-cs.md), when debugging a SQL Server object from a client application, such as an ASP.NET website, we need to disable connection pooling.</span></span> <span data-ttu-id="56bd3-205">如上所示的連接字串會停用連線共用 ( `Pooling=false` )。</span><span class="sxs-lookup"><span data-stu-id="56bd3-205">The connection string shown above disables connection pooling ( `Pooling=false` ).</span></span> <span data-ttu-id="56bd3-206">如果您不打算從 ASP.NET 網站，偵錯 managed 預存程序和 Udf，啟用連接共用。</span><span class="sxs-lookup"><span data-stu-id="56bd3-206">If you do not plan on debugging the managed stored procedures and UDFs from the ASP.NET website, enable connection pooling.</span></span>


## <a name="step-3-creating-a-managed-stored-procedure"></a><span data-ttu-id="56bd3-207">步驟 3： 建立 Managed 預存程序</span><span class="sxs-lookup"><span data-stu-id="56bd3-207">Step 3: Creating a Managed Stored Procedure</span></span>

<span data-ttu-id="56bd3-208">若要加入 Northwind 資料庫中的受管理的預存程序，我們需要建立預存程序，為 SQL Server 專案中的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-208">To add a managed stored procedure to the Northwind database we first need to create the stored procedure as a method in the SQL Server Project.</span></span> <span data-ttu-id="56bd3-209">從 方案總管 中，以滑鼠右鍵按一下`ManagedDatabaseConstructs`專案名稱，然後選擇 加入新項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-209">From the Solution Explorer, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new item.</span></span> <span data-ttu-id="56bd3-210">這會顯示 [加入新項目] 對話方塊，列出可以加入至專案的 managed 的資料庫物件的類型。</span><span class="sxs-lookup"><span data-stu-id="56bd3-210">This will display the Add New Item dialog box, which lists the types of managed database objects that can be added to the project.</span></span> <span data-ttu-id="56bd3-211">如 [圖 8] 所示，這包括預存程序和使用者定義函式，其他項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-211">As Figure 8 shows, this includes stored procedures and User-Defined Functions, among others.</span></span>

<span data-ttu-id="56bd3-212">可讓 s，將只會傳回所有已不再提供的產品的預存程序來開始。</span><span class="sxs-lookup"><span data-stu-id="56bd3-212">Let s start by adding a stored procedure that simply returns all of the products that have been discontinued.</span></span> <span data-ttu-id="56bd3-213">將新的預存程序檔案`GetDiscontinuedProducts.cs`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-213">Name the new stored procedure file `GetDiscontinuedProducts.cs`.</span></span>


<span data-ttu-id="56bd3-214">[![加入新的預存程序，以名為 GetDiscontinuedProducts.cs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-214">[![Add a New Stored Procedure Named GetDiscontinuedProducts.cs](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image13.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image12.png)</span></span>

<span data-ttu-id="56bd3-215">**圖 8**： 新增新預存程序名為`GetDiscontinuedProducts.cs`([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-215">**Figure 8**: Add a New Stored Procedure Named `GetDiscontinuedProducts.cs` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image14.png))</span></span>


<span data-ttu-id="56bd3-216">這會建立新的 C# 類別檔案，使用下列內容：</span><span class="sxs-lookup"><span data-stu-id="56bd3-216">This will create a new C# class file with the following content:</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample2.cs)]

<span data-ttu-id="56bd3-217">請注意，預存程序會實作成`static`方法內`partial`類別檔案命名為`StoredProcedures`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-217">Note that the stored procedure is implemented as a `static` method within a `partial` class file named `StoredProcedures`.</span></span> <span data-ttu-id="56bd3-218">此外，`GetDiscontinuedProducts`方法以裝飾`SqlProcedure attribute`，將會標示為預存程序的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-218">Moreover, the `GetDiscontinuedProducts` method is decorated with the `SqlProcedure attribute`, which marks the method as a stored procedure.</span></span>

<span data-ttu-id="56bd3-219">下列程式碼會建立`SqlCommand`物件以及設定其`CommandText`要`SELECT`會傳回所有的資料行的查詢`Products`其資料表適用於產品`Discontinued`欄位等於 1。</span><span class="sxs-lookup"><span data-stu-id="56bd3-219">The following code creates a `SqlCommand` object and sets its `CommandText` to a `SELECT` query that returns all of the columns from the `Products` table for products whose `Discontinued` field equals 1.</span></span> <span data-ttu-id="56bd3-220">然後執行命令，並將結果傳送回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="56bd3-220">It then executes the command and sends the results back to the client application.</span></span> <span data-ttu-id="56bd3-221">新增下列程式碼`GetDiscontinuedProducts`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-221">Add this code to the `GetDiscontinuedProducts` method.</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample3.cs)]

<span data-ttu-id="56bd3-222">所有的受管理的資料庫物件都具有存取權[`SqlContext`物件](https://msdn.microsoft.com/library/ms131108.aspx)表示呼叫端的內容。</span><span class="sxs-lookup"><span data-stu-id="56bd3-222">All managed database objects have access to a [`SqlContext` object](https://msdn.microsoft.com/library/ms131108.aspx) that represents the context of the caller.</span></span> <span data-ttu-id="56bd3-223">`SqlContext`提供存取權[`SqlPipe`物件](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx)透過其[`Pipe`屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-223">The `SqlContext` provides access to a [`SqlPipe` object](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx) via its [`Pipe` property](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.pipe.aspx).</span></span> <span data-ttu-id="56bd3-224">這`SqlPipe`物件用來在兩者之間互相傳遞 SQL Server 資料庫與呼叫的應用程式之間的資訊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-224">This `SqlPipe` object is used to ferry information between the SQL Server database and the calling application.</span></span> <span data-ttu-id="56bd3-225">正如其名， [ `ExecuteAndSend`方法](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx)傳入執行`SqlCommand`物件並將結果傳回用戶端應用程式。</span><span class="sxs-lookup"><span data-stu-id="56bd3-225">As its name implies, the [`ExecuteAndSend` method](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.executeandsend.aspx) executes a passed-in `SqlCommand` object and sends the results back to the client application.</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-226">Managed 的資料庫物件是最適合用於預存程序和 Udf，使用程序邏輯，而不是以集合為基礎的邏輯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-226">Managed database objects are best suited for stored procedures and UDFs that use procedural logic rather than set-based logic.</span></span> <span data-ttu-id="56bd3-227">程序邏輯牽涉到使用逐列為基礎的資料集，或使用純量資料。</span><span class="sxs-lookup"><span data-stu-id="56bd3-227">Procedural logic involves working with sets of data on a row-by-row basis or working with scalar data.</span></span> <span data-ttu-id="56bd3-228">`GetDiscontinuedProducts`我們剛剛建立，不過，方法牽涉到的任何程序的邏輯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-228">The `GetDiscontinuedProducts` method we just created, however, involves no procedural logic.</span></span> <span data-ttu-id="56bd3-229">因此，它會在理想情況下會實作為 T-SQL 預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-229">Therefore, it would ideally be implemented as a T-SQL stored procedure.</span></span> <span data-ttu-id="56bd3-230">它會實作為受管理的預存程序來建立及部署所需的步驟會示範 managed 預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-230">It is implemented as a managed stored procedure to demonstrate the steps necessary for creating and deploying managed stored procedures.</span></span>


## <a name="step-4-deploying-the-managed-stored-procedure"></a><span data-ttu-id="56bd3-231">步驟 4： 部署 Managed 預存程序</span><span class="sxs-lookup"><span data-stu-id="56bd3-231">Step 4: Deploying the Managed Stored Procedure</span></span>

<span data-ttu-id="56bd3-232">使用這個完整的程式碼，我們已準備好將它部署到 Northwind 資料庫項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-232">With this code complete, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="56bd3-233">部署 SQL Server 專案的程式碼編譯成組件、 使用資料庫時，註冊組件和建立對應的物件在資料庫中，將它們連結至組件中適當的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-233">Deploying a SQL Server Project compiles the code into an assembly, registers the assembly with the database, and creates the corresponding objects in the database, linking them to the appropriate methods in the assembly.</span></span> <span data-ttu-id="56bd3-234">確切的 [部署] 選項所執行的工作集更精確地拼寫步驟 13。</span><span class="sxs-lookup"><span data-stu-id="56bd3-234">The exact set of tasks performed by the Deploy option is more precisely spelled out in Step 13.</span></span> <span data-ttu-id="56bd3-235">以滑鼠右鍵按一下`ManagedDatabaseConstructs`專案在 [方案總管] 中的名稱，然後選擇 [部署] 選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-235">Right-click on the `ManagedDatabaseConstructs` project name in the Solution Explorer and choose the Deploy option.</span></span> <span data-ttu-id="56bd3-236">不過，部署會失敗，發生下列錯誤: 「 外部 」 附近的語法不正確。</span><span class="sxs-lookup"><span data-stu-id="56bd3-236">However, deployment fails with the following error: Incorrect syntax near 'EXTERNAL'.</span></span> <span data-ttu-id="56bd3-237">您可能需要目前資料庫的相容性層級設定為較高的值，以啟用這項功能。</span><span class="sxs-lookup"><span data-stu-id="56bd3-237">You may need to set the compatibility level of the current database to a higher value to enable this feature.</span></span> <span data-ttu-id="56bd3-238">請參閱預存程序的說明`sp_dbcmptlevel`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-238">See help for the stored procedure `sp_dbcmptlevel`.</span></span>

<span data-ttu-id="56bd3-239">當您嘗試使用 Northwind 資料庫中註冊組件時，就會發生此錯誤訊息。</span><span class="sxs-lookup"><span data-stu-id="56bd3-239">This error message occurs when attempting to register the assembly with the Northwind database.</span></span> <span data-ttu-id="56bd3-240">若要使用 SQL Server 2005 資料庫中註冊組件，資料庫 s 相容性層級必須設定為 90。</span><span class="sxs-lookup"><span data-stu-id="56bd3-240">In order to register an assembly with a SQL Server 2005 database, the database s compatibility level must be set to 90.</span></span> <span data-ttu-id="56bd3-241">根據預設，新的 SQL Server 2005 資料庫有相容性層級 90。</span><span class="sxs-lookup"><span data-stu-id="56bd3-241">By default, new SQL Server 2005 databases have a compatibility level of 90.</span></span> <span data-ttu-id="56bd3-242">不過，使用 Microsoft SQL Server 2000 建立的資料庫會有的預設相容性層級為 80。</span><span class="sxs-lookup"><span data-stu-id="56bd3-242">However, databases created using Microsoft SQL Server 2000 have a default compatibility level of 80.</span></span> <span data-ttu-id="56bd3-243">因為 Northwind 資料庫一開始是 Microsoft SQL Server 2000 資料庫，其相容性層級目前設為 80，並因此需要增加為 90，才能註冊 managed 的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-243">Since the Northwind database was initially a Microsoft SQL Server 2000 database, its compatibility level is currently set to 80 and therefore needs to be increased to 90 in order to register managed database objects.</span></span>

<span data-ttu-id="56bd3-244">若要更新資料庫 s 相容性層級，在 Management Studio 中開啟新的查詢視窗，並輸入：</span><span class="sxs-lookup"><span data-stu-id="56bd3-244">To update the database s compatibility level, open a New Query window in Management Studio and enter:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample4.sql)]

<span data-ttu-id="56bd3-245">按一下 [執行] 圖示，以執行上述查詢中。</span><span class="sxs-lookup"><span data-stu-id="56bd3-245">Click the Execute icon in the Toolbar to run the above query.</span></span>


<span data-ttu-id="56bd3-246">[![更新 Northwind 資料庫 s 相容性層級](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-246">[![Update the Northwind Database s Compatibility Level](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image16.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image15.png)</span></span>

<span data-ttu-id="56bd3-247">**圖 9**： 更新 Northwind 資料庫 s 相容性層級 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-247">**Figure 9**: Update the Northwind Database s Compatibility Level ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image17.png))</span></span>


<span data-ttu-id="56bd3-248">在更新之後的相容性層級，重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-248">After updating the compatibility level, redeploy the SQL Server Project.</span></span> <span data-ttu-id="56bd3-249">此時不會發生錯誤應該完成的部署。</span><span class="sxs-lookup"><span data-stu-id="56bd3-249">This time the deployment should complete without error.</span></span>

<span data-ttu-id="56bd3-250">返回 SQL Server Management Studio，Northwind 資料庫的 物件總管 中，以滑鼠右鍵按一下並選擇 重新整理。</span><span class="sxs-lookup"><span data-stu-id="56bd3-250">Return to SQL Server Management Studio, right-click on the Northwind database in the Object Explorer, and choose Refresh.</span></span> <span data-ttu-id="56bd3-251">接下來，向下切入至 [可程式性] 資料夾，然後再展開 [組件] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-251">Next, drill down into the Programmability folder and then expand the Assemblies folder.</span></span> <span data-ttu-id="56bd3-252">如 [圖 10] 所示，Northwind 資料庫現在會包含所產生的組件`ManagedDatabaseConstructs`專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-252">As Figure 10 shows, the Northwind database now includes the assembly generated by the `ManagedDatabaseConstructs` project.</span></span>


![ManagedDatabaseConstructs 組件是現在已向 Northwind 資料庫](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image18.png)

<span data-ttu-id="56bd3-254">**圖 10**:`ManagedDatabaseConstructs`組件是現在已向 Northwind 資料庫</span><span class="sxs-lookup"><span data-stu-id="56bd3-254">**Figure 10**: The `ManagedDatabaseConstructs` Assembly is Now Registered with the Northwind Database</span></span>


<span data-ttu-id="56bd3-255">也依序展開 [預存程序] 資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-255">Also expand the Stored Procedures folder.</span></span> <span data-ttu-id="56bd3-256">您會看到名為預存程序`GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-256">There you will see a stored procedure named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="56bd3-257">這個預存程序所建立的部署程序和指向`GetDiscontinuedProducts`方法中的`ManagedDatabaseConstructs`組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-257">This stored procedure was created by the deployment process and points to the `GetDiscontinuedProducts` method in the `ManagedDatabaseConstructs` assembly.</span></span> <span data-ttu-id="56bd3-258">當`GetDiscontinuedProducts`預存程序執行時，它，接著執行`GetDiscontinuedProducts`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-258">When the `GetDiscontinuedProducts` stored procedure is executed, it, in turn, executes the `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="56bd3-259">由於這是受管理的預存程序無法編輯透過 Management Studio (因此預存程序名稱旁邊的鎖定圖示)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-259">Since this is a managed stored procedure it cannot be edited through Management Studio (hence the lock icon next to the stored procedure name).</span></span>


![GetDiscontinuedProducts 預存程序會列在預存程序 資料夾](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image19.png)

<span data-ttu-id="56bd3-261">**[圖 11**:`GetDiscontinuedProducts`預存程序會列在預存程序] 資料夾</span><span class="sxs-lookup"><span data-stu-id="56bd3-261">**Figure 11**: The `GetDiscontinuedProducts` Stored Procedure is Listed in the Stored Procedures Folder</span></span>


<span data-ttu-id="56bd3-262">還有一個更多的障礙，我們必須克服前我們可以呼叫 managed 預存程序： 將資料庫設定以防止執行 managed 程式碼。</span><span class="sxs-lookup"><span data-stu-id="56bd3-262">There is still one more hurdle we have to overcome before we can call the managed stored procedure: the database is configured to prevent execution of managed code.</span></span> <span data-ttu-id="56bd3-263">驗證，請開啟新的查詢視窗並執行`GetDiscontinuedProducts`預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-263">Verify this by opening a new query window and executing the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="56bd3-264">您會收到下列錯誤訊息： 已停用的.NET Framework 中的使用者程式碼的執行。</span><span class="sxs-lookup"><span data-stu-id="56bd3-264">You will receive the following error message: Execution of user code in the .NET Framework is disabled.</span></span> <span data-ttu-id="56bd3-265">啟用 clr 已啟用組態選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-265">Enable �clr enabled configuration option.</span></span>

<span data-ttu-id="56bd3-266">若要檢查的 Northwind 資料庫的組態資訊、 輸入並執行命令`exec sp_configure`在查詢視窗中。</span><span class="sxs-lookup"><span data-stu-id="56bd3-266">To examine the Northwind database s configuration information, enter and execute the command `exec sp_configure` in the query window.</span></span> <span data-ttu-id="56bd3-267">這會顯示設定 clr 已啟用目前設定為 0。</span><span class="sxs-lookup"><span data-stu-id="56bd3-267">This shows that the clr enabled setting is currently set to 0.</span></span>


<span data-ttu-id="56bd3-268">[![Clr 已啟用] 設定為 0 是 [目前設定](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-268">[![The clr enabled Setting is Currently Set to 0](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image21.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image20.png)</span></span>

<span data-ttu-id="56bd3-269">**圖 12**: clr 已啟用] 設定為 0 是 [目前設定 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-269">**Figure 12**: The clr enabled Setting is Currently Set to 0 ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image22.png))</span></span>


<span data-ttu-id="56bd3-270">請注意，圖 12 中的每個組態設定一起列出的四個值： 最小值和最大值的組態和執行的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-270">Note that each configuration setting in Figure 12 has four values listed with it: the minimum and maximum values and the config and run values.</span></span> <span data-ttu-id="56bd3-271">若要更新 [clr 已啟用] 設定的設定值，執行下列命令：</span><span class="sxs-lookup"><span data-stu-id="56bd3-271">To update the config value for the clr enabled setting, execute the following command:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample5.sql)]

<span data-ttu-id="56bd3-272">如果您重新執行`exec sp_configure`您會看到上述陳述式更新 clr 已啟用設定的設定值，設為 1，但仍執行的值設定為 0。</span><span class="sxs-lookup"><span data-stu-id="56bd3-272">If you re-run the `exec sp_configure` you will see that the above statement updated the clr enabled setting s config value to 1, but that the run value is still set to 0.</span></span> <span data-ttu-id="56bd3-273">我們需要執行這項設定變更才會生效[`RECONFIGURE`命令](https://msdn.microsoft.com/library/ms176069.aspx)，它會將執行的值設定為目前的組態值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-273">For this configuration change to take affect we need to execute the [`RECONFIGURE` command](https://msdn.microsoft.com/library/ms176069.aspx), which will set the run value to the current config value.</span></span> <span data-ttu-id="56bd3-274">只要輸入`RECONFIGURE`在查詢視窗中，按一下工具列中的 [執行] 圖示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-274">Simply enter `RECONFIGURE` in the query window and click the Execute icon in the Toolbar.</span></span> <span data-ttu-id="56bd3-275">如果您執行`exec sp_configure`現在，您應該看到的值為 1，clr 已啟用設定的組態，然後執行值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-275">If you run `exec sp_configure` now you should see a value of 1 for the clr enabled setting s config and run values.</span></span>

<span data-ttu-id="56bd3-276">Clr 已啟用設定完成後，我們已準備好執行 managed`GetDiscontinuedProducts`預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-276">With the clr enabled configuration complete, we are ready to run the managed `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="56bd3-277">在查詢視窗中輸入，然後執行命令`exec` `GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-277">In the query window enter and execute the command `exec` `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="56bd3-278">叫用預存程序會導致對應的 managed 程式碼中`GetDiscontinuedProducts`方法來執行。</span><span class="sxs-lookup"><span data-stu-id="56bd3-278">Invoking the stored procedure causes the corresponding managed code in the `GetDiscontinuedProducts` method to execute.</span></span> <span data-ttu-id="56bd3-279">此程式碼發出`SELECT`查詢以傳回已停用，並傳回呼叫的應用程式，也就是 SQL Server Management Studio 這個執行個體中的這項資料的所有產品。</span><span class="sxs-lookup"><span data-stu-id="56bd3-279">This code issues a `SELECT` query to return all products that are discontinued and returns this data to the calling application, which is SQL Server Management Studio in this instance.</span></span> <span data-ttu-id="56bd3-280">Management Studio 接收這些結果，並在 [結果] 視窗中加以顯示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-280">Management Studio receives these results and displays them in the Results window.</span></span>


<span data-ttu-id="56bd3-281">[![預存程序會傳回所有 GetDiscontinuedProducts 停產的產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-281">[![The GetDiscontinuedProducts Stored Procedure Returns All Discontinued Products](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image24.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image23.png)</span></span>

<span data-ttu-id="56bd3-282">**圖 13**:`GetDiscontinuedProducts`預存程序傳回所有已停止的產品 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-282">**Figure 13**: The `GetDiscontinuedProducts` Stored Procedure Returns All Discontinued Products ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image25.png))</span></span>


## <a name="step-5-creating-managed-stored-procedures-that-accept-input-parameters"></a><span data-ttu-id="56bd3-283">步驟 5： 建立 Managed 預存程序會接受輸入的參數</span><span class="sxs-lookup"><span data-stu-id="56bd3-283">Step 5: Creating Managed Stored Procedures that Accept Input Parameters</span></span>

<span data-ttu-id="56bd3-284">許多查詢和預存程序，我們建立了在這些教學課程中使用*參數*。</span><span class="sxs-lookup"><span data-stu-id="56bd3-284">Many of the queries and stored procedures we have created throughout these tutorials have used *parameters*.</span></span> <span data-ttu-id="56bd3-285">例如，在[建立新預存程序的輸入資料集 Tableadapter](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md)教學課程中我們建立名為預存程序`GetProductsByCategoryID`，接受名為輸入的參數`@CategoryID`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-285">For example, in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial we created a stored procedure named `GetProductsByCategoryID` that accepted an input parameter named `@CategoryID`.</span></span> <span data-ttu-id="56bd3-286">預存程序，則傳回所有產品之`CategoryID`欄位比對所提供的值`@CategoryID`參數。</span><span class="sxs-lookup"><span data-stu-id="56bd3-286">The stored procedure then returned all products whose `CategoryID` field matched the value of the supplied `@CategoryID` parameter.</span></span>

<span data-ttu-id="56bd3-287">若要建立受管理的預存程序可接受輸入的參數，只需 s 方法定義中指定這些參數。</span><span class="sxs-lookup"><span data-stu-id="56bd3-287">To create a managed stored procedure that accepts input parameters, simply specify those parameters in the method s definition.</span></span> <span data-ttu-id="56bd3-288">為了說明這點，可讓 s 新增另一個 managed 預存程序`ManagedDatabaseConstructs`專案，命名為`GetProductsWithPriceLessThan`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-288">To illustrate this, let s add another managed stored procedure to the `ManagedDatabaseConstructs` project named `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="56bd3-289">此受管理的預存程序會接受輸入的參數指定的價格，而且會傳回所有產品的`UnitPrice`欄位小於參數 s 的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-289">This managed stored procedure will accept an input parameter specifying a price and will return all products whose `UnitPrice` field is less than the parameter s value.</span></span>

<span data-ttu-id="56bd3-290">將新的預存程序加入至專案，以滑鼠右鍵按一下`ManagedDatabaseConstructs`專案名稱，然後選擇 加入新的預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-290">To add a new stored procedure to the project, right-click on the `ManagedDatabaseConstructs` project name and choose to add a new stored procedure.</span></span> <span data-ttu-id="56bd3-291">將檔案命名為 `GetProductsWithPriceLessThan.cs`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-291">Name the file `GetProductsWithPriceLessThan.cs`.</span></span> <span data-ttu-id="56bd3-292">如我們在步驟 3 中所見的這會建立新的 C# 類別檔案命名的方法`GetProductsWithPriceLessThan`置於`partial`類別`StoredProcedures`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-292">As we saw in Step 3, this will create a new C# class file with a method named `GetProductsWithPriceLessThan` placed within the `partial` class `StoredProcedures`.</span></span>

<span data-ttu-id="56bd3-293">更新`GetProductsWithPriceLessThan`s 方法定義，使其接受[ `SqlMoney` ](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx)名為輸入的參數`price`和撰寫程式碼執行，並傳回查詢結果：</span><span class="sxs-lookup"><span data-stu-id="56bd3-293">Update the `GetProductsWithPriceLessThan` method s definition so that it accepts a [`SqlMoney`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.aspx) input parameter named `price` and write the code to execute and return the query results:</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample6.cs)]

<span data-ttu-id="56bd3-294">`GetProductsWithPriceLessThan` s 方法定義和程式碼十分相似的定義和程式碼`GetDiscontinuedProducts`步驟 3 中建立的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-294">The `GetProductsWithPriceLessThan` method s definition and code closely resembles the definition and code of the `GetDiscontinuedProducts` method created in Step 3.</span></span> <span data-ttu-id="56bd3-295">唯一的差異是，`GetProductsWithPriceLessThan`方法會接受做為輸入參數 (`price`)，則`SqlCommand`s 查詢包含參數 (`@MaxPrice`)，並將參數新增至`SqlCommand`s`Parameters`集合和將值指派給`price`變數。</span><span class="sxs-lookup"><span data-stu-id="56bd3-295">The only differences are that the `GetProductsWithPriceLessThan` method accepts as input parameter (`price`), the `SqlCommand` s query includes a parameter (`@MaxPrice`), and a parameter is added to the `SqlCommand` s `Parameters` collection is and assigned the value of the `price` variable.</span></span>

<span data-ttu-id="56bd3-296">新增此程式碼之後, 重新部署 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-296">After adding this code, redeploy the SQL Server Project.</span></span> <span data-ttu-id="56bd3-297">接下來，回到 SQL Server Management Studio，並重新整理的預存程序資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-297">Next, return to SQL Server Management Studio and Refresh the Stored Procedures folder.</span></span> <span data-ttu-id="56bd3-298">您應該會看到新的項目， `GetProductsWithPriceLessThan`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-298">You should see a new entry, `GetProductsWithPriceLessThan`.</span></span> <span data-ttu-id="56bd3-299">從 [查詢] 視窗中，輸入，然後執行命令`exec GetProductsWithPriceLessThan 25`，也將列出所有產品小於 $25，如 [圖 14] 所示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-299">From a query window, enter and execute the command `exec GetProductsWithPriceLessThan 25`, which will list all products less than $25, as Figure 14 shows.</span></span>


<span data-ttu-id="56bd3-300">[![顯示產品下 $25](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-300">[![Products Under $25 are Displayed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image27.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image26.png)</span></span>

<span data-ttu-id="56bd3-301">**圖 14**： 顯示產品下 $25 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-301">**Figure 14**: Products Under $25 are Displayed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image28.png))</span></span>


## <a name="step-6-calling-the-managed-stored-procedure-from-the-data-access-layer"></a><span data-ttu-id="56bd3-302">步驟 6： 從資料存取層呼叫 Managed 預存程序</span><span class="sxs-lookup"><span data-stu-id="56bd3-302">Step 6: Calling the Managed Stored Procedure from the Data Access Layer</span></span>

<span data-ttu-id="56bd3-303">此時，我們已新增`GetDiscontinuedProducts`並`GetProductsWithPriceLessThan`managed 預存程序`ManagedDatabaseConstructs`專案，並已向它們 Northwind SQL Server 資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-303">At this point we have added the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures to the `ManagedDatabaseConstructs` project and have registered them with the Northwind SQL Server database.</span></span> <span data-ttu-id="56bd3-304">我們也叫用這些 managed 預存程序從 SQL Server Management Studio （請參閱 圖 13 與 14，s）。</span><span class="sxs-lookup"><span data-stu-id="56bd3-304">We also invoked these managed stored procedures from SQL Server Management Studio (see Figure s 13 and 14).</span></span> <span data-ttu-id="56bd3-305">為了讓我們的 ASP.NET 應用程式使用這些 managed 預存程序，不過，我們需要將它們新增到架構中的商務邏輯層與資料存取。</span><span class="sxs-lookup"><span data-stu-id="56bd3-305">In order for our ASP.NET application to use these managed stored procedures, however, we need to add them to the Data Access and Business Logic Layers in the architecture.</span></span> <span data-ttu-id="56bd3-306">在此步驟中，我們會加入兩種新方法`ProductsTableAdapter`中`NorthwindWithSprocs`類型的 DataSet，最初在中建立[建立新預存程序的輸入資料集 Tableadapter](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md)教學課程。</span><span class="sxs-lookup"><span data-stu-id="56bd3-306">In this step we will add two new methods to the `ProductsTableAdapter` in the `NorthwindWithSprocs` Typed DataSet, which was initially created in the [Creating New Stored Procedures for the Typed DataSet s TableAdapters](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-cs.md) tutorial.</span></span> <span data-ttu-id="56bd3-307">在步驟 7 中，我們會將對應的方法加入 BLL。</span><span class="sxs-lookup"><span data-stu-id="56bd3-307">In Step 7 we will add corresponding methods to the BLL.</span></span>

<span data-ttu-id="56bd3-308">開啟`NorthwindWithSprocs`型別資料集，在 Visual Studio，並藉由新增新的方法來開始`ProductsTableAdapter`名為`GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-308">Open the `NorthwindWithSprocs` Typed DataSet in Visual Studio and start by adding a new method to the `ProductsTableAdapter` named `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="56bd3-309">若要加入 TableAdapter 的新方法，以滑鼠右鍵按一下設計工具中的 TableAdapter 的名稱，並從內容功能表中選擇 加入查詢選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-309">To add a new method to a TableAdapter, right-click on the TableAdapter s name in the Designer and choose the Add Query option from the context menu.</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-310">因為我們已從 Northwind 資料庫`App_Data`資料夾中的 SQL Server 2005 Express Edition 資料庫執行個體，請務必在 Web.config 中對應的連接字串更新，以反映這項變更。</span><span class="sxs-lookup"><span data-stu-id="56bd3-310">Since we moved the Northwind database from the `App_Data` folder to the SQL Server 2005 Express Edition database instance, it is imperative that the corresponding connection string in Web.config be updated to reflect this change.</span></span> <span data-ttu-id="56bd3-311">我們將討論在步驟 2 中更新`NORTHWNDConnectionString`中的值`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-311">In Step 2 we discussed updating the `NORTHWNDConnectionString` value in `Web.config`.</span></span> <span data-ttu-id="56bd3-312">如果您忘記執行這項更新，您會看到錯誤訊息無法加入查詢。</span><span class="sxs-lookup"><span data-stu-id="56bd3-312">If you forgot to make this update, then you will see the error message Failed to add query.</span></span> <span data-ttu-id="56bd3-313">找不到連接`NORTHWNDConnectionString`物件`Web.config`在對話方塊中，當嘗試將新方法加入至 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="56bd3-313">Unable to find connection `NORTHWNDConnectionString` for object `Web.config` in a dialog box when attempting to add a new method to the TableAdapter.</span></span> <span data-ttu-id="56bd3-314">若要解決這個錯誤，請按一下 [確定]，然後移至`Web.config`並更新`NORTHWNDConnectionString`值在步驟 2 中所述。</span><span class="sxs-lookup"><span data-stu-id="56bd3-314">To resolve this error, click OK and then go to `Web.config` and update the `NORTHWNDConnectionString` value as discussed in Step 2.</span></span> <span data-ttu-id="56bd3-315">然後再次嘗試重新將方法加入至 TableAdapter。</span><span class="sxs-lookup"><span data-stu-id="56bd3-315">Then try re-adding the method to the TableAdapter.</span></span> <span data-ttu-id="56bd3-316">這次它應該會運作不會發生錯誤。</span><span class="sxs-lookup"><span data-stu-id="56bd3-316">This time it should work without error.</span></span>


<span data-ttu-id="56bd3-317">加入新的方法，就會啟動我們在過去的教學課程中多次使用 [TableAdapter 查詢組態精靈]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-317">Adding a new method launches the TableAdapter Query Configuration wizard, which we have used many times in past tutorials.</span></span> <span data-ttu-id="56bd3-318">第一個步驟會要求我們指定 TableAdapter 存取資料庫的方式： 透過臨機操作 SQL 陳述式，或透過新的或現有的預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-318">The first step asks us to specify how the TableAdapter should access the database: through an ad-hoc SQL statement or via a new or existing stored procedure.</span></span> <span data-ttu-id="56bd3-319">因為我們已建立並註冊`GetDiscontinuedProducts`managed 預存程序，與資料庫中，選擇 使用現有預存程序選項，然後按 下一步。</span><span class="sxs-lookup"><span data-stu-id="56bd3-319">Since we have already created and registered the `GetDiscontinuedProducts` managed stored procedure with the database, choose the Use existing stored procedure option and hit Next.</span></span>


<span data-ttu-id="56bd3-320">[![選擇 使用現有的預存程序選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-320">[![Choose the Use existing stored procedure Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image30.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image29.png)</span></span>

<span data-ttu-id="56bd3-321">**圖 15**： 選擇 使用現有預存程序選項 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-321">**Figure 15**: Choose the Use existing stored procedure Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image31.png))</span></span>


<span data-ttu-id="56bd3-322">下一個畫面會提示我們輸入方法會叫用預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-322">The next screen prompts us for the stored procedure the method will invoke.</span></span> <span data-ttu-id="56bd3-323">選擇`GetDiscontinuedProducts`managed 預存程序，從下拉式清單，然後按 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-323">Choose the `GetDiscontinuedProducts` managed stored procedure from the drop-down list and hit Next.</span></span>


<span data-ttu-id="56bd3-324">[![選取 GetDiscontinuedProducts Managed 預存程序](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-324">[![Select the GetDiscontinuedProducts Managed Stored Procedure](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image33.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image32.png)</span></span>

<span data-ttu-id="56bd3-325">**圖 16**： 選取  `GetDiscontinuedProducts` Managed 預存程序 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-325">**Figure 16**: Select the `GetDiscontinuedProducts` Managed Stored Procedure ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image34.png))</span></span>


<span data-ttu-id="56bd3-326">系統會要求我們指定預存程序傳回資料列、 單一值，或執行任何動作。</span><span class="sxs-lookup"><span data-stu-id="56bd3-326">We are then asked to specify whether the stored procedure returns rows, a single value, or nothing.</span></span> <span data-ttu-id="56bd3-327">因為`GetDiscontinuedProducts`傳回集合的停產的產品資料列中，選擇第一個選項 （表格式資料），並按一下 [下一步]。</span><span class="sxs-lookup"><span data-stu-id="56bd3-327">Since `GetDiscontinuedProducts` returns the set of discontinued product rows, choose the first option ( Tabular data ) and click Next.</span></span>


<span data-ttu-id="56bd3-328">[![選取 表格式資料選項](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-328">[![Select the Tabular Data Option](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image36.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image35.png)</span></span>

<span data-ttu-id="56bd3-329">**圖 17**： 選取表格式的 [資料] 選項 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-329">**Figure 17**: Select the Tabular Data Option ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image37.png))</span></span>


<span data-ttu-id="56bd3-330">最後一個精靈畫面可讓我們指定使用的資料存取模式，以及產生方法的名稱。</span><span class="sxs-lookup"><span data-stu-id="56bd3-330">The final wizard screen allows us to specify the data access patterns used and the names of the resulting methods.</span></span> <span data-ttu-id="56bd3-331">保留核取方塊已核取和名稱的方法`FillByDiscontinued`和`GetDiscontinuedProducts`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-331">Leave both checkboxes checked and name the methods `FillByDiscontinued` and `GetDiscontinuedProducts`.</span></span> <span data-ttu-id="56bd3-332">按一下 完成 以完成精靈。</span><span class="sxs-lookup"><span data-stu-id="56bd3-332">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="56bd3-333">[![名稱方法 FillByDiscontinued 和 GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-333">[![Name the Methods FillByDiscontinued and GetDiscontinuedProducts](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image39.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image38.png)</span></span>

<span data-ttu-id="56bd3-334">**圖 18**: Name 方法`FillByDiscontinued`並`GetDiscontinuedProducts`([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-334">**Figure 18**: Name the Methods `FillByDiscontinued` and `GetDiscontinuedProducts` ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image40.png))</span></span>


<span data-ttu-id="56bd3-335">重複上述步驟來建立名為的方法`FillByPriceLessThan`並`GetProductsWithPriceLessThan`中`ProductsTableAdapter`如`GetProductsWithPriceLessThan`managed 預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-335">Repeat these steps to create methods named `FillByPriceLessThan` and `GetProductsWithPriceLessThan` in the `ProductsTableAdapter` for the `GetProductsWithPriceLessThan` managed stored procedure.</span></span>

<span data-ttu-id="56bd3-336">[圖 19] 顯示的 DataSet 設計工具的螢幕擷取畫面之後將方法加入至`ProductsTableAdapter`for`GetDiscontinuedProducts`和`GetProductsWithPriceLessThan`managed 預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-336">Figure 19 shows a screenshot of the DataSet Designer after adding the methods to the `ProductsTableAdapter` for the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures.</span></span>


<span data-ttu-id="56bd3-337">[![ProductsTableAdapter 包含在此步驟中新增新方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-337">[![The ProductsTableAdapter Includes the New Methods Added in this Step](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image42.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image41.png)</span></span>

<span data-ttu-id="56bd3-338">**圖 19**:`ProductsTableAdapter`包含在此步驟中的 新的方法加入 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-338">**Figure 19**: The `ProductsTableAdapter` Includes the New Methods Added in this Step ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image43.png))</span></span>


## <a name="step-7-adding-corresponding-methods-to-the-business-logic-layer"></a><span data-ttu-id="56bd3-339">步驟 7： 將相對應的方法加入商務邏輯層</span><span class="sxs-lookup"><span data-stu-id="56bd3-339">Step 7: Adding Corresponding Methods to the Business Logic Layer</span></span>

<span data-ttu-id="56bd3-340">既然我們已更新資料的存取層，來包含方法呼叫加入在步驟 4 和 5 中的 managed 預存程序，我們需要對應的方法加入商務邏輯層。</span><span class="sxs-lookup"><span data-stu-id="56bd3-340">Now that we have updated the Data Access Layer to include methods for calling the managed stored procedures added in Steps 4 and 5, we need to add corresponding methods to the Business Logic Layer.</span></span> <span data-ttu-id="56bd3-341">新增下列兩個方法來`ProductsBLLWithSprocs`類別：</span><span class="sxs-lookup"><span data-stu-id="56bd3-341">Add the following two methods to the `ProductsBLLWithSprocs` class:</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample7.cs)]

<span data-ttu-id="56bd3-342">這兩種方法只會呼叫對應的 DAL 方法，並傳回`ProductsDataTable`執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-342">Both methods simply call the corresponding DAL method and return the `ProductsDataTable` instance.</span></span> <span data-ttu-id="56bd3-343">`DataObjectMethodAttribute`上述每個方法的標記會導致 ObjectDataSource s 設定資料來源精靈 的 選取 索引標籤中的下拉式清單中包含這些方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-343">The `DataObjectMethodAttribute` markup above each method causes these methods to be included in the drop-down list in the SELECT tab of the ObjectDataSource s Configure Data Source wizard.</span></span>

## <a name="step-8-invoking-the-managed-stored-procedures-from-the-presentation-layer"></a><span data-ttu-id="56bd3-344">步驟 8： 叫用 Managed 預存程序從展示層</span><span class="sxs-lookup"><span data-stu-id="56bd3-344">Step 8: Invoking the Managed Stored Procedures from the Presentation Layer</span></span>

<span data-ttu-id="56bd3-345">使用商務邏輯和資料存取層級增強，以包括呼叫的支援`GetDiscontinuedProducts`和`GetProductsWithPriceLessThan`managed 預存程序，我們現在可以顯示這些預存程序結果，透過 ASP.NET 網頁。</span><span class="sxs-lookup"><span data-stu-id="56bd3-345">With the Business Logic and Data Access Layers augmented to include support for calling the `GetDiscontinuedProducts` and `GetProductsWithPriceLessThan` managed stored procedures, we can now display these stored procedures results through an ASP.NET page.</span></span>

<span data-ttu-id="56bd3-346">開啟`ManagedFunctionsAndSprocs.aspx`頁面中`AdvancedDAL`資料夾，並從 [工具箱] 拖曳至設計工具拖曳至 GridView。</span><span class="sxs-lookup"><span data-stu-id="56bd3-346">Open the `ManagedFunctionsAndSprocs.aspx` page in the `AdvancedDAL` folder and, from the Toolbox, drag a GridView onto the Designer.</span></span> <span data-ttu-id="56bd3-347">設定 GridView s`ID`屬性，以`DiscontinuedProducts`和它的智慧標籤，從繫結至名為新 ObjectDataSource `DiscontinuedProductsDataSource`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-347">Set the GridView s `ID` property to `DiscontinuedProducts` and, from its smart tag, bind it to a new ObjectDataSource named `DiscontinuedProductsDataSource`.</span></span> <span data-ttu-id="56bd3-348">設定提取其資料從 ObjectDataSource`ProductsBLLWithSprocs`類別的`GetDiscontinuedProducts`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-348">Configure the ObjectDataSource to pull its data from the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span>


<span data-ttu-id="56bd3-349">[![設定使用 ProductsBLLWithSprocs 類別 ObjectDataSource](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-349">[![Configure the ObjectDataSource to Use the ProductsBLLWithSprocs Class](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image45.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image44.png)</span></span>

<span data-ttu-id="56bd3-350">**圖 20**： 設定要使用 ObjectDataSource`ProductsBLLWithSprocs`類別 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-350">**Figure 20**: Configure the ObjectDataSource to Use the `ProductsBLLWithSprocs` Class ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image46.png))</span></span>


<span data-ttu-id="56bd3-351">[![從下拉式清單中選取的索引標籤中選擇 GetDiscontinuedProducts 方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-351">[![Choose the GetDiscontinuedProducts Method from the Drop-Down List in the SELECT Tab](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image48.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image47.png)</span></span>

<span data-ttu-id="56bd3-352">**圖 21**： 選擇`GetDiscontinuedProducts`方法，從下拉式清單中選取索引標籤中 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-352">**Figure 21**: Choose the `GetDiscontinuedProducts` Method from the Drop-Down List in the SELECT Tab ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image49.png))</span></span>


<span data-ttu-id="56bd3-353">因為此方格會用來只顯示產品資訊，設定下拉式清單中更新、 插入和刪除索引標籤為 （無） 以及然後按一下 完成。</span><span class="sxs-lookup"><span data-stu-id="56bd3-353">Since this grid will be used to just display product information, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and then click Finish.</span></span>

<span data-ttu-id="56bd3-354">在完成精靈，Visual Studio 會自動將新增 BoundField 或 CheckBoxField 中每個資料欄位`ProductsDataTable`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-354">Upon completing the wizard, Visual Studio will automatically add a BoundField or CheckBoxField for each data field in the `ProductsDataTable`.</span></span> <span data-ttu-id="56bd3-355">花點時間，移除所有的這些欄位除外`ProductName`和`Discontinued`，而此時您的 GridView 和 ObjectDataSource s 宣告式標記看起來應該如下所示：</span><span class="sxs-lookup"><span data-stu-id="56bd3-355">Take a moment to remove all of these fields except for `ProductName` and `Discontinued`, at which point your GridView and ObjectDataSource s declarative markup should look similar to the following:</span></span>


[!code-aspx[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample8.aspx)]

<span data-ttu-id="56bd3-356">請花一點時間才能檢視此頁面，透過瀏覽器。</span><span class="sxs-lookup"><span data-stu-id="56bd3-356">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="56bd3-357">當瀏覽頁面時，ObjectDataSource 會呼叫`ProductsBLLWithSprocs`類別的`GetDiscontinuedProducts`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-357">When the page is visited, the ObjectDataSource calls the `ProductsBLLWithSprocs` class s `GetDiscontinuedProducts` method.</span></span> <span data-ttu-id="56bd3-358">如我們所見步驟 7 中，這個方法會呼叫向下到 DAL`ProductsDataTable`類別 s`GetDiscontinuedProducts`方法，它會叫用`GetDiscontinuedProducts`預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-358">As we saw in Step 7, this method calls down to the DAL s `ProductsDataTable` class s `GetDiscontinuedProducts` method, which invokes the `GetDiscontinuedProducts` stored procedure.</span></span> <span data-ttu-id="56bd3-359">這個預存程序是 managed，則預存程序，並執行我們在步驟 3 中，傳回已停用的產品中建立的程式碼。</span><span class="sxs-lookup"><span data-stu-id="56bd3-359">This stored procedure is a managed stored procedure and executes the code we created in Step 3, returning the discontinued products.</span></span>

<span data-ttu-id="56bd3-360">Managed 預存程序所傳回的結果封裝成`ProductsDataTable`dal 後又返回的 BLL，然後將它們傳回展示層，它們會繫結至 GridView 和顯示的位置。</span><span class="sxs-lookup"><span data-stu-id="56bd3-360">The results returned by the managed stored procedure are packaged up into a `ProductsDataTable` by the DAL and then returned to the BLL, which then returns them to the Presentation Layer where they are bound to the GridView and displayed.</span></span> <span data-ttu-id="56bd3-361">如預期般，方格會列出已不再提供這些產品。</span><span class="sxs-lookup"><span data-stu-id="56bd3-361">As expected, the grid lists those products that have been discontinued.</span></span>


<span data-ttu-id="56bd3-362">[![列出已停止的產品](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-362">[![The Discontinued Products are Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image51.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image50.png)</span></span>

<span data-ttu-id="56bd3-363">**圖 22**： 列出已停止的產品 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-363">**Figure 22**: The Discontinued Products are Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image52.png))</span></span>


<span data-ttu-id="56bd3-364">進一步練習時，將文字方塊和另一個 GridView，加入頁面。</span><span class="sxs-lookup"><span data-stu-id="56bd3-364">For further practice, add a TextBox and another GridView to the page.</span></span> <span data-ttu-id="56bd3-365">有顯示產品低於金額在 TextBox 輸入藉由呼叫這個 GridView`ProductsBLLWithSprocs`類別的`GetProductsWithPriceLessThan`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-365">Have this GridView display the products less than the amount entered into the TextBox by calling the `ProductsBLLWithSprocs` class s `GetProductsWithPriceLessThan` method.</span></span>

## <a name="step-9-creating-and-calling-t-sql-udfs"></a><span data-ttu-id="56bd3-366">步驟 9： 建立和呼叫 T-SQL Udf</span><span class="sxs-lookup"><span data-stu-id="56bd3-366">Step 9: Creating and Calling T-SQL UDFs</span></span>

<span data-ttu-id="56bd3-367">使用者定義函數或 Udf，是資料庫物件精確地模擬的程式設計語言中的函式的語意。</span><span class="sxs-lookup"><span data-stu-id="56bd3-367">User-Defined Functions, or UDFs, are database objects the closely mimic the semantics of functions in programming languages.</span></span> <span data-ttu-id="56bd3-368">像在 C# 函式，Udf 可以包含多個輸入參數，並傳回特定類型的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-368">Like a function in C#, UDFs can include a variable number of input parameters and return a value of a particular type.</span></span> <span data-ttu-id="56bd3-369">UDF 可以傳回純量資料-字串、 整數、 和等位或表格式資料。</span><span class="sxs-lookup"><span data-stu-id="56bd3-369">A UDF can return either scalar data - a string, an integer, and so forth - or tabular data.</span></span> <span data-ttu-id="56bd3-370">可讓 s 快速看看這兩種類型的 Udf，開頭為 UDF，以傳回純量資料類型。</span><span class="sxs-lookup"><span data-stu-id="56bd3-370">Let s take a quick look at both types of UDFs, starting with a UDF that returns a scalar data type.</span></span>

<span data-ttu-id="56bd3-371">下列的 UDF 計算特定產品的清查的估計的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-371">The following UDF calculates the estimated value of the inventory for a particular product.</span></span> <span data-ttu-id="56bd3-372">它是藉由在三個輸入參數-採取`UnitPrice`， `UnitsInStock`，並`Discontinued`傳回值的型別和值特定產品- `money`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-372">It does so by taking in three input parameters - the `UnitPrice`, `UnitsInStock`, and `Discontinued` values for a particular product - and returns a value of type `money`.</span></span> <span data-ttu-id="56bd3-373">它會計算存貨估計的值乘以`UnitPrice`由`UnitsInStock`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-373">It computes the estimated value of the inventory by multiplying the `UnitPrice` by the `UnitsInStock`.</span></span> <span data-ttu-id="56bd3-374">已停止的項目，這個值會變成一半。</span><span class="sxs-lookup"><span data-stu-id="56bd3-374">For discontinued items, this value is halved.</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample9.sql)]

<span data-ttu-id="56bd3-375">此 UDF 新增至資料庫之後, 就可以找到透過 Management Studio 藉由展開可程式性 資料夾中，則函式，然後純量值函式。</span><span class="sxs-lookup"><span data-stu-id="56bd3-375">Once this UDF has been added to the database, it can be found through Management Studio by expanding the Programmability folder, then Functions, and then Scalar-value Functions.</span></span> <span data-ttu-id="56bd3-376">它可以用於`SELECT`查詢就像這樣：</span><span class="sxs-lookup"><span data-stu-id="56bd3-376">It can be used in a `SELECT` query like so:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample10.sql)]

<span data-ttu-id="56bd3-377">我已新增`udf_ComputeInventoryValue`UDF Northwind 資料庫中;[圖 23] 顯示上述輸出`SELECT`時透過 Management Studio 檢視查詢。</span><span class="sxs-lookup"><span data-stu-id="56bd3-377">I have added the `udf_ComputeInventoryValue` UDF to the Northwind database; Figure 23 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="56bd3-378">也請注意，UDF 會列在 物件總管 中的純量值函式 資料夾底下。</span><span class="sxs-lookup"><span data-stu-id="56bd3-378">Also note that the UDF is listed under the Scalar-value Functions folder in the Object Explorer.</span></span>


<span data-ttu-id="56bd3-379">[![列出每項產品的庫存值](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-379">[![Each Product s Inventory Values is Listed](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image54.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image53.png)</span></span>

<span data-ttu-id="56bd3-380">**圖 23**： 列出庫存值的每個產品 s ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-380">**Figure 23**: Each Product s Inventory Values is Listed ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image55.png))</span></span>


<span data-ttu-id="56bd3-381">Udf 也可以傳回表格式資料。</span><span class="sxs-lookup"><span data-stu-id="56bd3-381">UDFs can also return tabular data.</span></span> <span data-ttu-id="56bd3-382">比方說，我們可以建立 UDF，以傳回屬於特定分類的產品：</span><span class="sxs-lookup"><span data-stu-id="56bd3-382">For example, we can create a UDF that returns products that belong to a particular category:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample11.sql)]

<span data-ttu-id="56bd3-383">`udf_GetProductsByCategoryID`接受 UDF`@CategoryID`輸入的參數，並傳回指定之結果`SELECT`查詢。</span><span class="sxs-lookup"><span data-stu-id="56bd3-383">The `udf_GetProductsByCategoryID` UDF accepts a `@CategoryID` input parameter and returns the results of the specified `SELECT` query.</span></span> <span data-ttu-id="56bd3-384">建立之後，可以在中參考此 UDF `FROM` (或`JOIN`) 子句`SELECT`查詢。</span><span class="sxs-lookup"><span data-stu-id="56bd3-384">Once created, this UDF can be referenced in the `FROM` (or `JOIN`) clause of a `SELECT` query.</span></span> <span data-ttu-id="56bd3-385">下列範例會傳回`ProductID`， `ProductName`，和`CategoryID`各種飲料的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-385">The following example would return the `ProductID`, `ProductName`, and `CategoryID` values for each of the beverages.</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample12.sql)]

<span data-ttu-id="56bd3-386">我已新增`udf_GetProductsByCategoryID`UDF Northwind 資料庫中;[圖 24] 顯示上述輸出`SELECT`時透過 Management Studio 檢視查詢。</span><span class="sxs-lookup"><span data-stu-id="56bd3-386">I have added the `udf_GetProductsByCategoryID` UDF to the Northwind database; Figure 24 shows the output of the above `SELECT` query when viewed through Management Studio.</span></span> <span data-ttu-id="56bd3-387">傳回表格式資料的 Udf 可以在物件總管 中的 s 資料表值函式資料夾中找到。</span><span class="sxs-lookup"><span data-stu-id="56bd3-387">UDFs that return tabular data can be found in the Object Explorer s Table-value Functions folder.</span></span>


<span data-ttu-id="56bd3-388">[![ProductID、 ProductName、 及 CategoryID 列出每個飲料](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-388">[![The ProductID, ProductName, and CategoryID are Listed for Each Beverage](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image57.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image56.png)</span></span>

<span data-ttu-id="56bd3-389">**圖 24**: `ProductID`， `ProductName`，以及`CategoryID`列出每個飲料 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-389">**Figure 24**: The `ProductID`, `ProductName`, and `CategoryID` are Listed for Each Beverage ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image58.png))</span></span>


> [!NOTE]
> <span data-ttu-id="56bd3-390">如需有關建立和使用 Udf 的詳細資訊，請參閱[使用者定義函式簡介](http://www.sqlteam.com/item.asp?ItemID=1955)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-390">For more information on creating and using UDFs, check out [Intro to User-Defined Functions](http://www.sqlteam.com/item.asp?ItemID=1955).</span></span> <span data-ttu-id="56bd3-391">也瞧瞧[優點和 Drawbacks of User-Defined 函式](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-391">Also check out [Advantages and Drawbacks of User-Defined Functions](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1).</span></span>


## <a name="step-10-creating-a-managed-udf"></a><span data-ttu-id="56bd3-392">步驟 10： 建立 Managed 的 UDF</span><span class="sxs-lookup"><span data-stu-id="56bd3-392">Step 10: Creating a Managed UDF</span></span>

<span data-ttu-id="56bd3-393">`udf_ComputeInventoryValue`和`udf_GetProductsByCategoryID`上述範例中建立的 Udf 是 T-SQL 的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-393">The `udf_ComputeInventoryValue` and `udf_GetProductsByCategoryID` UDFs created in the above examples are T-SQL database objects.</span></span> <span data-ttu-id="56bd3-394">SQL Server 2005 也支援受管理的 Udf，可以加入至`ManagedDatabaseConstructs`專案就像 managed 預存程序，從步驟 3 和 5。</span><span class="sxs-lookup"><span data-stu-id="56bd3-394">SQL Server 2005 also supports managed UDFs, which can be added to the `ManagedDatabaseConstructs` project just like the managed stored procedures from Steps 3 and 5.</span></span> <span data-ttu-id="56bd3-395">此步驟中，可讓實作 s `udf_ComputeInventoryValue` managed 程式碼中的 UDF。</span><span class="sxs-lookup"><span data-stu-id="56bd3-395">For this step, let s implement the `udf_ComputeInventoryValue` UDF in managed code.</span></span>

<span data-ttu-id="56bd3-396">若要將 managed 的 UDF 以便`ManagedDatabaseConstructs`專案、 方案總管 中的專案名稱上按一下滑鼠右鍵，然後選擇要加入新項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-396">To add a managed UDF to the `ManagedDatabaseConstructs` project, right-click on the project name in Solution Explorer and choose to Add a New Item.</span></span> <span data-ttu-id="56bd3-397">從 [加入新項目] 對話方塊中選取使用者定義的範本，並將新的 UDF 檔案命名`udf_ComputeInventoryValue_Managed.cs`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-397">Select the User-Defined Template from the Add New Item dialog box and name the new UDF file `udf_ComputeInventoryValue_Managed.cs`.</span></span>


<span data-ttu-id="56bd3-398">[![ManagedDatabaseConstructs 專案中加入新的 Managed 的 UDF](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-398">[![Add a New Managed UDF to the ManagedDatabaseConstructs Project](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image60.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image59.png)</span></span>

<span data-ttu-id="56bd3-399">**圖 25**： 新增新 Managed UDF`ManagedDatabaseConstructs`專案 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-399">**Figure 25**: Add a New Managed UDF to the `ManagedDatabaseConstructs` Project ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image61.png))</span></span>


<span data-ttu-id="56bd3-400">使用者定義函式範本會建立`partial`名為類別`UserDefinedFunctions`方法，其名稱是做為類別 s 的檔案名稱相同 (`udf_ComputeInventoryValue_Managed`，這個執行個體中)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-400">The User-Defined Function template creates a `partial` class named `UserDefinedFunctions` with a method whose name is the same as the class file s name (`udf_ComputeInventoryValue_Managed`, in this instance).</span></span> <span data-ttu-id="56bd3-401">這個方法使用裝飾[`SqlFunction`屬性](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx)的旗標為 managed UDF 方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-401">This method is decorated using the [`SqlFunction` attribute](https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlfunctionattribute.aspx), which flags the method as a managed UDF.</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample13.cs)]

<span data-ttu-id="56bd3-402">`udf_ComputeInventoryValue`方法目前會傳回[`SqlString`物件](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx)，不接受任何輸入參數。</span><span class="sxs-lookup"><span data-stu-id="56bd3-402">The `udf_ComputeInventoryValue` method currently returns a [`SqlString` object](https://msdn.microsoft.com/library/system.data.sqltypes.sqlstring.aspx) and does not accept any input parameters.</span></span> <span data-ttu-id="56bd3-403">我們要更新的方法定義，讓它接受三個輸入參數- `UnitPrice`， `UnitsInStock`，並`Discontinued`-並傳回`SqlMoney`物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-403">We need to update the method definition so that it accepts three input parameters - `UnitPrice`, `UnitsInStock`, and `Discontinued` - and returns a `SqlMoney` object.</span></span> <span data-ttu-id="56bd3-404">計算存貨值的邏輯是完全在 T-SQL 中相同`udf_ComputeInventoryValue`UDF。</span><span class="sxs-lookup"><span data-stu-id="56bd3-404">The logic for calculating the inventory value is identical to that in the T-SQL `udf_ComputeInventoryValue` UDF.</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample14.cs)]

<span data-ttu-id="56bd3-405">請注意，UDF 方法 s 的輸入的參數是其對應的 SQL 型別： `SqlMoney` for`UnitPrice`欄位中， [ `SqlInt16` ](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx)如`UnitsInStock`，和[ `SqlBoolean` ](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx)針對`Discontinued`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-405">Note that the UDF method s input parameters are of their corresponding SQL types: `SqlMoney` for the `UnitPrice` field, [`SqlInt16`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlint16.aspx) for `UnitsInStock`, and [`SqlBoolean`](https://msdn.microsoft.com/library/system.data.sqltypes.sqlboolean.aspx) for `Discontinued`.</span></span> <span data-ttu-id="56bd3-406">這些資料型別反映中定義的類型`Products`資料表： `UnitPrice` sloupec je typu `money`，則`UnitsInStock`類型的資料行`smallint`，而`Discontinued`類型的資料行`bit`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-406">These data types reflect the types defined in the `Products` table: the `UnitPrice` column is of type `money`, the `UnitsInStock` column of type `smallint`, and the `Discontinued` column of type `bit`.</span></span>

<span data-ttu-id="56bd3-407">程式碼一開始會建立`SqlMoney`執行個體名為`inventoryValue`指派值為 0。</span><span class="sxs-lookup"><span data-stu-id="56bd3-407">The code starts by creating a `SqlMoney` instance named `inventoryValue` that is assigned a value of 0.</span></span> <span data-ttu-id="56bd3-408">`Products`資料庫的資料表允許`NULL`中的值`UnitsInPrice`和`UnitsInStock`資料行。</span><span class="sxs-lookup"><span data-stu-id="56bd3-408">The `Products` table allows for database `NULL` values in the `UnitsInPrice` and `UnitsInStock` columns.</span></span> <span data-ttu-id="56bd3-409">因此，我們需要先檢查以查看這些值是否包含`NULL`s，我們透過`SqlMoney`物件 s [ `IsNull`屬性](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-409">Therefore, we need to first check to see if these values contain `NULL` s, which we do through the `SqlMoney` object s [`IsNull` property](https://msdn.microsoft.com/library/system.data.sqltypes.sqlmoney.isnull.aspx).</span></span> <span data-ttu-id="56bd3-410">如果兩個`UnitPrice`並`UnitsInStock`包含非`NULL`值，那麼我們計算`inventoryValue`是兩個產品。</span><span class="sxs-lookup"><span data-stu-id="56bd3-410">If both `UnitPrice` and `UnitsInStock` contain non-`NULL` values, then we compute the `inventoryValue` to be the product of the two.</span></span> <span data-ttu-id="56bd3-411">然後，如果`Discontinued`為 true，則我們可以藉此值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-411">Then, if `Discontinued` is true, then we halve the value.</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-412">`SqlMoney`物件只允許兩個`SqlMoney`一起相乘的執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-412">The `SqlMoney` object only allows two `SqlMoney` instances to be multiplied together.</span></span> <span data-ttu-id="56bd3-413">它不允許`SqlMoney`先乘以常值的浮點數的執行個體。</span><span class="sxs-lookup"><span data-stu-id="56bd3-413">It does not allow a `SqlMoney` instance to be multiplied by a literal floating-point number.</span></span> <span data-ttu-id="56bd3-414">因此，到一半`inventoryValue`我們將它乘以新`SqlMoney`執行個體，其值為 0.5。</span><span class="sxs-lookup"><span data-stu-id="56bd3-414">Therefore, to halve `inventoryValue` we multiply it by a new `SqlMoney` instance that has the value 0.5.</span></span>


## <a name="step-11-deploying-the-managed-udf"></a><span data-ttu-id="56bd3-415">步驟 11： 部署受管理的 UDF</span><span class="sxs-lookup"><span data-stu-id="56bd3-415">Step 11: Deploying the Managed UDF</span></span>

<span data-ttu-id="56bd3-416">現在，建立受管理的 UDF 之後，我們已準備好將它部署到 Northwind 資料庫。</span><span class="sxs-lookup"><span data-stu-id="56bd3-416">Now that the managed UDF has been created, we are ready to deploy it to the Northwind database.</span></span> <span data-ttu-id="56bd3-417">如我們所見在步驟 4 中，會部署在 SQL Server 專案中的受管理的物件 [方案總管] 中的專案名稱上按一下滑鼠右鍵，並從操作功能表選擇 [部署] 選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-417">As we saw in Step 4, the managed objects in a SQL Server Project are deployed by right-clicking on the project name in the Solution Explorer and choosing the Deploy option from the context menu.</span></span>

<span data-ttu-id="56bd3-418">一旦您已部署專案，請返回 SQL Server Management Studio，並重新整理純量值函式資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-418">Once you have deployed the project, return to SQL Server Management Studio and refresh the Scalar-valued Functions folder.</span></span> <span data-ttu-id="56bd3-419">現在，您應該會看到兩個項目：</span><span class="sxs-lookup"><span data-stu-id="56bd3-419">You should now see two entries:</span></span>

- <span data-ttu-id="56bd3-420">`dbo.udf_ComputeInventoryValue` -步驟 9 中建立的 T-SQL UDF 和</span><span class="sxs-lookup"><span data-stu-id="56bd3-420">`dbo.udf_ComputeInventoryValue` - the T-SQL UDF created in Step 9, and</span></span>
- <span data-ttu-id="56bd3-421">`dbo.udf ComputeInventoryValue_Managed` -只是已部署的步驟 10 中建立的受管理的 UDF。</span><span class="sxs-lookup"><span data-stu-id="56bd3-421">`dbo.udf ComputeInventoryValue_Managed` - the managed UDF created in Step 10 that was just deployed.</span></span>

<span data-ttu-id="56bd3-422">若要測試此受管理的 UDF，請執行下列查詢從 Management Studio 中：</span><span class="sxs-lookup"><span data-stu-id="56bd3-422">To test this managed UDF, execute the following query from within Management Studio:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample15.sql)]

<span data-ttu-id="56bd3-423">此命令會使用 managed`udf ComputeInventoryValue_Managed`而不是 T-SQL 的 UDF `udf_ComputeInventoryValue` UDF，但輸出會相同。</span><span class="sxs-lookup"><span data-stu-id="56bd3-423">This command uses the managed `udf ComputeInventoryValue_Managed` UDF instead of the T-SQL `udf_ComputeInventoryValue` UDF, but the output is the same.</span></span> <span data-ttu-id="56bd3-424">若要查看 UDF 的輸出的螢幕擷取畫面的 圖 23 回頭參考。</span><span class="sxs-lookup"><span data-stu-id="56bd3-424">Refer back to Figure 23 to see a screenshot of the UDF s output.</span></span>

## <a name="step-12-debugging-the-managed-database-objects"></a><span data-ttu-id="56bd3-425">步驟 12： 偵錯 Managed 的資料庫物件</span><span class="sxs-lookup"><span data-stu-id="56bd3-425">Step 12: Debugging the Managed Database Objects</span></span>

<span data-ttu-id="56bd3-426">在 [偵錯預存程序](debugging-stored-procedures-cs.md)進行偵錯透過 Visual Studio 的 SQL Server 的教學課程中我們將討論三個選項： 直接資料庫偵錯、 應用程式偵錯，以及從 SQL Server 專案的偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-426">In the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial we discussed the three options for debugging SQL Server through Visual Studio: Direct Database Debugging, Application Debugging, and Debugging from a SQL Server Project.</span></span> <span data-ttu-id="56bd3-427">從用戶端應用程式，以及直接從 SQL Server 專案，請管理的資料庫物件無法透過直接資料庫偵錯，偵錯，但可以進行偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-427">Managed database objects cannot be debugged via Direct Database Debugging, but can be debugged from a client application and directly from the SQL Server Project.</span></span> <span data-ttu-id="56bd3-428">為了讓偵錯能夠運作，不過，SQL Server 2005 資料庫必須允許 SQL/CLR 偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-428">In order for debugging to work, however, the SQL Server 2005 database must allow SQL/CLR debugging.</span></span> <span data-ttu-id="56bd3-429">請注意，當我們第一次建立`ManagedDatabaseConstructs`Visual Studio 要求我們是否要啟用 SQL/CLR 偵錯 （請參閱 圖 6 在步驟 2） 的專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-429">Recall that when we first created the `ManagedDatabaseConstructs` project Visual Studio asked us whether we wanted to enable SQL/CLR debugging (see Figure 6 in Step 2).</span></span> <span data-ttu-id="56bd3-430">以滑鼠右鍵按一下 [伺服器總管] 視窗的資料庫，就可以修改此設定。</span><span class="sxs-lookup"><span data-stu-id="56bd3-430">This setting can be modified by right-clicking on the database from the Server Explorer window.</span></span>


![請確定資料庫允許 SQL/CLR 偵錯](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image62.png)

<span data-ttu-id="56bd3-432">**圖 26**： 請確定資料庫允許 SQL/CLR 偵錯</span><span class="sxs-lookup"><span data-stu-id="56bd3-432">**Figure 26**: Ensure that the Database Allows SQL/CLR Debugging</span></span>


<span data-ttu-id="56bd3-433">假設我們想要偵錯`GetProductsWithPriceLessThan`managed 預存程序。</span><span class="sxs-lookup"><span data-stu-id="56bd3-433">Imagine that we wanted to debug the `GetProductsWithPriceLessThan` managed stored procedure.</span></span> <span data-ttu-id="56bd3-434">藉由設定中斷點的程式碼中，我們會開始`GetProductsWithPriceLessThan`方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-434">We would start by setting a breakpoint within the code of the `GetProductsWithPriceLessThan` method.</span></span>


<span data-ttu-id="56bd3-435">[![GetProductsWithPriceLessThan 方法中設定中斷點](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-435">[![Set a Breakpoint in the GetProductsWithPriceLessThan Method](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image64.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image63.png)</span></span>

<span data-ttu-id="56bd3-436">**圖 27**： 在設定的中斷點`GetProductsWithPriceLessThan`方法 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-436">**Figure 27**: Set a Breakpoint in the `GetProductsWithPriceLessThan` Method ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image65.png))</span></span>


<span data-ttu-id="56bd3-437">可讓 s 第一次查看偵錯 managed 的資料庫物件，從 SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-437">Let s first look at debugging the managed database objects from the SQL Server Project.</span></span> <span data-ttu-id="56bd3-438">因為我們的解決方案包含兩個專案- `ManagedDatabaseConstructs` SQL Server 專案，以及我們的網站-若要從 SQL Server 專案，我們必須指示來啟動 Visual Studio 偵錯`ManagedDatabaseConstructs`我們開始偵錯時，SQL Server 專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-438">Since our Solution includes two projects - the `ManagedDatabaseConstructs` SQL Server Project along with our website - in order to debug from the SQL Server Project we need to instruct Visual Studio to launch the `ManagedDatabaseConstructs` SQL Server Project when we start debugging.</span></span> <span data-ttu-id="56bd3-439">以滑鼠右鍵按一下`ManagedDatabaseConstructs`專案在 方案總管，然後選擇 設定為啟始專案選項，從內容功能表。</span><span class="sxs-lookup"><span data-stu-id="56bd3-439">Right-click the `ManagedDatabaseConstructs` project in Solution Explorer and choose the Set as StartUp Project option from the context menu.</span></span>

<span data-ttu-id="56bd3-440">當`ManagedDatabaseConstructs`對執行中的 SQL 陳述式的偵錯工具啟動專案`Test.sql`檔案，位於`Test Scripts`資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-440">When the `ManagedDatabaseConstructs` project is launched from the debugger it executes the SQL statements in the `Test.sql` file, which is located in the `Test Scripts` folder.</span></span> <span data-ttu-id="56bd3-441">例如，若要測試`GetProductsWithPriceLessThan`managed 預存程序，取代現有`Test.sql`檔案內容，使用下列陳述式，會叫用`GetProductsWithPriceLessThan`managed 預存程序傳入`@CategoryID`14.95 的值：</span><span class="sxs-lookup"><span data-stu-id="56bd3-441">For example, to test the `GetProductsWithPriceLessThan` managed stored procedure, replace the existing `Test.sql` file content with the following statement, which invokes the `GetProductsWithPriceLessThan` managed stored procedure passing in the `@CategoryID` value of 14.95:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample16.sql)]

<span data-ttu-id="56bd3-442">一旦您已輸入到上述指令碼`Test.sql`、 開始偵錯移至 偵錯 功能表並選擇 開始偵錯，或按 F5 或綠色工具列中 播放 圖示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-442">Once you ve entered the above script into `Test.sql`, start debugging by going to the Debug menu and choosing Start Debugging or by hitting F5 or the green play icon in the Toolbar.</span></span> <span data-ttu-id="56bd3-443">這會建置專案的方案中，Northwind 資料庫中，部署 managed 的資料庫物件，然後執行`Test.sql`指令碼。</span><span class="sxs-lookup"><span data-stu-id="56bd3-443">This will build the projects within the Solution, deploy the managed database objects to the Northwind database, and then execute the `Test.sql` script.</span></span> <span data-ttu-id="56bd3-444">此時，會叫用中斷點，而且我們可以逐步執行`GetProductsWithPriceLessThan`方法，檢查輸入參數的值等等。</span><span class="sxs-lookup"><span data-stu-id="56bd3-444">At this point, the breakpoint will be hit and we can step through the `GetProductsWithPriceLessThan` method, examine the values of the input parameters, and so on.</span></span>


<span data-ttu-id="56bd3-445">[![叫用中斷點，在 GetProductsWithPriceLessThan 方法](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-445">[![The Breakpoint in the GetProductsWithPriceLessThan Method Was Hit](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image67.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image66.png)</span></span>

<span data-ttu-id="56bd3-446">**圖 28**： 在中斷點`GetProductsWithPriceLessThan`已叫用方法 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-446">**Figure 28**: The Breakpoint in the `GetProductsWithPriceLessThan` Method Was Hit ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image68.png))</span></span>


<span data-ttu-id="56bd3-447">為了要透過用戶端應用程式進行偵錯的 SQL 資料庫物件，因此務必資料庫設定來支援應用程式偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-447">In order for a SQL database object to be debugged through a client application, it is imperative that the database be configured to support application debugging.</span></span> <span data-ttu-id="56bd3-448">以滑鼠右鍵按一下伺服器總管] 中的資料庫，並確定已核取 [應用程式偵錯的選項。</span><span class="sxs-lookup"><span data-stu-id="56bd3-448">Right-click on the database in Server Explorer and ensure that the Application Debugging option is checked.</span></span> <span data-ttu-id="56bd3-449">此外，我們需要設定 ASP.NET 應用程式與 SQL 偵錯工具整合，並在停用連接共用。</span><span class="sxs-lookup"><span data-stu-id="56bd3-449">Furthermore, we need to configure the ASP.NET application to integrate with the SQL Debugger and to disable connection pooling.</span></span> <span data-ttu-id="56bd3-450">下列步驟所述的步驟 2 中的詳細資料[偵錯預存程序](debugging-stored-procedures-cs.md)教學課程。</span><span class="sxs-lookup"><span data-stu-id="56bd3-450">These steps were discussed in detail in Step 2 of the [Debugging Stored Procedures](debugging-stored-procedures-cs.md) tutorial.</span></span>

<span data-ttu-id="56bd3-451">一旦您已設定的 ASP.NET 應用程式和資料庫，將 ASP.NET 網站設定為啟始專案，並開始偵錯。</span><span class="sxs-lookup"><span data-stu-id="56bd3-451">Once you have configured the ASP.NET application and database, set the ASP.NET website as the startup project and start debugging.</span></span> <span data-ttu-id="56bd3-452">如果您造訪的頁面，會呼叫具有中斷點的受管理物件的其中一個時，應用程式將會中止，控制項將會開啟偵錯工具，其中您可以逐步執行程式碼如圖 28 所示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-452">If you visit a page that calls one of the managed objects that has a breakpoint, the application will halt and control will be turned over to the debugger, where you can step through the code as shown in Figure 28.</span></span>

## <a name="step-13-manually-compiling-and-deploying-managed-database-objects"></a><span data-ttu-id="56bd3-453">步驟 13： 手動編譯和部署 Managed 資料庫物件</span><span class="sxs-lookup"><span data-stu-id="56bd3-453">Step 13: Manually Compiling and Deploying Managed Database Objects</span></span>

<span data-ttu-id="56bd3-454">SQL Server 專案，讓您輕鬆建立、 編譯及部署 managed 的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-454">SQL Server Projects make it easy to create, compile, and deploy managed database objects.</span></span> <span data-ttu-id="56bd3-455">不幸的是，SQL Server 專案中才有的 Visual Studio Professional 和 Team 系統版本。</span><span class="sxs-lookup"><span data-stu-id="56bd3-455">Unfortunately, SQL Server Projects are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="56bd3-456">如果您使用 Visual Web Developer 或 Standard Edition 的 Visual Studio，並想要使用 managed 的資料庫物件，您必須以手動方式建立，並將其部署。</span><span class="sxs-lookup"><span data-stu-id="56bd3-456">If you are using Visual Web Developer or the Standard Edition of Visual Studio and want to use managed database objects, you will need to manually create and deploy them.</span></span> <span data-ttu-id="56bd3-457">這牽涉到四個步驟：</span><span class="sxs-lookup"><span data-stu-id="56bd3-457">This involves four steps:</span></span>

1. <span data-ttu-id="56bd3-458">建立此檔案包含 managed 的資料庫物件的原始程式碼</span><span class="sxs-lookup"><span data-stu-id="56bd3-458">Create a file that contains the source code for the managed database object,</span></span>
2. <span data-ttu-id="56bd3-459">編譯為組件中物件</span><span class="sxs-lookup"><span data-stu-id="56bd3-459">Compile the object into an assembly,</span></span>
3. <span data-ttu-id="56bd3-460">使用 SQL Server 2005 資料庫時，註冊組件和</span><span class="sxs-lookup"><span data-stu-id="56bd3-460">Register the assembly with the SQL Server 2005 database, and</span></span>
4. <span data-ttu-id="56bd3-461">指向組件中的適當方法的 SQL Server 中建立資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-461">Create a database object in SQL Server that points to the appropriate method in the assembly.</span></span>

<span data-ttu-id="56bd3-462">說明這些工作，讓建立新的受管理的預存程序會傳回這些產品的`UnitPrice`大於指定的值。</span><span class="sxs-lookup"><span data-stu-id="56bd3-462">To illustrate these tasks, let s create a new managed stored procedure that returns those products whose `UnitPrice` is greater than a specified value.</span></span> <span data-ttu-id="56bd3-463">建立名為您電腦上的新檔案`GetProductsWithPriceGreaterThan.cs`和輸入檔案中的下列程式碼 （您可以使用 Visual Studio 中，[記事本] 或任何文字編輯器來完成這項作業）：</span><span class="sxs-lookup"><span data-stu-id="56bd3-463">Create a new file on your computer named `GetProductsWithPriceGreaterThan.cs` and enter the following code into the file (you can use Visual Studio, Notepad, or any text editor to accomplish this):</span></span>


[!code-csharp[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample17.cs)]

<span data-ttu-id="56bd3-464">此程式碼是幾乎完全相同的`GetProductsWithPriceLessThan`步驟 5 中建立的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-464">This code is nearly identical to that of the `GetProductsWithPriceLessThan` method created in Step 5.</span></span> <span data-ttu-id="56bd3-465">唯一的差異是方法名稱，`WHERE`子句，而且查詢中使用的參數名稱。</span><span class="sxs-lookup"><span data-stu-id="56bd3-465">The only differences are the method names, the `WHERE` clause, and the parameter name used in the query.</span></span> <span data-ttu-id="56bd3-466">回到`GetProductsWithPriceLessThan`方法中，`WHERE`讀取的子句： `WHERE UnitPrice < @MaxPrice`。</span><span class="sxs-lookup"><span data-stu-id="56bd3-466">Back in the `GetProductsWithPriceLessThan` method, the `WHERE` clause read: `WHERE UnitPrice < @MaxPrice`.</span></span> <span data-ttu-id="56bd3-467">此處，請在`GetProductsWithPriceGreaterThan`，我們使用： `WHERE UnitPrice > @MinPrice` 。</span><span class="sxs-lookup"><span data-stu-id="56bd3-467">Here, in `GetProductsWithPriceGreaterThan`, we use: `WHERE UnitPrice > @MinPrice` .</span></span>

<span data-ttu-id="56bd3-468">我們現在需要此類別編譯為組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-468">We now need to compile this class into an assembly.</span></span> <span data-ttu-id="56bd3-469">從命令列中，瀏覽至您的儲存位置的目錄`GetProductsWithPriceGreaterThan.cs`檔案，並使用 C# 編譯器 (`csc.exe`) 來編譯為組件的類別檔案：</span><span class="sxs-lookup"><span data-stu-id="56bd3-469">From the command line, navigate to the directory where you saved the `GetProductsWithPriceGreaterThan.cs` file and use the C# compiler (`csc.exe`) to compile the class file into an assembly:</span></span>


[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample18.cmd)]

<span data-ttu-id="56bd3-470">如果包含的資料夾`csc.exe`中不在系統 s `PATH`，您必須完整參考它的路徑， `%WINDOWS%\Microsoft.NET\Framework\version\`，就像這樣：</span><span class="sxs-lookup"><span data-stu-id="56bd3-470">If the folder containing `csc.exe` in not in the system s `PATH`, you will have to fully reference its path, `%WINDOWS%\Microsoft.NET\Framework\version\`, like so:</span></span>


[!code-console[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample19.cmd)]


<span data-ttu-id="56bd3-471">[![GetProductsWithPriceGreaterThan.cs 編譯為組件](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-471">[![Compile GetProductsWithPriceGreaterThan.cs Into an Assembly](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image70.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image69.png)</span></span>

<span data-ttu-id="56bd3-472">**圖 29**： 編譯`GetProductsWithPriceGreaterThan.cs`成組件 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-472">**Figure 29**: Compile `GetProductsWithPriceGreaterThan.cs` Into an Assembly ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image71.png))</span></span>


<span data-ttu-id="56bd3-473">`/t`旗標會指定 C# 類別檔案，應編譯成 DLL （而不是可執行檔）。</span><span class="sxs-lookup"><span data-stu-id="56bd3-473">The `/t` flag specifies that the C# class file should be compiled into a DLL (rather than an executable).</span></span> <span data-ttu-id="56bd3-474">`/out`旗標會指定產生的組件的名稱。</span><span class="sxs-lookup"><span data-stu-id="56bd3-474">The `/out` flag specifies the name of the resulting assembly.</span></span>

> [!NOTE]
> <span data-ttu-id="56bd3-475">而不是編譯`GetProductsWithPriceGreaterThan.cs`從命令列，您也可以使用的類別檔案[Visual C# Express 版](https://msdn.microsoft.com/vstudio/express/visualcsharp/)或 Visual Studio Standard Edition 中建立個別的類別庫專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-475">Rather than compiling the `GetProductsWithPriceGreaterThan.cs` class file from the command line you could alternatively use [Visual C# Express Edition](https://msdn.microsoft.com/vstudio/express/visualcsharp/) or create a separate Class Library project in Visual Studio Standard Edition.</span></span> <span data-ttu-id="56bd3-476">S ren Jacob Lauritsen 請提供程式碼具有這類的 Visual C# Express 版專案`GetProductsWithPriceGreaterThan`預存程序和兩個 managed 預存程序，並在步驟 3、 5 和 10 中建立的 UDF。</span><span class="sxs-lookup"><span data-stu-id="56bd3-476">S ren Jacob Lauritsen has kindly provided such a Visual C# Express Edition project with code for the `GetProductsWithPriceGreaterThan` stored procedure and the two managed stored procedures and UDF created in Steps 3, 5, and 10.</span></span> <span data-ttu-id="56bd3-477">S ren s 專案也包含新增對應的資料庫物件所需的 T-SQL 命令。</span><span class="sxs-lookup"><span data-stu-id="56bd3-477">S ren s project also includes the T-SQL commands needed to add the corresponding database objects.</span></span>


<span data-ttu-id="56bd3-478">程式碼編譯成組件時，我們已準備好註冊 SQL Server 2005 資料庫內組件項目。</span><span class="sxs-lookup"><span data-stu-id="56bd3-478">With the code compiled into an assembly, we are ready to register the assembly within the SQL Server 2005 database.</span></span> <span data-ttu-id="56bd3-479">這可透過 T-SQL，使用命令來執行`CREATE ASSEMBLY`，或透過 SQL Server Management Studio。</span><span class="sxs-lookup"><span data-stu-id="56bd3-479">This can be performed through T-SQL, using the command `CREATE ASSEMBLY`, or through SQL Server Management Studio.</span></span> <span data-ttu-id="56bd3-480">使用 Management Studio 讓 s 焦點。</span><span class="sxs-lookup"><span data-stu-id="56bd3-480">Let s focus on using Management Studio.</span></span>

<span data-ttu-id="56bd3-481">從 Management Studio 中，展開 Northwind 資料庫中的 可程式性 資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-481">From Management Studio, expand the Programmability folder in the Northwind database.</span></span> <span data-ttu-id="56bd3-482">及其子資料夾是組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-482">One of its subfolder is Assemblies.</span></span> <span data-ttu-id="56bd3-483">手動將新的組件新增至資料庫中，以滑鼠右鍵按一下組件 資料夾，並從操作功能表中選擇新的組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-483">To manually add a new Assembly to the database, right-click on the Assemblies folder and choose New Assembly from the context menu.</span></span> <span data-ttu-id="56bd3-484">新組件對話方塊 （請參閱圖 30） 此顯示。</span><span class="sxs-lookup"><span data-stu-id="56bd3-484">This displays the New Assembly dialog box (see Figure 30).</span></span> <span data-ttu-id="56bd3-485">按一下 瀏覽按鈕，選取`ManuallyCreatedDBObjects.dll`我們剛所編譯，，，然後按一下 確定 以加入資料庫中的組件的組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-485">Click on the Browse button, select the `ManuallyCreatedDBObjects.dll` assembly we just compiled, and then click OK to add the Assembly to the database.</span></span> <span data-ttu-id="56bd3-486">您不應該看見`ManuallyCreatedDBObjects.dll`物件總管 中的組件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-486">You should not see the `ManuallyCreatedDBObjects.dll` assembly in the Object Explorer.</span></span>


<span data-ttu-id="56bd3-487">[![將 ManuallyCreatedDBObjects.dll 組件加入至資料庫](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-487">[![Add the ManuallyCreatedDBObjects.dll Assembly to the Database](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image73.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image72.png)</span></span>

<span data-ttu-id="56bd3-488">**圖 30**： 新增`ManuallyCreatedDBObjects.dll`資料庫的組件 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-488">**Figure 30**: Add the `ManuallyCreatedDBObjects.dll` Assembly to the Database ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image74.png))</span></span>


![ManuallyCreatedDBObjects.dll 會列在 [物件總管]](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image75.png)

<span data-ttu-id="56bd3-490">**圖 31**:`ManuallyCreatedDBObjects.dll`會列在 [物件總管]</span><span class="sxs-lookup"><span data-stu-id="56bd3-490">**Figure 31**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer</span></span>


<span data-ttu-id="56bd3-491">雖然我們已加入組件至 Northwind 資料庫，我們尚未建立關聯的預存程序`GetProductsWithPriceGreaterThan`組件中的方法。</span><span class="sxs-lookup"><span data-stu-id="56bd3-491">While we have added the assembly to the Northwind database, we have yet to associate a stored procedure with the `GetProductsWithPriceGreaterThan` method in the assembly.</span></span> <span data-ttu-id="56bd3-492">若要這麼做，開啟新的查詢視窗並執行下列指令碼：</span><span class="sxs-lookup"><span data-stu-id="56bd3-492">To accomplish this, open a new query window and execute the following script:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample20.sql)]

<span data-ttu-id="56bd3-493">這會在名為 Northwind 資料庫中建立新的預存程序`GetProductsWithPriceGreaterThan`，並產生關聯的 managed 方法`GetProductsWithPriceGreaterThan`(這是在類別中`StoredProcedures`，這是組件中`ManuallyCreatedDBObjects`)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-493">This creates a new stored procedure in the Northwind database named `GetProductsWithPriceGreaterThan` and associates it with the managed method `GetProductsWithPriceGreaterThan` (which is in the class `StoredProcedures`, which is in the assembly `ManuallyCreatedDBObjects`).</span></span>

<span data-ttu-id="56bd3-494">執行上述指令碼之後, 重新整理物件總管 中的 預存程序 資料夾。</span><span class="sxs-lookup"><span data-stu-id="56bd3-494">After executing the above script, refresh the Stored Procedures folder in the Object Explorer.</span></span> <span data-ttu-id="56bd3-495">您應該會看到新的預存程序項目- `GetProductsWithPriceGreaterThan` -具有鎖定圖示旁邊。</span><span class="sxs-lookup"><span data-stu-id="56bd3-495">You should see a new stored procedure entry - `GetProductsWithPriceGreaterThan` - which has a lock icon next to it.</span></span> <span data-ttu-id="56bd3-496">若要測試此預存程序，請輸入，並在查詢視窗中執行下列指令碼：</span><span class="sxs-lookup"><span data-stu-id="56bd3-496">To test this stored procedure, enter and execute the following script in the query window:</span></span>


[!code-sql[Main](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/samples/sample21.sql)]

<span data-ttu-id="56bd3-497">如圖 32 所示，上述命令會顯示與這些產品的資訊`UnitPrice`大於美金 24.95。</span><span class="sxs-lookup"><span data-stu-id="56bd3-497">As Figure 32 shows, the above command displays information for those products with a `UnitPrice` greater than $24.95.</span></span>


<span data-ttu-id="56bd3-498">[![ManuallyCreatedDBObjects.dll 會列在 [物件總管]](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span><span class="sxs-lookup"><span data-stu-id="56bd3-498">[![The ManuallyCreatedDBObjects.dll is Listed in the Object Explorer](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image77.png)](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image76.png)</span></span>

<span data-ttu-id="56bd3-499">**圖 32**:`ManuallyCreatedDBObjects.dll`會列在 [物件總管] 中 ([按一下以檢視完整大小的影像](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png))</span><span class="sxs-lookup"><span data-stu-id="56bd3-499">**Figure 32**: The `ManuallyCreatedDBObjects.dll` is Listed in the Object Explorer ([Click to view full-size image](creating-stored-procedures-and-user-defined-functions-with-managed-code-cs/_static/image78.png))</span></span>


## <a name="summary"></a><span data-ttu-id="56bd3-500">總結</span><span class="sxs-lookup"><span data-stu-id="56bd3-500">Summary</span></span>

<span data-ttu-id="56bd3-501">Microsoft SQL Server 2005 提供整合與 Common Language Runtime (CLR)，可使用 managed 程式碼建立的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-501">Microsoft SQL Server 2005 provides integration with the Common Language Runtime (CLR), which allows database objects to be created using managed code.</span></span> <span data-ttu-id="56bd3-502">先前，這些資料庫物件只能建立使用 T-SQL，但現在我們可以在其中建立這些物件使用的.NET 程式設計語言，例如 C#。</span><span class="sxs-lookup"><span data-stu-id="56bd3-502">Previously, these database objects could only be created using T-SQL, but now we can create these objects using .NET programming languages like C#.</span></span> <span data-ttu-id="56bd3-503">在本教學課程，我們建立兩個受管理預存程序和 managed 使用者定義函式。</span><span class="sxs-lookup"><span data-stu-id="56bd3-503">In this tutorial we created two managed stored procedures and a managed User-Defined Function.</span></span>

<span data-ttu-id="56bd3-504">Visual Studio 的 SQL Server 專案類型可協助建立、 編譯和部署 managed 的資料庫物件。</span><span class="sxs-lookup"><span data-stu-id="56bd3-504">Visual Studio s SQL Server Project type facilitates creating, compiling, and deploying managed database objects.</span></span> <span data-ttu-id="56bd3-505">此外，它提供豐富的偵錯支援。</span><span class="sxs-lookup"><span data-stu-id="56bd3-505">Moreover, it offers rich debugging support.</span></span> <span data-ttu-id="56bd3-506">不過，SQL Server 專案類型中才有的 Visual Studio Professional 和 Team 系統版本。</span><span class="sxs-lookup"><span data-stu-id="56bd3-506">However, SQL Server Project types are only available in the Professional and Team Systems editions of Visual Studio.</span></span> <span data-ttu-id="56bd3-507">對於使用 Visual Web Developer 或 Standard Edition 的 Visual Studio、 建立、 編譯和部署步驟必須手動執行，如我們所見步驟 13。</span><span class="sxs-lookup"><span data-stu-id="56bd3-507">For those using Visual Web Developer or the Standard Edition of Visual Studio, the creation, compilation, and deployment steps must be performed manually, as we saw in Step 13.</span></span>

<span data-ttu-id="56bd3-508">快樂地寫程式 ！</span><span class="sxs-lookup"><span data-stu-id="56bd3-508">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="56bd3-509">進一步閱讀</span><span class="sxs-lookup"><span data-stu-id="56bd3-509">Further Reading</span></span>

<span data-ttu-id="56bd3-510">如需有關在本教學課程所討論的主題的詳細資訊，請參閱下列資源：</span><span class="sxs-lookup"><span data-stu-id="56bd3-510">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="56bd3-511">優點和缺點的使用者定義函式</span><span class="sxs-lookup"><span data-stu-id="56bd3-511">Advantages and Drawbacks of User-Defined Functions</span></span>](http://www.samspublishing.com/articles/article.asp?p=31724&amp;rl=1)
- [<span data-ttu-id="56bd3-512">在 Managed 程式碼中建立 SQL Server 2005 物件</span><span class="sxs-lookup"><span data-stu-id="56bd3-512">Creating SQL Server 2005 Objects in Managed Code</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- [<span data-ttu-id="56bd3-513">建立觸發程序使用 SQL Server 2005 中的 Managed 程式碼</span><span class="sxs-lookup"><span data-stu-id="56bd3-513">Creating Triggers Using Managed Code in SQL Server 2005</span></span>](http://www.15seconds.com/issue/041006.htm)
- <span data-ttu-id="56bd3-514">[如何： 建立和執行 CLR 的 SQL Server 預存程序](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="56bd3-514">[How To: Create and Run a CLR SQL Server Stored Procedure](https://msdn.microsoft.com/library/5czye81z(VS.80).aspx)</span></span>
- <span data-ttu-id="56bd3-515">[如何： 建立和執行 CLR 的 SQL Server 使用者定義函式](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="56bd3-515">[How To: Create and Run a CLR SQL Server User-Defined Function](https://msdn.microsoft.com/library/w2kae45k(VS.80).aspx)</span></span>
- <span data-ttu-id="56bd3-516">[如何： 編輯`Test.sql`執行 SQL 物件的指令碼](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="56bd3-516">[How To: Edit the `Test.sql` Script to Run SQL Objects](https://msdn.microsoft.com/library/ms233682(VS.80).aspx)</span></span>
- [<span data-ttu-id="56bd3-517">簡介使用者定義函式</span><span class="sxs-lookup"><span data-stu-id="56bd3-517">Intro to User Defined Functions</span></span>](http://www.sqlteam.com/item.asp?ItemID=1955)
- [<span data-ttu-id="56bd3-518">Managed 程式碼和 SQL Server 2005 （影片）</span><span class="sxs-lookup"><span data-stu-id="56bd3-518">Managed Code and SQL Server 2005 (Video)</span></span>](https://channel9.msdn.com/Showpost.aspx?postid=142413)
- <span data-ttu-id="56bd3-519">[TRANSACT-SQL 參考](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="56bd3-519">[Transact-SQL Reference](https://msdn.microsoft.com/library/aa299742(SQL.80).aspx)</span></span>
- <span data-ttu-id="56bd3-520">[逐步解說： 在 Managed 程式碼建立預存程序](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span><span class="sxs-lookup"><span data-stu-id="56bd3-520">[Walkthrough: Creating a Stored Procedure in Managed Code](https://msdn.microsoft.com/library/zxsa8hkf(VS.80).aspx)</span></span>

## <a name="about-the-author"></a><span data-ttu-id="56bd3-521">關於作者</span><span class="sxs-lookup"><span data-stu-id="56bd3-521">About the Author</span></span>

<span data-ttu-id="56bd3-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)，作者的七個 ASP 書籍和的創辦人[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年從事 Microsoft Web 技術工作。</span><span class="sxs-lookup"><span data-stu-id="56bd3-522">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="56bd3-523">Scott 會擔任獨立的顧問、 培訓講師和作家。</span><span class="sxs-lookup"><span data-stu-id="56bd3-523">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="56bd3-524">他最新的著作是[ *Sams 教導您自己 ASP.NET 2.0 在 24 小時內*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-524">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="56bd3-525">他可以在觸達[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="56bd3-525">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="56bd3-526">或透過他的部落格，這位於[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="56bd3-526">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="56bd3-527">特別感謝</span><span class="sxs-lookup"><span data-stu-id="56bd3-527">Special Thanks To</span></span>

<span data-ttu-id="56bd3-528">本教學課程系列是由許多實用的檢閱者檢閱。</span><span class="sxs-lookup"><span data-stu-id="56bd3-528">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="56bd3-529">本教學課程中的潛在客戶檢閱者已 S ren Jacob Lauritsen。</span><span class="sxs-lookup"><span data-stu-id="56bd3-529">Lead reviewer for this tutorial was S ren Jacob Lauritsen.</span></span> <span data-ttu-id="56bd3-530">除了檢閱此文件、 S ren 也建立了包含在此發行項的下載手動編譯 managed 的資料庫物件中的 Visual C# Express 版專案。</span><span class="sxs-lookup"><span data-stu-id="56bd3-530">In addition to reviewing this article, S ren also created the Visual C# Express Edition project included in this article s download for manually compiling the managed database objects.</span></span> <span data-ttu-id="56bd3-531">有興趣檢閱我即將推出的 MSDN 文章嗎？</span><span class="sxs-lookup"><span data-stu-id="56bd3-531">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="56bd3-532">如果是這樣，psychic 在[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="56bd3-532">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="56bd3-533">[上一頁](debugging-stored-procedures-cs.md)
> [下一頁](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span><span class="sxs-lookup"><span data-stu-id="56bd3-533">[Previous](debugging-stored-procedures-cs.md)
[Next](creating-new-stored-procedures-for-the-typed-dataset-s-tableadapters-vb.md)</span></span>
